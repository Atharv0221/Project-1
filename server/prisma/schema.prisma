generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("STUDENT") // "STUDENT", "ADMIN"
  
  // Profile Fields
  gender        String?
  age           Int?
  classStandard String? // "8", "9", "10"
  schoolName    String?
  board         String?  @default("Maharashtra State Board")
  profilePhoto  String?

  // Gamification & Progress
  streak        Int      @default(0)
  lastLogin     DateTime?
  xp            Int      @default(0)
  scholarStatus String   @default("Learner") // "Learner", "Smart Scholar", "Gold Scholar", "Elite Scholar"
  rankScore     Float    @default(0.0)
  
  // Pro Plan Fields
  isPro              Boolean   @default(false)
  subscriptionExpiry DateTime?

  // Email Verification
  emailVerified      Boolean   @default(false)
  verificationToken  String?   @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  attempts        Attempt[]
  quizSessions    QuizSession[]
  mastery         MasteryTracking[]
  xpLogs          XpLog[]
  badges          UserBadge[]
  mockAttempts    MockAttempt[]
  posts           ForumPost[]
  flaggedAttempts FlaggedAttempt[]
  timeTracking    TimeTracking[]
  notifications   Notification[]
}

model Subject {
  id        String    @id @default(uuid())
  name      String
  standard  String    // "8", "9", "10"
  chapters  Chapter[]
  posts     ForumPost[]
  timeLogs  TimeTracking[]
  createdAt DateTime  @default(now())

  @@unique([name, standard])
}

model Chapter {
  id        String     @id @default(uuid())
  name      String
  subjectId String
  subject   Subject    @relation(fields: [subjectId], references: [id])
  youtubeLink String?
  levels    Level[]
  subtopics Subtopic[] // Keeping for backward compatibility if needed, else can depend on Levels
  order     Int        @default(0)
  createdAt DateTime   @default(now())

  @@unique([subjectId, name])
}

model Level {
  id        String     @id @default(uuid())
  name      String     // "Diagnostic", "Beginner", "Intermediate", "Advance", "Challenge"
  order     Int        // 1, 2, 3, 4, 5
  chapterId String
  chapter   Chapter    @relation(fields: [chapterId], references: [id])
  questions Question[] 
  sessions  QuizSession[]
  createdAt DateTime   @default(now())

  @@unique([chapterId, name])
}

model Subtopic {
  id        String            @id @default(uuid())
  name      String
  chapterId String
  chapter   Chapter           @relation(fields: [chapterId], references: [id])
  questions Question[] 
  mastery   MasteryTracking[]
  createdAt DateTime          @default(now())

  @@index([chapterId])
}

model Question {
  id            String     @id @default(uuid())
  content       String // Markdown or HTML
  options       String // JSON string
  correctOption Int
  explanation   String?
  rightFeedback String?
  wrongFeedback String?
  difficulty    String // "EASY", "MEDIUM", "HARD"
  
  // Link to either Subtopic (old) or Level (new). 
  // For new structure, we prefer linking to Level directly or via Subtopic if Level is subset of Subtopic (unlikely).
  // Strategy: We can keep subtopicId nullable or just use it as a grouper.
  // BUT the prompt says "Each Chapter -> 5 Levels". 
  // Questions are distributed 5 Easy, 3 Medium, 2 Hard per Quiz. 
  // It implies Questions belong to a Level? Or Questions belong to a Chapter and are tagged by Difficulty?
  // "Each Quiz: 10 Questions ... 5 Easy, 3 Medium, 2 Hard".
  // This implies questions are likely pooled at Chapter or Level.
  // Let's attach questions to Level to be explicit, OR keep attaching to Subtopic (which belongs to Chapter) and filter by Difficulty.
  // To support "Diagnostic", "Beginner", etc., maybe the Level itself is just a container for the user's progress, 
  // and questions are pulled from the Chapter pool based on difficulty?
  // User Prompt: "Each Chapter -> 5 Levels ... Each Quiz -> 10 Questions (5E, 3M, 2H)".
  // This suggests the "Level" is a user progression state, NOT necessarily a bucket of questions (unless questions are specifically "Beginner Questions").
  // However, usually questions are tagged by difficulty.
  // Let's link Question to Subtopic (content grouping) AND likely Level (if specific).
  // For now, I'll keep subtopicId as the primary content organizer.
  subtopicId    String?
  subtopic      Subtopic?  @relation(fields: [subtopicId], references: [id])
  
  levelId       String?    // If we want to assign questions specifically to a standard/level
  level         Level?     @relation(fields: [levelId], references: [id])

  attempts      Attempt[]
  createdAt     DateTime   @default(now())

  @@index([subtopicId])
  @@index([levelId])
  @@index([difficulty])
}

model QuizSession {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  levelId     String
  level       Level     @relation(fields: [levelId], references: [id])
  score       Float
  startTime   DateTime  @default(now())
  endTime     DateTime?
  timeSpent   Int       @default(0) // Total time in seconds
  status      String    // "IN_PROGRESS", "COMPLETED", "ABORTED"
  tabSwitches Int       @default(0)
  isFlagged   Boolean   @default(false)
  aiFeedback  String?   // AI generated feedback on the session
  recommendations String? // AI generated recommendations (youtube links, subtopics)
  
  attempts    Attempt[] // detailed attempts in this session
  createdAt   DateTime  @default(now())
}

model Attempt {
  id            String       @id @default(uuid())
  userId        String
  user          User         @relation(fields: [userId], references: [id])
  quizSessionId String?
  quizSession   QuizSession? @relation(fields: [quizSessionId], references: [id])
  questionId    String
  question      Question     @relation(fields: [questionId], references: [id])
  isCorrect     Boolean
  timeTaken     Int // in seconds
  createdAt     DateTime     @default(now())

  @@index([userId])
  @@index([questionId])
}

model MasteryTracking {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  subtopicId  String
  subtopic    Subtopic @relation(fields: [subtopicId], references: [id])
  masteryLevel Float    @default(0.0) // 0 to 100
  lastTested  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, subtopicId])
  @@index([userId])
}

model TimeTracking {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  subjectId String
  subject   Subject  @relation(fields: [subjectId], references: [id])
  minutes   Int      @default(0)
  date      DateTime @default(now()) // To track daily usage
  
  @@index([userId, subjectId])
}

model AnalyticsLog {
  id        String   @id @default(uuid())
  userId    String 
  action    String
  metadata  String?
  createdAt DateTime @default(now())
}

model XpLog {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  amount    Int
  reason    String
  createdAt DateTime @default(now())

  @@index([userId])
}

model Badge {
  id          String      @id @default(uuid())
  name        String
  description String
  iconUrl     String?
  users       UserBadge[]
  createdAt   DateTime    @default(now())
}

model UserBadge {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  badgeId   String
  badge     Badge    @relation(fields: [badgeId], references: [id])
  awardedAt DateTime @default(now())

  @@unique([userId, badgeId])
}

model MockTest {
  id        String        @id @default(uuid())
  title     String
  startTime DateTime
  duration  Int // in minutes
  questions String // Array of IDs
  attempts  MockAttempt[]
  createdAt DateTime      @default(now())
}

model MockAttempt {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  mockTestId String
  mockTest   MockTest @relation(fields: [mockTestId], references: [id])
  score      Int
  rank       Int?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([mockTestId])
}

model ForumPost {
  id        String      @id @default(uuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id])
  subjectId String?
  subject   Subject?    @relation(fields: [subjectId], references: [id])
  title     String
  content   String
  fileUrl   String?
  upvotes   Int         @default(0)
  parentId  String? // For replies
  parent    ForumPost?  @relation("PostReplies", fields: [parentId], references: [id])
  replies   ForumPost[] @relation("PostReplies")
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@index([userId])
  @@index([subjectId])
}

model FlaggedAttempt {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  reason    String
  details   String?
  createdAt DateTime @default(now())
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  title     String
  message   String
  type      String   // "REMINDER", "STREAK", "NUDGE", "INFO"
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
}

model Mentor {
  id             String         @id @default(uuid())
  name           String
  email          String         @unique
  profilePicture String?
  youtubeChannel String?
  boards         String         // JSON array: ["CBSE","Maharashtra State Board"]
  languages      String         // JSON array: ["English","Hindi","Marathi"]
  standards      String         // JSON array: ["8","9","10"]
  playlists      String?        // JSON array: [{"title": "Science 10th", "url": "https://youtube.com/..."}]
  bio            String?
  isActive       Boolean        @default(true)
  ratings        MentorRating[]
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

model MentorRating {
  id        String   @id @default(uuid())
  mentorId  String
  mentor    Mentor   @relation(fields: [mentorId], references: [id], onDelete: Cascade)
  userId    String
  rating    Int      // 1â€“5
  comment   String?
  createdAt DateTime @default(now())

  @@unique([mentorId, userId])
  @@index([mentorId])
}
