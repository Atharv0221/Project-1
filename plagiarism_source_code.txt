PROJECT SOURCE CODE COMPILATION FOR PLAGIARISM CHECK
========================================================



/*******************************************************************************
 * FILE: client/src/app/admin/page.tsx
 *******************************************************************************/

'use client';

import { useState, useEffect } from 'react';
import {
    ShieldCheck, Users, MessageSquare, HelpCircle, CheckCircle2,
    Search, RefreshCcw, UserPlus, UserMinus, ChevronRight, Loader2,
    BarChart3, GraduationCap, Plus, Trash2, Mail, Youtube, Edit2, X
} from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import ReactCrop, { Crop, PixelCrop, centerCrop, makeAspectCrop } from 'react-image-crop';
import 'react-image-crop/dist/ReactCrop.css';
import Sidebar from '@/components/layout/Sidebar';
import Header from '@/components/layout/Header';
import { getAdminStats, getAllUsers, updateUserRole } from '@/services/adminService';
import { getMentors, createMentor, deleteMentor, updateMentor, Mentor } from '@/services/mentorService';
import { useAuthStore } from '@/store/authStore';
import { useRouter } from 'next/navigation';

const BOARDS_OPT = ['CBSE', 'ICSE', 'Maharashtra State Board', 'Gujarat Board', 'UP Board'];
const LANG_OPT = ['English', 'Hindi', 'Marathi'];
const STD_OPT = ['8', '9', '10'];

function MultiSelect({ options, value, onChange, placeholder }: { options: string[]; value: string[]; onChange: (v: string[]) => void; placeholder: string }) {
    const toggle = (o: string) => onChange(value.includes(o) ? value.filter(x => x !== o) : [...value, o]);
    return (
        <div className="flex flex-wrap gap-2 p-2 bg-[#0B1120] border border-gray-700 rounded-xl min-h-[44px]">
            {value.map(v => (
                <span key={v} className="flex items-center gap-1 px-2 py-0.5 bg-cyan-500/20 text-cyan-400 rounded-full text-xs font-bold">
                    {v}
                    <button onClick={() => toggle(v)} className="hover:text-red-400"><X size={10} /></button>
                </span>
            ))}
            <div className="relative flex-1">
                <select
                    onChange={e => { if (e.target.value) toggle(e.target.value); e.target.value = ''; }}
                    className="appearance-none bg-transparent text-gray-500 text-xs cursor-pointer focus:outline-none w-full"
                    defaultValue=""
                >
                    <option value="" disabled>{value.length === 0 ? placeholder : 'Add more...'}</option>
                    {options.filter(o => !value.includes(o)).map(o => <option key={o} value={o}>{o}</option>)}
                </select>
            </div>
        </div>
    );
}

const getProfilePicUrl = (path: string) => {
    const baseUrl = (process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000/api').replace('/api', '');
    return `${baseUrl}${path.startsWith('/') ? '' : '/'}${path}`;
};

const EMPTY_FORM = { name: '', email: '', youtubeChannel: '', boards: [] as string[], languages: [] as string[], standards: [] as string[], bio: '', profilePicture: null as File | null };

export default function AdminDashboard() {
    const { user } = useAuthStore();
    const router = useRouter();
    const [activeTab, setActiveTab] = useState<'users' | 'mentors'>('users');
    const [stats, setStats] = useState<any>(null);
    const [users, setUsers] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);
    const [searchQuery, setSearchQuery] = useState('');
    const [updatingUserId, setUpdatingUserId] = useState<string | null>(null);
    // Mentor State
    const [mentors, setMentors] = useState<Mentor[]>([]);
    const [mentorLoading, setMentorLoading] = useState(false);
    const [showAddMentor, setShowAddMentor] = useState(false);
    const [mentorForm, setMentorForm] = useState(EMPTY_FORM);
    const [savingMentor, setSavingMentor] = useState(false);
    const [mentorError, setMentorError] = useState('');
    const [editingMentor, setEditingMentor] = useState<Mentor | null>(null);

    // Image Crop State
    const [cropModalOpen, setCropModalOpen] = useState(false);
    const [imgSrc, setImgSrc] = useState('');
    const [crop, setCrop] = useState<Crop>();
    const [completedCrop, setCompletedCrop] = useState<PixelCrop | null>(null);
    const [imageRef, setImageRef] = useState<HTMLImageElement | null>(null);
    const [croppedPreviewUrl, setCroppedPreviewUrl] = useState<string | null>(null);

    useEffect(() => {
        if (user && user.role !== 'ADMIN') { router.push('/dashboard'); return; }
        fetchData();
    }, [user]);

    const fetchData = async () => {
        setLoading(true);
        try {
            const [statsData, usersData] = await Promise.all([getAdminStats(), getAllUsers()]);
            setStats(statsData);
            setUsers(usersData);
        } catch (error) {
            console.error('Failed to fetch admin data:', error);
        } finally {
            setLoading(false);
        }
    };

    const fetchMentors = async () => {
        setMentorLoading(true);
        try { setMentors(await getMentors()); }
        catch (e) { console.error(e); }
        finally { setMentorLoading(false); }
    };

    useEffect(() => { if (activeTab === 'mentors') fetchMentors(); }, [activeTab]);

    const handleToggleRole = async (targetUser: any) => {
        const newRole = targetUser.role === 'ADMIN' ? 'STUDENT' : 'ADMIN';
        setUpdatingUserId(targetUser.id);
        try {
            await updateUserRole(targetUser.id, newRole);
            setUsers(users.map(u => u.id === targetUser.id ? { ...u, role: newRole } : u));
        } catch (error) {
            console.error('Failed to update user role:', error);
            alert('Failed to update role');
        } finally { setUpdatingUserId(null); }
    };

    function onSelectFile(e: React.ChangeEvent<HTMLInputElement>) {
        if (e.target.files && e.target.files.length > 0) {
            setCrop(undefined); // Reset crop state
            const reader = new FileReader();
            reader.addEventListener('load', () => {
                setImgSrc(reader.result?.toString() || '');
                setCropModalOpen(true);
            });
            reader.readAsDataURL(e.target.files[0]);
            e.target.value = ''; // Reset input so same file can be selected again
        }
    }

    function onImageLoad(e: React.SyntheticEvent<HTMLImageElement>) {
        const { width, height } = e.currentTarget;
        setImageRef(e.currentTarget);
        const crop = centerCrop(
            makeAspectCrop({ unit: '%', width: 90 }, 1, width, height),
            width,
            height
        );
        setCrop(crop);
    }

    const generateCroppedImage = async () => {
        if (!completedCrop || !imageRef) return;

        const canvas = document.createElement('canvas');
        const scaleX = imageRef.naturalWidth / imageRef.width;
        const scaleY = imageRef.naturalHeight / imageRef.height;
        canvas.width = completedCrop.width;
        canvas.height = completedCrop.height;
        const ctx = canvas.getContext('2d');
        if (!ctx) return;

        ctx.drawImage(
            imageRef,
            completedCrop.x * scaleX,
            completedCrop.y * scaleY,
            completedCrop.width * scaleX,
            completedCrop.height * scaleY,
            0,
            0,
            completedCrop.width,
            completedCrop.height
        );

        canvas.toBlob((blob) => {
            if (!blob) return;
            const file = new File([blob], 'profile_picture.jpg', { type: 'image/jpeg' });
            setMentorForm((prev) => ({ ...prev, profilePicture: file }));
            setCroppedPreviewUrl(URL.createObjectURL(blob));
            setCropModalOpen(false);
        }, 'image/jpeg');
    };

    const handleSaveMentor = async () => {
        if (!mentorForm.name || !mentorForm.email || !mentorForm.boards.length || !mentorForm.languages.length || !mentorForm.standards.length) {
            setMentorError('Name, email, board, language and standard are required.'); return;
        }
        setSavingMentor(true); setMentorError('');
        try {
            const formData = new FormData();
            formData.append('name', mentorForm.name);
            formData.append('email', mentorForm.email);
            if (mentorForm.youtubeChannel) formData.append('youtubeChannel', mentorForm.youtubeChannel);
            if (mentorForm.bio) formData.append('bio', mentorForm.bio);
            mentorForm.boards.forEach(b => formData.append('boards', b));
            mentorForm.languages.forEach(l => formData.append('languages', l));
            mentorForm.standards.forEach(s => formData.append('standards', s));
            if (mentorForm.profilePicture) {
                formData.append('profilePicture', mentorForm.profilePicture);
            }

            if (editingMentor) {
                formData.append('isActive', editingMentor.isActive ? 'true' : 'false');
                const updated = await updateMentor(editingMentor.id, formData);
                setMentors(mentors.map(m => m.id === editingMentor.id ? updated : m));
            } else {
                const newMentor = await createMentor(formData as unknown as any); // Type assertion for compatibility
                setMentors([newMentor, ...mentors]);
            }
            setShowAddMentor(false); setMentorForm(EMPTY_FORM); setEditingMentor(null); setCroppedPreviewUrl(null);
        } catch (e: any) {
            setMentorError(e.message || 'Failed to save mentor.');
        } finally { setSavingMentor(false); }
    };

    const handleDeleteMentor = async (id: string) => {
        if (!confirm('Delete this mentor?')) return;
        try { await deleteMentor(id); setMentors(mentors.filter(m => m.id !== id)); }
        catch (e) { alert('Failed to delete.'); }
    };

    const filteredUsers = users.filter(u =>
        u.name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        u.email?.toLowerCase().includes(searchQuery.toLowerCase())
    );

    if (!user || user.role !== 'ADMIN') return null;

    return (
        <div className="min-h-screen bg-[#0B1120] text-white">
            <Sidebar />
            <Header />
            <main className="ml-0 lg:ml-64 pt-20 p-8 transition-all relative">
                <div className="absolute inset-0 pointer-events-none overflow-hidden">
                    <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-cyan-500/10 blur-[120px] rounded-full animate-pulse" />
                    <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-purple-500/10 blur-[120px] rounded-full animate-pulse delay-1000" />
                </div>
                <div className="max-w-7xl mx-auto relative z-10">
                    {/* Page Header */}
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                        <div>
                            <div className="inline-flex items-center gap-2 px-4 py-2 bg-cyan-500/10 border border-cyan-500/20 rounded-full text-cyan-400 text-sm font-bold mb-4">
                                <ShieldCheck size={16} />ADMIN CONTROL CENTER
                            </div>
                            <h1 className="text-4xl md:text-5xl font-black mb-2 tracking-tight">System Overview</h1>
                            <p className="text-gray-400">Manage users, mentors, and platform settings.</p>
                        </div>
                        <button onClick={fetchData} className="bg-[#151B2D] border border-gray-800 p-3 rounded-2xl hover:border-cyan-500/50 transition-all flex items-center gap-2 group">
                            <RefreshCcw size={18} className={`text-gray-400 group-hover:text-cyan-400 ${loading ? 'animate-spin' : ''}`} />
                            <span className="text-sm font-bold">Refresh</span>
                        </button>
                    </div>

                    {/* Stats */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <StatCard icon={Users} label="Total Students" value={stats?.users || 0} color="cyan" loading={loading} />
                        <StatCard icon={MessageSquare} label="Forum Posts" value={stats?.posts || 0} color="purple" loading={loading} />
                        <StatCard icon={HelpCircle} label="Total Questions" value={stats?.questions || 0} color="orange" loading={loading} />
                        <StatCard icon={CheckCircle2} label="Quiz Attempts" value={stats?.attempts || 0} color="emerald" loading={loading} />
                    </div>

                    {/* Tabs */}
                    <div className="flex gap-2 mb-6">
                        <button onClick={() => setActiveTab('users')} className={`px-5 py-2.5 rounded-xl font-bold text-sm transition-all flex items-center gap-2 ${activeTab === 'users' ? 'bg-cyan-500 text-black' : 'bg-[#151B2D] text-gray-400 hover:text-white border border-gray-800'}`}>
                            <Users size={16} />User Management
                        </button>
                        <button onClick={() => setActiveTab('mentors')} className={`px-5 py-2.5 rounded-xl font-bold text-sm transition-all flex items-center gap-2 ${activeTab === 'mentors' ? 'bg-cyan-500 text-black' : 'bg-[#151B2D] text-gray-400 hover:text-white border border-gray-800'}`}>
                            <GraduationCap size={16} />Mentors
                        </button>
                    </div>

                    {/* Users Tab */}
                    {activeTab === 'users' && (
                        <div className="bg-[#151B2D] border border-gray-800 rounded-3xl overflow-hidden mb-12">
                            <div className="p-8 border-b border-gray-800 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                                <div className="flex items-center gap-4">
                                    <div className="w-12 h-12 bg-cyan-500/10 rounded-2xl flex items-center justify-center"><Users className="text-cyan-400" /></div>
                                    <div><h2 className="text-2xl font-bold">User Management</h2><p className="text-sm text-gray-500">Manage roles and view user activity stats.</p></div>
                                </div>
                                <div className="relative w-full md:w-96">
                                    <Search size={20} className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500" />
                                    <input type="text" placeholder="Search by name or email..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)}
                                        className="w-full bg-[#0B1120] border border-gray-700 rounded-2xl py-3 pl-12 pr-4 focus:border-cyan-500/50 focus:outline-none transition-all text-sm" />
                                </div>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead className="bg-[#0B1120]/50 text-gray-400 text-xs font-bold uppercase tracking-widest">
                                        <tr><th className="px-8 py-4">User</th><th className="px-8 py-4">Role</th><th className="px-8 py-4">Joined</th><th className="px-8 py-4 text-right">Actions</th></tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-800">
                                        {loading ? ([...Array(5)].map((_, i) => (
                                            <tr key={i} className="animate-pulse">
                                                <td className="px-8 py-6"><div className="h-10 bg-gray-800 rounded-xl w-48" /></td>
                                                <td className="px-8 py-6"><div className="h-6 bg-gray-800 rounded-lg w-20" /></td>
                                                <td className="px-8 py-6"><div className="h-6 bg-gray-800 rounded-lg w-24" /></td>
                                                <td className="px-8 py-6 text-right"><div className="h-10 bg-gray-800 rounded-xl w-32 ml-auto" /></td>
                                            </tr>
                                        ))) : filteredUsers.length > 0 ? (
                                            filteredUsers.map(u => (
                                                <tr key={u.id} className="hover:bg-white/5 transition-colors">
                                                    <td className="px-8 py-6">
                                                        <div className="flex items-center gap-4">
                                                            <div className="w-10 h-10 rounded-full bg-gradient-to-tr from-cyan-600 to-blue-600 flex items-center justify-center font-bold text-white">{u.name?.[0]?.toUpperCase() || 'U'}</div>
                                                            <div><div className="font-bold text-white">{u.name}</div><div className="text-xs text-gray-500">{u.email}</div></div>
                                                        </div>
                                                    </td>
                                                    <td className="px-8 py-6">
                                                        <span className={`px-3 py-1 rounded-full text-[10px] font-black tracking-widest uppercase ${u.role === 'ADMIN' ? 'bg-purple-500/20 text-purple-400' : 'bg-gray-800 text-gray-400'}`}>{u.role}</span>
                                                    </td>
                                                    <td className="px-8 py-6 text-sm text-gray-400">{new Date(u.createdAt).toLocaleDateString()}</td>
                                                    <td className="px-8 py-6 text-right">
                                                        <button onClick={() => handleToggleRole(u)} disabled={updatingUserId === u.id || u.email === user.email}
                                                            className={`px-4 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-2 ml-auto ${updatingUserId === u.id ? 'bg-gray-800 text-gray-500 cursor-not-allowed' : u.role === 'ADMIN' ? 'bg-red-500/10 text-red-500 border border-red-500/20 hover:bg-red-500 hover:text-white' : 'bg-cyan-500/10 text-cyan-400 border border-cyan-500/20 hover:bg-cyan-500 hover:text-white'}`}>
                                                            {updatingUserId === u.id ? <Loader2 size={14} className="animate-spin" /> : u.role === 'ADMIN' ? <UserMinus size={14} /> : <UserPlus size={14} />}
                                                            {u.role === 'ADMIN' ? 'Revoke Admin' : 'Make Admin'}
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))
                                        ) : (
                                            <tr><td colSpan={5} className="px-8 py-20 text-center text-gray-500">No users found matching your search.</td></tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* Mentors Tab */}
                    {activeTab === 'mentors' && (
                        <div className="bg-[#151B2D] border border-gray-800 rounded-3xl overflow-hidden mb-12">
                            <div className="p-8 border-b border-gray-800 flex justify-between items-center">
                                <div className="flex items-center gap-4">
                                    <div className="w-12 h-12 bg-cyan-500/10 rounded-2xl flex items-center justify-center"><GraduationCap className="text-cyan-400" /></div>
                                    <div><h2 className="text-2xl font-bold">Mentor Management</h2><p className="text-sm text-gray-500">Add and manage mentor profiles for students.</p></div>
                                </div>
                                <button onClick={() => { setMentorForm(EMPTY_FORM); setEditingMentor(null); setShowAddMentor(true); setMentorError(''); setCroppedPreviewUrl(null); }}
                                    className="flex items-center gap-2 px-5 py-2.5 bg-cyan-500 hover:bg-cyan-400 text-black font-black rounded-xl transition-all">
                                    <Plus size={16} />Add Mentor
                                </button>
                            </div>
                            {mentorLoading ? (
                                <div className="flex justify-center py-16"><Loader2 size={32} className="animate-spin text-cyan-400" /></div>
                            ) : mentors.length === 0 ? (
                                <div className="text-center py-16 text-gray-500"><GraduationCap size={40} className="mx-auto mb-3 text-gray-700" />No mentors added yet.</div>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left">
                                        <thead className="bg-[#0B1120]/50 text-gray-400 text-xs font-bold uppercase tracking-widest">
                                            <tr><th className="px-6 py-4">Mentor</th><th className="px-6 py-4">Boards</th><th className="px-6 py-4">Standards</th><th className="px-6 py-4">Languages</th><th className="px-6 py-4">Rating</th><th className="px-6 py-4 text-right">Actions</th></tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-800">
                                            {mentors.map(m => (
                                                <tr key={m.id} className="hover:bg-white/5 transition-colors">
                                                    <td className="px-6 py-4">
                                                        <div className="flex items-center gap-3">
                                                            {m.profilePicture ? (
                                                                <img src={getProfilePicUrl(m.profilePicture)} alt={m.name} className="w-9 h-9 rounded-xl object-cover" />
                                                            ) : (
                                                                <div className="w-9 h-9 rounded-xl bg-gradient-to-tr from-cyan-600 to-blue-700 flex items-center justify-center text-white font-black text-sm">{m.name[0]}</div>
                                                            )}
                                                            <div><div className="font-bold text-white text-sm">{m.name}</div><div className="text-xs text-gray-500">{m.email}</div></div>
                                                        </div>
                                                    </td>
                                                    <td className="px-6 py-4"><div className="flex flex-wrap gap-1">{m.boards.map(b => <span key={b} className="px-2 py-0.5 bg-purple-500/10 text-purple-400 rounded-full text-xs">{b}</span>)}</div></td>
                                                    <td className="px-6 py-4"><div className="flex flex-wrap gap-1">{m.standards.map(s => <span key={s} className="px-2 py-0.5 bg-cyan-500/10 text-cyan-400 rounded-full text-xs">Std {s}</span>)}</div></td>
                                                    <td className="px-6 py-4"><div className="flex flex-wrap gap-1">{m.languages.map(l => <span key={l} className="px-2 py-0.5 bg-emerald-500/10 text-emerald-400 rounded-full text-xs">{l}</span>)}</div></td>
                                                    <td className="px-6 py-4">{m.avgRating ? <span className="text-yellow-400 font-bold">‚≠ê {m.avgRating}</span> : <span className="text-gray-600 text-xs">No ratings</span>}</td>
                                                    <td className="px-6 py-4 text-right">
                                                        <div className="flex gap-2 justify-end">
                                                            <button onClick={() => { setEditingMentor(m); setMentorForm({ name: m.name, email: m.email, youtubeChannel: m.youtubeChannel || '', boards: m.boards, languages: m.languages, standards: m.standards, bio: m.bio || '', profilePicture: null }); setCroppedPreviewUrl(null); setShowAddMentor(true); setMentorError(''); }}
                                                                className="px-3 py-1.5 rounded-xl text-xs font-bold bg-blue-500/10 text-blue-400 border border-blue-500/20 hover:bg-blue-500 hover:text-white transition-all flex items-center gap-1">
                                                                <Edit2 size={12} />Edit
                                                            </button>
                                                            <button onClick={() => handleDeleteMentor(m.id)}
                                                                className="px-3 py-1.5 rounded-xl text-xs font-bold bg-red-500/10 text-red-500 border border-red-500/20 hover:bg-red-500 hover:text-white transition-all flex items-center gap-1">
                                                                <Trash2 size={12} />Delete
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            </main>

            {/* Add/Edit Mentor Modal */}
            <AnimatePresence>
                {showAddMentor && (
                    <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}
                        className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4"
                        onClick={() => setShowAddMentor(false)}>
                        <motion.div initial={{ scale: 0.9 }} animate={{ scale: 1 }} exit={{ scale: 0.9 }}
                            className="bg-[#0F1729] border border-gray-800 rounded-3xl w-full max-w-lg max-h-[90vh] overflow-y-auto"
                            onClick={e => e.stopPropagation()}>
                            <div className="p-6 border-b border-gray-800 flex justify-between items-center">
                                <h2 className="text-xl font-black">{editingMentor ? 'Edit Mentor' : 'Add New Mentor'}</h2>
                                <button onClick={() => setShowAddMentor(false)} className="text-gray-500 hover:text-white p-2 hover:bg-gray-800 rounded-xl">
                                    <X size={18} />
                                </button>
                            </div>
                            <div className="p-6 space-y-4">
                                <Field label="Full Name *"><input value={mentorForm.name} onChange={e => setMentorForm({ ...mentorForm, name: e.target.value })} placeholder="Dr. Ramesh Sharma" className="w-full bg-[#0B1120] border border-gray-700 rounded-xl p-3 text-white text-sm focus:border-cyan-500/50 focus:outline-none" /></Field>
                                <Field label="Email Address *"><input type="email" value={mentorForm.email} onChange={e => setMentorForm({ ...mentorForm, email: e.target.value })} placeholder="mentor@email.com" className="w-full bg-[#0B1120] border border-gray-700 rounded-xl p-3 text-white text-sm focus:border-cyan-500/50 focus:outline-none" /></Field>
                                <Field label="Profile Picture (optional)">
                                    <div className="flex items-center gap-4">
                                        {(croppedPreviewUrl || (editingMentor && editingMentor.profilePicture)) && (
                                            <img
                                                src={croppedPreviewUrl || getProfilePicUrl(editingMentor!.profilePicture!)}
                                                alt="Preview"
                                                className="w-16 h-16 rounded-full object-cover border-2 border-cyan-500/50"
                                            />
                                        )}
                                        <input type="file" accept="image/jpeg, image/png, image/gif" onChange={onSelectFile} className="w-full bg-[#0B1120] border border-gray-700 rounded-xl p-3 text-white text-sm focus:border-cyan-500/50 focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-500/10 file:text-cyan-400 hover:file:bg-cyan-500/20" />
                                    </div>
                                </Field>
                                <Field label="YouTube Channel (optional)"><input value={mentorForm.youtubeChannel} onChange={e => setMentorForm({ ...mentorForm, youtubeChannel: e.target.value })} placeholder="@channelname" className="w-full bg-[#0B1120] border border-gray-700 rounded-xl p-3 text-white text-sm focus:border-cyan-500/50 focus:outline-none" /></Field>
                                <Field label="Board of Teaching *"><MultiSelect options={BOARDS_OPT} value={mentorForm.boards} onChange={v => setMentorForm({ ...mentorForm, boards: v })} placeholder="Select boards..." /></Field>
                                <Field label="Can Speak In *"><MultiSelect options={LANG_OPT} value={mentorForm.languages} onChange={v => setMentorForm({ ...mentorForm, languages: v })} placeholder="Select languages..." /></Field>
                                <Field label="Can Teach Standards *"><MultiSelect options={STD_OPT} value={mentorForm.standards} onChange={v => setMentorForm({ ...mentorForm, standards: v })} placeholder="Select standards..." /></Field>
                                <Field label="Short Bio (optional)"><textarea value={mentorForm.bio} onChange={e => setMentorForm({ ...mentorForm, bio: e.target.value })} placeholder="Brief background..." rows={3} className="w-full bg-[#0B1120] border border-gray-700 rounded-xl p-3 text-white text-sm focus:border-cyan-500/50 focus:outline-none resize-none" /></Field>
                                {mentorError && <p className="text-red-400 text-sm">{mentorError}</p>}
                                <button onClick={handleSaveMentor} disabled={savingMentor}
                                    className="w-full flex items-center justify-center gap-2 py-3 bg-cyan-500 hover:bg-cyan-400 text-black font-black rounded-xl transition-all disabled:opacity-50">
                                    {savingMentor ? <Loader2 size={16} className="animate-spin" /> : <Plus size={16} />}
                                    {savingMentor ? 'Saving...' : editingMentor ? 'Update Mentor' : 'Add Mentor'}
                                </button>
                            </div>
                        </motion.div>
                    </motion.div>
                )}
            </AnimatePresence>

            {/* Crop Modal */}
            <AnimatePresence>
                {cropModalOpen && (
                    <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}
                        className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[110] flex items-center justify-center p-4"
                        onClick={() => setCropModalOpen(false)}>
                        <motion.div initial={{ scale: 0.9 }} animate={{ scale: 1 }} exit={{ scale: 0.9 }}
                            className="bg-[#0F1729] border border-gray-800 rounded-3xl w-full max-w-lg overflow-hidden flex flex-col"
                            onClick={e => e.stopPropagation()}>
                            <div className="p-4 border-b border-gray-800 flex justify-between items-center bg-[#151B2D]">
                                <h3 className="text-lg font-bold">Crop Profile Picture</h3>
                                <button onClick={() => setCropModalOpen(false)} className="text-gray-500 hover:text-white p-1 hover:bg-gray-800 rounded-lg"><X size={18} /></button>
                            </div>
                            <div className="p-4 flex-1 flex justify-center items-center bg-black/50 overflow-auto max-h-[60vh]">
                                {imgSrc && (
                                    <ReactCrop
                                        crop={crop}
                                        onChange={(_, percentCrop) => setCrop(percentCrop)}
                                        onComplete={(c) => setCompletedCrop(c)}
                                        aspect={1}
                                        circularCrop
                                    >
                                        <img
                                            src={imgSrc}
                                            alt="Crop me"
                                            className="max-h-[50vh] object-contain"
                                            onLoad={onImageLoad}
                                        />
                                    </ReactCrop>
                                )}
                            </div>
                            <div className="p-4 border-t border-gray-800 bg-[#151B2D] flex justify-end gap-2">
                                <button onClick={() => setCropModalOpen(false)} className="px-4 py-2 rounded-xl font-bold text-sm text-gray-400 hover:text-white hover:bg-gray-800 transition-all">Cancel</button>
                                <button onClick={generateCroppedImage} disabled={!completedCrop?.width || !completedCrop?.height} className="px-5 py-2 rounded-xl font-bold text-sm bg-cyan-500 hover:bg-cyan-400 text-black transition-all disabled:opacity-50">Crop & Save</button>
                            </div>
                        </motion.div>
                    </motion.div>
                )}
            </AnimatePresence>
        </div>
    );
}

function Field({ label, children }: { label: string; children: React.ReactNode }) {
    return (
        <div>
            <label className="block text-xs font-bold text-gray-400 mb-1.5 uppercase tracking-wider">{label}</label>
            {children}
        </div>
    );
}

function StatCard({ icon: Icon, label, value, color, loading }: any) {
    const colorClasses: any = {
        cyan: 'text-cyan-400 bg-cyan-500/10',
        purple: 'text-purple-400 bg-purple-500/10',
        orange: 'text-orange-400 bg-orange-500/10',
        emerald: 'text-emerald-400 bg-emerald-500/10',
    };
    return (
        <div className="bg-[#151B2D] border border-gray-800 rounded-3xl p-6 group hover:border-cyan-500/30 transition-all">
            <div className="flex justify-between items-start mb-4">
                <div className={`p-4 rounded-2xl ${colorClasses[color]}`}><Icon size={24} /></div>
                <div className="p-2 bg-gray-800/50 rounded-lg"><BarChart3 size={14} className="text-gray-600" /></div>
            </div>
            {loading ? (<div className="h-8 bg-gray-800 rounded-lg animate-pulse w-24 mb-2" />) : (<div className="text-3xl font-black mb-1 tracking-tight">{value.toLocaleString()}</div>)}
            <div className="text-xs font-bold text-gray-500 uppercase tracking-widest">{label}</div>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/app/ai-mentor/page.tsx
 *******************************************************************************/

'use client';

import { useState, useRef, useEffect } from 'react';
import axios from 'axios';
import { Send, User, Bot, Loader2 } from 'lucide-react';
import Sidebar from '../../components/layout/Sidebar';
import Header from '../../components/layout/Header';
import { useAuthStore } from '../../store/authStore';
import { sendChatMessage } from '../../services/aiService';

export default function AIMentorPage() {
    const { user } = useAuthStore();
    const [messages, setMessages] = useState<{ role: 'user' | 'assistant', content: string }[]>([
        { role: 'assistant', content: "Hi! I'm Yatsya, your AI Mentor. I can help with study plans, explanations, or just motivation. What's on your mind?" }
    ]);
    const [input, setInput] = useState('');
    const [loading, setLoading] = useState(false);
    const messagesEndRef = useRef<HTMLDivElement>(null);

    const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    };

    useEffect(scrollToBottom, [messages]);

    const handleSend = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!input.trim() || loading) return;

        const userMessage = input;
        setInput('');
        setMessages(prev => [...prev, { role: 'user', content: userMessage }]);
        setLoading(true);

        setLoading(true);

        try {
            const botResponseData = await sendChatMessage(userMessage, {
                level: user?.classStandard || 8,
                weakTopics: [], // TODO: Fetch from analytics
            });
            const botResponse = botResponseData.response;
            setMessages(prev => [...prev, { role: 'assistant', content: botResponse }]);
        } catch (error) {
            setMessages(prev => [...prev, { role: 'assistant', content: "Sorry, I'm having trouble connecting right now." }]);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="min-h-screen bg-[#0B1120] text-white">
            <Sidebar />
            <Header />

            <main className="ml-0 lg:ml-64 pt-16 h-screen flex flex-col transition-all">
                <div className="flex-1 overflow-y-auto p-4 md:p-8 space-y-6">
                    {messages.map((msg, idx) => (
                        <div key={idx} className={`flex gap-4 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                            {msg.role === 'assistant' && (
                                <div className="w-8 h-8 rounded-full bg-cyan-500/20 text-cyan-400 flex items-center justify-center border border-cyan-500/50">
                                    <Bot size={16} />
                                </div>
                            )}
                            <div className={`max-w-[80%] rounded-2xl p-4 ${msg.role === 'user'
                                ? 'bg-gradient-to-r from-cyan-600 to-blue-600 text-white rounded-tr-none'
                                : 'bg-[#151B2D] border border-gray-800 text-gray-300 rounded-tl-none'
                                }`}>
                                <p className="whitespace-pre-wrap leading-relaxed text-sm md:text-base">{msg.content}</p>
                            </div>
                            {msg.role === 'user' && (
                                <div className="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white">
                                    <User size={16} />
                                </div>
                            )}
                        </div>
                    ))}
                    {loading && (
                        <div className="flex gap-4">
                            <div className="w-8 h-8 rounded-full bg-cyan-500/20 text-cyan-400 flex items-center justify-center border border-cyan-500/50">
                                <Bot size={16} />
                            </div>
                            <div className="bg-[#151B2D] border border-gray-800 rounded-2xl p-4 rounded-tl-none flex items-center gap-2 text-gray-400">
                                <Loader2 size={16} className="animate-spin" />
                                <span className="text-sm">Yatsya is thinking...</span>
                            </div>
                        </div>
                    )}
                    <div ref={messagesEndRef} />
                </div>

                {/* Input Area */}
                <div className="p-4 md:p-8 bg-[#0B1120] border-t border-gray-800">
                    <form onSubmit={handleSend} className="max-w-4xl mx-auto relative">
                        <input
                            type="text"
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            placeholder="Ask me anything..."
                            className="w-full bg-[#151B2D] border border-gray-700 rounded-full py-4 pl-6 pr-14 text-white focus:outline-none focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 transition-all shadow-lg"
                            disabled={loading}
                        />
                        <button
                            type="submit"
                            disabled={!input.trim() || loading}
                            className="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-gradient-to-r from-cyan-500 to-blue-600 text-white rounded-full disabled:opacity-50 disabled:cursor-not-allowed hover:shadow-[0_0_15px_rgba(6,182,212,0.4)] transition-all"
                        >
                            <Send size={18} />
                        </button>
                    </form>
                    <p className="text-center text-xs text-gray-500 mt-2">Yatsya can make mistakes. Consider checking important information.</p>
                </div>
            </main>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/app/analytics/page.tsx
 *******************************************************************************/

'use client';

import { useState, useEffect } from 'react';
import Sidebar from '../../components/layout/Sidebar';
import Header from '../../components/layout/Header';
import TimeSpentGraph from '../../components/dashboard/TimeSpentGraph';
import DifficultyCompletionGraph from '../../components/dashboard/DifficultyCompletionGraph';
import { getAccuracyTrend, getRankProgression } from '../../services/analyticsService';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } from 'recharts';
import { TrendingUp, Target } from 'lucide-react';

export default function AnalyticsPage() {
    const [accuracyData, setAccuracyData] = useState<any[]>([]);
    const [rankData, setRankData] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        fetchAnalytics();
    }, []);

    const fetchAnalytics = async () => {
        try {
            const [accuracy, rank] = await Promise.all([
                getAccuracyTrend(),
                getRankProgression()
            ]);
            setAccuracyData(accuracy);
            setRankData(rank);
        } catch (error) {
            console.error('Error fetching analytics:', error);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="min-h-screen bg-[#0B1120] text-white">
            <Sidebar />
            <Header />

            <main className="ml-0 lg:ml-64 pt-16 p-8 transition-all">
                <div className="max-w-7xl mx-auto space-y-8">

                    <div className="mb-8">
                        <h1 className="text-3xl font-bold mb-2">Detailed Analytics</h1>
                        <p className="text-gray-400">Track your performance, accuracy, and study habits.</p>
                    </div>

                    {/* Top Row: Time & Difficulty */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div className="h-80">
                            <TimeSpentGraph />
                        </div>
                        <div className="h-80">
                            <DifficultyCompletionGraph />
                        </div>
                    </div>

                    {/* Middle Row: Accuracy Trend */}
                    <div className="bg-[#151B2D] rounded-3xl p-8 border border-gray-800">
                        <div className="flex items-center gap-3 mb-6">
                            <div className="w-10 h-10 bg-cyan-500/10 rounded-lg flex items-center justify-center">
                                <Target className="text-cyan-400" size={20} />
                            </div>
                            <h3 className="font-bold text-white">Accuracy Trend (Last 30 Days)</h3>
                        </div>
                        {loading ? (
                            <div className="h-64 flex items-center justify-center text-gray-400">Loading...</div>
                        ) : (
                            <ResponsiveContainer width="100%" height={300}>
                                <LineChart data={accuracyData}>
                                    <CartesianGrid strokeDasharray="3 3" stroke="#1A2333" />
                                    <XAxis dataKey="date" stroke="#6B7280" />
                                    <YAxis stroke="#6B7280" />
                                    <Tooltip
                                        contentStyle={{ backgroundColor: '#1A2333', border: '1px solid #374151', borderRadius: '8px' }}
                                        labelStyle={{ color: '#9CA3AF' }}
                                    />
                                    <Legend />
                                    <Line type="monotone" dataKey="accuracy" stroke="#06B6D4" strokeWidth={3} dot={{ fill: '#06B6D4', r: 4 }} />
                                </LineChart>
                            </ResponsiveContainer>
                        )}
                    </div>

                    {/* Rank Progression */}
                    <div className="bg-[#151B2D] rounded-3xl p-8 border border-gray-800">
                        <div className="flex items-center gap-3 mb-6">
                            <div className="w-10 h-10 bg-purple-500/10 rounded-lg flex items-center justify-center">
                                <TrendingUp className="text-purple-400" size={20} />
                            </div>
                            <h3 className="font-bold text-white">Rank Score Progression</h3>
                        </div>
                        {loading ? (
                            <div className="h-64 flex items-center justify-center text-gray-400">Loading...</div>
                        ) : (
                            <ResponsiveContainer width="100%" height={300}>
                                <LineChart data={rankData}>
                                    <CartesianGrid strokeDasharray="3 3" stroke="#1A2333" />
                                    <XAxis dataKey="date" stroke="#6B7280" />
                                    <YAxis stroke="#6B7280" />
                                    <Tooltip
                                        contentStyle={{ backgroundColor: '#1A2333', border: '1px solid #374151', borderRadius: '8px' }}
                                        labelStyle={{ color: '#9CA3AF' }}
                                    />
                                    <Legend />
                                    <Line type="monotone" dataKey="rankScore" stroke="#A855F7" strokeWidth={3} dot={{ fill: '#A855F7', r: 4 }} />
                                </LineChart>
                            </ResponsiveContainer>
                        )}
                    </div>

                </div>
            </main>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/app/dashboard/page.tsx
 *******************************************************************************/

'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { useAuthStore } from '../../store/authStore';
import { getQuizReports } from '../../services/quizService';
import { FileText, ChevronRight, Mail, X, Loader2, CheckCircle } from 'lucide-react';
import Link from 'next/link';

// Components
import Sidebar from '../../components/layout/Sidebar';
import Header from '../../components/layout/Header';
import WelcomeBanner from '../../components/dashboard/WelcomeBanner';
import DailyPlan from '../../components/dashboard/DailyPlan';
import ScholarStatus from '../../components/dashboard/ScholarStatus';
import TimeSpentGraph from '../../components/dashboard/TimeSpentGraph';
import DifficultyCompletionGraph from '../../components/dashboard/DifficultyCompletionGraph';
import DailyStreak from '../../components/dashboard/DailyStreak';

export default function DashboardPage() {
    const { user, isAuthenticated } = useAuthStore();
    const router = useRouter();
    const [reports, setReports] = useState<any[]>([]);
    const [loadingReports, setLoadingReports] = useState(true);
    const [showVerifyBanner, setShowVerifyBanner] = useState(true);
    const [resending, setResending] = useState(false);
    const [resendMsg, setResendMsg] = useState('');

    useEffect(() => {
        if (!isAuthenticated) {
            router.push('/login');
            return;
        }

        // Sync profile data from server to ensure dashboard metrics (streak, xp) are fresh
        const syncProfile = async () => {
            try {
                const { getProfile } = await import('../../services/profileService');
                const data = await getProfile();
                if (data) {
                    const token = useAuthStore.getState().token;
                    useAuthStore.getState().login(data, token!);
                }
            } catch (error) {
                console.error('Failed to sync profile on dashboard:', error);
            }
        };

        const fetchReports = async () => {
            const token = useAuthStore.getState().token;
            if (!token) {
                setLoadingReports(false);
                return;
            }

            try {
                const data = await getQuizReports();
                setReports(data || []);
            } catch (error: any) {
                if (error.response?.status !== 401) {
                    console.error('Failed to fetch reports:', error);
                }
            } finally {
                setLoadingReports(false);
            }
        };

        syncProfile();
        fetchReports();
    }, [isAuthenticated, router]);

    if (!user) return null;

    const handleResend = async () => {
        setResending(true);
        try {
            await fetch('http://localhost:5000/api/auth/resend-verification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: user.email })
            });
            setResendMsg('‚úÖ Verification email sent! Check your inbox.');
        } catch { setResendMsg('Failed to send. Try again.'); }
        finally { setResending(false); }
    };

    return (
        <div className="min-h-screen bg-[#0B1120] text-white">
            <Sidebar />
            <Header />

            {/* Email Verification Banner */}
            {user.emailVerified === false && showVerifyBanner && (
                <div className="fixed top-16 left-0 lg:left-64 right-0 z-40 flex items-center justify-between gap-4 px-6 py-3 bg-amber-500/10 border-b border-amber-500/30 backdrop-blur-sm">
                    <div className="flex items-center gap-3 text-sm">
                        <Mail size={16} className="text-amber-400 flex-shrink-0" />
                        <span className="text-amber-300 font-bold">Verify your email</span>
                        <span className="text-amber-200/70 hidden sm:block">‚Äî Check your inbox for a verification link to confirm <strong>{user.email}</strong></span>
                    </div>
                    <div className="flex items-center gap-3">
                        {resendMsg ? (
                            <span className="text-emerald-400 text-xs font-bold flex items-center gap-1"><CheckCircle size={12} />{resendMsg}</span>
                        ) : (
                            <button onClick={handleResend} disabled={resending}
                                className="text-xs font-bold text-amber-400 border border-amber-500/40 px-3 py-1.5 rounded-lg hover:bg-amber-500 hover:text-black transition-all flex items-center gap-1 disabled:opacity-50">
                                {resending ? <Loader2 size={12} className="animate-spin" /> : <Mail size={12} />}
                                Resend Email
                            </button>
                        )}
                        <button onClick={() => setShowVerifyBanner(false)} className="text-gray-500 hover:text-white p-1">
                            <X size={16} />
                        </button>
                    </div>
                </div>
            )}

            <main className="ml-0 lg:ml-64 pt-16 p-8 transition-all">
                <div className="max-w-7xl mx-auto space-y-8">

                    {/* Top Section: Welcome & Stats */}
                    <div id="stats-section" className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        {/* Left Column (Hero) */}
                        <div className="lg:col-span-2 space-y-8">
                            <WelcomeBanner streak={user.streak} />
                            <DailyPlan />
                        </div>

                        {/* Right Column (Gamification) */}
                        <div className="space-y-8">
                            <ScholarStatus
                                xp={user.xp || 0}
                                rank={0} // Need rank from API
                                streak={user.streak || 0}
                                levelTitle={user.scholarStatus || 'Learner'}
                            />
                            <DailyStreak streak={user.streak} />
                        </div>
                    </div>

                    {/* Bottom Section: Charts */}
                    <div id="analytics-section" className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2 h-80">
                            <TimeSpentGraph />
                        </div>
                        <div className="h-80">
                            <DifficultyCompletionGraph />
                        </div>
                    </div>

                    {/* Quiz Reports Section */}
                    <div id="reports-section" className="bg-[#151B2D] border border-gray-800 rounded-[2.5rem] p-8">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold flex items-center gap-3">
                                <FileText className="text-cyan-400" />
                                Previous Quiz Reports
                            </h2>
                        </div>

                        {loadingReports ? (
                            <div className="flex justify-center py-10">
                                <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-cyan-500"></div>
                            </div>
                        ) : reports.length > 0 ? (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {reports.map((report) => (
                                    <Link
                                        key={report.id}
                                        href={`/quiz/result/${report.id}?data=${encodeURIComponent(JSON.stringify({
                                            score: report.score,
                                            xpEarned: 0, // Not stored in session but can be inferred or left 0
                                            rankScoreEarned: 0,
                                            newStatus: user.scholarStatus,
                                            message: `Report for ${report.level.chapter.name}`,
                                            nextLevelUnlock: '',
                                            aiFeedback: report.aiFeedback,
                                            recommendations: report.recommendations
                                        }))}`}
                                        className="group"
                                    >
                                        <div className="bg-[#1A2333] border border-gray-700/50 p-6 rounded-3xl flex items-center justify-between hover:border-cyan-500/50 transition-all hover:bg-[#1E293B]">
                                            <div className="flex items-center gap-4">
                                                <div className="w-12 h-12 rounded-2xl bg-cyan-500/10 flex items-center justify-center text-cyan-400 font-bold">
                                                    {Math.round(report.score)}%
                                                </div>
                                                <div>
                                                    <h3 className="font-bold text-white group-hover:text-cyan-400 transition-colors">
                                                        {report.level.chapter.name}
                                                    </h3>
                                                    <p className="text-xs text-gray-500 italic">
                                                        {report.level.chapter.subject.name} ‚Ä¢ {report.level.name}
                                                    </p>
                                                </div>
                                            </div>
                                            <ChevronRight className="text-gray-600 group-hover:text-cyan-400 transform group-hover:translate-x-1 transition-all" size={20} />
                                        </div>
                                    </Link>
                                ))}
                            </div>
                        ) : (
                            <div className="text-center py-10 text-gray-500">
                                No quiz reports found. Start a quiz to see your progress!
                            </div>
                        )}
                    </div>

                </div>
            </main>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/app/forum/page.tsx
 *******************************************************************************/

'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { getPosts, createPost } from '../../services/forumService';
import { getSubjects } from '../../services/contentService';
import { MessageSquare, Plus, ThumbsUp, MessageCircle, ArrowLeft, Filter } from 'lucide-react';
import Link from 'next/link';
import { format } from 'timeago.js';

export default function ForumPage() {
    const router = useRouter();
    const [posts, setPosts] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);
    const [showCreate, setShowCreate] = useState(false);
    const [showFilters, setShowFilters] = useState(false);

    // Filter State
    const [filterStandard, setFilterStandard] = useState('');
    const [filterBoard, setFilterBoard] = useState('');
    const [filterSubject, setFilterSubject] = useState('');
    const [sortBy, setSortBy] = useState('newest');
    const [subjects, setSubjects] = useState<any[]>([]);
    const [allSubjects, setAllSubjects] = useState<any[]>([]);

    // Form State
    const [title, setTitle] = useState('');
    const [content, setContent] = useState('');
    const [subjectId, setSubjectId] = useState('');
    const [file, setFile] = useState<File | null>(null);

    useEffect(() => {
        loadPosts();
        // Load all subjects once on mount
        getSubjects().then((data) => {
            setAllSubjects(data);
            setSubjects(data);
        }).catch(console.error);
    }, []);

    // Re-run loadPosts when filters change
    useEffect(() => {
        loadPosts();
    }, [filterStandard, filterBoard, filterSubject, sortBy]);

    useEffect(() => {
        // Filter subjects by selected standard (client-side)
        if (filterStandard) {
            const filtered = allSubjects.filter(
                (s) => String(s.standard) === String(filterStandard)
            );
            setSubjects(filtered.length > 0 ? filtered : allSubjects);
        } else {
            setSubjects(allSubjects);
        }
        setFilterSubject(''); // reset subject when standard changes
    }, [filterStandard, allSubjects]);

    const loadPosts = async () => {
        setLoading(true);
        try {
            const filters = {
                standard: filterStandard,
                board: filterBoard,
                subjectId: filterSubject,
                sortBy
            };
            const data = await getPosts(filters);
            setPosts(data);
        } catch (error) {
            console.error(error);
        } finally {
            setLoading(false);
        }
    };

    const handleCreate = async (e: React.FormEvent) => {
        e.preventDefault();
        try {
            const formData = new FormData();
            formData.append('title', title);
            formData.append('content', content);
            if (subjectId) formData.append('subjectId', subjectId);
            if (file) formData.append('file', file);

            await createPost(formData);
            setShowCreate(false);
            setTitle('');
            setContent('');
            setFile(null);
            loadPosts();
        } catch (error: any) {
            const msg = error?.response?.data?.message || 'Failed to create post';
            alert(msg);
        }
    };

    return (
        <div className="min-h-screen bg-[#0B1120] text-white p-8 pt-24 pl-0 lg:pl-72">
            <div className="max-w-5xl mx-auto">
                <Link href="/dashboard" className="inline-flex items-center gap-2 text-gray-400 hover:text-cyan-400 mb-6 transition-colors">
                    <ArrowLeft size={18} />
                    Back to Dashboard
                </Link>

                {/* Header */}
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                    <div>
                        <h1 className="text-3xl font-bold">Community Forum</h1>
                        <p className="text-gray-400">Discuss topics, ask questions, and share knowledge.</p>
                    </div>
                    <div className="flex gap-3">
                        <button
                            onClick={() => setShowFilters(!showFilters)}
                            className={`px-4 py-3 rounded-xl font-bold flex items-center gap-2 border transition-all ${showFilters ? 'bg-cyan-500/10 border-cyan-500 text-cyan-400' : 'bg-[#151B2D] border-gray-700 text-gray-400 hover:text-white'}`}
                        >
                            <Filter size={20} />
                            Filters
                        </button>
                        <button
                            onClick={() => setShowCreate(true)}
                            className="px-6 py-3 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-xl font-bold flex items-center gap-2 hover:shadow-[0_0_20px_rgba(6,182,212,0.4)] transition-all"
                        >
                            <Plus size={20} />
                            New Post
                        </button>
                    </div>
                </div>

                {/* Filters Section */}
                {showFilters && (
                    <div className="bg-[#151B2D] border border-gray-700 rounded-2xl p-6 mb-8 grid grid-cols-1 md:grid-cols-4 gap-4 animate-in fade-in slide-in-from-top-4">
                        <div>
                            <label className="text-xs text-gray-500 block mb-1">Standard</label>
                            <select
                                value={filterStandard}
                                onChange={(e) => setFilterStandard(e.target.value)}
                                className="w-full bg-[#0B1120] border border-gray-700 rounded-xl p-3 text-sm focus:border-cyan-500 outline-none"
                            >
                                <option value="">All Standards</option>
                                <option value="8">8th Standard</option>
                                <option value="9">9th Standard</option>
                                <option value="10">10th Standard</option>
                            </select>
                        </div>
                        <div>
                            <label className="text-xs text-gray-500 block mb-1">Board</label>
                            <select
                                value={filterBoard}
                                onChange={(e) => setFilterBoard(e.target.value)}
                                className="w-full bg-[#0B1120] border border-gray-700 rounded-xl p-3 text-sm focus:border-cyan-500 outline-none"
                            >
                                <option value="">All Boards</option>
                                <option value="Maharashtra State Board">Maharashtra State Board</option>
                                <option value="CBSE">CBSE</option>
                                <option value="ICSE">ICSE</option>
                            </select>
                        </div>
                        <div>
                            <label className="text-xs text-gray-500 block mb-1">Subject</label>
                            <select
                                value={filterSubject}
                                onChange={(e) => setFilterSubject(e.target.value)}
                                className="w-full bg-[#0B1120] border border-gray-700 rounded-xl p-3 text-sm focus:border-cyan-500 outline-none"
                            >
                                <option value="">All Subjects</option>
                                {subjects.map(sub => (
                                    <option key={sub.id} value={sub.id}>{sub.name}</option>
                                ))}
                            </select>
                        </div>
                        <div>
                            <label className="text-xs text-gray-500 block mb-1">Sort By</label>
                            <select
                                value={sortBy}
                                onChange={(e) => setSortBy(e.target.value)}
                                className="w-full bg-[#0B1120] border border-gray-700 rounded-xl p-3 text-sm focus:border-cyan-500 outline-none"
                            >
                                <option value="newest">Newest First</option>
                                <option value="oldest">Oldest First</option>
                                <option value="popular">Most Popular</option>
                            </select>
                        </div>
                    </div>
                )}

                {/* Posts List */}
                {loading ? (
                    <div className="text-center py-20 text-gray-500">Loading discussions...</div>
                ) : (
                    <div className="space-y-4">
                        {posts.map((post) => (
                            <div key={post.id} className="block group cursor-pointer" onClick={() => router.push(`/forum/${post.id}`)}>
                                <div className="bg-[#151B2D] border border-gray-800 rounded-2xl p-6 transition-all group-hover:border-cyan-500/50 group-hover:bg-[#1A2333]">
                                    <div className="flex gap-4">
                                        {/* Avatar */}
                                        <div className="w-10 h-10 rounded-full bg-gray-700 overflow-hidden flex-shrink-0">
                                            {post.user?.profilePhoto ? (
                                                <img src={post.user.profilePhoto} className="w-full h-full object-cover" />
                                            ) : (
                                                <div className="w-full h-full flex items-center justify-center text-xs font-bold text-gray-400">
                                                    {post.user?.name?.charAt(0) || 'U'}
                                                </div>
                                            )}
                                        </div>

                                        <div className="flex-1">
                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <h3 className="font-bold text-lg text-white group-hover:text-cyan-400 transition-colors">{post.title}</h3>
                                                    <div className="flex items-center gap-2 text-xs text-gray-500">
                                                        <span>{post.user?.name || 'Unknown User'}</span>
                                                        <span>‚Ä¢</span>
                                                        <span>{format(post.createdAt)}</span>
                                                        {post.subject && (
                                                            <>
                                                                <span>‚Ä¢</span>
                                                                <span className="px-2 py-0.5 bg-blue-500/10 text-blue-400 rounded-full border border-blue-500/20">{post.subject.name}</span>
                                                            </>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>

                                            <p className="text-gray-400 text-sm line-clamp-2 mb-4">{post.content}</p>

                                            {post.fileUrl && (
                                                <div className="mb-4">
                                                    {post.fileUrl.match(/\.(jpeg|jpg|png|gif)$/i) ? (
                                                        <img src={`${process.env.NEXT_PUBLIC_API_URL ? process.env.NEXT_PUBLIC_API_URL.replace('/api', '') : 'http://localhost:5000'}${post.fileUrl}`} className="max-h-64 rounded-xl border border-gray-700" alt="Attachment" />
                                                    ) : (
                                                        <a
                                                            href={`${process.env.NEXT_PUBLIC_API_URL ? process.env.NEXT_PUBLIC_API_URL.replace('/api', '') : 'http://localhost:5000'}${post.fileUrl}`}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            className="flex items-center gap-2 p-3 bg-[#1A2333] border border-gray-700 rounded-xl text-cyan-400 hover:text-cyan-300 transition-colors w-max"
                                                            onClick={(e) => e.stopPropagation()}
                                                        >
                                                            <div className="w-8 h-8 bg-red-500/10 rounded flex items-center justify-center text-red-500">
                                                                PDF
                                                            </div>
                                                            <span className="text-sm font-medium">View Attachment</span>
                                                        </a>
                                                    )}
                                                </div>
                                            )}

                                            <div className="flex gap-6 text-sm text-gray-500">
                                                <div className="flex items-center gap-1">
                                                    <ThumbsUp size={16} />
                                                    <span>{post.upvotes}</span>
                                                </div>
                                                <div className="flex items-center gap-1 group-hover:text-cyan-400">
                                                    <MessageCircle size={16} />
                                                    <span>{post._count?.replies || 0} Replies</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}

                        {posts.length === 0 && (
                            <div className="text-center py-20 bg-[#151B2D] rounded-3xl border border-gray-800">
                                <MessageSquare size={40} className="mx-auto text-gray-600 mb-4" />
                                <h3 className="text-xl font-bold text-gray-400">No discussions yet</h3>
                                <p className="text-gray-600">Be the first to start a conversation!</p>
                            </div>
                        )}
                    </div>
                )}

                {/* Create Modal */}
                {showCreate && (
                    <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm p-4">
                        <div className="bg-[#151B2D] p-8 rounded-3xl border border-gray-700 w-full max-w-2xl shadow-2xl">
                            <h2 className="text-2xl font-bold mb-6">Create New Post</h2>
                            <form onSubmit={handleCreate} className="space-y-4">
                                <div>
                                    <label className="block text-sm text-gray-400 mb-1">Title</label>
                                    <input
                                        type="text"
                                        value={title}
                                        onChange={(e) => setTitle(e.target.value)}
                                        className="w-full bg-[#0B1120] border border-gray-700 rounded-xl p-3 text-white focus:outline-none focus:border-cyan-500"
                                        placeholder="What's on your mind?"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm text-gray-400 mb-1">Content</label>
                                    <textarea
                                        value={content}
                                        onChange={(e) => setContent(e.target.value)}
                                        className="w-full h-32 bg-[#0B1120] border border-gray-700 rounded-xl p-3 text-white focus:outline-none focus:border-cyan-500"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm text-gray-400 mb-1">Attachment (Image or PDF)</label>
                                    <input
                                        type="file"
                                        onChange={(e) => setFile(e.target.files?.[0] || null)}
                                        className="w-full bg-[#0B1120] border border-gray-700 rounded-xl p-3 text-white focus:outline-none focus:border-cyan-500"
                                        accept="image/*,.pdf"
                                    />
                                </div>
                                {/* Subject Select could go here if I fetched subjects */}

                                <div className="flex gap-4 pt-4">
                                    <button
                                        type="button"
                                        onClick={() => setShowCreate(false)}
                                        className="flex-1 py-3 bg-[#1A2333] hover:bg-[#232D42] text-white font-bold rounded-xl transition-all"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        type="submit"
                                        className="flex-1 py-3 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-bold rounded-xl hover:shadow-[0_0_15px_rgba(6,182,212,0.4)] transition-all"
                                    >
                                        Post Discussion
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/app/forum/[id]/page.tsx
 *******************************************************************************/

'use client';

import { useState, useEffect } from 'react';
import { useParams, useRouter } from 'next/navigation';
import { getPost, createReply, likePost } from '../../../services/forumService';
import { format } from 'timeago.js';
import { ArrowLeft, MessageSquare, ThumbsUp, Send } from 'lucide-react';
import Link from 'next/link';
import { useAuthStore } from '../../../store/authStore';

export default function ThreadPage() {
    const params = useParams();
    const router = useRouter();
    const postId = params.id as string;
    const { user } = useAuthStore();

    const [post, setPost] = useState<any>(null);
    const [loading, setLoading] = useState(true);
    const [replyContent, setReplyContent] = useState('');

    useEffect(() => {
        if (postId) loadPost();
    }, [postId]);

    const loadPost = async () => {
        try {
            const data = await getPost(postId);
            setPost(data);
        } catch (error) {
            console.error(error);
        } finally {
            setLoading(false);
        }
    };

    const handleReply = async (e: React.FormEvent) => {
        e.preventDefault();
        try {
            await createReply(postId, replyContent);
            setReplyContent('');
            loadPost(); // Refresh
        } catch (error) {
            alert('Failed to post reply');
        }
    };

    const handleLike = async () => {
        try {
            await likePost(postId);
            // Optimistic update
            setPost((prev: any) => ({ ...prev, upvotes: prev.upvotes + 1 }));
        } catch (error) {
            console.error(error);
        }
    };

    if (loading) return <div className="text-center py-20 bg-[#0B1120] text-gray-500 min-h-screen pt-24 pl-0 lg:pl-72">Loading discussion...</div>;
    if (!post) return <div className="text-center py-20 bg-[#0B1120] text-gray-500 min-h-screen pt-24 pl-0 lg:pl-72">Post not found</div>;

    return (
        <div className="min-h-screen bg-[#0B1120] text-white p-8 pt-24 pl-0 lg:pl-72">
            <div className="max-w-4xl mx-auto">
                <Link href="/forum" className="inline-flex items-center gap-2 text-gray-400 hover:text-cyan-400 mb-6 transition-colors">
                    <ArrowLeft size={18} />
                    Back to Forum
                </Link>

                {/* Main Post */}
                <div className="bg-[#151B2D] border border-gray-800 rounded-3xl p-8 mb-8">
                    <div className="flex justify-between items-start mb-6">
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-12 rounded-full bg-gray-700 overflow-hidden">
                                {post.user?.profilePhoto ? (
                                    <img src={post.user.profilePhoto} className="w-full h-full object-cover" />
                                ) : (
                                    <div className="w-full h-full flex items-center justify-center font-bold text-gray-400">
                                        {post.user?.name?.charAt(0) || 'U'}
                                    </div>
                                )}
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold text-white mb-1">{post.title}</h1>
                                <div className="flex items-center gap-2 text-sm text-gray-400">
                                    <span className="text-cyan-400 font-medium">{post.user?.name}</span>
                                    <span>‚Ä¢</span>
                                    <span>{format(post.createdAt)}</span>
                                    {post.subject && (
                                        <>
                                            <span>‚Ä¢</span>
                                            <span className="px-2 py-0.5 bg-blue-500/10 text-blue-400 rounded-full border border-blue-500/20 text-xs">{post.subject.name}</span>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="prose prose-invert max-w-none text-gray-300 mb-8 whitespace-pre-wrap leading-relaxed">
                        {post.content}
                    </div>

                    <div className="flex items-center gap-6 pt-6 border-t border-gray-800">
                        <button
                            onClick={handleLike}
                            className="flex items-center gap-2 text-gray-400 hover:text-cyan-400 transition-colors"
                        >
                            <ThumbsUp size={20} />
                            <span className="font-bold">{post.upvotes} Upvotes</span>
                        </button>
                        <div className="flex items-center gap-2 text-gray-400">
                            <MessageSquare size={20} />
                            <span className="font-bold">{post.replies.length} Replies</span>
                        </div>
                    </div>
                </div>

                {/* Replies Section */}
                <div className="mb-8">
                    <h3 className="text-xl font-bold mb-6 flex items-center gap-2">
                        Replies <span className="bg-gray-800 text-sm px-2 py-1 rounded-full text-gray-400">{post.replies.length}</span>
                    </h3>

                    <div className="space-y-6">
                        {post.replies.map((reply: any) => (
                            <div key={reply.id} className="flex gap-4 group">
                                <div className="w-10 h-10 rounded-full bg-gray-800 overflow-hidden flex-shrink-0 border border-gray-700">
                                    {reply.user?.profilePhoto ? (
                                        <img src={reply.user.profilePhoto} className="w-full h-full object-cover" />
                                    ) : (
                                        <div className="w-full h-full flex items-center justify-center text-xs font-bold text-gray-500">
                                            {reply.user?.name?.charAt(0) || 'U'}
                                        </div>
                                    )}
                                </div>
                                <div className="flex-1">
                                    <div className="bg-[#1A2333] border border-gray-800 rounded-2xl p-4 rounded-tl-none">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="font-bold text-sm text-cyan-400">{reply.user?.name}</span>
                                            <span className="text-xs text-gray-500">{format(reply.createdAt)}</span>
                                        </div>
                                        <p className="text-gray-300 text-sm whitespace-pre-wrap">{reply.content}</p>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>

                {/* Reply Form */}
                <div className="bg-[#151B2D] border border-gray-800 rounded-3xl p-6 sticky bottom-6 shadow-2xl">
                    <form onSubmit={handleReply} className="flex gap-4">
                        <div className="w-10 h-10 rounded-full bg-gray-700 overflow-hidden flex-shrink-0 hidden md:block">
                            {user?.profilePhoto ? (
                                <img src={user.profilePhoto} className="w-full h-full object-cover" />
                            ) : (
                                <div className="w-full h-full flex items-center justify-center font-bold text-gray-400">
                                    {user?.name?.charAt(0) || 'U'}
                                </div>
                            )}
                        </div>
                        <div className="flex-1 relative">
                            <input
                                type="text"
                                value={replyContent}
                                onChange={(e) => setReplyContent(e.target.value)}
                                placeholder="Write a reply..."
                                className="w-full bg-[#0B1120] border border-gray-700 rounded-xl py-3 pl-4 pr-12 text-white focus:outline-none focus:border-cyan-500 transition-all"
                                required
                            />
                            <button
                                type="submit"
                                disabled={!replyContent.trim()}
                                className="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-cyan-500 hover:bg-cyan-400 text-white rounded-lg disabled:opacity-50 disabled:bg-gray-700 transition-all"
                            >
                                <Send size={16} />
                            </button>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/app/globals.css
 *******************************************************************************/

@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}



/*******************************************************************************
 * FILE: client/src/app/layout.tsx
 *******************************************************************************/

import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        {children}
      </body>
    </html>
  );
}



/*******************************************************************************
 * FILE: client/src/app/leaderboard/page.tsx
 *******************************************************************************/

'use client';

import { useState, useEffect } from 'react';
import { getGlobalLeaderboard, getStandardLeaderboard, getSubjectLeaderboard, getUserRank } from '../../services/leaderboardService';
import { Trophy, Medal, Award, TrendingUp } from 'lucide-react';

interface LeaderboardUser {
    id: string;
    name: string;
    email: string;
    xp: number;
    rankScore: number;
    scholarStatus: string;
    streak: number;
    rank: number;
}

export default function LeaderboardPage() {
    const [activeTab, setActiveTab] = useState<'global' | 'standard' | 'subject'>('global');
    const [leaderboard, setLeaderboard] = useState<LeaderboardUser[]>([]);
    const [userRank, setUserRank] = useState<any>(null);
    const [loading, setLoading] = useState(true);
    const [selectedStandard, setSelectedStandard] = useState('8');

    useEffect(() => {
        fetchLeaderboard();
        fetchUserRank();
    }, [activeTab, selectedStandard]);

    const fetchLeaderboard = async () => {
        setLoading(true);
        try {
            let data;
            if (activeTab === 'global') {
                data = await getGlobalLeaderboard();
            } else if (activeTab === 'standard') {
                data = await getStandardLeaderboard(selectedStandard);
            } else {
                // For subject, we'd need to select a subject first
                data = await getGlobalLeaderboard();
            }
            setLeaderboard(data);
        } catch (error) {
            console.error('Error fetching leaderboard:', error);
        } finally {
            setLoading(false);
        }
    };

    const fetchUserRank = async () => {
        try {
            const userId = localStorage.getItem('userId');
            if (userId) {
                const data = await getUserRank(userId);
                setUserRank(data);
            }
        } catch (error) {
            console.error('Error fetching user rank:', error);
        }
    };

    const getRankIcon = (rank: number) => {
        if (rank === 1) return <Trophy className="text-yellow-400" size={24} />;
        if (rank === 2) return <Medal className="text-gray-400" size={24} />;
        if (rank === 3) return <Award className="text-orange-400" size={24} />;
        return <span className="text-gray-500 font-bold">#{rank}</span>;
    };

    const getStatusColor = (status: string) => {
        switch (status) {
            case 'Elite Scholar': return 'text-purple-400';
            case 'Gold Scholar': return 'text-yellow-400';
            case 'Smart Scholar': return 'text-blue-400';
            default: return 'text-gray-400';
        }
    };

    return (
        <div className="min-h-screen bg-[#0B1120] text-white p-8">
            <div className="max-w-6xl mx-auto">
                {/* Header */}
                <div className="mb-8">
                    <h1 className="text-4xl font-bold mb-2 bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">
                        Leaderboard
                    </h1>
                    <p className="text-gray-400">Compete with learners across the platform</p>
                </div>

                {/* User Rank Card */}
                {userRank && (
                    <div className="bg-gradient-to-r from-cyan-500/10 to-blue-500/10 border border-cyan-500/30 rounded-2xl p-6 mb-8">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <div className="w-16 h-16 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-full flex items-center justify-center">
                                    <TrendingUp size={28} />
                                </div>
                                <div>
                                    <h3 className="text-xl font-bold">Your Rank</h3>
                                    <p className="text-gray-400">#{userRank.rank} out of {userRank.totalUsers} learners</p>
                                </div>
                            </div>
                            <div className="text-right">
                                <div className="text-3xl font-bold text-cyan-400">{userRank.rankScore}</div>
                                <div className="text-sm text-gray-400">Rank Score</div>
                            </div>
                        </div>
                    </div>
                )}

                {/* Tabs */}
                <div className="flex gap-4 mb-6 border-b border-gray-800">
                    <button
                        onClick={() => setActiveTab('global')}
                        className={`px-6 py-3 font-bold transition-all ${activeTab === 'global'
                                ? 'text-cyan-400 border-b-2 border-cyan-400'
                                : 'text-gray-400 hover:text-white'
                            }`}
                    >
                        Global
                    </button>
                    <button
                        onClick={() => setActiveTab('standard')}
                        className={`px-6 py-3 font-bold transition-all ${activeTab === 'standard'
                                ? 'text-cyan-400 border-b-2 border-cyan-400'
                                : 'text-gray-400 hover:text-white'
                            }`}
                    >
                        Standard-wise
                    </button>
                </div>

                {/* Standard Selector (only for standard tab) */}
                {activeTab === 'standard' && (
                    <div className="mb-6">
                        <select
                            value={selectedStandard}
                            onChange={(e) => setSelectedStandard(e.target.value)}
                            className="bg-[#1A2333] border border-gray-700 rounded-lg px-4 py-2 text-white"
                        >
                            <option value="8">Standard 8</option>
                            <option value="9">Standard 9</option>
                            <option value="10">Standard 10</option>
                        </select>
                    </div>
                )}

                {/* Leaderboard Table */}
                <div className="bg-[#151B2D] rounded-2xl border border-gray-800 overflow-hidden">
                    {loading ? (
                        <div className="p-12 text-center text-gray-400">Loading leaderboard...</div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-[#1A2333] border-b border-gray-800">
                                    <tr>
                                        <th className="px-6 py-4 text-left text-sm font-bold text-gray-400">Rank</th>
                                        <th className="px-6 py-4 text-left text-sm font-bold text-gray-400">Name</th>
                                        <th className="px-6 py-4 text-left text-sm font-bold text-gray-400">Status</th>
                                        <th className="px-6 py-4 text-right text-sm font-bold text-gray-400">XP</th>
                                        <th className="px-6 py-4 text-right text-sm font-bold text-gray-400">Rank Score</th>
                                        <th className="px-6 py-4 text-right text-sm font-bold text-gray-400">Streak</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {leaderboard.map((user) => (
                                        <tr
                                            key={user.id}
                                            className={`border-b border-gray-800 hover:bg-[#1A2333] transition-colors ${user.id === localStorage.getItem('userId') ? 'bg-cyan-500/5' : ''
                                                }`}
                                        >
                                            <td className="px-6 py-4">
                                                <div className="flex items-center gap-2">
                                                    {getRankIcon(user.rank)}
                                                </div>
                                            </td>
                                            <td className="px-6 py-4">
                                                <div className="font-bold">{user.name}</div>
                                                <div className="text-sm text-gray-500">{user.email}</div>
                                            </td>
                                            <td className="px-6 py-4">
                                                <span className={`font-bold ${getStatusColor(user.scholarStatus)}`}>
                                                    {user.scholarStatus}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 text-right font-bold text-cyan-400">
                                                {user.xp.toLocaleString()}
                                            </td>
                                            <td className="px-6 py-4 text-right font-bold">
                                                {user.rankScore.toLocaleString()}
                                            </td>
                                            <td className="px-6 py-4 text-right">
                                                <div className="flex items-center justify-end gap-1">
                                                    <span className="font-bold text-orange-400">{user.streak}</span>
                                                    <span className="text-gray-500">üî•</span>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/app/login/page.tsx
 *******************************************************************************/

'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { useAuthStore } from '../../store/authStore';
import axios from 'axios';
import Link from 'next/link';
import { Mail, Lock, Eye, EyeOff, ArrowRight } from 'lucide-react';

function ForgotPasswordModal({ onClose }: { onClose: () => void }) {
    const [email, setEmail] = useState('');
    const [loading, setLoading] = useState(false);
    const [message, setMessage] = useState('');
    const [error, setError] = useState('');

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setLoading(true);
        setMessage('');
        setError('');

        try {
            const res = await axios.post(`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000/api'}/auth/forgot-password`, { email });
            setMessage(res.data.message);
            // In dev mode, if the password is returned, we could show it, but for now let's stick to the message
            if (res.data.devPass) {
                console.log("DEV TIP: The temp password is " + res.data.devPass);
                setMessage(res.data.message + " (Check console for dev password)");
            }
        } catch (err: any) {
            setError(err.response?.data?.message || 'Failed to send reset email');
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm p-4">
            <div className="bg-[#151B2D] p-8 rounded-3xl border border-gray-700 w-full max-w-md shadow-2xl relative">
                <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white">‚úï</button>
                <h2 className="text-2xl font-bold mb-2 text-white">Reset Password</h2>
                <p className="text-gray-400 text-sm mb-6">Enter your email to receive a temporary password.</p>

                {message && <div className="mb-4 p-3 bg-green-500/10 border border-green-500/20 rounded text-green-500 text-sm">{message}</div>}
                {error && <div className="mb-4 p-3 bg-red-500/10 border border-red-500/20 rounded text-red-500 text-sm">{error}</div>}

                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Email Address</label>
                        <input
                            type="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            className="w-full bg-[#0B1120] border border-gray-700 rounded-xl p-3 text-white focus:outline-none focus:border-cyan-500"
                            required
                        />
                    </div>
                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded-xl transition-all"
                    >
                        {loading ? 'Sending...' : 'Send Temporary Password'}
                    </button>
                </form>
            </div>
        </div>
    );
}

function LoginContent() {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [showPassword, setShowPassword] = useState(false);
    const [error, setError] = useState('');
    const [successMessage, setSuccessMessage] = useState('');
    const [loading, setLoading] = useState(false);
    const [showForgot, setShowForgot] = useState(false);
    const router = useRouter();
    const searchParams = useSearchParams();
    const { login } = useAuthStore();

    useEffect(() => {
        const message = searchParams.get('message');
        if (message) {
            setSuccessMessage(message);
        }
    }, [searchParams]);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError('');
        setSuccessMessage('');
        setLoading(true);

        try {
            const response = await axios.post(`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000/api'}/auth/login`, {
                email,
                password,
            });

            const { user, token } = response.data;
            login(user, token);
            router.push('/dashboard');
        } catch (err: any) {
            // If email not verified ‚Äî redirect to pending page
            if (err.response?.status === 403 && err.response?.data?.emailVerified === false) {
                router.push(`/verify-email/pending?email=${encodeURIComponent(err.response.data.email || email)}`);
                return;
            }
            setError(err.response?.data?.message || 'Login failed');
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="min-h-screen bg-[#050A18] flex flex-col items-center justify-center p-4 relative overflow-hidden">
            {/* Background Dots Pattern (Simulated) */}
            <div className="absolute inset-0 opacity-20"
                style={{ backgroundImage: 'radial-gradient(#4b5563 1px, transparent 1px)', backgroundSize: '32px 32px' }}>
            </div>

            <div className="w-full max-w-[420px] relative z-10">
                <div className="bg-[#0B1120]/80 backdrop-blur-xl border border-blue-900/30 rounded-3xl p-8 shadow-2xl">

                    {/* Logo Section */}
                    <div className="bg-[#10162B] rounded-2xl p-8 mb-8 text-center border border-blue-900/20 relative overflow-hidden group">
                        <div className="absolute top-0 right-0 w-24 h-24 bg-blue-600/20 rounded-full blur-2xl -mr-10 -mt-10"></div>

                        {/* Bird Logo */}
                        <div className="w-full h-64 mx-auto relative flex items-center justify-center">
                            <img
                                src="/login-brand.jpg"
                                alt="Yatsya Logo"
                                className="w-full h-full object-contain"
                            />
                        </div>
                    </div>

                    {error && <div className="mb-4 p-3 bg-red-500/10 border border-red-500/20 rounded text-red-500 text-sm text-center">{error}</div>}
                    {successMessage && <div className="mb-4 p-3 bg-green-500/10 border border-green-500/20 rounded text-green-500 text-sm text-center">{successMessage}</div>}

                    <form onSubmit={handleSubmit} className="space-y-5">
                        <div>
                            <label className="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-2">Email Address</label>
                            <div className="relative group">
                                <Mail className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 group-focus-within:text-cyan-400 transition" size={18} />
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    placeholder="name@company.com"
                                    className="w-full bg-[#0F1525] border border-gray-800 rounded-lg py-3 pl-10 pr-4 text-sm text-white focus:outline-none focus:border-cyan-500 transition-all placeholder:text-gray-600"
                                    required
                                />
                            </div>
                        </div>

                        <div>
                            <div className="flex justify-between items-center mb-2">
                                <label className="block text-[10px] font-bold text-gray-500 uppercase tracking-wider">Password</label>
                                <button type="button" onClick={() => setShowForgot(true)} className="text-[10px] font-bold text-pink-500 hover:text-pink-400 transition">Forgot Password?</button>
                            </div>
                            <div className="relative group">
                                <Lock className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 group-focus-within:text-cyan-400 transition" size={18} />
                                <input
                                    type={showPassword ? "text" : "password"}
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                    className="w-full bg-[#0F1525] border border-gray-800 rounded-lg py-3 pl-10 pr-10 text-sm text-white focus:outline-none focus:border-cyan-500 transition-all placeholder:text-gray-600"
                                    required
                                />
                                <button
                                    type="button"
                                    onClick={() => setShowPassword(!showPassword)}
                                    className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-white transition"
                                >
                                    {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                                </button>
                            </div>
                        </div>

                        <button
                            type="submit"
                            disabled={loading}
                            className="w-full py-3 bg-gradient-to-r from-purple-500 to-orange-400 hover:from-purple-600 hover:to-orange-500 text-white font-bold rounded-lg transition-all shadow-lg shadow-purple-500/20 flex items-center justify-center gap-2 group"
                        >
                            {loading ? 'Signing In...' : 'Sign In'}
                            {!loading && <ArrowRight size={18} className="group-hover:translate-x-1 transition" />}
                        </button>
                    </form>

                    <div className="mt-6 text-center">
                        <p className="text-sm text-gray-500">
                            Don't have an account?{' '}
                            <Link href="/signup" className="text-purple-400 font-bold hover:text-purple-300 transition">
                                Create an Account
                            </Link>
                        </p>
                    </div>
                </div>

                {/* Footer */}
                <div className="mt-8 text-center space-y-2">
                    <p className="text-[10px] text-gray-600 uppercase tracking-wider">¬© 2024 Yatsya Inc. ‚Ä¢ Secure Adaptive Protocol v4.0.2</p>
                    <div className="flex justify-center gap-6 text-[10px] text-gray-500">
                        <a href="#" className="hover:text-gray-400">Privacy Policy</a>
                        <a href="#" className="hover:text-gray-400">Terms of Service</a>
                        <a href="#" className="hover:text-gray-400">Support</a>
                    </div>
                </div>
            </div>

            {showForgot && <ForgotPasswordModal onClose={() => setShowForgot(false)} />}
        </div>
    );
}

export default function LoginPage() {
    return (
        <Suspense fallback={<div className="min-h-screen bg-[#050A18] flex items-center justify-center text-white">Loading...</div>}>
            <LoginContent />
        </Suspense>
    );
}



/*******************************************************************************
 * FILE: client/src/app/mentors/page.tsx
 *******************************************************************************/

'use client';

import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
    GraduationCap, Search, Star, Youtube, Mail, BookOpen,
    Globe, X, Send, CheckCircle, Loader2, Filter, ChevronDown
} from 'lucide-react';
import Sidebar from '@/components/layout/Sidebar';
import Header from '@/components/layout/Header';
import { getMentors, requestMeeting, rateMentor, Mentor } from '@/services/mentorService';
import { useAuthStore } from '@/store/authStore';

const BOARDS = ['All Boards', 'CBSE', 'ICSE', 'Maharashtra State Board', 'Gujarat Board', 'UP Board'];
const STANDARDS = ['All Standards', '8', '9', '10'];
const LANGUAGES = ['All Languages', 'English', 'Hindi', 'Marathi'];

const getProfilePicUrl = (path: string) => {
    const baseUrl = (process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000/api').replace('/api', '');
    return `${baseUrl}${path.startsWith('/') ? '' : '/'}${path}`;
};

function StarRating({ value, onChange, readonly = false }: { value: number; onChange?: (v: number) => void; readonly?: boolean }) {
    const [hovered, setHovered] = useState(0);
    return (
        <div className="flex gap-1">
            {[1, 2, 3, 4, 5].map(s => (
                <button
                    key={s}
                    disabled={readonly}
                    onMouseEnter={() => !readonly && setHovered(s)}
                    onMouseLeave={() => !readonly && setHovered(0)}
                    onClick={() => onChange?.(s)}
                    className={`transition-all ${readonly ? 'cursor-default' : 'cursor-pointer hover:scale-110'}`}
                >
                    <Star
                        size={18}
                        className={`transition-colors ${(hovered || value) >= s ? 'text-yellow-400 fill-yellow-400' : 'text-gray-600'}`}
                    />
                </button>
            ))}
        </div>
    );
}

function MentorCard({ mentor, onClick }: { mentor: Mentor; onClick: () => void }) {
    return (
        <motion.div
            layout
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, scale: 0.95 }}
            whileHover={{ y: -4 }}
            onClick={onClick}
            className="bg-[#151B2D] border border-gray-800 hover:border-cyan-500/40 rounded-2xl p-6 cursor-pointer transition-all group"
        >
            {/* Avatar */}
            <div className="flex items-start gap-4 mb-4">
                {mentor.profilePicture ? (
                    <img src={getProfilePicUrl(mentor.profilePicture)} alt={mentor.name} className="w-14 h-14 rounded-2xl object-cover flex-shrink-0" />
                ) : (
                    <div className="w-14 h-14 rounded-2xl bg-gradient-to-tr from-cyan-600 to-blue-700 flex items-center justify-center text-white font-black text-xl flex-shrink-0">
                        {mentor.name[0].toUpperCase()}
                    </div>
                )}
                <div className="flex-1 min-w-0">
                    <h3 className="font-bold text-white text-lg leading-tight group-hover:text-cyan-400 transition-colors truncate">{mentor.name}</h3>
                    {mentor.avgRating ? (
                        <div className="flex items-center gap-1 mt-1">
                            <Star size={13} className="text-yellow-400 fill-yellow-400" />
                            <span className="text-yellow-400 font-bold text-sm">{mentor.avgRating}</span>
                            <span className="text-gray-500 text-xs">({mentor.totalRatings} reviews)</span>
                        </div>
                    ) : (
                        <span className="text-gray-600 text-xs mt-1 block">No ratings yet</span>
                    )}
                </div>
            </div>

            {/* Tags */}
            <div className="space-y-2 text-sm">
                <div className="flex flex-wrap gap-1">
                    {mentor.boards.map(b => (
                        <span key={b} className="px-2 py-0.5 bg-purple-500/10 border border-purple-500/20 text-purple-400 rounded-full text-xs">{b}</span>
                    ))}
                </div>
                <div className="flex flex-wrap gap-1">
                    {mentor.standards.map(s => (
                        <span key={s} className="px-2 py-0.5 bg-cyan-500/10 border border-cyan-500/20 text-cyan-400 rounded-full text-xs">Std {s}</span>
                    ))}
                </div>
                <div className="flex flex-wrap gap-1">
                    {mentor.languages.map(l => (
                        <span key={l} className="px-2 py-0.5 bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 rounded-full text-xs">{l}</span>
                    ))}
                </div>
            </div>

            {mentor.bio && (
                <p className="text-gray-500 text-xs mt-3 line-clamp-2">{mentor.bio}</p>
            )}

            <button className="w-full mt-4 py-2.5 rounded-xl bg-cyan-500/10 border border-cyan-500/20 text-cyan-400 text-sm font-bold hover:bg-cyan-500 hover:text-white transition-all">
                View Profile
            </button>
        </motion.div>
    );
}

function MentorModal({ mentor, onClose, currentUserId }: { mentor: Mentor; onClose: () => void; currentUserId: string }) {
    const [message, setMessage] = useState('');
    const [sending, setSending] = useState(false);
    const [sent, setSent] = useState(false);
    const [ratingValue, setRatingValue] = useState(0);
    const [ratingComment, setRatingComment] = useState('');
    const [submittingRating, setSubmittingRating] = useState(false);
    const [ratingDone, setRatingDone] = useState(false);
    const [activeTab, setActiveTab] = useState<'profile' | 'request' | 'rate'>('profile');
    const [error, setError] = useState('');

    const handleRequest = async () => {
        if (!message.trim()) { setError('Please write a message.'); return; }
        setSending(true); setError('');
        try {
            await requestMeeting(mentor.id, message);
            setSent(true);
        } catch (e: any) {
            setError(e.message || 'Failed to send request.');
        } finally {
            setSending(false);
        }
    };

    const handleRate = async () => {
        if (!ratingValue) { setError('Please select a star rating.'); return; }
        setSubmittingRating(true); setError('');
        try {
            await rateMentor(mentor.id, ratingValue, ratingComment);
            setRatingDone(true);
        } catch (e: any) {
            setError(e.message || 'Failed to submit rating.');
        } finally {
            setSubmittingRating(false);
        }
    };

    return (
        <motion.div
            initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}
            className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4"
            onClick={onClose}
        >
            <motion.div
                initial={{ scale: 0.9, y: 20 }} animate={{ scale: 1, y: 0 }} exit={{ scale: 0.9, y: 20 }}
                className="bg-[#0F1729] border border-gray-800 rounded-3xl w-full max-w-xl max-h-[90vh] overflow-y-auto"
                onClick={e => e.stopPropagation()}
            >
                {/* Header */}
                <div className="p-6 border-b border-gray-800 flex items-start justify-between">
                    <div className="flex items-center gap-4">
                        {mentor.profilePicture ? (
                            <img src={getProfilePicUrl(mentor.profilePicture)} alt={mentor.name} className="w-14 h-14 rounded-2xl object-cover text-xl" />
                        ) : (
                            <div className="w-14 h-14 rounded-2xl bg-gradient-to-tr from-cyan-600 to-blue-700 flex items-center justify-center text-white font-black text-2xl">
                                {mentor.name[0].toUpperCase()}
                            </div>
                        )}
                        <div>
                            <h2 className="text-xl font-black text-white">{mentor.name}</h2>
                            {mentor.avgRating ? (
                                <div className="flex items-center gap-1 mt-1">
                                    <StarRating value={Math.round(mentor.avgRating)} readonly />
                                    <span className="text-yellow-400 text-sm font-bold">{mentor.avgRating}</span>
                                    <span className="text-gray-500 text-xs">({mentor.totalRatings})</span>
                                </div>
                            ) : <span className="text-gray-600 text-xs">No ratings yet</span>}
                        </div>
                    </div>
                    <button onClick={onClose} className="text-gray-500 hover:text-white p-2 hover:bg-gray-800 rounded-xl transition-all">
                        <X size={20} />
                    </button>
                </div>

                {/* Tabs */}
                <div className="flex border-b border-gray-800">
                    {(['profile', 'request', 'rate'] as const).map(tab => (
                        <button
                            key={tab}
                            onClick={() => { setActiveTab(tab); setError(''); }}
                            className={`flex-1 py-3 text-sm font-bold capitalize transition-all ${activeTab === tab ? 'text-cyan-400 border-b-2 border-cyan-400' : 'text-gray-500 hover:text-white'}`}
                        >
                            {tab === 'request' ? 'Request Meeting' : tab === 'rate' ? 'Rate Mentor' : 'Profile'}
                        </button>
                    ))}
                </div>

                <div className="p-6">
                    {/* Profile Tab */}
                    {activeTab === 'profile' && (
                        <div className="space-y-5">
                            {mentor.bio && (
                                <div className="bg-[#151B2D] rounded-2xl p-4">
                                    <p className="text-gray-300 leading-relaxed text-sm">{mentor.bio}</p>
                                </div>
                            )}
                            <div className="grid grid-cols-1 gap-3">
                                <InfoRow icon={BookOpen} label="Boards" value={mentor.boards.join(', ')} color="purple" />
                                <InfoRow icon={GraduationCap} label="Standards" value={mentor.standards.map(s => `Std ${s}`).join(', ')} color="cyan" />
                                <InfoRow icon={Globe} label="Languages" value={mentor.languages.join(', ')} color="emerald" />
                                <InfoRow icon={Mail} label="Email" value={mentor.email} color="blue" />
                                {mentor.youtubeChannel && (
                                    <div className="flex items-center gap-3 p-3 bg-red-500/5 border border-red-500/20 rounded-xl">
                                        <Youtube size={16} className="text-red-400 flex-shrink-0" />
                                        <a href={`https://youtube.com/@${mentor.youtubeChannel}`} target="_blank" rel="noreferrer" className="text-red-400 hover:text-red-300 text-sm font-medium truncate">
                                            {mentor.youtubeChannel}
                                        </a>
                                    </div>
                                )}
                            </div>

                            {/* Reviews */}
                            {mentor.ratings.length > 0 && (
                                <div>
                                    <h4 className="text-white font-bold mb-3 text-sm">Student Reviews</h4>
                                    <div className="space-y-2 max-h-48 overflow-y-auto">
                                        {mentor.ratings.map((r: any, i) => (
                                            <div key={i} className="bg-[#151B2D] rounded-xl p-3">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <StarRating value={r.rating} readonly />
                                                </div>
                                                {r.comment && <p className="text-gray-400 text-xs">{r.comment}</p>}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Request Meeting Tab */}
                    {activeTab === 'request' && (
                        <div className="space-y-4">
                            {sent ? (
                                <div className="text-center py-8">
                                    <CheckCircle className="mx-auto text-emerald-400 mb-3" size={48} />
                                    <h3 className="text-white font-bold text-lg mb-1">Request Sent!</h3>
                                    <p className="text-gray-400 text-sm">Your meeting request has been emailed to <strong>{mentor.name}</strong>.</p>
                                    <p className="text-gray-500 text-xs mt-2">They will reply to your email directly.</p>
                                </div>
                            ) : (
                                <>
                                    <p className="text-gray-400 text-sm">Write a message to <strong className="text-white">{mentor.name}</strong>. An email will be sent from Yatsya with your contact details.</p>
                                    <textarea
                                        value={message}
                                        onChange={e => setMessage(e.target.value)}
                                        placeholder="Hi, I'm a Std 9 student struggling with Algebra. I'd love to schedule a 1-on-1 session..."
                                        rows={5}
                                        className="w-full bg-[#151B2D] border border-gray-700 rounded-xl p-4 text-white text-sm placeholder-gray-600 focus:border-cyan-500/50 focus:outline-none resize-none"
                                    />
                                    {error && <p className="text-red-400 text-sm">{error}</p>}
                                    <button
                                        onClick={handleRequest}
                                        disabled={sending}
                                        className="w-full flex items-center justify-center gap-2 py-3 bg-cyan-500 hover:bg-cyan-400 text-black font-black rounded-xl transition-all disabled:opacity-50"
                                    >
                                        {sending ? <Loader2 size={16} className="animate-spin" /> : <Send size={16} />}
                                        {sending ? 'Sending...' : 'Send Meeting Request'}
                                    </button>
                                </>
                            )}
                        </div>
                    )}

                    {/* Rate Mentor Tab */}
                    {activeTab === 'rate' && (
                        <div className="space-y-4">
                            {ratingDone ? (
                                <div className="text-center py-8">
                                    <CheckCircle className="mx-auto text-emerald-400 mb-3" size={48} />
                                    <h3 className="text-white font-bold text-lg mb-1">Thank you!</h3>
                                    <p className="text-gray-400 text-sm">Your rating for <strong>{mentor.name}</strong> has been saved.</p>
                                </div>
                            ) : (
                                <>
                                    <div className="bg-[#151B2D] rounded-2xl p-5 text-center">
                                        <p className="text-gray-400 text-sm mb-3">Rate your experience with <strong className="text-white">{mentor.name}</strong></p>
                                        <div className="flex justify-center">
                                            <StarRating value={ratingValue} onChange={setRatingValue} />
                                        </div>
                                        <p className="text-gray-600 text-xs mt-2">
                                            {ratingValue === 1 ? 'Poor' : ratingValue === 2 ? 'Fair' : ratingValue === 3 ? 'Good' : ratingValue === 4 ? 'Very Good' : ratingValue === 5 ? 'Excellent!' : 'Tap a star'}
                                        </p>
                                    </div>
                                    <textarea
                                        value={ratingComment}
                                        onChange={e => setRatingComment(e.target.value)}
                                        placeholder="Share your experience (optional)..."
                                        rows={3}
                                        className="w-full bg-[#151B2D] border border-gray-700 rounded-xl p-4 text-white text-sm placeholder-gray-600 focus:border-cyan-500/50 focus:outline-none resize-none"
                                    />
                                    {error && <p className="text-red-400 text-sm">{error}</p>}
                                    <button
                                        onClick={handleRate}
                                        disabled={submittingRating || !ratingValue}
                                        className="w-full flex items-center justify-center gap-2 py-3 bg-yellow-500 hover:bg-yellow-400 text-black font-black rounded-xl transition-all disabled:opacity-50"
                                    >
                                        {submittingRating ? <Loader2 size={16} className="animate-spin" /> : <Star size={16} />}
                                        {submittingRating ? 'Submitting...' : 'Submit Rating'}
                                    </button>
                                </>
                            )}
                        </div>
                    )}
                </div>
            </motion.div>
        </motion.div>
    );
}

function InfoRow({ icon: Icon, label, value, color }: { icon: any; label: string; value: string; color: string }) {
    const colors: any = { purple: 'text-purple-400 bg-purple-500/10 border-purple-500/20', cyan: 'text-cyan-400 bg-cyan-500/10 border-cyan-500/20', emerald: 'text-emerald-400 bg-emerald-500/10 border-emerald-500/20', blue: 'text-blue-400 bg-blue-500/10 border-blue-500/20' };
    return (
        <div className={`flex items-center gap-3 p-3 border rounded-xl ${colors[color]}`}>
            <Icon size={16} className="flex-shrink-0" />
            <div>
                <span className="text-gray-500 text-xs">{label}</span>
                <p className="text-white text-sm font-medium">{value}</p>
            </div>
        </div>
    );
}

export default function MentorsPage() {
    const { user } = useAuthStore();
    const [mentors, setMentors] = useState<Mentor[]>([]);
    const [filtered, setFiltered] = useState<Mentor[]>([]);
    const [loading, setLoading] = useState(true);
    const [selectedMentor, setSelectedMentor] = useState<Mentor | null>(null);
    const [search, setSearch] = useState('');
    const [boardFilter, setBoardFilter] = useState('All Boards');
    const [stdFilter, setStdFilter] = useState('All Standards');
    const [langFilter, setLangFilter] = useState('All Languages');

    useEffect(() => {
        fetchMentors();
    }, []);

    useEffect(() => {
        let result = mentors;
        if (search) result = result.filter(m => m.name.toLowerCase().includes(search.toLowerCase()) || m.bio?.toLowerCase().includes(search.toLowerCase()));
        if (boardFilter !== 'All Boards') result = result.filter(m => m.boards.includes(boardFilter));
        if (stdFilter !== 'All Standards') result = result.filter(m => m.standards.includes(stdFilter));
        if (langFilter !== 'All Languages') result = result.filter(m => m.languages.includes(langFilter));
        setFiltered(result);
    }, [mentors, search, boardFilter, stdFilter, langFilter]);

    const fetchMentors = async () => {
        setLoading(true);
        try {
            const data = await getMentors();
            setMentors(data);
            setFiltered(data);
        } catch (e) {
            console.error(e);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="min-h-screen bg-[#0B1120] text-white">
            <Sidebar />
            <Header />
            <main className="ml-0 lg:ml-64 pt-20 p-6 transition-all">
                {/* Ambient BG */}
                <div className="fixed inset-0 pointer-events-none overflow-hidden">
                    <div className="absolute top-1/4 left-1/3 w-96 h-96 bg-cyan-500/5 blur-[120px] rounded-full" />
                    <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-purple-500/5 blur-[120px] rounded-full" />
                </div>

                <div className="max-w-7xl mx-auto relative z-10">
                    {/* Header */}
                    <div className="mb-8">
                        <div className="inline-flex items-center gap-2 px-4 py-2 bg-cyan-500/10 border border-cyan-500/20 rounded-full text-cyan-400 text-sm font-bold mb-4">
                            <GraduationCap size={16} />
                            FIND YOUR MENTOR
                        </div>
                        <h1 className="text-4xl md:text-5xl font-black mb-2 tracking-tight">
                            Expert <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">Mentors</span>
                        </h1>
                        <p className="text-gray-400">Connect with experienced teachers for 1-on-1 guidance.</p>
                    </div>

                    {/* Filters */}
                    <div className="bg-[#151B2D] border border-gray-800 rounded-2xl p-4 mb-8 flex flex-col md:flex-row gap-3">
                        {/* Search */}
                        <div className="relative flex-1">
                            <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" />
                            <input
                                type="text"
                                placeholder="Search mentors..."
                                value={search}
                                onChange={e => setSearch(e.target.value)}
                                className="w-full bg-[#0B1120] border border-gray-700 rounded-xl py-2.5 pl-9 pr-4 text-sm text-white placeholder-gray-600 focus:border-cyan-500/50 focus:outline-none"
                            />
                        </div>
                        {/* Board Filter */}
                        <FilterSelect label="Board" value={boardFilter} options={BOARDS} onChange={setBoardFilter} />
                        <FilterSelect label="Standard" value={stdFilter} options={STANDARDS} onChange={setStdFilter} />
                        <FilterSelect label="Language" value={langFilter} options={LANGUAGES} onChange={setLangFilter} />
                    </div>

                    {/* Count */}
                    <p className="text-gray-500 text-sm mb-4">
                        {loading ? 'Loading...' : `${filtered.length} mentor${filtered.length !== 1 ? 's' : ''} found`}
                    </p>

                    {/* Grid */}
                    {loading ? (
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {[...Array(8)].map((_, i) => (
                                <div key={i} className="bg-[#151B2D] border border-gray-800 rounded-2xl p-6 animate-pulse">
                                    <div className="flex gap-3 mb-4">
                                        <div className="w-14 h-14 bg-gray-800 rounded-2xl" />
                                        <div className="flex-1 space-y-2">
                                            <div className="h-4 bg-gray-800 rounded w-3/4" />
                                            <div className="h-3 bg-gray-800 rounded w-1/2" />
                                        </div>
                                    </div>
                                    <div className="space-y-2">
                                        <div className="h-6 bg-gray-800 rounded-full w-24" />
                                        <div className="h-6 bg-gray-800 rounded-full w-20" />
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : filtered.length === 0 ? (
                        <div className="text-center py-20">
                            <GraduationCap size={48} className="mx-auto text-gray-700 mb-4" />
                            <h3 className="text-xl font-bold text-gray-500">No mentors found</h3>
                            <p className="text-gray-600 text-sm mt-1">Try adjusting your filters.</p>
                        </div>
                    ) : (
                        <motion.div layout className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            <AnimatePresence>
                                {filtered.map(mentor => (
                                    <MentorCard key={mentor.id} mentor={mentor} onClick={() => setSelectedMentor(mentor)} />
                                ))}
                            </AnimatePresence>
                        </motion.div>
                    )}
                </div>
            </main>

            {/* Mentor Modal */}
            <AnimatePresence>
                {selectedMentor && (
                    <MentorModal
                        mentor={selectedMentor}
                        onClose={() => setSelectedMentor(null)}
                        currentUserId={user?.id || ''}
                    />
                )}
            </AnimatePresence>
        </div>
    );
}

function FilterSelect({ label, value, options, onChange }: { label: string; value: string; options: string[]; onChange: (v: string) => void }) {
    return (
        <div className="relative">
            <select
                value={value}
                onChange={e => onChange(e.target.value)}
                className="appearance-none bg-[#0B1120] border border-gray-700 rounded-xl py-2.5 pl-3 pr-8 text-sm text-white focus:border-cyan-500/50 focus:outline-none cursor-pointer w-full md:w-auto"
            >
                {options.map(o => <option key={o} value={o}>{o}</option>)}
            </select>
            <ChevronDown size={14} className="absolute right-2.5 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none" />
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/app/page.tsx
 *******************************************************************************/

import Link from 'next/link';
import Image from 'next/image';

export default function Home() {
  return (
    <div className="min-h-screen bg-gray-900 text-white flex flex-col items-center justify-center p-8">
      <main className="flex flex-col items-center text-center max-w-4xl">
        <h1 className="text-5xl md:text-7xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-600 mb-6">
          Adaptive Learning System
        </h1>
        <p className="text-xl md:text-2xl text-gray-300 mb-12 max-w-2xl">
          Master any subject with our AI-powered personalized learning platform that adapts to your pace and style.
        </p>

        <div className="flex gap-6 flex-wrap justify-center">
          <Link
            href="/login"
            className="px-8 py-3 bg-purple-600 hover:bg-purple-700 rounded-full font-bold text-lg transition shadow-lg hover:shadow-purple-500/20"
          >
            Get Started
          </Link>
          <Link
            href="/dashboard"
            className="px-8 py-3 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-full font-bold text-lg transition"
          >
            Dashboard
          </Link>
        </div>

        <div className="mt-20 grid grid-cols-1 md:grid-cols-3 gap-8 w-full">
          <div className="p-6 bg-gray-800/50 rounded-xl border border-gray-700">
            <div className="text-4xl mb-4">üß†</div>
            <h3 className="text-xl font-bold mb-2">AI Adaptive</h3>
            <p className="text-gray-400">Questions get harder as you improve, ensuring optimal learning curve.</p>
          </div>
          <div className="p-6 bg-gray-800/50 rounded-xl border border-gray-700">
            <div className="text-4xl mb-4">üìä</div>
            <h3 className="text-xl font-bold mb-2">Smart Analytics</h3>
            <p className="text-gray-400">Track your mastery with detailed heatmaps and progress charts.</p>
          </div>
          <div className="p-6 bg-gray-800/50 rounded-xl border border-gray-700">
            <div className="text-4xl mb-4">üèÜ</div>
            <h3 className="text-xl font-bold mb-2">Gamified</h3>
            <p className="text-gray-400">Earn XP, badges, and compete on leaderboards while you learn.</p>
          </div>
        </div>
      </main>

      <footer className="mt-auto py-8 text-gray-500">
        <p>&copy; 2026 Adaptive Learning System</p>
      </footer>
    </div>
  );
}



/*******************************************************************************
 * FILE: client/src/app/profile/page.tsx
 *******************************************************************************/

'use client';

import { useState, useEffect } from 'react';
import { useAuthStore } from '../../store/authStore';
import Header from '../../components/layout/Header';
import Sidebar from '../../components/layout/Sidebar';
import PhotoCropModal from '../../components/PhotoCropModal';
import { getProfile, updateProfile, uploadPhotoBase64 } from '../../services/profileService';
import { User, Save, Camera } from 'lucide-react';

export default function ProfilePage() {
    const { user, login } = useAuthStore();
    const [loading, setLoading] = useState(false);
    const [message, setMessage] = useState('');
    const [showCropModal, setShowCropModal] = useState(false);

    const [formData, setFormData] = useState({
        name: '',
        gender: '',
        age: '',
        classStandard: '',
        schoolName: '',
        board: 'Maharashtra State Board',
        profilePhoto: ''
    });

    useEffect(() => {
        const fetchProfile = async () => {
            const token = useAuthStore.getState().token;
            if (!token) return;

            try {
                const data = await getProfile();
                if (data) {
                    login(data, token);
                }
            } catch (error: any) {
                if (error.response?.status !== 401) {
                    console.error('Failed to fetch profile:', error);
                }
            }
        };

        fetchProfile();
    }, []);

    useEffect(() => {
        if (user) {
            setFormData({
                name: user.name || '',
                gender: user.gender || '',
                age: user.age ? user.age.toString() : '',
                classStandard: user.classStandard || '',
                schoolName: user.schoolName || '',
                board: user.board || 'Maharashtra State Board',
                profilePhoto: user.profilePhoto || ''
            });
        }
    }, [user]);

    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
    };

    const handlePhotoSave = async (croppedImageUrl: string) => {
        try {
            const data = await uploadPhotoBase64(croppedImageUrl);
            setFormData({ ...formData, profilePhoto: data.photoUrl });
            setMessage('Photo uploaded! Remember to click "Save Profile" to keep it.');
        } catch (error: any) {
            const errorMsg = error.response?.data?.message || 'Failed to upload photo.';
            setMessage(errorMsg);
            console.error(error);
        }
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setLoading(true);
        setMessage('');

        try {
            const data = await updateProfile(formData);

            if (data.user) {
                const token = useAuthStore.getState().token;
                login(data.user, token!);
                setMessage('Profile updated successfully!');
            } else {
                setMessage('Update successful, but no user data received.');
            }
        } catch (error: any) {
            const errorMsg = error.response?.data?.message || 'Failed to update profile. Please try again.';
            setMessage(errorMsg);
            console.error('Update Error:', error);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="min-h-screen bg-[#0B1120] text-white">
            <Sidebar />
            <Header />

            <main className="ml-0 lg:ml-64 pt-16 p-8 transition-all">
                <div className="max-w-3xl mx-auto">
                    <h1 className="text-3xl font-bold mb-8 flex items-center gap-3">
                        <User className="text-cyan-400" size={32} />
                        My Profile
                    </h1>

                    <div className="bg-[#151B2D] rounded-3xl p-8 border border-gray-800">
                        {message && (
                            <div className={`mb-6 p-4 rounded-xl ${message.includes('success') ? 'bg-green-500/10 text-green-400' : 'bg-red-500/10 text-red-400'}`}>
                                {message}
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-6">
                            {/* Photo Section */}
                            <div className="flex flex-col items-center mb-8">
                                <div
                                    onClick={() => setShowCropModal(true)}
                                    className="w-24 h-24 rounded-full bg-[#1A2333] border-2 border-dashed border-gray-600 flex items-center justify-center relative overflow-hidden group cursor-pointer hover:border-cyan-500 transition"
                                >
                                    {formData.profilePhoto ? (
                                        <img src={formData.profilePhoto} alt="Profile" className="w-full h-full object-cover" />
                                    ) : (
                                        <User size={40} className="text-gray-500" />
                                    )}
                                    <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                                        <Camera size={24} className="text-white" />
                                    </div>
                                </div>
                                <p className="text-xs text-gray-500 mt-2">Click to upload and crop photo</p>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Full Name</label>
                                    <input
                                        type="text"
                                        name="name"
                                        value={formData.name}
                                        onChange={handleChange}
                                        className="w-full bg-[#0B1120] border border-gray-700 rounded-xl px-4 py-3 focus:border-cyan-500 outline-none transition"
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Age</label>
                                    <input
                                        type="number"
                                        name="age"
                                        value={formData.age}
                                        onChange={handleChange}
                                        className="w-full bg-[#0B1120] border border-gray-700 rounded-xl px-4 py-3 focus:border-cyan-500 outline-none transition"
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Gender</label>
                                    <select
                                        name="gender"
                                        value={formData.gender}
                                        onChange={handleChange}
                                        className="w-full bg-[#0B1120] border border-gray-700 rounded-xl px-4 py-3 focus:border-cyan-500 outline-none transition text-gray-300"
                                    >
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Standard / Class</label>
                                    <input
                                        type="text"
                                        name="classStandard"
                                        value={formData.classStandard}
                                        onChange={handleChange}
                                        placeholder="e.g. 10th"
                                        className="w-full bg-[#0B1120] border border-gray-700 rounded-xl px-4 py-3 focus:border-cyan-500 outline-none transition"
                                    />
                                </div>

                                <div className="md:col-span-2">
                                    <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">School Name</label>
                                    <input
                                        type="text"
                                        name="schoolName"
                                        value={formData.schoolName}
                                        onChange={handleChange}
                                        className="w-full bg-[#0B1120] border border-gray-700 rounded-xl px-4 py-3 focus:border-cyan-500 outline-none transition"
                                    />
                                </div>

                                <div className="md:col-span-2">
                                    <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Board</label>
                                    <select
                                        name="board"
                                        value={formData.board}
                                        onChange={handleChange}
                                        className="w-full bg-[#0B1120] border border-gray-700 rounded-xl px-4 py-3 focus:border-cyan-500 outline-none transition text-gray-300"
                                    >
                                        <option value="Maharashtra State Board">Maharashtra State Board</option>
                                        <option value="CBSE">CBSE</option>
                                        <option value="ICSE">ICSE</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>

                            <div className="pt-4 flex justify-end">
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="px-8 py-3 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 text-white font-bold rounded-xl flex items-center gap-2 transition-all shadow-lg hover:shadow-cyan-500/20"
                                >
                                    <Save size={18} />
                                    {loading ? 'Saving...' : 'Save Profile'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </main>

            <PhotoCropModal
                isOpen={showCropModal}
                onClose={() => setShowCropModal(false)}
                onSave={handlePhotoSave}
            />
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/app/quiz/result/[id]/page.tsx
 *******************************************************************************/

'use client';

import { useEffect, useState } from 'react';
import { useRouter, useParams, useSearchParams } from 'next/navigation';
import Link from 'next/link';
import { Trophy, Clock, Target, ArrowRight, Home, RefreshCw, BarChart3, Star, Sparkles } from 'lucide-react';
import { useAuthStore } from '../../../../store/authStore';
import { getQuizSession } from '../../../../services/quizService';

export default function ResultPage() {
    const params = useParams();
    const searchParams = useSearchParams();
    const router = useRouter();
    const { user } = useAuthStore();
    const sessionId = params.id as string;

    const [resultData, setResultData] = useState<any>(null);
    const [loading, setLoading] = useState(true);
    const [aiLoading, setAiLoading] = useState(false);

    useEffect(() => {
        const dataStr = searchParams.get('data');
        if (dataStr) {
            try {
                const parsedData = JSON.parse(dataStr);
                setResultData(parsedData);
                setLoading(false);

                // Start polling if AI feedback is missing
                if (!parsedData.aiFeedback) {
                    setAiLoading(true);
                }
            } catch (e) {
                console.error("Failed to parse result data", e);
                setLoading(false);
            }
        } else {
            setLoading(false);
        }
    }, [searchParams]);

    // Polling effect for AI Feedback
    useEffect(() => {
        if (!aiLoading || !sessionId) return;

        let pollCount = 0;
        const maxPolls = 15; // Max 30 seconds

        const poll = async () => {
            try {
                const session = await getQuizSession(sessionId);
                if (session && session.aiFeedback) {
                    setResultData((prev: any) => ({
                        ...prev,
                        aiFeedback: session.aiFeedback,
                        recommendations: session.recommendations,
                        youtubeLink: session.level?.chapter?.youtubeLink
                    }));
                    setAiLoading(false);
                } else if (pollCount >= maxPolls) {
                    setAiLoading(false); // Stop polling after limit
                }
                pollCount++;
            } catch (error) {
                console.error("Polling error:", error);
                setAiLoading(false);
            }
        };

        const interval = setInterval(() => {
            if (aiLoading) poll();
        }, 2000);

        return () => clearInterval(interval);
    }, [aiLoading, sessionId]);

    if (loading) {
        return (
            <div className="min-h-screen bg-[#0B1120] text-white flex items-center justify-center">
                <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-cyan-500"></div>
            </div>
        );
    }

    if (!resultData) {
        return (
            <div className="min-h-screen bg-[#0B1120] text-white flex flex-col items-center justify-center p-8">
                <h1 className="text-2xl font-bold mb-4">No Result Found</h1>
                <Link href="/dashboard" className="px-6 py-3 bg-cyan-600 rounded-xl font-bold">Return to Dashboard</Link>
            </div>
        );
    }

    const { score, xpEarned, rankScoreEarned, newStatus, message, nextLevelUnlock, aiFeedback, recommendations } = resultData;

    return (
        <div className="min-h-screen bg-[#0B1120] text-white p-4 md:p-8 flex items-center justify-center">
            <div className="max-w-4xl w-full">
                {/* Main Card */}
                <div className="bg-[#151B2D] rounded-[2.5rem] border border-gray-800 shadow-2xl shadow-cyan-500/10 overflow-hidden relative">

                    {/* Decorative background elements */}
                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500 via-purple-500 to-pink-500"></div>
                    <div className="absolute -top-24 -right-24 w-64 h-64 bg-cyan-500/10 rounded-full blur-3xl"></div>
                    <div className="absolute -bottom-24 -left-24 w-64 h-64 bg-purple-500/10 rounded-full blur-3xl"></div>

                    <div className="p-8 md:p-12 relative z-10">
                        {/* Header */}
                        <div className="text-center mb-12">
                            <div className="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-yellow-400 to-orange-600 rounded-3xl rotate-12 mb-6 shadow-xl shadow-orange-500/20">
                                <Trophy size={40} className="text-white -rotate-12" />
                            </div>
                            <h1 className="text-4xl md:text-5xl font-black mb-4">Quiz Completed!</h1>
                            <p className="text-gray-400 text-lg max-w-lg mx-auto leading-relaxed">
                                {message}
                            </p>
                        </div>

                        {/* Stats Grid */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                            {/* Score Card */}
                            <div className="bg-[#1A2333] border border-gray-700/50 p-6 rounded-3xl text-center transform hover:scale-105 transition-all duration-300">
                                <div className="flex justify-center mb-3 text-cyan-400">
                                    <Target size={24} />
                                </div>
                                <div className="text-3xl font-black text-white mb-1">{Math.round(score)}%</div>
                                <div className="text-xs text-gray-500 uppercase tracking-widest font-bold">Accuracy Score</div>
                            </div>

                            {/* XP Card */}
                            <div className="bg-[#1A2333] border border-gray-700/50 p-6 rounded-3xl text-center transform hover:scale-105 transition-all duration-300">
                                <div className="flex justify-center mb-3 text-purple-400">
                                    <Star size={24} />
                                </div>
                                <div className="text-3xl font-black text-white mb-1">+{xpEarned}</div>
                                <div className="text-xs text-gray-500 uppercase tracking-widest font-bold">XP Earned</div>
                            </div>

                            {/* Potential Rank Upgrade */}
                            <div className="bg-[#1A2333] border border-gray-700/50 p-6 rounded-3xl text-center transform hover:scale-105 transition-all duration-300">
                                <div className="flex justify-center mb-3 text-pink-400">
                                    <BarChart3 size={24} />
                                </div>
                                <div className="text-3xl font-black text-white mb-1">+{Math.round(rankScoreEarned)}</div>
                                <div className="text-xs text-gray-500 uppercase tracking-widest font-bold">Rank Points</div>
                            </div>
                        </div>

                        {/* AI Feedback Section */}
                        {(aiLoading || aiFeedback || recommendations) && (
                            <div className="bg-gradient-to-br from-[#1A2333] to-[#0B1120] border border-gray-700/50 rounded-[2.5rem] p-8 mb-12 relative overflow-hidden">
                                <h3 className="text-xl font-bold mb-6 flex items-center gap-3">
                                    <div className="p-2 bg-purple-500/20 rounded-xl text-purple-400">
                                        <Star size={20} />
                                    </div>
                                    AI Learning Insights
                                    {aiLoading && (
                                        <div className="ml-2 flex items-center gap-2">
                                            <div className="w-4 h-4 border-2 border-purple-500/30 border-t-purple-500 rounded-full animate-spin" />
                                            <span className="text-xs font-medium text-gray-500 animate-pulse">Generating...</span>
                                        </div>
                                    )}
                                </h3>

                                {aiLoading ? (
                                    <div className="space-y-6">
                                        <div className="space-y-2">
                                            <div className="h-4 bg-gray-800 rounded w-full animate-pulse" />
                                            <div className="h-4 bg-gray-800 rounded w-5/6 animate-pulse" />
                                            <div className="h-4 bg-gray-800 rounded w-4/6 animate-pulse" />
                                        </div>
                                        <div className="h-32 bg-gray-800/50 rounded-2xl border border-gray-800 animate-pulse" />
                                    </div>
                                ) : (
                                    <>
                                        {aiFeedback && (
                                            <div className="mb-6">
                                                <p className="text-gray-300 leading-relaxed italic">
                                                    "{aiFeedback}"
                                                </p>
                                            </div>
                                        )}

                                        {recommendations && (
                                            <div className="bg-[#151B2D]/50 rounded-2xl p-6 border border-gray-800">
                                                <h4 className="text-xs font-black text-cyan-400 uppercase tracking-widest mb-4">Recommended for Revision</h4>
                                                <div className="text-gray-400 text-sm whitespace-pre-line leading-loose">
                                                    {(recommendations as string).split('\n').map((line: string, i: number) => {
                                                        if (line.includes('http')) {
                                                            const parts = line.split(': ');
                                                            return (
                                                                <div key={i} className="mb-2">
                                                                    <span className="text-gray-300">{parts[0]}</span>
                                                                    <a href={parts[1]} target="_blank" rel="noopener noreferrer" className="ml-2 text-cyan-400 hover:underline">
                                                                        Watch Lesson
                                                                    </a>
                                                                </div>
                                                            );
                                                        }
                                                        return <div key={i}>{line}</div>;
                                                    })}
                                                </div>
                                            </div>
                                        )}
                                    </>
                                )}
                            </div>
                        )}


                        {/* Status Update / Next Steps Section */}
                        <div className="bg-gradient-to-br from-[#1A2333] to-[#0B1120] border border-gray-700 rounded-[2rem] p-8 mb-12 relative overflow-hidden">

                            {/* Recommended Revision Video */}
                            {resultData.youtubeLink && (
                                <div className="mb-8 p-6 bg-red-600/10 border border-red-600/30 rounded-2xl flex items-center justify-between gap-4">
                                    <div>
                                        <h4 className="text-red-400 font-bold mb-1">Concept Revision</h4>
                                        <p className="text-gray-400 text-sm">Watch the full chapter playlist to strengthen your concepts.</p>
                                    </div>
                                    <a
                                        href={resultData.youtubeLink}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="px-6 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-xl flex items-center gap-2 transition-transform active:scale-95"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                                        Watch Video
                                    </a>
                                </div>
                            )}

                            <div className="flex flex-col md:flex-row items-center gap-8 relative z-10">
                                <div className="flex-1 text-center md:text-left">
                                    <h3 className="text-xl font-bold mb-2">Scholar Status Updated</h3>
                                    <p className="text-gray-400 mb-4">Your dedication is paying off! You are now a:</p>
                                    <div className="inline-flex items-center gap-3 px-6 py-3 bg-cyan-500/10 border border-cyan-500/30 rounded-2xl">
                                        <div className="w-4 h-4 rounded-full bg-cyan-500 animate-pulse"></div>
                                        <span className="text-cyan-400 font-black text-xl tracking-wide">{newStatus}</span>
                                    </div>
                                </div>

                                {nextLevelUnlock && (
                                    <div className="w-full md:w-auto">
                                        <div className="bg-white/5 p-6 rounded-3xl border border-white/10">
                                            <span className="text-[10px] font-bold text-cyan-400 uppercase tracking-widest block mb-2">NEXT MILESTONE</span>
                                            <div className="flex items-center gap-4">
                                                <div className="p-3 bg-cyan-500 rounded-xl">
                                                    <RefreshCw size={24} className="text-black" />
                                                </div>
                                                <div>
                                                    <div className="font-bold text-white">{nextLevelUnlock} Level</div>
                                                    <div className="text-xs text-gray-500">Ready to unlock</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Action Buttons */}
                        <div className="flex flex-col md:flex-row gap-4">
                            <Link
                                href="/dashboard"
                                className="flex-1 flex items-center justify-center gap-3 py-4 bg-gray-800 hover:bg-gray-700 border border-gray-700 text-white font-bold rounded-2xl transition-all active:scale-95"
                            >
                                <Home size={20} />
                                Back to Dashboard
                            </Link>
                            <Link
                                href="/subjects"
                                className="flex-1 flex items-center justify-center gap-3 py-4 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 text-black font-black rounded-2xl transition-all shadow-xl shadow-cyan-500/20 active:scale-95"
                            >
                                Continue Learning
                                <ArrowRight size={20} />
                            </Link>
                        </div>
                    </div>
                </div>

                {/* Secondary advice or quote */}
                <div className="mt-8 text-center text-gray-500 text-sm italic">
                    "Every master was once a beginner. Keep pushing your limits!"
                </div>
            </div>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/app/quiz/[id]/page.tsx
 *******************************************************************************/

'use client';

import { useState, useEffect, useRef } from 'react';
import { useRouter, useParams } from 'next/navigation';
import { startQuiz, getQuizQuestions, submitAnswer, completeQuiz, getAdaptiveQuestion } from '../../../services/quizService';
import { fetchRemediation } from '../../../services/aiService';
import { AlertTriangle, Timer, XCircle, Sparkles, Brain, Lightbulb, GraduationCap } from 'lucide-react';

export default function QuizPage() {
    const params = useParams();
    const router = useRouter();
    const levelId = params.id as string;

    // State variables
    const [questions, setQuestions] = useState<any[]>([]);
    const [currentIndex, setCurrentIndex] = useState(0);
    const [sessionId, setSessionId] = useState<string | null>(null);
    const [timer, setTimer] = useState(600); // 10 minutes
    const [warnings, setWarnings] = useState(0);
    const [showWarning, setShowWarning] = useState(false);
    const [loading, setLoading] = useState(true);
    const [feedback, setFeedback] = useState<{ isCorrect: boolean; text: string; correctOption?: number } | null>(null);
    const [selectedOption, setSelectedOption] = useState<number | null>(null);

    // Refs
    const questionStartTime = useRef(Date.now());

    // Computed values
    const currentQuestion = questions[currentIndex];

    // Initialize quiz
    useEffect(() => {
        const initQuiz = async () => {
            try {
                // Start quiz session
                const session = await startQuiz(levelId);
                setSessionId(session.id);

                // Get questions
                const quizQuestions = await getQuizQuestions(levelId);
                setQuestions(quizQuestions);
                setLoading(false);
                questionStartTime.current = Date.now();
            } catch (error) {
                console.error('Error initializing quiz:', error);
                router.push('/subjects');
            }
        };

        initQuiz();
    }, [levelId, router]);

    // Timer countdown
    useEffect(() => {
        if (loading || !sessionId) return;

        const interval = setInterval(() => {
            setTimer(prev => {
                if (prev <= 1) {
                    finishQuiz();
                    return 0;
                }
                return prev - 1;
            });
        }, 1000);

        return () => clearInterval(interval);
    }, [loading, sessionId]);

    // Tab switch detection
    useEffect(() => {
        const handleVisibilityChange = () => {
            if (document.hidden && sessionId) {
                setWarnings(prev => {
                    const newWarnings = prev + 1;
                    if (newWarnings >= 3) {
                        finishQuiz();
                    } else {
                        setShowWarning(true);
                    }
                    return newWarnings;
                });
            }
        };

        document.addEventListener('visibilitychange', handleVisibilityChange);
        return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
    }, [sessionId]);

    // Prevent copy/paste
    useEffect(() => {
        const preventCopy = (e: Event) => e.preventDefault();
        document.addEventListener('copy', preventCopy);
        document.addEventListener('paste', preventCopy);
        document.addEventListener('contextmenu', preventCopy);

        return () => {
            document.removeEventListener('copy', preventCopy);
            document.removeEventListener('paste', preventCopy);
            document.removeEventListener('contextmenu', preventCopy);
        };
    }, []);

    const [toast, setToast] = useState<{ message: string; type: 'success' | 'warning' } | null>(null);
    const [remediation, setRemediation] = useState<string | null>(null);
    const [isLoadingRemediation, setIsLoadingRemediation] = useState(false);

    const handleAnswer = async (optionId: number) => {
        if (!sessionId || selectedOption !== null) return; // Prevent multiple clicks

        setSelectedOption(optionId);
        const timeTaken = Math.round((Date.now() - questionStartTime.current) / 1000);
        const currentQ = questions[currentIndex];

        setRemediation(null); // Reset for new question

        try {
            const res = await submitAnswer({
                sessionId,
                questionId: currentQ.id,
                selectedOptionId: optionId,
                timeTaken
            });

            setFeedback({
                isCorrect: res.isCorrect,
                text: res.feedback,
                correctOption: res.correctOption
            });

            // --- ADAPTIVE LOGIC & REMEDIATION ---
            if (res.adaptiveAction !== 'NONE') {
                setIsLoadingRemediation(true);
                fetchRemediation(currentQ.id, res.adaptiveAction)
                    .then(data => setRemediation(data.remediation))
                    .catch(err => console.error("Remediation fetch error:", err))
                    .finally(() => setIsLoadingRemediation(false));

                if (res.adaptiveAction === 'UPGRADE') {
                    setToast({ message: "Leveling Up! üöÄ Skipping to Challenge Mode", type: 'success' });
                    const challengeQ = await getAdaptiveQuestion({
                        difficulty: 'CHALLENGE',
                        chapterId: res.chapterId,
                        sessionId
                    });

                    setQuestions(prev => {
                        const nextQ = [...prev.slice(0, currentIndex + 1)];
                        return [...nextQ, challengeQ];
                    });
                } else if (res.adaptiveAction === 'DOWNGRADE') {
                    setToast({ message: "Practice makes perfect! Here is an easier one.", type: 'warning' });
                    const easyQ = await getAdaptiveQuestion({
                        difficulty: 'EASY',
                        chapterId: res.chapterId,
                        sessionId
                    });
                    setQuestions(prev => {
                        const newQs = [...prev];
                        newQs.splice(currentIndex + 1, 0, easyQ);
                        return newQs;
                    });
                }

                setTimeout(() => setToast(null), 3000);
            }
        } catch (error) {
            console.error("Error submitting answer:", error);
        }
    };

    const nextQuestion = () => {
        setFeedback(null);
        setSelectedOption(null);
        if (currentIndex < questions.length - 1) {
            setCurrentIndex(prev => prev + 1);
            questionStartTime.current = Date.now();
        } else {
            finishQuiz();
        }
    };

    const [showQuitConfirm, setShowQuitConfirm] = useState(false);

    // Refs
    // ... (existing refs)

    const finishQuiz = async () => {
        if (!sessionId) {
            router.push('/subjects');
            return;
        }
        setLoading(true);
        try {
            const res = await completeQuiz(sessionId);
            const dataStr = encodeURIComponent(JSON.stringify(res));
            router.push(`/quiz/result/${sessionId}?data=${dataStr}`);
        } catch (error) {
            console.error("Error completing quiz:", error);
            router.push('/subjects');
        }
    };

    const handleQuitClick = () => {
        setShowQuitConfirm(true);
    };

    return (
        <div className="min-h-screen bg-[#0B1120] text-white flex flex-col select-none relative overflow-hidden">
            {/* Adaptive Toast */}
            {toast && (
                <div className={`fixed top-20 left-1/2 -translate-x-1/2 z-50 px-6 py-3 rounded-2xl border shadow-2xl flex items-center gap-3 animate-bounce ${toast.type === 'success'
                    ? 'bg-green-500/10 border-green-500/50 text-green-400'
                    : 'bg-yellow-500/10 border-yellow-500/50 text-yellow-400'
                    }`}>
                    {toast.type === 'success' ? <Sparkles size={20} /> : <Brain size={20} />}
                    <span className="font-bold">{toast.message}</span>
                </div>
            )}

            {/* Header */}
            <div className="h-16 border-b border-gray-800 flex items-center justify-between px-8 bg-[#151B2D] relative z-30">
                <div className="flex items-center gap-4">
                    <button onClick={handleQuitClick} className="p-2 hover:bg-gray-800 rounded-full transition-colors text-gray-400 hover:text-white">
                        <XCircle size={24} />
                    </button>
                    <div className="h-4 w-px bg-gray-700"></div>
                </div>

                <div className="flex items-center gap-4">
                    <span className="font-bold text-lg">Question {currentIndex + 1} / {questions.length}</span>
                    <div className="flex items-center gap-2 px-3 py-1 bg-gray-800 rounded-full text-sm">
                        <Timer size={14} className="text-cyan-400" />
                        {Math.floor(timer / 60)}:{(timer % 60).toString().padStart(2, '0')}
                    </div>
                </div>

                <div className="flex items-center gap-4">
                    <div className="flex items-center gap-2 text-red-500 hidden md:flex">
                        <AlertTriangle size={18} />
                        <span className="font-bold text-sm">Warnings: {warnings}/3</span>
                    </div>
                    <button onClick={handleQuitClick} className="px-4 py-2 bg-red-500/10 text-red-500 rounded-lg hover:bg-red-500/20 text-xs font-bold transition-all">
                        Quit Test
                    </button>
                </div>
            </div>

            {/* Main Content ... (Keep same) */}
            <div className="flex-1 flex items-center justify-center p-8 pb-32">
                <div className="max-w-3xl w-full relative z-10">
                    <h2 className="text-2xl font-bold mb-8 leading-relaxed">
                        {currentQuestion?.content}
                    </h2>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {currentQuestion?.options.map((opt: any) => {
                            let statusClass = "bg-[#1A2333] border-gray-700 hover:border-cyan-500 hover:bg-cyan-500/10";
                            if (selectedOption !== null) {
                                if (opt.id === feedback?.correctOption) {
                                    statusClass = "bg-green-500/20 border-green-500 text-green-400"; // Correct Answer
                                } else if (opt.id === selectedOption && !feedback?.isCorrect) {
                                    statusClass = "bg-red-500/20 border-red-500 text-red-400"; // Wrong Selection
                                } else {
                                    statusClass = "bg-gray-800/50 border-gray-800 opacity-50"; // Others
                                }
                            }

                            return (
                                <button
                                    key={opt.id}
                                    onClick={() => handleAnswer(opt.id)}
                                    disabled={selectedOption !== null}
                                    className={`p-6 border rounded-xl transition-all text-left group relative overflow-hidden ${statusClass}`}
                                >
                                    <div className="flex items-center gap-4 relative z-10">
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold transition-colors ${selectedOption !== null && opt.id === feedback?.correctOption ? 'bg-green-500 text-white' :
                                            selectedOption === opt.id && !feedback?.isCorrect ? 'bg-red-500 text-white' :
                                                'bg-gray-800 text-gray-400'
                                            }`}>
                                            {String.fromCharCode(64 + opt.id)}
                                        </div>
                                        <span className="text-lg">{opt.text}</span>
                                    </div>
                                </button>
                            );
                        })}
                    </div>
                </div>
            </div>

            {/* Feedback Bottom Sheet ... (Keep same) */}
            <div className={`fixed bottom-0 left-0 w-full bg-[#151B2D] border-t border-gray-700 p-8 transform transition-transform duration-300 z-20 ${feedback ? 'translate-y-0' : 'translate-y-full'}`}>
                <div className="max-w-3xl mx-auto">
                    <div className="flex items-center justify-between mb-6">
                        <div className="pr-8">
                            <div className={`text-xl font-bold mb-1 ${feedback?.isCorrect ? 'text-green-400' : 'text-red-400'}`}>
                                {feedback?.isCorrect ? 'Correct Answer!' : 'Incorrect Answer'}
                            </div>
                            <p className="text-gray-400 line-clamp-2">{feedback?.text}</p>
                        </div>
                        <button
                            onClick={nextQuestion}
                            className="px-8 py-3 bg-cyan-500 hover:bg-cyan-400 text-black font-bold rounded-xl transition-colors shrink-0"
                        >
                            {currentIndex < questions.length - 1 ? 'Next Question' : 'Finish Quiz'}
                        </button>
                    </div>

                    {/* AI Remediation Card */}
                    {(isLoadingRemediation || remediation) && (
                        <div className="bg-cyan-500/5 border border-cyan-500/20 rounded-2xl p-6 flex gap-4 animate-in fade-in slide-in-from-bottom-2 duration-500">
                            <div className="w-12 h-12 bg-cyan-500/10 rounded-full flex items-center justify-center shrink-0">
                                {feedback?.isCorrect ? (
                                    <GraduationCap className="text-cyan-400" size={24} />
                                ) : (
                                    <Lightbulb className="text-yellow-400" size={24} />
                                )}
                            </div>
                            <div className="flex-1">
                                <div className="flex items-center gap-2 mb-2">
                                    <span className="text-sm font-bold text-cyan-400 uppercase tracking-wider">
                                        {feedback?.isCorrect ? 'AI Deep Dive' : 'AI Micro-Lesson'}
                                    </span>
                                    {isLoadingRemediation && (
                                        <div className="w-4 h-4 border-2 border-cyan-500/30 border-t-cyan-500 rounded-full animate-spin" />
                                    )}
                                </div>
                                {isLoadingRemediation ? (
                                    <div className="space-y-2">
                                        <div className="h-4 bg-gray-800 rounded w-3/4 animate-pulse" />
                                        <div className="h-4 bg-gray-800 rounded w-1/2 animate-pulse" />
                                    </div>
                                ) : (
                                    <p className="text-gray-300 text-sm leading-relaxed">
                                        {remediation}
                                    </p>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            </div>

            {/* Warning Modal */}
            {showWarning && (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm p-4">
                    <div className="bg-[#151B2D] p-8 rounded-3xl border border-red-500/50 max-w-md text-center shadow-[0_0_50px_rgba(239,68,68,0.3)]">
                        <div className="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
                            <AlertTriangle size={32} className="text-red-500" />
                        </div>
                        <h3 className="text-2xl font-bold text-white mb-2">Warning!</h3>
                        <p className="text-gray-400 mb-6">
                            Tab switching is strictly prohibited. You have used {warnings} of 3 warnings.
                            Further violations will result in immediate disqualification.
                        </p>
                        <button
                            onClick={() => setShowWarning(false)}
                            className="w-full py-3 bg-red-500 hover:bg-red-600 text-white font-bold rounded-xl transition-all"
                        >
                            I Understand
                        </button>
                    </div>
                </div>
            )}

            {/* Quit Confirmation Modal */}
            {showQuitConfirm && (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm p-4">
                    <div className="bg-[#151B2D] p-8 rounded-3xl border border-gray-700 max-w-md text-center shadow-2xl">
                        <div className="w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4">
                            <XCircle size={32} className="text-gray-400" />
                        </div>
                        <h3 className="text-2xl font-bold text-white mb-2">Quit Test?</h3>
                        <p className="text-gray-400 mb-8">
                            Are you sure you want to quit? Your current progress will be submitted as is, and this attempt will be counted.
                        </p>
                        <div className="flex gap-4">
                            <button
                                onClick={() => setShowQuitConfirm(false)}
                                className="flex-1 py-3 bg-gray-800 hover:bg-gray-700 text-white font-bold rounded-xl transition-all"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={() => {
                                    setShowQuitConfirm(false);
                                    finishQuiz();
                                }}
                                className="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white font-bold rounded-xl transition-all shadow-lg shadow-red-500/20"
                            >
                                Yes, Quit
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}




/*******************************************************************************
 * FILE: client/src/app/settings/page.tsx
 *******************************************************************************/

'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useAuthStore } from '../../store/authStore';
import Header from '../../components/layout/Header';
import Sidebar from '../../components/layout/Sidebar';
import { Settings as SettingsIcon, LogOut, Lock, Eye, EyeOff } from 'lucide-react';
import axios from 'axios';

export default function SettingsPage() {
    const { user, logout } = useAuthStore();
    const router = useRouter();
    const [loading, setLoading] = useState(false);
    const [message, setMessage] = useState('');
    const [showPasswords, setShowPasswords] = useState({
        current: false,
        new: false,
        confirm: false
    });

    const [passwordData, setPasswordData] = useState({
        currentPassword: '',
        newPassword: '',
        confirmPassword: ''
    });

    const handlePasswordChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        setPasswordData({ ...passwordData, [e.target.name]: e.target.value });
    };

    const handleChangePassword = async (e: React.FormEvent) => {
        e.preventDefault();
        setLoading(true);
        setMessage('');

        if (passwordData.newPassword !== passwordData.confirmPassword) {
            setMessage('New passwords do not match!');
            setLoading(false);
            return;
        }

        try {
            const token = useAuthStore.getState().token;
            await axios.put(`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000/api'}/auth/change-password`, {
                userId: user?.id,
                currentPassword: passwordData.currentPassword,
                newPassword: passwordData.newPassword
            }, {
                headers: { Authorization: `Bearer ${token}` }
            });

            setMessage('Password changed successfully!');
            setPasswordData({ currentPassword: '', newPassword: '', confirmPassword: '' });
        } catch (error: any) {
            setMessage(error.response?.data?.message || 'Failed to change password.');
            console.error(error);
        } finally {
            setLoading(false);
        }
    };

    const handleLogout = () => {
        logout();
        router.push('/login');
    };

    const togglePasswordVisibility = (field: 'current' | 'new' | 'confirm') => {
        setShowPasswords({ ...showPasswords, [field]: !showPasswords[field] });
    };

    return (
        <div className="min-h-screen bg-[#0B1120] text-white">
            <Sidebar />
            <Header />

            <main className="ml-64 pt-16 p-8">
                <div className="max-w-3xl mx-auto">
                    <h1 className="text-3xl font-bold mb-8 flex items-center gap-3">
                        <SettingsIcon className="text-cyan-400" size={32} />
                        Settings
                    </h1>

                    {/* Change Password Section */}
                    <div className="bg-[#151B2D] rounded-3xl p-8 border border-gray-800 mb-6">
                        <div className="flex items-center gap-3 mb-6">
                            <Lock className="text-purple-400" size={24} />
                            <h2 className="text-xl font-bold">Change Password</h2>
                        </div>

                        {message && (
                            <div className={`mb-6 p-4 rounded-xl ${message.includes('success') ? 'bg-green-500/10 text-green-400' : 'bg-red-500/10 text-red-400'}`}>
                                {message}
                            </div>
                        )}

                        <form onSubmit={handleChangePassword} className="space-y-6">
                            <div>
                                <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Current Password</label>
                                <div className="relative">
                                    <input
                                        type={showPasswords.current ? "text" : "password"}
                                        name="currentPassword"
                                        value={passwordData.currentPassword}
                                        onChange={handlePasswordChange}
                                        className="w-full bg-[#0B1120] border border-gray-700 rounded-xl px-4 py-3 pr-12 focus:border-cyan-500 outline-none transition"
                                        required
                                    />
                                    <button
                                        type="button"
                                        onClick={() => togglePasswordVisibility('current')}
                                        className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 hover:text-white transition"
                                    >
                                        {showPasswords.current ? <EyeOff size={18} /> : <Eye size={18} />}
                                    </button>
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">New Password</label>
                                <div className="relative">
                                    <input
                                        type={showPasswords.new ? "text" : "password"}
                                        name="newPassword"
                                        value={passwordData.newPassword}
                                        onChange={handlePasswordChange}
                                        className="w-full bg-[#0B1120] border border-gray-700 rounded-xl px-4 py-3 pr-12 focus:border-cyan-500 outline-none transition"
                                        required
                                    />
                                    <button
                                        type="button"
                                        onClick={() => togglePasswordVisibility('new')}
                                        className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 hover:text-white transition"
                                    >
                                        {showPasswords.new ? <EyeOff size={18} /> : <Eye size={18} />}
                                    </button>
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Confirm New Password</label>
                                <div className="relative">
                                    <input
                                        type={showPasswords.confirm ? "text" : "password"}
                                        name="confirmPassword"
                                        value={passwordData.confirmPassword}
                                        onChange={handlePasswordChange}
                                        className="w-full bg-[#0B1120] border border-gray-700 rounded-xl px-4 py-3 pr-12 focus:border-cyan-500 outline-none transition"
                                        required
                                    />
                                    <button
                                        type="button"
                                        onClick={() => togglePasswordVisibility('confirm')}
                                        className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 hover:text-white transition"
                                    >
                                        {showPasswords.confirm ? <EyeOff size={18} /> : <Eye size={18} />}
                                    </button>
                                </div>
                            </div>

                            <div className="pt-4">
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="px-8 py-3 bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-400 hover:to-pink-500 text-white font-bold rounded-xl transition-all shadow-lg hover:shadow-purple-500/20"
                                >
                                    {loading ? 'Updating...' : 'Update Password'}
                                </button>
                            </div>
                        </form>
                    </div>

                    {/* Logout Section */}
                    <div className="bg-[#151B2D] rounded-3xl p-8 border border-gray-800">
                        <div className="flex items-center gap-3 mb-4">
                            <LogOut className="text-red-400" size={24} />
                            <h2 className="text-xl font-bold">Logout</h2>
                        </div>
                        <p className="text-gray-400 mb-6">
                            Sign out of your account. You'll need to log in again to access your dashboard.
                        </p>
                        <button
                            onClick={handleLogout}
                            className="px-8 py-3 bg-red-500/10 hover:bg-red-500/20 text-red-400 font-bold rounded-xl border border-red-500/30 hover:border-red-500/50 transition-all"
                        >
                            Logout
                        </button>
                    </div>
                </div>
            </main>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/app/signup/page.tsx
 *******************************************************************************/

'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import axios from 'axios';
import Link from 'next/link';
import { Eye, EyeOff, Loader2, CheckCircle, User, Mail, Lock, BookOpen } from 'lucide-react';

const API = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000/api';

export default function SignupPage() {
    const [form, setForm] = useState({
        name: '',
        email: '',
        password: '',
        confirmPassword: '',
        board: 'Maharashtra State Board',
    });
    const [showPass, setShowPass] = useState(false);
    const [showConfirm, setShowConfirm] = useState(false);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');
    const router = useRouter();

    const passwordStrength = (p: string) => {
        if (p.length === 0) return null;
        if (p.length < 6) return { label: 'Too short', color: 'bg-red-500', width: '25%' };
        if (p.length < 8) return { label: 'Weak', color: 'bg-orange-500', width: '50%' };
        if (!/[A-Z]/.test(p) || !/[0-9]/.test(p)) return { label: 'Good', color: 'bg-yellow-500', width: '75%' };
        return { label: 'Strong', color: 'bg-emerald-500', width: '100%' };
    };
    const strength = passwordStrength(form.password);

    const set = (k: string) => (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) =>
        setForm(f => ({ ...f, [k]: e.target.value }));

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError('');

        if (form.password !== form.confirmPassword) {
            setError('Passwords do not match.');
            return;
        }
        if (form.password.length < 6) {
            setError('Password must be at least 6 characters.');
            return;
        }

        setLoading(true);
        try {
            await axios.post(`${API}/auth/register`, {
                name: form.name,
                email: form.email,
                password: form.password,
                board: form.board,
            });
            // Redirect to "check your email" page ‚Äî do NOT auto-login
            router.push(`/verify-email/pending?email=${encodeURIComponent(form.email)}`);
        } catch (err: any) {
            setError(err.response?.data?.message || 'Registration failed. Please try again.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="min-h-screen bg-[#0B1120] flex items-center justify-center p-4">
            {/* Ambient glow */}
            <div className="fixed inset-0 pointer-events-none overflow-hidden">
                <div className="absolute top-1/4 left-1/3 w-[500px] h-[500px] bg-cyan-500/8 blur-[140px] rounded-full" />
                <div className="absolute bottom-1/3 right-1/4 w-[400px] h-[400px] bg-purple-500/8 blur-[120px] rounded-full" />
            </div>

            <div className="relative z-10 w-full max-w-md">
                {/* Logo */}
                <div className="text-center mb-8">
                    <span className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">
                        YATSYA
                    </span>
                    <p className="text-gray-500 text-sm mt-1">Adaptive Learning Platform</p>
                </div>

                <div className="bg-[#151B2D] border border-gray-800 rounded-3xl p-8 shadow-2xl">
                    <h2 className="text-2xl font-black text-white mb-1">Create Account</h2>
                    <p className="text-gray-500 text-sm mb-6">You'll need to verify your email after signup.</p>

                    {error && (
                        <div className="mb-4 p-3 bg-red-500/10 border border-red-500/30 rounded-xl text-red-400 text-sm">
                            {error}
                        </div>
                    )}

                    <form onSubmit={handleSubmit} className="space-y-4">
                        {/* Name */}
                        <Field icon={User} label="Full Name">
                            <input
                                type="text" value={form.name} onChange={set('name')}
                                placeholder="John Doe" required
                                className="w-full bg-[#0B1120] border border-gray-700 rounded-xl p-3 pl-10 text-white text-sm placeholder-gray-600 focus:border-cyan-500/50 focus:outline-none transition-colors"
                            />
                        </Field>

                        {/* Email */}
                        <Field icon={Mail} label="Email Address">
                            <input
                                type="email" value={form.email} onChange={set('email')}
                                placeholder="you@example.com" required
                                className="w-full bg-[#0B1120] border border-gray-700 rounded-xl p-3 pl-10 text-white text-sm placeholder-gray-600 focus:border-cyan-500/50 focus:outline-none transition-colors"
                            />
                        </Field>

                        {/* Board */}
                        <Field icon={BookOpen} label="Educational Board">
                            <select value={form.board} onChange={set('board')} required
                                className="w-full bg-[#0B1120] border border-gray-700 rounded-xl p-3 pl-10 text-white text-sm focus:border-cyan-500/50 focus:outline-none transition-colors appearance-none cursor-pointer">
                                <option value="Maharashtra State Board">Maharashtra State Board</option>
                                <option value="CBSE">CBSE</option>
                                <option value="ICSE">ICSE</option>
                                <option value="Gujarat Board">Gujarat Board</option>
                                <option value="UP Board">UP Board</option>
                                <option value="Other">Other</option>
                            </select>
                        </Field>

                        {/* Password */}
                        <div>
                            <label className="block text-xs font-bold text-gray-400 mb-1.5 uppercase tracking-wider">Password</label>
                            <div className="relative">
                                <Lock size={15} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" />
                                <input
                                    type={showPass ? 'text' : 'password'}
                                    value={form.password} onChange={set('password')}
                                    placeholder="Min. 6 characters" required minLength={6}
                                    className="w-full bg-[#0B1120] border border-gray-700 rounded-xl p-3 pl-10 pr-10 text-white text-sm placeholder-gray-600 focus:border-cyan-500/50 focus:outline-none transition-colors"
                                />
                                <button type="button" onClick={() => setShowPass(v => !v)}
                                    className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-white transition-colors">
                                    {showPass ? <EyeOff size={15} /> : <Eye size={15} />}
                                </button>
                            </div>
                            {/* Strength bar */}
                            {strength && (
                                <div className="mt-1.5 flex items-center gap-2">
                                    <div className="flex-1 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                        <div className={`h-full rounded-full transition-all ${strength.color}`} style={{ width: strength.width }} />
                                    </div>
                                    <span className={`text-xs font-bold ${strength.color.replace('bg-', 'text-')}`}>{strength.label}</span>
                                </div>
                            )}
                        </div>

                        {/* Confirm Password */}
                        <div>
                            <label className="block text-xs font-bold text-gray-400 mb-1.5 uppercase tracking-wider">Confirm Password</label>
                            <div className="relative">
                                <Lock size={15} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" />
                                <input
                                    type={showConfirm ? 'text' : 'password'}
                                    value={form.confirmPassword} onChange={set('confirmPassword')}
                                    placeholder="Re-enter your password" required
                                    className={`w-full bg-[#0B1120] border rounded-xl p-3 pl-10 pr-10 text-white text-sm placeholder-gray-600 focus:outline-none transition-colors ${form.confirmPassword && form.confirmPassword !== form.password
                                            ? 'border-red-500/60 focus:border-red-500'
                                            : form.confirmPassword && form.confirmPassword === form.password
                                                ? 'border-emerald-500/60 focus:border-emerald-500'
                                                : 'border-gray-700 focus:border-cyan-500/50'
                                        }`}
                                />
                                <button type="button" onClick={() => setShowConfirm(v => !v)}
                                    className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-white transition-colors">
                                    {showConfirm ? <EyeOff size={15} /> : <Eye size={15} />}
                                </button>
                                {form.confirmPassword && form.confirmPassword === form.password && (
                                    <CheckCircle size={15} className="absolute right-9 top-1/2 -translate-y-1/2 text-emerald-400" />
                                )}
                            </div>
                            {form.confirmPassword && form.confirmPassword !== form.password && (
                                <p className="text-red-400 text-xs mt-1">Passwords do not match</p>
                            )}
                        </div>

                        <button type="submit" disabled={loading}
                            className="w-full flex items-center justify-center gap-2 py-3.5 bg-cyan-500 hover:bg-cyan-400 text-black font-black rounded-xl transition-all disabled:opacity-50 mt-2 text-sm">
                            {loading ? <Loader2 size={16} className="animate-spin" /> : null}
                            {loading ? 'Creating Account...' : 'Create Account & Verify Email ‚Üí'}
                        </button>
                    </form>

                    <p className="mt-5 text-center text-sm text-gray-500">
                        Already have an account?{' '}
                        <Link href="/login" className="text-cyan-400 hover:text-cyan-300 font-bold transition-colors">
                            Login
                        </Link>
                    </p>
                </div>
            </div>
        </div>
    );
}

function Field({ icon: Icon, label, children }: { icon: any; label: string; children: React.ReactNode }) {
    return (
        <div>
            <label className="block text-xs font-bold text-gray-400 mb-1.5 uppercase tracking-wider">{label}</label>
            <div className="relative">
                <Icon size={15} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 z-10 pointer-events-none" />
                {children}
            </div>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/app/subjects/page.tsx
 *******************************************************************************/

'use client';

import { useEffect, useState, Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { useAuthStore } from '../../store/authStore';
import { getSubjects, getStandards } from '../../services/contentService';
import Link from 'next/link';
import { ArrowLeft, BookOpen, ChevronRight, Lock, BarChart2 } from 'lucide-react';
import TimeSpentGraph from '../../components/dashboard/TimeSpentGraph';
import DifficultyCompletionGraph from '../../components/dashboard/DifficultyCompletionGraph';
import Sidebar from '../../components/layout/Sidebar';
import Header from '../../components/layout/Header';

interface Level {
    id: string;
    name: string;
    isLocked?: boolean;
}

interface Subtopic {
    id: string;
    name: string;
}

interface Chapter {
    id: string;
    name: string;
    subtopics: Subtopic[];
    levels: Level[];
}

interface Subject {
    id: string;
    name: string;
    standard: string;
    chapters: Chapter[];
}

export default function SubjectsPage() {
    return (
        <Suspense fallback={
            <div className="min-h-screen bg-[#0B1120] flex items-center justify-center">
                <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-cyan-500"></div>
            </div>
        }>
            <SubjectsPageContent />
        </Suspense>
    );
}

function SubjectsPageContent() {
    const { user, isAuthenticated, token } = useAuthStore();
    const router = useRouter();
    const searchParams = useSearchParams();
    const searchQuery = searchParams.get('search')?.toLowerCase() || '';
    const [standards, setStandards] = useState<{ id: string, name: string }[]>([]);
    const [selectedStandard, setSelectedStandard] = useState<string>('8'); // Default to 8
    const [subjects, setSubjects] = useState<Subject[]>([]);
    const [loading, setLoading] = useState(true);
    const [viewStatsSubjectId, setViewStatsSubjectId] = useState<string | null>(null);

    useEffect(() => {
        if (!isAuthenticated) {
            router.push('/login');
            return;
        }

        // Wait for token to be available before fetching
        if (!token) return;

        // Set default standard from user profile if available, otherwise 8
        if (user?.classStandard) {
            const std = user.classStandard.replace(/\D/g, ''); // Extract number just in case
            if (['8', '9', '10'].includes(std)) {
                setSelectedStandard(std);
            }
        }

        const fetchData = async () => {
            try {
                // Fetch standards (though we know them, it's good practice)
                const standardsData = await getStandards();
                setStandards(standardsData);
            } catch (error) {
                console.error('Failed to fetch standards:', error);
                // Fallback
                setStandards([
                    { id: '8', name: 'Standard 8' },
                    { id: '9', name: 'Standard 9' },
                    { id: '10', name: 'Standard 10' }
                ]);
            }
        };

        fetchData();
    }, [isAuthenticated, router, user, token]);

    // Fetch subjects whenever selectedStandard changes
    useEffect(() => {
        const fetchSubjects = async () => {
            setLoading(true);
            try {
                const data = await getSubjects(selectedStandard);
                setSubjects(data);
            } catch (error) {
                console.error('Failed to fetch subjects:', error);
            } finally {
                setLoading(false);
            }
        };

        if (selectedStandard) {
            fetchSubjects();
        }
    }, [selectedStandard]);

    if (!user) return null;

    return (
        <div className="min-h-screen bg-[#0B1120] text-white">
            <Sidebar />
            <Header />

            <main className="ml-0 lg:ml-64 pt-20 p-8 transition-all">
                <div className="max-w-6xl mx-auto space-y-8">
                    <header className="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-12">
                        <div className="flex items-center gap-4">
                            <h1 className="text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-500 tracking-tight">
                                Learning Hub
                            </h1>
                        </div>

                        {/* Standard Selector */}
                        <div className="flex bg-[#151B2D] p-1.5 rounded-2xl border border-gray-800">
                            {['8', '9', '10'].map((std) => (
                                <button
                                    key={std}
                                    onClick={() => setSelectedStandard(std)}
                                    className={`px-6 py-2 rounded-xl text-sm font-bold transition-all ${selectedStandard === std
                                        ? 'bg-gradient-to-r from-cyan-500 to-blue-600 text-white shadow-lg'
                                        : 'text-gray-500 hover:text-white hover:bg-[#1A2333]'
                                        }`}
                                >
                                    Class {std}
                                </button>
                            ))}
                        </div>
                    </header>

                    {loading ? (
                        <div className="flex justify-center items-center h-64">
                            <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-cyan-500"></div>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 p-4">
                            {subjects && subjects.length > 0 ? subjects
                                .filter(subject =>
                                    subject.name.toLowerCase().includes(searchQuery) ||
                                    subject.chapters.some(chapter => chapter.name.toLowerCase().includes(searchQuery))
                                )
                                .map((subject) => (
                                    <div key={subject.id} className="bg-[#151B2D] rounded-3xl overflow-hidden border border-gray-800 shadow-lg hover:shadow-cyan-500/10 transition duration-300 flex flex-col h-full group">
                                        <div className="p-6 flex-grow">
                                            <div className="flex items-center justify-between mb-6">
                                                <div className="flex items-center gap-3">
                                                    <div className="p-3 bg-cyan-500/20 rounded-2xl text-cyan-400 group-hover:scale-110 transition-transform">
                                                        <BookOpen size={24} />
                                                    </div>
                                                    <div>
                                                        <h2 className="text-xl font-bold text-white">{subject.name}</h2>
                                                        <p className="text-[10px] text-cyan-400 font-black uppercase tracking-widest">Class {subject.standard}</p>
                                                    </div>
                                                </div>
                                                <button
                                                    onClick={() => setViewStatsSubjectId(viewStatsSubjectId === subject.id ? null : subject.id)}
                                                    className={`p-2 rounded-xl border transition-all ${viewStatsSubjectId === subject.id ? 'bg-cyan-500 border-cyan-500 text-white' : 'border-gray-800 text-gray-500 hover:text-cyan-400 hover:border-cyan-500/50'}`}
                                                    title="View Analytics"
                                                >
                                                    <BarChart2 size={20} />
                                                </button>
                                            </div>

                                            {viewStatsSubjectId === subject.id ? (
                                                <div className="space-y-4 animate-in fade-in slide-in-from-top-4 duration-300">
                                                    <div className="h-56">
                                                        <TimeSpentGraph subjectId={subject.id} />
                                                    </div>
                                                    <div className="h-56">
                                                        <DifficultyCompletionGraph subjectId={subject.id} />
                                                    </div>
                                                    <button
                                                        onClick={() => setViewStatsSubjectId(null)}
                                                        className="w-full py-3 text-[10px] font-black text-gray-500 hover:text-cyan-400 uppercase tracking-[0.2em] mt-2 transition-colors"
                                                    >
                                                        Close Stats
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="space-y-4">
                                                    {subject.chapters && subject.chapters.length > 0 ? subject.chapters
                                                        .filter(chapter =>
                                                            chapter.name.toLowerCase().includes(searchQuery) ||
                                                            subject.name.toLowerCase().includes(searchQuery)
                                                        )
                                                        .map((chapter) => (
                                                            <div key={chapter.id} className="border-t border-gray-800 pt-4 first:border-0 first:pt-0">
                                                                <div className="flex items-center gap-2 mb-3">
                                                                    <div className="w-1.5 h-1.5 rounded-full bg-cyan-500 shadow-[0_0_5px_rgba(6,182,212,0.8)]"></div>
                                                                    <h3 className="font-bold text-gray-200 text-sm">{chapter.name}</h3>
                                                                </div>
                                                                <div className="space-y-1.5 ml-2 border-l border-gray-800/50 pl-4">
                                                                    {chapter.levels && chapter.levels.length > 0 ? (
                                                                        chapter.levels.map((level: any) => (
                                                                            <div key={level.id}>
                                                                                {level.isLocked ? (
                                                                                    <div className="flex items-center justify-between p-2 rounded-xl bg-[#0B1120]/30 cursor-not-allowed opacity-50 grayscale">
                                                                                        <span className="text-xs text-gray-600">
                                                                                            {level.name}
                                                                                        </span>
                                                                                        <Lock size={12} className="text-gray-700" />
                                                                                    </div>
                                                                                ) : (
                                                                                    <Link
                                                                                        href={`/quiz/${level.id}`}
                                                                                        className="group/item flex items-center justify-between p-2 rounded-xl hover:bg-[#1C2539] transition-all cursor-pointer"
                                                                                    >
                                                                                        <span className="text-xs text-gray-500 group-hover/item:text-cyan-400 transition-colors">
                                                                                            {level.name}
                                                                                        </span>
                                                                                        <ChevronRight size={14} className="text-gray-700 group-hover/item:text-cyan-500 transition-transform group-hover/item:translate-x-1" />
                                                                                    </Link>
                                                                                )}
                                                                            </div>
                                                                        ))
                                                                    ) : chapter.subtopics && chapter.subtopics.length > 0 ? (
                                                                        chapter.subtopics.map((subtopic: any) => (
                                                                            <Link
                                                                                key={subtopic.id}
                                                                                href={`/quiz/${subtopic.id}`}
                                                                                className="group/item flex items-center justify-between p-2 rounded-xl hover:bg-[#1C2539] transition-all cursor-pointer"
                                                                            >
                                                                                <span className="text-xs text-gray-500 group-hover/item:text-cyan-400 transition-colors">
                                                                                    {subtopic.name}
                                                                                </span>
                                                                                <ChevronRight size={14} className="text-gray-700 group-hover/item:text-cyan-500 transition-transform group-hover/item:translate-x-1" />
                                                                            </Link>
                                                                        ))
                                                                    ) : (
                                                                        <p className="text-[10px] text-gray-600 italic py-1 pl-2">Coming Soon</p>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        )) : (
                                                        <div className="flex flex-col items-center justify-center py-8 text-center bg-[#0B1120]/50 rounded-2xl border border-dashed border-gray-800">
                                                            <p className="text-gray-600 text-[10px] font-bold uppercase tracking-wider">No chapters found</p>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )) : (
                                <div className="col-span-full py-20 text-center bg-[#151B2D] rounded-[2.5rem] border border-gray-800 border-dashed">
                                    <div className="inline-flex items-center justify-center w-20 h-20 rounded-3xl bg-[#0B1120] mb-6 text-gray-700 border border-gray-800 shadow-xl">
                                        <BookOpen size={40} />
                                    </div>
                                    <h3 className="text-2xl font-bold text-white mb-2">No content found</h3>
                                    <p className="text-gray-500 text-sm max-w-sm mx-auto">
                                        We haven't uploaded subjects for Standard {selectedStandard} yet. Check back soon!
                                    </p>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            </main>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/app/verify-email/page.tsx
 *******************************************************************************/

'use client';

import { useEffect, useState, Suspense } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';
import { CheckCircle, XCircle, Loader2, Mail } from 'lucide-react';
import Link from 'next/link';

function VerifyEmailContent() {
    const searchParams = useSearchParams();
    const router = useRouter();
    const token = searchParams.get('token');

    const [status, setStatus] = useState<'loading' | 'success' | 'error' | 'no-token'>('loading');
    const [message, setMessage] = useState('');
    const [resending, setResending] = useState(false);
    const [resendEmail, setResendEmail] = useState('');
    const [resendMsg, setResendMsg] = useState('');

    useEffect(() => {
        if (!token) { setStatus('no-token'); return; }

        fetch(`http://localhost:5000/api/auth/verify-email?token=${token}`)
            .then(async res => {
                const data = await res.json();
                if (res.ok) {
                    setStatus('success');
                    setMessage(data.message);
                    // Redirect to login after 3s
                    setTimeout(() => router.push('/login'), 3000);
                } else {
                    setStatus('error');
                    setMessage(data.message || 'Verification failed.');
                }
            })
            .catch(() => { setStatus('error'); setMessage('Network error. Please try again.'); });
    }, [token]);

    const handleResend = async () => {
        if (!resendEmail.trim()) return;
        setResending(true);
        try {
            const res = await fetch('http://localhost:5000/api/auth/resend-verification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: resendEmail })
            });
            const data = await res.json();
            setResendMsg(data.message);
        } catch {
            setResendMsg('Failed to resend. Please try again.');
        } finally {
            setResending(false);
        }
    };

    return (
        <div className="min-h-screen bg-[#0B1120] flex items-center justify-center p-6">
            {/* Ambient */}
            <div className="fixed inset-0 pointer-events-none">
                <div className="absolute top-1/4 left-1/3 w-96 h-96 bg-cyan-500/10 blur-[120px] rounded-full" />
                <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-purple-500/5 blur-[120px] rounded-full" />
            </div>

            <div className="relative z-10 bg-[#151B2D] border border-gray-800 rounded-3xl p-10 max-w-md w-full text-center shadow-2xl">
                {/* Logo */}
                <div className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 mb-8">
                    YATSYA
                </div>

                {status === 'loading' && (
                    <div>
                        <Loader2 size={52} className="animate-spin text-cyan-400 mx-auto mb-4" />
                        <h2 className="text-xl font-bold text-white mb-2">Verifying your email...</h2>
                        <p className="text-gray-500 text-sm">Please wait a moment.</p>
                    </div>
                )}

                {status === 'success' && (
                    <div>
                        <CheckCircle size={52} className="text-emerald-400 mx-auto mb-4" />
                        <h2 className="text-2xl font-black text-white mb-2">Email Verified! üéâ</h2>
                        <p className="text-gray-400 text-sm mb-6">{message}</p>
                        <p className="text-gray-500 text-xs">Redirecting to login in 3 seconds...</p>
                        <Link href="/login" className="inline-block mt-4 px-6 py-3 bg-cyan-500 hover:bg-cyan-400 text-black font-black rounded-xl transition-all text-sm">
                            Go to Login ‚Üí
                        </Link>
                    </div>
                )}

                {status === 'error' && (
                    <div>
                        <XCircle size={52} className="text-red-400 mx-auto mb-4" />
                        <h2 className="text-2xl font-black text-white mb-2">Verification Failed</h2>
                        <p className="text-gray-400 text-sm mb-6">{message}</p>

                        {/* Resend section */}
                        <div className="bg-[#0B1120] border border-gray-700 rounded-2xl p-5 text-left">
                            <p className="text-gray-400 text-sm mb-3 flex items-center gap-2">
                                <Mail size={14} className="text-cyan-400" />
                                Resend verification email
                            </p>
                            <input
                                type="email"
                                placeholder="Enter your email..."
                                value={resendEmail}
                                onChange={e => setResendEmail(e.target.value)}
                                className="w-full bg-[#151B2D] border border-gray-700 rounded-xl p-3 text-white text-sm placeholder-gray-600 focus:border-cyan-500/50 focus:outline-none mb-3"
                            />
                            <button
                                onClick={handleResend}
                                disabled={resending || !resendEmail}
                                className="w-full flex items-center justify-center gap-2 py-2.5 bg-cyan-500 hover:bg-cyan-400 text-black font-black rounded-xl transition-all disabled:opacity-50 text-sm"
                            >
                                {resending ? <Loader2 size={14} className="animate-spin" /> : <Mail size={14} />}
                                {resending ? 'Sending...' : 'Resend Email'}
                            </button>
                            {resendMsg && <p className="text-emerald-400 text-xs mt-2 text-center">{resendMsg}</p>}
                        </div>
                    </div>
                )}

                {status === 'no-token' && (
                    <div>
                        <XCircle size={52} className="text-yellow-400 mx-auto mb-4" />
                        <h2 className="text-2xl font-black text-white mb-2">No Token Provided</h2>
                        <p className="text-gray-400 text-sm mb-6">
                            Please use the verification link sent to your email.
                        </p>
                        <Link href="/login" className="inline-block px-6 py-3 bg-cyan-500 hover:bg-cyan-400 text-black font-black rounded-xl transition-all text-sm">
                            Back to Login
                        </Link>
                    </div>
                )}
            </div>
        </div>
    );
}

export default function VerifyEmailPage() {
    return (
        <Suspense fallback={<div className="min-h-screen bg-[#0B1120] flex items-center justify-center p-6"><Loader2 size={52} className="animate-spin text-cyan-400" /></div>}>
            <VerifyEmailContent />
        </Suspense>
    );
}



/*******************************************************************************
 * FILE: client/src/app/verify-email/pending/page.tsx
 *******************************************************************************/

'use client';

import { useState } from 'react';
import { useSearchParams } from 'next/navigation';
import { Mail, Loader2, CheckCircle, RefreshCcw } from 'lucide-react';
import Link from 'next/link';

export default function VerifyPendingPage() {
    const searchParams = useSearchParams();
    const email = searchParams.get('email') || '';
    const [resending, setResending] = useState(false);
    const [sent, setSent] = useState(false);
    const [error, setError] = useState('');

    const handleResend = async () => {
        setResending(true); setSent(false); setError('');
        try {
            const res = await fetch('http://localhost:5000/api/auth/resend-verification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });
            const data = await res.json();
            if (res.ok) { setSent(true); }
            else { setError(data.message || 'Failed to resend.'); }
        } catch {
            setError('Network error. Please try again.');
        } finally {
            setResending(false);
        }
    };

    return (
        <div className="min-h-screen bg-[#0B1120] flex items-center justify-center p-6">
            {/* Ambient */}
            <div className="fixed inset-0 pointer-events-none">
                <div className="absolute top-1/3 left-1/3 w-[500px] h-[500px] bg-cyan-500/8 blur-[150px] rounded-full" />
                <div className="absolute bottom-1/4 right-1/4 w-[400px] h-[400px] bg-purple-500/8 blur-[120px] rounded-full" />
            </div>

            <div className="relative z-10 w-full max-w-md text-center">
                {/* Logo */}
                <div className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 mb-8">
                    YATSYA
                </div>

                <div className="bg-[#151B2D] border border-gray-800 rounded-3xl p-10 shadow-2xl">
                    {/* Icon */}
                    <div className="w-20 h-20 bg-cyan-500/10 border border-cyan-500/20 rounded-3xl flex items-center justify-center mx-auto mb-6">
                        <Mail size={36} className="text-cyan-400" />
                    </div>

                    <h1 className="text-2xl font-black text-white mb-2">Check Your Email! üìß</h1>
                    <p className="text-gray-400 text-sm mb-1">
                        We sent a verification link to:
                    </p>
                    <p className="text-cyan-400 font-bold text-sm mb-6 break-all">{email || 'your email address'}</p>

                    <div className="bg-[#0B1120] border border-gray-800 rounded-2xl p-5 text-left mb-6 space-y-3">
                        <Step num={1} text="Open your email inbox" />
                        <Step num={2} text='Find the email from "Yatsya Platform"' />
                        <Step num={3} text='Click "Verify My Email" button' />
                        <Step num={4} text="Come back and log in!" />
                    </div>

                    <p className="text-gray-500 text-xs mb-4">
                        Didn't receive the email? Check your <strong className="text-gray-400">spam/junk</strong> folder, or resend below.
                    </p>

                    {sent ? (
                        <div className="flex items-center justify-center gap-2 text-emerald-400 text-sm font-bold py-3">
                            <CheckCircle size={16} />
                            Email resent! Check your inbox.
                        </div>
                    ) : (
                        <button onClick={handleResend} disabled={resending}
                            className="w-full flex items-center justify-center gap-2 py-3 bg-[#0B1120] border border-gray-700 hover:border-cyan-500/50 text-gray-300 hover:text-cyan-400 font-bold rounded-xl transition-all text-sm disabled:opacity-50">
                            {resending ? <Loader2 size={15} className="animate-spin" /> : <RefreshCcw size={15} />}
                            {resending ? 'Sending...' : 'Resend Verification Email'}
                        </button>
                    )}
                    {error && <p className="text-red-400 text-xs mt-2">{error}</p>}

                    <div className="mt-6 pt-6 border-t border-gray-800">
                        <Link href="/login" className="text-gray-500 text-sm hover:text-gray-300 transition-colors">
                            ‚Üê Back to Login
                        </Link>
                    </div>
                </div>
            </div>
        </div>
    );
}

function Step({ num, text }: { num: number; text: string }) {
    return (
        <div className="flex items-center gap-3">
            <div className="w-6 h-6 rounded-full bg-cyan-500/20 border border-cyan-500/30 flex items-center justify-center text-cyan-400 text-xs font-black flex-shrink-0">
                {num}
            </div>
            <span className="text-gray-400 text-sm">{text}</span>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/app/zen-zone/page.tsx
 *******************************************************************************/

'use client';

import { useState, useEffect, useRef } from 'react';
import { Sparkles, Wind, Music, Coffee, Heart, Volume2, BookOpen, ChevronRight, Target, HelpCircle, CheckCircle2, Play, Pause, SkipForward, SkipBack, Lock, Crown, VolumeX, Volume1 } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { getZenRevisionData } from '@/services/analyticsService';
import Sidebar from '@/components/layout/Sidebar';
import Header from '@/components/layout/Header';
import { useAuthStore } from '@/store/authStore';
import Link from 'next/link';

const QUOTES = [
    "You are capable of amazing things.",
    "Stress is temporary, your potential is forever.",
    "One step at a time, one breath at a time.",
    "Your worth is not defined by a single test.",
    "Focus on the progress, not just the result.",
    "You've got this, Champion!",
    "Pause. Breathe. Reset.",
];

// Lofi tracks ‚Äî free ones use royalty-free public audio, pro ones unlock premium vibes
const TRACKS = [
    {
        id: 1,
        title: "Rainy Study Session",
        artist: "Yatsya Lofi",
        duration: "3:42",
        genre: "Lofi Hip-Hop",
        color: "from-cyan-500 to-blue-600",
        isPro: false,
        // Working track
        src: "https://cdn.pixabay.com/audio/2022/05/27/audio_1808fbf07a.mp3",
    },
    {
        id: 2,
        title: "Lofi Girl Chill",
        artist: "Watermello",
        duration: "2:45",
        genre: "Chill Beats",
        color: "from-purple-500 to-pink-600",
        isPro: false,
        src: "https://cdn.pixabay.com/audio/2026/02/13/audio_adff0ddee5.mp3",
    },
    {
        id: 3,
        title: "Ocean Wave Focus",
        artist: "Yatsya Lofi",
        duration: "3:58",
        genre: "Ambient",
        color: "from-emerald-500 to-cyan-600",
        isPro: false,
        src: "https://cdn.pixabay.com/audio/2022/08/02/audio_884fe92c21.mp3",
    },
    {
        id: 4,
        title: "Good Night Lofi",
        artist: "FASSounds",
        duration: "3:20",
        genre: "Lofi Jazz",
        color: "from-orange-500 to-yellow-500",
        isPro: false,
        src: "https://cdn.pixabay.com/audio/2023/07/30/audio_e0908e8569.mp3",
    },
    // PRO TRACKS (NOW FREE)
    {
        id: 5,
        title: "Cherry Blossom Beats",
        artist: "Lofi Library",
        duration: "4:12",
        genre: "Japanese Lofi",
        color: "from-pink-500 to-rose-600",
        isPro: false,
        src: "https://cdn.pixabay.com/audio/2026/01/06/audio_2e752c8e21.mp3",
    },
    {
        id: 6,
        title: "Coffee Chill",
        artist: "Watermello",
        duration: "2:55",
        genre: "Focus Flow",
        color: "from-indigo-500 to-purple-700",
        isPro: false,
        src: "https://cdn.pixabay.com/audio/2025/12/30/audio_c6c6e726a9.mp3",
    },
    {
        id: 7,
        title: "Stellar Ambient",
        artist: "Watermello",
        duration: "3:40",
        genre: "Space Lofi",
        color: "from-violet-500 to-blue-700",
        isPro: false,
        src: "https://cdn.pixabay.com/audio/2025/12/30/audio_6477e71e4c.mp3",
    },
    {
        id: 8,
        title: "Monsoon Rain Lofi",
        artist: "Lofi Music",
        duration: "4:05",
        genre: "Desi Lofi",
        color: "from-teal-500 to-emerald-700",
        isPro: false,
        src: "https://cdn.pixabay.com/audio/2025/12/28/audio_738b7c2f2e.mp3",
    },
];

export default function ZenZonePage() {
    const { user } = useAuthStore();
    const isPro = true; // All users are essentially Pro now that features are free

    const [quoteIndex, setQuoteIndex] = useState(0);
    const [breathingStep, setBreathingStep] = useState('Inhale');
    const [progress, setProgress] = useState(0);
    const [revisionData, setRevisionData] = useState<any>(null);
    const [loading, setLoading] = useState(true);
    const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
    const [showAnswer, setShowAnswer] = useState(false);

    // Music player state
    const [currentTrackIdx, setCurrentTrackIdx] = useState(0);
    const [isPlaying, setIsPlaying] = useState(false);
    const [volume, setVolume] = useState(0.7);
    const [trackProgress, setTrackProgress] = useState(0);
    const [trackDuration, setTrackDuration] = useState(0);
    const [isMuted, setIsMuted] = useState(false);
    const [localTracks, setLocalTracks] = useState<any[]>([]);
    const audioRef = useRef<HTMLAudioElement | null>(null);
    const progressInterval = useRef<NodeJS.Timeout | null>(null);
    const fileInputRef = useRef<HTMLInputElement>(null);

    const ALL_TRACKS = [...TRACKS, ...localTracks];
    const currentTrack = ALL_TRACKS[currentTrackIdx] || TRACKS[0];
    const canPlay = true;

    useEffect(() => {
        const fetchData = async () => {
            try {
                const data = await getZenRevisionData();
                setRevisionData(data);
            } catch (error) {
                console.error("Error fetching Zen data:", error);
            } finally {
                setLoading(false);
            }
        };
        fetchData();
    }, []);

    // Quote rotation
    useEffect(() => {
        const interval = setInterval(() => {
            setQuoteIndex((prev) => (prev + 1) % QUOTES.length);
        }, 8000);
        return () => clearInterval(interval);
    }, []);

    // Breathing Logic (4-4-4 pattern)
    useEffect(() => {
        let step = 'Inhale';
        let p = 0;
        const interval = setInterval(() => {
            p += 2;
            if (p > 100) {
                p = 0;
                if (step === 'Inhale') step = 'Hold';
                else if (step === 'Hold') step = 'Exhale';
                else step = 'Inhale';
                setBreathingStep(step);
            }
            setProgress(p);
        }, 80);
        return () => clearInterval(interval);
    }, []);

    // Audio player logic
    useEffect(() => {
        if (audioRef.current) {
            audioRef.current.pause();
            audioRef.current.src = currentTrack.src;
            audioRef.current.volume = isMuted ? 0 : volume;
            if (isPlaying && canPlay) {
                audioRef.current.play().catch(() => setIsPlaying(false));
            }
        }
    }, [currentTrackIdx, ALL_TRACKS.length]);

    useEffect(() => {
        if (!audioRef.current) return;
        if (isPlaying && canPlay) {
            audioRef.current.play().catch(() => setIsPlaying(false));
        } else {
            audioRef.current.pause();
        }
    }, [isPlaying]);

    useEffect(() => {
        if (audioRef.current) {
            audioRef.current.volume = isMuted ? 0 : volume;
        }
    }, [volume, isMuted]);

    // Track progress
    useEffect(() => {
        if (progressInterval.current) clearInterval(progressInterval.current);
        if (isPlaying) {
            progressInterval.current = setInterval(() => {
                if (audioRef.current) {
                    setTrackProgress(audioRef.current.currentTime);
                    setTrackDuration(audioRef.current.duration || 0);
                }
            }, 500);
        }
        return () => { if (progressInterval.current) clearInterval(progressInterval.current); };
    }, [isPlaying]);

    const handlePlay = (idx: number) => {
        if (idx === currentTrackIdx) {
            setIsPlaying(!isPlaying);
        } else {
            setCurrentTrackIdx(idx);
            setTrackProgress(0);
            setIsPlaying(true);
        }
    };

    const handlePrev = () => {
        const newIdx = (currentTrackIdx - 1 + ALL_TRACKS.length) % ALL_TRACKS.length;
        setCurrentTrackIdx(newIdx);
        setTrackProgress(0);
        setIsPlaying(true);
    };

    const handleNext = () => {
        const newIdx = (currentTrackIdx + 1) % ALL_TRACKS.length;
        setCurrentTrackIdx(newIdx);
        setTrackProgress(0);
        setIsPlaying(true);
    };

    const onFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (file) {
            const url = URL.createObjectURL(file);
            const newTrack = {
                id: `local-${Date.now()}`,
                title: file.name.replace(/\.[^/.]+$/, ""),
                artist: "Your Library",
                duration: "--:--",
                genre: "Local File",
                color: "from-gray-600 to-gray-800",
                isPro: false,
                src: url,
            };
            setLocalTracks((prev) => [...prev, newTrack]);
            setCurrentTrackIdx(ALL_TRACKS.length); // Play the newly added track
            setIsPlaying(true);
        }
    };

    const handleSeek = (e: React.ChangeEvent<HTMLInputElement>) => {
        const val = parseFloat(e.target.value);
        if (audioRef.current) {
            audioRef.current.currentTime = val;
            setTrackProgress(val);
        }
    };

    const formatTime = (sec: number) => {
        if (isNaN(sec)) return '0:00';
        const m = Math.floor(sec / 60);
        const s = Math.floor(sec % 60);
        return `${m}:${s.toString().padStart(2, '0')}`;
    };

    const nextFlashcard = () => {
        setShowAnswer(false);
        setCurrentQuestionIndex((prev) => (prev + 1) % (revisionData?.importantQuestions?.length || 1));
    };

    return (
        <div className="min-h-screen bg-[#0B1120] text-white">
            <audio ref={audioRef} onEnded={handleNext} />
            <input
                type="file"
                ref={fileInputRef}
                onChange={onFileSelect}
                accept="audio/*"
                className="hidden"
            />
            <Sidebar />
            <Header />

            <main className="ml-0 lg:ml-64 pt-20 p-8 transition-all relative">
                {/* Ambient Background */}
                <div className="absolute inset-0 pointer-events-none overflow-hidden">
                    <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-cyan-500/10 blur-[120px] rounded-full animate-pulse"></div>
                    <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-purple-500/10 blur-[120px] rounded-full animate-pulse delay-1000"></div>
                </div>

                <div className="max-w-7xl mx-auto relative z-10">
                    {/* Header */}
                    <header className="mb-12 text-center">
                        <div className="inline-flex items-center gap-2 px-4 py-2 bg-cyan-500/10 border border-cyan-500/20 rounded-full text-cyan-400 text-sm font-bold mb-4">
                            <Sparkles size={16} />
                            ZEN ZONE
                        </div>
                        <h1 className="text-4xl md:text-5xl font-black mb-4 tracking-tight">Personalized Revision Hub</h1>
                        <p className="text-gray-400 text-lg max-w-2xl mx-auto">
                            Relaxing stress-relievers and quick power-revisions for your next exam.{' '}
                            <span className="text-cyan-400 font-bold">100% Free Access</span>
                        </p>
                    </header>

                    <div className="grid grid-cols-1 xl:grid-cols-3 gap-8 items-start">

                        {/* Column 1: Breathing + Lofi Player */}
                        <div className="space-y-8">
                            {/* Guided Breathing */}
                            <div className="bg-[#151B2D] border border-gray-800 rounded-3xl p-8 flex flex-col items-center text-center relative overflow-hidden group hover:border-cyan-500/30 transition-all">
                                <div className="absolute top-4 right-4 bg-cyan-500/20 text-cyan-400 px-3 py-1 rounded-full text-[10px] font-black tracking-widest uppercase">Free Forever</div>
                                <h3 className="text-xl font-bold mb-8 flex items-center gap-3 self-start">
                                    <Wind className="text-cyan-400" />
                                    Breathing Guide
                                </h3>
                                <div className="relative w-48 h-48 mb-8">
                                    <motion.div
                                        animate={{
                                            scale: breathingStep === 'Inhale' ? 1.4 : breathingStep === 'Exhale' ? 1 : 1.4,
                                            opacity: breathingStep === 'Hold' ? 0.8 : 0.5
                                        }}
                                        transition={{ duration: 4, ease: "easeInOut" }}
                                        className="absolute inset-0 bg-cyan-500/20 rounded-full blur-2xl"
                                    />
                                    <motion.div
                                        animate={{ scale: breathingStep === 'Inhale' ? 1.2 : breathingStep === 'Exhale' ? 0.8 : 1.2 }}
                                        transition={{ duration: 4, ease: "easeInOut" }}
                                        className="absolute inset-0 border-4 border-cyan-500/30 rounded-full flex items-center justify-center bg-[#0B1120]/50"
                                    >
                                        <div className="text-center">
                                            <div className="text-2xl font-black text-cyan-400">{breathingStep}</div>
                                        </div>
                                    </motion.div>
                                    <svg className="absolute inset-0 w-full h-full -rotate-90">
                                        <circle cx="96" cy="96" r="90" fill="transparent" stroke="currentColor" strokeWidth="4" className="text-gray-800" />
                                        <circle cx="96" cy="96" r="90" fill="transparent" stroke="currentColor" strokeWidth="4" strokeDasharray={565} strokeDashoffset={565 - (565 * progress) / 100} className="text-cyan-500 transition-all duration-100" />
                                    </svg>
                                </div>
                            </div>

                            {/* NOW PLAYING - Music Player */}
                            <div className="bg-[#151B2D] border border-gray-800 rounded-3xl p-6 space-y-5 relative group hover:border-purple-500/30 transition-all">
                                <div className="flex justify-between items-center">
                                    <h3 className="text-xl font-bold flex items-center gap-2">
                                        <Music className="text-purple-400" />
                                        Focus Beats
                                    </h3>
                                    <div className="bg-purple-500/20 text-purple-400 px-3 py-1 rounded-full text-[10px] font-black tracking-widest uppercase">
                                        {isPlaying ? '‚ñ∂ Live' : 'Paused'}
                                    </div>
                                </div>

                                {/* Album art + info */}
                                <div className={`w-full h-28 bg-gradient-to-br ${currentTrack.color} rounded-2xl flex items-center justify-center relative overflow-hidden`}>
                                    {/* Animated bars visualizer */}
                                    <div className="flex items-end gap-1 h-14">
                                        {[...Array(12)].map((_, i) => (
                                            <motion.div
                                                key={i}
                                                className="w-1.5 bg-white/80 rounded-full"
                                                animate={isPlaying ? {
                                                    height: [`${8 + Math.random() * 40}px`, `${8 + Math.random() * 40}px`, `${8 + Math.random() * 40}px`]
                                                } : { height: '8px' }}
                                                transition={{ duration: 0.5, repeat: Infinity, delay: i * 0.07, repeatType: 'mirror' }}
                                            />
                                        ))}
                                    </div>
                                </div>

                                <div className="text-center">
                                    <div className="font-bold text-white truncate">{currentTrack.title}</div>
                                    <div className="text-xs text-gray-500">{currentTrack.artist} ¬∑ {currentTrack.genre}</div>
                                </div>

                                {/* Progress bar */}
                                <div className="space-y-1">
                                    <input
                                        type="range"
                                        min={0}
                                        max={trackDuration || 100}
                                        value={trackProgress}
                                        onChange={handleSeek}
                                        className="w-full h-1 accent-purple-500 cursor-pointer"
                                    />
                                    <div className="flex justify-between text-[10px] text-gray-500">
                                        <span>{formatTime(trackProgress)}</span>
                                        <span>{formatTime(trackDuration)}</span>
                                    </div>
                                </div>

                                {/* Controls */}
                                <div className="flex items-center justify-between">
                                    <button onClick={handlePrev} className="p-2 text-gray-400 hover:text-white transition-colors">
                                        <SkipBack size={20} />
                                    </button>
                                    <button
                                        onClick={() => canPlay ? setIsPlaying(!isPlaying) : null}
                                        className={`w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition-all ${canPlay ? 'bg-purple-500 hover:bg-purple-400 shadow-purple-500/30' : 'bg-gray-700 cursor-not-allowed'}`}
                                    >
                                        {isPlaying ? <Pause size={20} className="text-white" /> : <Play size={20} className="text-white ml-0.5" />}
                                    </button>
                                    <button onClick={handleNext} className="p-2 text-gray-400 hover:text-white transition-colors">
                                        <SkipForward size={20} />
                                    </button>
                                </div>

                                {/* Volume */}
                                <div className="flex items-center gap-3">
                                    <button onClick={() => setIsMuted(!isMuted)} className="text-gray-500 hover:text-white transition-colors flex-shrink-0">
                                        {isMuted || volume === 0 ? <VolumeX size={16} /> : volume < 0.5 ? <Volume1 size={16} /> : <Volume2 size={16} />}
                                    </button>
                                    <input
                                        type="range"
                                        min={0}
                                        max={1}
                                        step={0.01}
                                        value={isMuted ? 0 : volume}
                                        onChange={(e) => { setVolume(parseFloat(e.target.value)); setIsMuted(false); }}
                                        className="w-full h-1 accent-purple-500 cursor-pointer"
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Column 2: Track List + Quote */}
                        <div className="space-y-8">
                            {/* Track List */}
                            <div className="bg-[#151B2D] border border-gray-800 rounded-3xl p-6">
                                <div className="flex justify-between items-center mb-5">
                                    <h3 className="text-xl font-bold flex items-center gap-2">
                                        <BookOpen className="text-cyan-400" size={20} />
                                        Playlist
                                    </h3>
                                    <button
                                        onClick={() => fileInputRef.current?.click()}
                                        className="text-[10px] font-black tracking-widest uppercase bg-cyan-500/10 text-cyan-400 px-3 py-1.5 rounded-full border border-cyan-500/20 hover:bg-cyan-500 hover:text-white transition-all transform hover:scale-105"
                                    >
                                        + Add Local Track
                                    </button>
                                </div>
                                <div className="space-y-2">
                                    {ALL_TRACKS.map((track, idx) => {
                                        const active = idx === currentTrackIdx;
                                        return (
                                            <div
                                                key={track.id}
                                                onClick={() => handlePlay(idx)}
                                                className={`flex items-center gap-3 p-3 rounded-2xl transition-all cursor-pointer ${active ? 'bg-purple-500/10 border border-purple-500/30' : 'hover:bg-white/5 border border-transparent'}`}
                                            >
                                                {/* Mini color dot / play indicator */}
                                                <div className={`w-10 h-10 rounded-xl bg-gradient-to-br ${track.color} flex items-center justify-center flex-shrink-0 relative`}>
                                                    {active && isPlaying ? (
                                                        <div className="flex items-end gap-0.5 h-5">
                                                            {[...Array(4)].map((_, i) => (
                                                                <motion.div
                                                                    key={i}
                                                                    className="w-0.5 bg-white rounded-full"
                                                                    animate={{ height: [`${4 + Math.random() * 12}px`, `${4 + Math.random() * 12}px`] }}
                                                                    transition={{ duration: 0.4, repeat: Infinity, delay: i * 0.1, repeatType: 'mirror' }}
                                                                />
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <Play size={14} className="text-white ml-0.5" />
                                                    )}
                                                </div>

                                                <div className="flex-1 min-w-0">
                                                    <div className={`font-bold text-sm truncate ${active ? 'text-purple-400' : 'text-white'}`}>{track.title}</div>
                                                    <div className="text-xs text-gray-500 truncate">{track.genre}</div>
                                                </div>

                                                <div className="flex items-center gap-2 flex-shrink-0">
                                                    <span className="text-xs text-gray-600">{track.duration}</span>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* Quote Card */}
                            <div className="bg-gradient-to-br from-purple-500/10 to-blue-500/10 border border-purple-500/20 rounded-3xl p-8 text-center">
                                <AnimatePresence mode="wait">
                                    <motion.div
                                        key={quoteIndex}
                                        initial={{ opacity: 0, y: 10 }}
                                        animate={{ opacity: 1, y: 0 }}
                                        exit={{ opacity: 0, y: -10 }}
                                        className="text-xl font-serif italic text-white/90"
                                    >
                                        "{QUOTES[quoteIndex]}"
                                    </motion.div>
                                </AnimatePresence>
                            </div>
                        </div>

                        {/* Column 3: Quick Revise + Flashcards */}
                        <div className="space-y-8">
                            {/* Quick Revise */}
                            <div className="bg-[#151B2D] border border-gray-800 rounded-3xl p-8 min-h-[300px]">
                                <h3 className="text-2xl font-bold mb-4 flex items-center gap-3">
                                    <Target className="text-orange-400" />
                                    Quick Revise
                                </h3>
                                <p className="text-sm text-gray-500 mb-6">Science-backed review of your weakest topics before the exam.</p>
                                {loading ? (
                                    <div className="space-y-4">
                                        {[1, 2, 3].map(i => <div key={i} className="h-20 bg-gray-800 rounded-2xl animate-pulse" />)}
                                    </div>
                                ) : revisionData?.weakTopics?.length > 0 ? (
                                    <div className="space-y-4">
                                        <p className="text-xs text-gray-600 italic mb-2">üìä Based on your actual quiz performance</p>
                                        {revisionData.weakTopics.map((topic: any, idx: number) => (
                                            <div key={idx} className="group p-5 bg-[#0B1120] border border-gray-800 rounded-2xl hover:border-orange-500/30 transition-all">
                                                <div className="flex justify-between items-start mb-3">
                                                    <div className="flex-1 min-w-0">
                                                        <div className="text-xs font-bold text-orange-400 uppercase tracking-wider mb-1">{topic.subject}</div>
                                                        <div className="text-base font-bold text-white group-hover:text-orange-400 transition-colors truncate">{topic.chapter}</div>
                                                    </div>
                                                    <div className="text-right ml-3 flex-shrink-0">
                                                        <div className="text-sm font-black text-white">{topic.mastery}%</div>
                                                        <div className="text-[10px] text-gray-600 uppercase">Mastery</div>
                                                        {topic.total > 0 && (
                                                            <div className="text-[10px] text-gray-600">{topic.total} attempts</div>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="w-full bg-gray-800 h-1.5 rounded-full overflow-hidden mb-3">
                                                    <div
                                                        className={`h-full rounded-full ${topic.mastery < 40 ? 'bg-red-500' : topic.mastery < 70 ? 'bg-orange-500' : 'bg-emerald-500'}`}
                                                        style={{ width: `${topic.mastery}%` }}
                                                    />
                                                </div>
                                            </div>
                                        ))}
                                        <Link href="/subjects" className="w-full py-4 mt-2 bg-orange-500/10 border border-orange-500/20 text-orange-400 rounded-2xl font-bold flex items-center justify-center gap-2 hover:bg-orange-500 hover:text-white transition-all">
                                            Practise Weak Chapters <ChevronRight size={18} />
                                        </Link>
                                    </div>
                                ) : (
                                    <div className="text-center py-8 text-gray-600 text-sm">
                                        <div className="text-4xl mb-3">üìö</div>
                                        Complete some quizzes first ‚Äî then we'll show your weakest chapters here!
                                    </div>
                                )}
                            </div>

                            {/* Last Minute Flashcards */}
                            <div className="bg-[#151B2D] border border-gray-800 rounded-3xl p-8 flex flex-col min-h-[300px]">
                                <h3 className="text-2xl font-bold mb-4 flex items-center gap-3">
                                    <HelpCircle className="text-emerald-400" />
                                    Last Minute Check
                                </h3>
                                <p className="text-sm text-gray-500 mb-6">High-yield questions for quick mental recall.</p>
                                {loading ? (
                                    <div className="flex-1 flex items-center justify-center">
                                        <div className="w-12 h-12 border-4 border-emerald-500/30 border-t-emerald-500 rounded-full animate-spin" />
                                    </div>
                                ) : (
                                    <div className="flex-1 flex flex-col">
                                        <motion.div
                                            key={currentQuestionIndex + (showAnswer ? '-ans' : '-q')}
                                            initial={{ rotateY: 180, opacity: 0 }}
                                            animate={{ rotateY: 0, opacity: 1 }}
                                            transition={{ duration: 0.4 }}
                                            className={`flex-1 p-6 rounded-2xl border ${showAnswer ? 'bg-emerald-500/5 border-emerald-500/30' : 'bg-[#0B1120] border-gray-700'} flex flex-col items-center justify-center text-center cursor-pointer`}
                                            onClick={() => setShowAnswer(!showAnswer)}
                                        >
                                            <span className="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">
                                                {showAnswer ? '‚úÖ Correct Answer' : `Question ${currentQuestionIndex + 1} of ${revisionData?.importantQuestions?.length}`}
                                            </span>

                                            {showAnswer ? (
                                                <div className="flex flex-col items-center gap-3">
                                                    {/* Correct answer badge */}
                                                    <div className="px-5 py-2.5 bg-emerald-500/20 border border-emerald-500/40 rounded-xl text-emerald-300 font-black text-lg">
                                                        {revisionData?.importantQuestions[currentQuestionIndex]?.correctAnswerText}
                                                    </div>
                                                    {/* AI Explanation */}
                                                    <p className="text-gray-400 text-sm leading-relaxed mt-1">
                                                        {revisionData?.importantQuestions[currentQuestionIndex]?.explanation}
                                                    </p>
                                                </div>
                                            ) : (
                                                <>
                                                    <div className="text-base font-bold text-white">
                                                        {revisionData?.importantQuestions[currentQuestionIndex]?.content}
                                                    </div>
                                                    <div className="mt-6 text-xs text-emerald-400 font-bold uppercase tracking-wider bg-emerald-500/10 px-4 py-2 rounded-full ring-1 ring-emerald-500/30">
                                                        Tap to Reveal Answer
                                                    </div>
                                                </>
                                            )}
                                        </motion.div>
                                        <button
                                            onClick={nextFlashcard}
                                            className="mt-4 py-3 bg-emerald-500 text-black font-black rounded-2xl flex items-center justify-center gap-2 hover:bg-emerald-400 transition-all shadow-lg shadow-emerald-500/20"
                                        >
                                            Next Question <CheckCircle2 size={18} />
                                        </button>
                                    </div>
                                )}
                            </div>

                            {/* Tips Grid */}
                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-[#151B2D] p-5 rounded-2xl border border-gray-800 flex items-center gap-3 group hover:border-orange-500/30 transition-all">
                                    <Coffee className="text-orange-400" size={20} />
                                    <span className="text-xs font-bold text-gray-400">Coffee Break</span>
                                </div>
                                <div className="bg-[#151B2D] p-5 rounded-2xl border border-gray-800 flex items-center gap-3 group hover:border-pink-500/30 transition-all">
                                    <Heart className="text-pink-400" size={20} />
                                    <span className="text-xs font-bold text-gray-400">Self Care</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/components/dashboard/AccuracyChart.tsx
 *******************************************************************************/

'use client';

import { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid } from 'recharts';
import { Crosshair } from 'lucide-react';

const data = [
    { name: 'Quiz 1', accuracy: 65 },
    { name: 'Quiz 2', accuracy: 70 },
    { name: 'Quiz 3', accuracy: 68 },
    { name: 'Quiz 4', accuracy: 75 },
    { name: 'Quiz 5', accuracy: 82 },
    { name: 'Quiz 6', accuracy: 88 },
];

export default function AccuracyChart() {
    return (
        <div className="bg-[#151B2D] p-6 rounded-3xl border border-gray-800 h-full flex flex-col">
            <div className="flex items-center gap-2 mb-6">
                <div className="p-1.5 bg-purple-500/10 rounded-full">
                    <Crosshair size={16} className="text-purple-400" />
                </div>
                <h3 className="font-bold text-white">Accuracy Trend</h3>
            </div>

            <div className="flex-1 min-h-[200px]">
                <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={data}>
                        <CartesianGrid strokeDasharray="3 3" stroke="#374151" vertical={false} />
                        <XAxis
                            dataKey="name"
                            tick={{ fill: '#6b7280', fontSize: 12 }}
                            axisLine={false}
                            tickLine={false}
                            dy={10}
                        />
                        <YAxis
                            hide
                        />
                        <Tooltip
                            contentStyle={{ backgroundColor: '#1F2937', border: 'none', borderRadius: '8px', color: '#fff' }}
                            cursor={{ stroke: '#4b5563', strokeWidth: 1 }}
                        />
                        <Line
                            type="monotone"
                            dataKey="accuracy"
                            stroke="#8b5cf6"
                            strokeWidth={3}
                            dot={{ fill: '#8b5cf6', strokeWidth: 0, r: 4 }}
                            activeDot={{ r: 6, fill: '#fff' }}
                        />
                    </LineChart>
                </ResponsiveContainer>
            </div>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/components/dashboard/DailyPlan.tsx
 *******************************************************************************/

'use client';

import { useEffect, useState } from 'react';
import { TrendingDown, Zap, BookOpen, Loader2 } from 'lucide-react';
import { getDailyPlan } from '../../services/aiService';
import { useAuthStore } from '../../store/authStore';

interface Task {
    subject: string;
    topic: string;
    duration: string;
    type: string;
}

export default function DailyPlan() {
    const [tasks, setTasks] = useState<Task[]>([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const token = useAuthStore.getState().token;
        if (!token) {
            setLoading(false);
            return;
        }

        const fetchPlan = async () => {
            try {
                const data = await getDailyPlan();
                if (data.success && data.plan?.tasks) {
                    setTasks(data.plan.tasks);
                }
            } catch (error: any) {
                if (error.response?.status !== 401) {
                    console.error('Failed to fetch daily plan:', error);
                }
            } finally {
                setLoading(false);
            }
        };

        fetchPlan();
    }, [useAuthStore.getState().token]);

    const getIcon = (type: string = 'default') => {
        switch ((type || 'default').toLowerCase()) {
            case 'weak topic':
            case 'focus':
                return <TrendingDown size={24} className="text-orange-500" />;
            case 'revision':
                return <Zap size={24} className="text-cyan-400" />;
            default:
                return <BookOpen size={24} className="text-purple-400" />;
        }
    };

    const getBgColor = (type: string = 'default') => {
        switch ((type || 'default').toLowerCase()) {
            case 'weak topic':
            case 'focus':
                return 'bg-orange-500/10';
            case 'revision':
                return 'bg-cyan-500/10';
            default:
                return 'bg-purple-500/10';
        }
    };

    const getLabelColor = (type: string = 'default') => {
        switch ((type || 'default').toLowerCase()) {
            case 'weak topic':
            case 'focus':
                return 'text-orange-500';
            case 'revision':
                return 'text-cyan-400';
            default:
                return 'text-purple-400';
        }
    };

    if (loading) {
        return (
            <div className="mt-8">
                <div className="flex items-center gap-2 mb-4">
                    <Loader2 className="w-5 h-5 animate-spin text-cyan-400" />
                    <h3 className="text-lg font-bold text-white">Generating Your Daily Plan...</h3>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {[1, 2].map((i) => (
                        <div key={i} className="bg-[#151B2D] p-5 rounded-2xl border border-gray-800 animate-pulse h-40"></div>
                    ))}
                </div>
            </div>
        );
    }

    if (tasks.length === 0) {
        return null; // Don't show if no tasks generated
    }

    return (
        <div className="mt-8">
            <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-2">
                    <div className="p-1.5 bg-cyan-500/10 rounded-lg">
                        <div className="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></div>
                    </div>
                    <h3 className="text-lg font-bold text-white">Adaptive Daily Plan</h3>
                </div>
                <span className="text-xs text-gray-500 font-medium">Suggested by AI Mentor</span>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {tasks.map((task, index) => (
                    <div key={index} className="bg-[#151B2D] p-5 rounded-2xl border border-gray-800 hover:border-gray-700 transition group cursor-pointer">
                        <div className="flex justify-between items-start mb-4">
                            <div className={`p-3 rounded-xl transition-colors duration-300 ${getBgColor(task.type)}`}>
                                {getIcon(task.type)}
                            </div>
                            <div className="text-right">
                                <span className="block text-2xl font-bold text-white">{task.duration || '20 mins'}</span>
                                <span className="text-[10px] text-gray-500 uppercase tracking-widest">EST. TIME</span>
                            </div>
                        </div>
                        <div>
                            <span className={`text-xs font-bold uppercase tracking-wider mb-1 block ${getLabelColor(task.type)}`}>
                                {task.type || 'Activity'}
                            </span>
                            <h4 className="text-lg font-bold text-white mb-1">{task.subject || 'General'}: {task.topic || 'Revision'}</h4>
                            <p className="text-sm text-gray-400">Personalized for your progress</p>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/components/dashboard/DailyStreak.tsx
 *******************************************************************************/

'use client';

import { Flame } from 'lucide-react';

export default function DailyStreak({ streak = 5 }) {
    const badges = [
        { days: 7, label: '7 Days', achieved: streak >= 7 },
        { days: 15, label: '15 Days', achieved: streak >= 15 },
        { days: 30, label: '30 Days', achieved: streak >= 30 },
    ];

    return (
        <div className="bg-[#151B2D] p-6 rounded-3xl border border-gray-800">
            <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-2">
                    <div className="p-1.5 bg-orange-500/10 rounded-full">
                        <Flame size={16} className="text-orange-500 fill-orange-500" />
                    </div>
                    <h3 className="font-bold text-white">Daily Streak</h3>
                </div>
                <span className="text-2xl font-bold text-white">{streak} üî•</span>
            </div>

            <div className="flex justify-between gap-2">
                {badges.map((badge) => (
                    <div
                        key={badge.days}
                        className={`flex-1 py-3 px-2 rounded-xl border flex flex-col items-center justify-center text-center transition-all ${badge.achieved
                                ? 'bg-orange-500/10 border-orange-500/30 text-orange-400 shadow-[0_0_10px_rgba(249,115,22,0.2)]'
                                : 'bg-[#0B1120] border-gray-800 text-gray-600 opacity-50'
                            }`}
                    >
                        <span className="text-xs font-bold mb-1">{badge.label}</span>
                        <div className={`w-2 h-2 rounded-full ${badge.achieved ? 'bg-orange-500' : 'bg-gray-700'}`}></div>
                    </div>
                ))}
            </div>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/components/dashboard/DifficultyCompletionGraph.tsx
 *******************************************************************************/

'use client';

import { PieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip } from 'recharts';
import { Target } from 'lucide-react';
import { useEffect, useState } from 'react';
import { getDifficultyMastery } from '../../services/analyticsService';

import { useAuthStore } from '../../store/authStore';

const DIFFICULTY_COLORS: Record<string, string> = {
    'EASY': '#10b981',
    'MEDIUM': '#f59e0b',
    'HARD': '#ef4444'
};

export default function DifficultyCompletionGraph({ subjectId, chapterId }: { subjectId?: string, chapterId?: string }) {
    const [data, setData] = useState<any[]>([]);
    const [avgMastery, setAvgMastery] = useState(0);
    const [loading, setLoading] = useState(true);
    const { token } = useAuthStore();

    useEffect(() => {
        if (!token) return;

        const fetchData = async () => {
            try {
                const result = await getDifficultyMastery(subjectId, chapterId);
                const chartData = result.map((item: any) => ({
                    name: item.difficulty,
                    value: item.accuracy,
                    color: DIFFICULTY_COLORS[item.difficulty] || '#374151'
                }));
                setData(chartData);

                const avg = result.length > 0 ?
                    Math.round(result.reduce((acc: number, curr: any) => acc + curr.accuracy, 0) / result.length) : 0;
                setAvgMastery(avg);
            } catch (error: any) {
                if (error.response?.status !== 401) {
                    console.error('Failed to fetch difficulty mastery:', error);
                }
            } finally {
                setLoading(false);
            }
        };

        fetchData();
    }, [subjectId, chapterId, token]);

    if (loading) return <div className="bg-[#151B2D] p-6 rounded-3xl border border-gray-800 h-full animate-pulse" />;

    return (
        <div className="bg-[#151B2D] p-6 rounded-3xl border border-gray-800 h-full flex flex-col">
            <div className="flex items-center gap-2 mb-2">
                <div className="p-1.5 bg-green-500/10 rounded-full">
                    <Target size={16} className="text-green-400" />
                </div>
                <h3 className="font-bold text-white">Mastery by Difficulty</h3>
            </div>

            <div className="flex-1 min-h-[200px] flex items-center justify-center relative">
                {data.some(d => d.value > 0) ? (
                    <>
                        <ResponsiveContainer width="100%" height="100%">
                            <PieChart>
                                <Pie
                                    data={data}
                                    cx="50%"
                                    cy="50%"
                                    innerRadius={45}
                                    outerRadius={65}
                                    paddingAngle={5}
                                    dataKey="value"
                                    stroke="none"
                                >
                                    {data.map((entry, index) => (
                                        <Cell key={`cell-${index}`} fill={entry.color} />
                                    ))}
                                </Pie>
                                <Tooltip
                                    contentStyle={{ backgroundColor: '#1F2937', border: 'none', borderRadius: '8px', color: '#fff' }}
                                />
                                <Legend
                                    verticalAlign="bottom"
                                    height={36}
                                    iconType="circle"
                                    wrapperStyle={{ fontSize: '10px', opacity: 0.7 }}
                                />
                            </PieChart>
                        </ResponsiveContainer>

                        <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <div className="text-center pt-2">
                                <span className="text-xl font-bold text-white">{avgMastery}%</span>
                                <p className="text-[8px] text-gray-500 uppercase font-bold">AVG</p>
                            </div>
                        </div>
                    </>
                ) : (
                    <div className="text-gray-500 text-sm">No mastery data yet</div>
                )}
            </div>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/components/dashboard/MockTestCard.tsx
 *******************************************************************************/

'use client';

import Link from 'next/link';

export default function MockTestCard() {
    return (
        <div className="bg-[#151B2D] p-6 rounded-3xl border border-gray-800 relative overflow-hidden">
            <div className="absolute top-0 right-0 w-2 h-2 bg-pink-500 rounded-full m-6 animate-pulse shadow-[0_0_10px_#ec4899]"></div>

            <h3 className="font-bold text-white mb-6">Live Mock Tests</h3>

            <div className="bg-gradient-to-br from-[#1A2333] to-[#0B1120] rounded-2xl p-5 border border-gray-700/50">
                <span className="text-[10px] font-bold text-cyan-400 uppercase tracking-widest mb-2 block">UPCOMING EXAM</span>
                <h4 className="text-lg font-bold text-white mb-4 leading-tight">All India Science Merit 2024</h4>

                <div className="grid grid-cols-3 gap-2 text-center">
                    <div className="bg-[#0B1120] rounded-lg p-2 border border-gray-800">
                        <span className="block text-xl font-bold text-white">02</span>
                        <span className="text-[9px] text-gray-500 uppercase">DAYS</span>
                    </div>
                    <div className="bg-[#0B1120] rounded-lg p-2 border border-gray-800">
                        <span className="block text-xl font-bold text-white">14</span>
                        <span className="text-[9px] text-gray-500 uppercase">HRS</span>
                    </div>
                    <div className="bg-[#0B1120] rounded-lg p-2 border border-gray-800">
                        <span className="block text-xl font-bold text-white">38</span>
                        <span className="text-[9px] text-gray-500 uppercase">MINS</span>
                    </div>
                </div>

                <div className="mt-4">
                    <Link href="/subjects" className="block w-full text-center py-3 bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 rounded-xl text-white font-bold transition shadow-lg shadow-pink-500/20">
                        Prepare Now
                    </Link>
                </div>
            </div>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/components/dashboard/ProgressChart.tsx
 *******************************************************************************/

'use client';

import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell } from 'recharts';

const data = [
    { day: 'MON', value: 4 },
    { day: 'TUE', value: 6 },
    { day: 'WED', value: 8 }, // Peak
    { day: 'THU', value: 5 },
    { day: 'FRI', value: 9 },
    { day: 'SAT', value: 3 },
    { day: 'SUN', value: 2 },
];

export default function ProgressChart() {
    return (
        <div className="bg-[#151B2D] p-6 rounded-3xl border border-gray-800 h-full flex flex-col">
            <div className="flex justify-between items-center mb-6">
                <h3 className="font-bold text-white">My Progress</h3>
                <div className="flex bg-[#0B1120] rounded-lg p-1 border border-gray-800">
                    <button className="px-3 py-1 bg-cyan-500 text-white text-[10px] font-bold rounded uppercase">Weekly</button>
                    <button className="px-3 py-1 text-gray-500 text-[10px] font-bold rounded hover:text-white uppercase">Monthly</button>
                </div>
            </div>

            <div className="flex-1 min-h-[200px]">
                <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={data}>
                        <XAxis
                            dataKey="day"
                            axisLine={false}
                            tickLine={false}
                            tick={{ fill: '#6B7280', fontSize: 10, fontWeight: 'bold' }}
                            dy={10}
                        />
                        <Tooltip
                            cursor={{ fill: 'rgba(255, 255, 255, 0.05)' }}
                            contentStyle={{ backgroundColor: '#1F2937', border: 'none', borderRadius: '8px', color: '#fff' }}
                        />
                        <Bar dataKey="value" radius={[4, 4, 0, 0]}>
                            {data.map((entry, index) => (
                                <Cell
                                    key={`cell-${index}`}
                                    fill={entry.value >= 8 ? '#22d3ee' : (entry.value >= 5 ? '#a855f7' : '#374151')}
                                />
                            ))}
                        </Bar>
                    </BarChart>
                </ResponsiveContainer>
            </div>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/components/dashboard/ProPlanCard.tsx
 *******************************************************************************/

export default function ProPlanCard() { return null; }



/*******************************************************************************
 * FILE: client/src/components/dashboard/ScholarStatus.tsx
 *******************************************************************************/

'use client';

import { Star, Trophy, Zap, Crown } from 'lucide-react';

interface ScholarStatusProps {
    xp: number;
    rank: number;
    streak: number;
    levelTitle: string;
    nextLevelXp: number;
}

export default function ScholarStatus({
    xp = 1240,
    rank = 14,
    streak = 5,
    levelTitle = 'Gold Scholar',
    nextLevelXp = 3000
}: Partial<ScholarStatusProps>) {

    const progress = Math.min((xp / nextLevelXp) * 100, 100);

    return (
        <div className="bg-[#151B2D] p-6 rounded-3xl border border-gray-800">
            <div className="flex items-center justify-between mb-6">
                <div className="flex items-center gap-2">
                    <div className="p-1.5 bg-yellow-500/10 rounded-full">
                        <Crown size={16} className="text-yellow-500 fill-yellow-500" />
                    </div>
                    <h3 className="font-bold text-white">Scholar Status</h3>
                </div>
                <div className="flex items-center gap-1 text-orange-400 bg-orange-500/10 px-2 py-1 rounded-lg">
                    <Zap size={14} className="fill-orange-400" />
                    <span className="text-xs font-bold">{streak}x Streak</span>
                </div>
            </div>

            <div className="mb-6">
                <div className="flex justify-between items-end mb-2">
                    <div>
                        <span className="text-xs text-gray-500 font-bold uppercase tracking-wider">CURRENT LEVEL</span>
                        <h4 className="text-xl font-bold text-white leading-none mt-1">{levelTitle}</h4>
                    </div>
                    <div className="text-right">
                        <span className="text-xl font-bold text-cyan-400">{Math.round(progress)}%</span>
                        <span className="block text-[10px] text-gray-500 font-bold uppercase">TO NEXT LEVEL</span>
                    </div>
                </div>
                <div className="h-2 bg-[#0B1120] rounded-full overflow-hidden">
                    <div
                        className="h-full bg-gradient-to-r from-cyan-400 to-purple-500 rounded-full shadow-[0_0_10px_rgba(6,182,212,0.5)] transition-all duration-1000"
                        style={{ width: `${progress}%` }}
                    ></div>
                </div>
                <p className="text-center text-[10px] text-gray-500 mt-2 font-medium">{xp} / {nextLevelXp} XP</p>
            </div>

            <div className="flex items-center justify-between bg-[#0B1120] p-3 rounded-xl border border-gray-800/50">
                <div className="flex items-center gap-3">
                    <div className="w-8 h-8 rounded-full bg-cyan-900/20 text-cyan-400 flex items-center justify-center border border-cyan-800">
                        <Trophy size={14} />
                    </div>
                    <div>
                        <p className="text-[10px] text-gray-500 font-bold uppercase">CLASS RANK</p>
                        <p className="text-sm font-bold text-white">#{rank}</p>
                    </div>
                </div>
                <div className="flex items-center gap-3">
                    <div className="w-8 h-8 rounded-full bg-purple-900/20 text-purple-400 flex items-center justify-center border border-purple-800">
                        <Star size={14} />
                    </div>
                    <div>
                        <p className="text-[10px] text-gray-500 font-bold uppercase">TOTAL XP</p>
                        <p className="text-sm font-bold text-white">{xp}</p>
                    </div>
                </div>
            </div>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/components/dashboard/TimeSpentGraph.tsx
 *******************************************************************************/

'use client';

import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell } from 'recharts';
import { Clock } from 'lucide-react';
import { useEffect, useState } from 'react';
import { getTimeSpentAnalytics } from '../../services/analyticsService';

import { useAuthStore } from '../../store/authStore';

const COLORS = ['#06b6d4', '#8b5cf6', '#f59e0b', '#10b981', '#ec4899', '#f97316'];

export default function TimeSpentGraph({ subjectId }: { subjectId?: string }) {
    const [data, setData] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);
    const { token } = useAuthStore();

    useEffect(() => {
        if (!token) return;

        const fetchData = async () => {
            try {
                const result = await getTimeSpentAnalytics(subjectId);
                // Map API result to chart format
                const chartData = result.map((item: any, index: number) => ({
                    name: item.label,
                    minutes: item.value,
                    color: COLORS[index % COLORS.length]
                }));
                setData(chartData);
            } catch (error: any) {
                if (error.response?.status !== 401) {
                    console.error('Failed to fetch time analytics:', error);
                }
            } finally {
                setLoading(false);
            }
        };

        fetchData();
    }, [subjectId, token]);

    if (loading) return <div className="bg-[#151B2D] p-6 rounded-3xl border border-gray-800 h-full animate-pulse" />;

    return (
        <div className="bg-[#151B2D] p-6 rounded-3xl border border-gray-800 h-full flex flex-col">
            <div className="flex items-center gap-2 mb-6">
                <div className="p-1.5 bg-blue-500/10 rounded-full">
                    <Clock size={16} className="text-blue-400" />
                </div>
                <h3 className="font-bold text-white">
                    {subjectId ? 'Chapter-wise Study Time' : 'Time Spent (Subject-wise)'}
                </h3>
            </div>

            <div className="flex-1 min-h-[200px]">
                {data.length > 0 ? (
                    <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={data}>
                            <XAxis
                                dataKey="name"
                                tick={{ fill: '#6b7280', fontSize: 10 }}
                                axisLine={false}
                                tickLine={false}
                            />
                            <YAxis hide />
                            <Tooltip
                                contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #374151', borderRadius: '8px', color: '#fff', fontSize: '12px' }}
                                cursor={{ fill: 'rgba(255, 255, 255, 0.05)' }}
                            />
                            <Bar dataKey="minutes" radius={[4, 4, 0, 0]}>
                                {data.map((entry, index) => (
                                    <Cell key={`cell-${index}`} fill={entry.color} />
                                ))}
                            </Bar>
                        </BarChart>
                    </ResponsiveContainer>
                ) : (
                    <div className="flex flex-col items-center justify-center h-full text-gray-500 text-sm">
                        No study data yet
                    </div>
                )}
            </div>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/components/dashboard/WelcomeBanner.tsx
 *******************************************************************************/

'use client';

import { Flame, ArrowRight, ShieldCheck } from 'lucide-react';
import Link from 'next/link';
import { useAuthStore } from '../../store/authStore';

export default function WelcomeBanner({ streak = 0 }) {
    const { user } = useAuthStore();

    return (
        <div className="bg-[#151B2D] rounded-3xl p-8 relative overflow-hidden border border-gray-800 group">
            {/* Background Decor */}
            <div className="absolute top-0 right-0 w-[400px] h-[400px] bg-gradient-to-br from-blue-600/20 to-purple-600/20 rounded-full blur-3xl -mr-20 -mt-20"></div>

            <div className="relative z-10 max-w-2xl">
                <div className="inline-flex items-center gap-2 bg-[#1A1F33] border border-gray-700 rounded-full px-4 py-1.5 mb-6">
                    <Flame size={14} className="text-pink-500 fill-pink-500" />
                    <span className="text-xs font-bold text-pink-500 uppercase tracking-wider">{streak} Day Streak</span>
                </div>

                <h1 className="text-4xl font-bold text-white mb-8 flex items-center gap-3">
                    Welcome, <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">{user?.name?.split(' ')[0] || 'Student'}</span>!
                </h1>

                <div className="flex gap-4">
                    <Link
                        href="/subjects"
                        className="px-6 py-3 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 text-white font-bold rounded-xl flex items-center gap-2 transition-all shadow-[0_0_20px_rgba(6,182,212,0.3)] hover:shadow-[0_0_25px_rgba(6,182,212,0.5)]"
                    >
                        Continue Learning
                        <ArrowRight size={18} />
                    </Link>
                    <Link
                        href="#reports-section"
                        className="px-6 py-3 bg-[#1A2333] hover:bg-[#232D42] text-white font-semibold rounded-xl border border-gray-700 transition-all"
                    >
                        View Report
                    </Link>
                </div>
            </div>

            {/* Bird Illustration Placeholder/Art */}
            <div className="absolute right-10 top-1/2 -translate-y-1/2 hidden lg:block">
                <div className="relative w-64 h-64">
                    {/* Abstract Geometric Bird constructed with simple CSS similar to design */}
                    <div className="absolute inset-0 flex items-center justify-center">
                        <svg viewBox="0 0 200 200" className="w-full h-full drop-shadow-[0_0_15px_rgba(168,85,247,0.4)]">
                            <path d="M40 100 L100 40 L160 100 L100 160 Z" fill="none" stroke="url(#grad1)" strokeWidth="2" />
                            <path d="M100 40 L160 80 L180 140 L120 180 L60 140 L40 80 Z" fill="url(#grad2)" opacity="0.8" />
                            <defs>
                                <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stopColor="#22d3ee" />
                                    <stop offset="100%" stopColor="#a855f7" />
                                </linearGradient>
                                <linearGradient id="grad2" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stopColor="#3b82f6" stopOpacity="0.5" />
                                    <stop offset="100%" stopColor="#ec4899" stopOpacity="0.5" />
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/components/layout/Header.tsx
 *******************************************************************************/

'use client';

import { useState, useEffect, useRef, Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { Search, Bell, Settings, Command, Menu, X, XCircle, ChevronRight } from 'lucide-react';
import { useAuthStore } from '../../store/authStore';
import Link from 'next/link';
import NotificationDropdown from './NotificationDropdown';

function HeaderContent() {
    const { user } = useAuthStore();
    const router = useRouter();
    const searchParams = useSearchParams();
    const inputRef = useRef<HTMLInputElement>(null);
    const dropdownRef = useRef<HTMLDivElement>(null);

    const urlQuery = searchParams.get('search') || '';
    const [searchQuery, setSearchQuery] = useState(urlQuery);
    const [sidebarOpen, setSidebarOpen] = useState(true);
    const [showResults, setShowResults] = useState(false);
    const [selectedIndex, setSelectedIndex] = useState(0);

    // Sync initial state with window width
    useEffect(() => {
        const checkMobile = () => {
            setSidebarOpen(window.innerWidth >= 1024);
        };
        checkMobile();
        window.addEventListener('resize', checkMobile);
        return () => window.removeEventListener('resize', checkMobile);
    }, []);

    // List of searchable features
    const allFeatures = [
        { name: 'Dashboard', path: '/dashboard', icon: 'üè†', keywords: ['home', 'main', 'stats'] },
        { name: 'Learning Stats', path: '/dashboard#stats-section', icon: 'üìà', keywords: ['xp', 'streak', 'progress', 'scholar'] },
        { name: 'Study Analytics', path: '/dashboard#analytics-section', icon: 'üìä', keywords: ['time spent', 'mastery', 'charts', 'graphs'] },
        { name: 'Quiz Reports', path: '/dashboard#reports-section', icon: 'üìÑ', keywords: ['results', 'history', 'scores', 'reports'] },
        { name: 'AI Mentor', path: '/ai-mentor', icon: 'ü§ñ', keywords: ['chat', 'bot', 'help', 'ask'] },
        { name: 'Forum', path: '/forum', icon: 'üí¨', keywords: ['community', 'posts', 'discussion'] },
        { name: 'Subjects', path: '/subjects', icon: 'üìö', keywords: ['courses', 'chapters', 'topics'] },
        { name: 'Leaderboard', path: '/leaderboard', icon: 'üèÜ', keywords: ['rank', 'top', 'players'] },
        { name: 'Profile', path: '/profile', icon: 'üë§', keywords: ['account', 'user', 'settings'] },
        { name: 'Settings', path: '/settings', icon: '‚öôÔ∏è', keywords: ['preferences', 'config'] },
        { name: 'Zen Zone', path: '/zen-zone', icon: 'üßò', keywords: ['focus', 'music', 'lofi'] },
        { name: 'Admin Panel', path: '/admin', icon: 'üõ°Ô∏è', keywords: ['management', 'users', 'roles'], adminOnly: true },
    ];

    const filteredFeatures = searchQuery.trim() === ''
        ? []
        : allFeatures.filter(f => {
            if (f.adminOnly && user?.role !== 'ADMIN') return false;
            const query = searchQuery.toLowerCase();
            return f.name.toLowerCase().includes(query) ||
                f.keywords.some(k => k.includes(query));
        });

    // ONLY sync input when the actual URL query string changes
    useEffect(() => {
        setSearchQuery(urlQuery);
    }, [urlQuery]);

    // Handle clicks outside of dropdown to close it
    useEffect(() => {
        const handleClickOutside = (event: MouseEvent) => {
            if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
                setShowResults(false);
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    // Sidebar event listener & Shortcuts
    useEffect(() => {
        const handleToggle = (event: any) => {
            setSidebarOpen(event.detail.open);
        };
        window.addEventListener('toggleSidebar', handleToggle);

        const handleKeyDown = (e: KeyboardEvent) => {
            // Keyboard Shortcut: Cmd/Ctrl + K
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                inputRef.current?.focus();
                setShowResults(true);
            }

            // ESC to close
            if (e.key === 'Escape') {
                setShowResults(false);
                inputRef.current?.blur();
            }

            // Arrow navigation
            if (showResults && filteredFeatures.length > 0) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    setSelectedIndex(prev => (prev + 1) % filteredFeatures.length);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    setSelectedIndex(prev => (prev - 1 + filteredFeatures.length) % filteredFeatures.length);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    router.push(filteredFeatures[selectedIndex].path);
                    setShowResults(false);
                    setSearchQuery('');
                }
            }
        };
        window.addEventListener('keydown', handleKeyDown);

        return () => {
            window.removeEventListener('toggleSidebar', handleToggle);
            window.removeEventListener('keydown', handleKeyDown);
        };
    }, [showResults, filteredFeatures, selectedIndex, router]);

    const toggleSidebar = () => {
        const newState = !sidebarOpen;
        setSidebarOpen(newState);
        window.dispatchEvent(new CustomEvent('toggleSidebar', { detail: { open: newState } }));
    };

    const handleSearchSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        if (filteredFeatures.length > 0) {
            router.push(filteredFeatures[selectedIndex].path);
            setShowResults(false);
            setSearchQuery('');
        } else {
            // Fallback to subject search
            router.push(`/subjects?search=${encodeURIComponent(searchQuery)}`);
        }
    };

    const clearSearch = () => {
        setSearchQuery('');
        setShowResults(false);
    };

    return (
        <header className={`h-16 border-b border-gray-800 bg-[#0B1120] flex items-center justify-between px-4 md:px-8 fixed top-0 right-0 z-40 transition-all ${sidebarOpen ? 'lg:left-64 left-0' : 'left-0'}`}>
            {/* Sidebar Toggle */}
            <button
                onClick={toggleSidebar}
                className="text-gray-400 hover:text-cyan-400 transition p-2"
                aria-label="Toggle Sidebar"
            >
                {sidebarOpen ? <X size={24} /> : <Menu size={24} />}
            </button>

            {/* Search */}
            <div className="flex-1 max-w-xl mx-4 relative" ref={dropdownRef}>
                <form onSubmit={handleSearchSubmit}>
                    <div className="relative group">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 group-focus-within:text-cyan-400 transition" size={18} />
                        <input
                            ref={inputRef}
                            type="text"
                            value={searchQuery}
                            onFocus={() => setShowResults(true)}
                            onChange={(e) => {
                                setSearchQuery(e.target.value);
                                setShowResults(true);
                                setSelectedIndex(0);
                            }}
                            placeholder="Type to search features..."
                            className="w-full bg-[#151B2D] border border-gray-700 rounded-xl py-2 pl-10 pr-20 text-sm text-white focus:outline-none focus:border-cyan-500 transition-all placeholder:text-gray-600 focus:ring-1 focus:ring-cyan-500/30"
                        />
                        <div className="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-2">
                            {searchQuery && (
                                <button
                                    type="button"
                                    onClick={clearSearch}
                                    className="text-gray-500 hover:text-red-400 transition p-1"
                                >
                                    <XCircle size={16} />
                                </button>
                            )}
                            <div className="hidden sm:flex items-center gap-1 text-[10px] text-gray-500 border border-gray-700 px-1.5 py-0.5 rounded bg-gray-900 pointer-events-none">
                                <Command size={10} />
                                <span>K</span>
                            </div>
                        </div>
                    </div>
                </form>

                {/* Search Results Dropdown */}
                {showResults && searchQuery.trim() !== '' && (
                    <div className="absolute top-full left-0 right-0 mt-2 bg-[#1A2333] border border-gray-700 rounded-xl shadow-2xl overflow-hidden z-50 animate-in fade-in slide-in-from-top-2 duration-200">
                        {filteredFeatures.length > 0 ? (
                            <div className="py-2">
                                <div className="px-3 py-1 text-[10px] uppercase font-bold text-gray-500 tracking-wider">
                                    Quick Navigation
                                </div>
                                {filteredFeatures.map((feature, index) => (
                                    <button
                                        key={feature.path}
                                        onClick={() => {
                                            router.push(feature.path);
                                            setShowResults(false);
                                            setSearchQuery('');
                                        }}
                                        onMouseEnter={() => setSelectedIndex(index)}
                                        className={`w-full flex items-center gap-3 px-4 py-3 transition-all ${index === selectedIndex ? 'bg-cyan-500/10 text-cyan-400' : 'text-gray-300 hover:bg-gray-800'}`}
                                    >
                                        <span className="text-lg">{feature.icon}</span>
                                        <div className="flex-1 text-left">
                                            <p className="text-sm font-medium">{feature.name}</p>
                                        </div>
                                        {index === selectedIndex && (
                                            <ChevronRight size={14} className="opacity-50" />
                                        )}
                                    </button>
                                ))}
                            </div>
                        ) : (
                            <div className="p-4 text-center">
                                <p className="text-sm text-gray-500 italic">No features found for "{searchQuery}"</p>
                                <button
                                    onClick={() => router.push(`/subjects?search=${encodeURIComponent(searchQuery)}`)}
                                    className="mt-2 text-xs text-cyan-500 hover:underline"
                                >
                                    Search for topics in Subjects instead ‚Üí
                                </button>
                            </div>
                        )}
                    </div>
                )}
            </div>

            {/* Right Actions */}
            <div className="flex items-center gap-3 md:gap-6">
                <div className="flex items-center gap-2 md:gap-4 text-gray-400">
                    <NotificationDropdown />
                    <Link href="/settings" className="hover:text-cyan-400 transition p-2">
                        <Settings size={20} />
                    </Link>
                </div>

                <div className="h-8 w-[1px] bg-gray-800 hidden sm:block"></div>

                <div className="flex items-center gap-3">
                    <div className="text-right hidden xl:block">
                        <p className="text-sm font-bold text-white max-w-[120px] truncate">{user?.name || 'Student'}</p>
                    </div>
                    <Link href="/profile" className="block shrink-0">
                        <div className="w-9 h-9 md:w-10 md:h-10 rounded-full bg-gradient-to-r from-cyan-500 to-blue-600 p-[2px] transition hover:shadow-[0_0_15px_rgba(6,182,212,0.4)]">
                            <div className="w-full h-full rounded-full bg-[#0B1120] flex items-center justify-center overflow-hidden">
                                <img
                                    src={user?.profilePhoto || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user?.email || 'default'}`}
                                    alt="Profile"
                                    className="w-full h-full object-cover"
                                />
                            </div>
                        </div>
                    </Link>
                </div>
            </div>
        </header>
    );
}

export default function Header() {
    return (
        <Suspense fallback={<header className="h-16 bg-[#0B1120] border-b border-gray-800 fixed top-0 right-0 left-64 z-40" />}>
            <HeaderContent />
        </Suspense>
    );
}



/*******************************************************************************
 * FILE: client/src/components/layout/NotificationDropdown.tsx
 *******************************************************************************/

'use client';

import { useState, useEffect } from 'react';
import { Bell, Flame, Bird, Info, Check } from 'lucide-react';
import { getNotifications, syncNotifications, markAsRead } from '../../services/notificationService';
import { useAuthStore } from '../../store/authStore';

export default function NotificationDropdown() {
    const [notifications, setNotifications] = useState<any[]>([]);
    const [isOpen, setIsOpen] = useState(false);
    const { token } = useAuthStore();

    const fetchNotifications = async () => {
        if (!token) return;

        try {
            const data = await syncNotifications();
            setNotifications(data);
        } catch (error: any) {
            if (error.response?.status !== 401) {
                console.error('Error fetching notifications:', error);
            }
        }
    };

    useEffect(() => {
        if (!token) {
            setNotifications([]);
            return;
        }

        fetchNotifications();
        // Polling every 5 minutes
        const interval = setInterval(fetchNotifications, 5 * 60 * 1000);
        return () => clearInterval(interval);
    }, [token]);

    const handleMarkAsRead = async (id: string) => {
        try {
            await markAsRead(id);
            setNotifications(prev => prev.map(n => n.id === id ? { ...n, isRead: true } : n));
        } catch (error) {
            console.error('Error marking as read:', error);
        }
    };

    const unreadCount = notifications.filter(n => !n.isRead).length;

    const getIcon = (type: string) => {
        switch (type) {
            case 'STREAK': return <Flame className="text-orange-500" size={18} />;
            case 'NUDGE': return <Bird className="text-cyan-400" size={18} />;
            case 'REMINDER': return <Bell className="text-blue-400" size={18} />;
            default: return <Info className="text-gray-400" size={18} />;
        }
    };

    return (
        <div className="relative">
            <button
                onClick={() => setIsOpen(!isOpen)}
                className="text-gray-400 hover:text-cyan-400 transition relative p-2 rounded-full hover:bg-gray-800"
            >
                <Bell size={20} />
                {unreadCount > 0 && (
                    <span className="absolute top-1.5 right-1.5 w-4 h-4 bg-red-500 rounded-full border border-[#0B1120] text-[10px] flex items-center justify-center text-white font-bold">
                        {unreadCount}
                    </span>
                )}
            </button>

            {isOpen && (
                <>
                    <div className="fixed inset-0 z-40" onClick={() => setIsOpen(false)}></div>
                    <div className="absolute right-0 mt-3 w-80 bg-[#151B2D] border border-gray-700 rounded-2xl shadow-2xl z-50 overflow-hidden animate-in fade-in slide-in-from-top-2 duration-200">
                        <div className="p-4 border-b border-gray-800 flex items-center justify-between bg-[#1A2333]">
                            <h3 className="text-sm font-bold text-white">Notifications</h3>
                            <span className="text-[10px] text-gray-500 uppercase tracking-widest">{unreadCount} Unread</span>
                        </div>

                        <div className="max-h-[400px] overflow-y-auto custom-scrollbar">
                            {notifications.length === 0 ? (
                                <div className="p-8 text-center text-gray-500">
                                    <Bell size={32} className="mx-auto mb-2 opacity-20" />
                                    <p className="text-xs">All caught up!</p>
                                </div>
                            ) : (
                                notifications.map((n) => (
                                    <div
                                        key={n.id}
                                        className={`p-4 border-b border-gray-800/50 hover:bg-[#1A2333] transition-colors group relative ${!n.isRead ? 'bg-[#1A2333]/30' : ''}`}
                                    >
                                        <div className="flex gap-3">
                                            <div className="mt-1 shrink-0">{getIcon(n.type)}</div>
                                            <div className="flex-1">
                                                <div className="flex items-center justify-between mb-0.5">
                                                    <h4 className={`text-xs font-bold ${!n.isRead ? 'text-white' : 'text-gray-400'}`}>{n.title}</h4>
                                                    {!n.isRead && (
                                                        <button
                                                            onClick={() => handleMarkAsRead(n.id)}
                                                            className="text-cyan-500 opacity-0 group-hover:opacity-100 transition-opacity p-1"
                                                            title="Mark as read"
                                                        >
                                                            <Check size={12} />
                                                        </button>
                                                    )}
                                                </div>
                                                <p className="text-[11px] text-gray-400 leading-relaxed font-medium">{n.message}</p>
                                                <span className="text-[9px] text-gray-600 mt-2 block">{new Date(n.createdAt).toLocaleDateString()}</span>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>

                        <div className="p-3 bg-[#1A2333] border-t border-gray-800 text-center">
                            <button className="text-[10px] font-bold text-cyan-400 hover:text-cyan-300 transition uppercase tracking-widest">
                                View Activity Log
                            </button>
                        </div>
                    </div>
                </>
            )}
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/components/layout/Sidebar.tsx
 *******************************************************************************/

'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { LayoutDashboard, BookOpen, Sparkles, Zap, MessageSquare, BarChart2, Settings, ShieldCheck, User, CheckCircle, Loader2, X, GraduationCap } from 'lucide-react';
import { useAuthStore } from '../../store/authStore';

const menuItems = [
    { icon: LayoutDashboard, label: 'Dashboard', href: '/dashboard' },
    { icon: BookOpen, label: 'My Courses', href: '/subjects' },
    { icon: Sparkles, label: 'Zen Zone', href: '/zen-zone' },
    { icon: Zap, label: 'AI Mentor', href: '/ai-mentor' },
    { icon: GraduationCap, label: 'Mentors', href: '/mentors' },
    { icon: MessageSquare, label: 'Forum', href: '/forum' },
    { icon: BarChart2, label: 'Analytics', href: '/analytics' },
    { icon: User, label: 'Profile', href: '/profile' },
    { icon: Settings, label: 'Settings', href: '/settings' },
];

export default function Sidebar() {
    const pathname = usePathname();
    const [isOpen, setIsOpen] = useState(true);
    const { user, login, token } = useAuthStore();
    const [upgrading, setUpgrading] = useState(false);
    const [isMobile, setIsMobile] = useState(false);

    // Initial state and resize handler
    useEffect(() => {
        const checkMobile = () => {
            const mobile = window.innerWidth < 1024;
            setIsMobile(mobile);
            // On mobile, start closed. On desktop, start open.
            const initialState = !mobile;
            setIsOpen(initialState);
            window.dispatchEvent(new CustomEvent('toggleSidebar', { detail: { open: initialState } }));
        };

        checkMobile();
        window.addEventListener('resize', checkMobile);
        return () => window.removeEventListener('resize', checkMobile);
    }, []);

    // Close sidebar on mobile when navigating
    useEffect(() => {
        if (isMobile && isOpen) {
            setIsOpen(false);
            window.dispatchEvent(new CustomEvent('toggleSidebar', { detail: { open: false } }));
        }
    }, [pathname]);

    const toggleSidebar = () => {
        const newState = !isOpen;
        setIsOpen(newState);
        window.dispatchEvent(new CustomEvent('toggleSidebar', { detail: { open: newState } }));
    };

    // Dynamic menu items based on role
    const filteredMenuItems = [...menuItems];
    if (user?.role === 'ADMIN') {
        filteredMenuItems.push({ icon: ShieldCheck, label: 'Admin Panel', href: '/admin' });
    }

    useEffect(() => {
        const handleToggle = (event: any) => {
            setIsOpen(event.detail.open);
        };

        window.addEventListener('toggleSidebar', handleToggle);
        return () => window.removeEventListener('toggleSidebar', handleToggle);
    }, []);

    return (
        <>
            {/* Mobile Backdrop */}
            {isOpen && isMobile && (
                <div
                    className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[45] lg:hidden"
                    onClick={toggleSidebar}
                />
            )}

            <aside
                className={`bg-[#0B1120] text-gray-400 flex flex-col h-screen border-r border-gray-800 fixed left-0 top-0 z-50 transition-all duration-300 transform ${isOpen ? 'translate-x-0 w-64' : '-translate-x-full w-64'
                    } ${isMobile ? 'shadow-2xl' : ''}`}
            >
                {/* Brand & Close Button (Mobile) */}
                <div className="p-6 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className="w-10 h-10 flex-shrink-0 relative group">
                            <img
                                src="/sidebar-logo.jpg?v=2"
                                alt="Yatsya Logo"
                                className="w-full h-full object-contain relative z-10 rounded-lg"
                            />
                        </div>
                        <div className="flex flex-col">
                            <h1 className="text-lg font-bold text-white tracking-wide leading-none">YATSYA</h1>
                        </div>
                    </div>
                    {isMobile && (
                        <button
                            onClick={toggleSidebar}
                            className="p-2 text-gray-500 hover:text-white lg:hidden"
                        >
                            <X size={20} />
                        </button>
                    )}
                </div>

                {/* Navigation */}
                <nav className="flex-1 px-4 space-y-2 mt-4">
                    {filteredMenuItems.map((item) => {
                        const isActive = pathname === item.href;
                        return (
                            <Link
                                key={item.href}
                                href={item.href}
                                className={`flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group ${isActive
                                    ? 'bg-cyan-500 text-white shadow-[0_0_15px_rgba(6,182,212,0.5)]'
                                    : 'hover:bg-[#1A2333] hover:text-white'
                                    }`}
                            >
                                <item.icon size={20} className={isActive ? 'text-white' : 'text-gray-500 group-hover:text-cyan-400'} />
                                <span className="font-medium">{item.label}</span>
                            </Link>
                        );
                    })}
                </nav>
            </aside>
        </>
    );
}



/*******************************************************************************
 * FILE: client/src/components/PhotoCropModal.tsx
 *******************************************************************************/

'use client';

import { useState, useRef } from 'react';
import ReactCrop, { Crop, PixelCrop } from 'react-image-crop';
import 'react-image-crop/dist/ReactCrop.css';
import { X, Upload } from 'lucide-react';

interface PhotoCropModalProps {
    isOpen: boolean;
    onClose: () => void;
    onSave: (croppedImageUrl: string) => void;
}

export default function PhotoCropModal({ isOpen, onClose, onSave }: PhotoCropModalProps) {
    const [imgSrc, setImgSrc] = useState('');
    const [crop, setCrop] = useState<Crop>({
        unit: '%',
        width: 50,
        height: 50,
        x: 25,
        y: 25
    });
    const [completedCrop, setCompletedCrop] = useState<PixelCrop>();
    const imgRef = useRef<HTMLImageElement>(null);
    const fileInputRef = useRef<HTMLInputElement>(null);

    const onSelectFile = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files.length > 0) {
            const reader = new FileReader();
            reader.addEventListener('load', () =>
                setImgSrc(reader.result?.toString() || '')
            );
            reader.readAsDataURL(e.target.files[0]);
        }
    };

    const getCroppedImg = (): string | null => {
        if (!completedCrop || !imgRef.current) return null;

        const canvas = document.createElement('canvas');
        const image = imgRef.current;
        const scaleX = image.naturalWidth / image.width;
        const scaleY = image.naturalHeight / image.height;

        canvas.width = completedCrop.width;
        canvas.height = completedCrop.height;
        const ctx = canvas.getContext('2d');

        if (!ctx) return null;

        ctx.drawImage(
            image,
            completedCrop.x * scaleX,
            completedCrop.y * scaleY,
            completedCrop.width * scaleX,
            completedCrop.height * scaleY,
            0,
            0,
            completedCrop.width,
            completedCrop.height
        );

        return canvas.toDataURL('image/jpeg', 0.9);
    };

    const handleSave = () => {
        const croppedImage = getCroppedImg();
        if (croppedImage) {
            onSave(croppedImage);
            handleClose();
        }
    };

    const handleClose = () => {
        setImgSrc('');
        setCrop({ unit: '%', width: 50, height: 50, x: 25, y: 25 });
        setCompletedCrop(undefined);
        onClose();
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
            <div className="bg-[#151B2D] rounded-3xl border border-gray-800 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div className="p-6 border-b border-gray-800 flex items-center justify-between">
                    <h2 className="text-xl font-bold text-white">Upload & Crop Photo</h2>
                    <button onClick={handleClose} className="text-gray-400 hover:text-white transition">
                        <X size={24} />
                    </button>
                </div>

                <div className="p-6 space-y-6">
                    {!imgSrc ? (
                        <div className="text-center">
                            <input
                                ref={fileInputRef}
                                type="file"
                                accept="image/*"
                                onChange={onSelectFile}
                                className="hidden"
                            />
                            <button
                                onClick={() => fileInputRef.current?.click()}
                                className="px-8 py-4 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 text-white font-bold rounded-xl flex items-center gap-3 mx-auto transition-all shadow-lg"
                            >
                                <Upload size={20} />
                                Select Photo
                            </button>
                            <p className="text-gray-400 text-sm mt-4">Choose an image to upload and crop</p>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            <ReactCrop
                                crop={crop}
                                onChange={(c) => setCrop(c)}
                                onComplete={(c) => setCompletedCrop(c)}
                                aspect={1}
                                circularCrop
                            >
                                <img
                                    ref={imgRef}
                                    src={imgSrc}
                                    alt="Crop preview"
                                    className="max-w-full h-auto"
                                />
                            </ReactCrop>

                            <div className="flex gap-4 justify-end">
                                <button
                                    onClick={() => fileInputRef.current?.click()}
                                    className="px-6 py-2 bg-[#1A2333] hover:bg-[#232D42] text-white font-semibold rounded-xl border border-gray-700 transition"
                                >
                                    Choose Different Photo
                                </button>
                                <button
                                    onClick={handleSave}
                                    disabled={!completedCrop}
                                    className="px-8 py-2 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 text-white font-bold rounded-xl transition-all shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    Save Photo
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}



/*******************************************************************************
 * FILE: client/src/services/adminService.ts
 *******************************************************************************/

import axios from 'axios';
import { useAuthStore } from '../store/authStore';

const API_URL = `${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000/api'}/admin`;

const api = axios.create({
    baseURL: API_URL,
});

api.interceptors.request.use((config) => {
    const token = useAuthStore.getState().token;
    if (token) {
        config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
});

export const getAdminStats = async () => {
    const response = await api.get('/stats');
    return response.data;
};

export const getAllUsers = async () => {
    const response = await api.get('/users');
    return response.data;
};

export const updateUserRole = async (userId: string, role: string) => {
    const response = await api.patch(`/users/${userId}/role`, { role });
    return response.data;
};



/*******************************************************************************
 * FILE: client/src/services/aiService.ts
 *******************************************************************************/

import axios from 'axios';
import { useAuthStore } from '../store/authStore';

const API_URL = `${process.env.NEXT_PUBLIC_API_URL || 'http://127.0.0.1:5000/api'}/ai/`;

const api = axios.create({
    baseURL: API_URL,
});

api.interceptors.request.use((config) => {
    const token = useAuthStore.getState().token;
    if (token) {
        config.headers.Authorization = `Bearer ${token}`;
    } else {
        // Return a Promise.reject or a custom signal to stop the request
        // But better is to let the component handle it or return empty data
    }
    return config;
});

export const sendChatMessage = async (message: string, userContext?: any) => {
    const token = useAuthStore.getState().token;
    if (!token) return null;
    const response = await api.post('chat', { message, userContext });
    return response.data;
};

export const getDailyPlan = async () => {
    const token = useAuthStore.getState().token;
    if (!token) return { success: false, plan: null };
    const response = await api.get('daily-plan');
    return response.data;
};

export const fetchRemediation = async (questionId: string, type: 'UPGRADE' | 'DOWNGRADE') => {
    const token = useAuthStore.getState().token;
    if (!token) return null;
    const response = await api.post('remediation', { questionId, type });
    return response.data;
};



/*******************************************************************************
 * FILE: client/src/services/analyticsService.ts
 *******************************************************************************/

import axios from 'axios';
import { useAuthStore } from '../store/authStore';

const API_URL = `${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000/api'}/analytics`;

// Setup axios instance with interceptor for auth token
const api = axios.create({
    baseURL: API_URL,
});

api.interceptors.request.use((config) => {
    const token = useAuthStore.getState().token;
    if (token) {
        config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
});

export const getTimeSpentAnalytics = async (subjectId?: string) => {
    const token = useAuthStore.getState().token;
    if (!token) return [];
    const response = await api.get('/time-spent', {
        params: { subjectId }
    });
    return response.data;
};

export const getAccuracyTrend = async () => {
    const token = useAuthStore.getState().token;
    if (!token) return [];
    const response = await api.get('/accuracy-trend');
    return response.data;
};

export const getDifficultyMastery = async (subjectId?: string, chapterId?: string) => {
    const token = useAuthStore.getState().token;
    if (!token) return [];
    const response = await api.get('/difficulty-mastery', {
        params: { subjectId, chapterId }
    });
    return response.data;
};

export const getRankProgression = async () => {
    const token = useAuthStore.getState().token;
    if (!token) return [];
    const response = await api.get('/rank-progression');
    return response.data;
};

export const getZenRevisionData = async () => {
    const token = useAuthStore.getState().token;
    if (!token) return null;
    const response = await api.get('/zen-revision');
    return response.data;
};



/*******************************************************************************
 * FILE: client/src/services/contentService.ts
 *******************************************************************************/

import axios from 'axios';
import { useAuthStore } from '../store/authStore';

const API_URL = `${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000/api'}/content`;

// Setup axios instance with interceptor for auth token
const api = axios.create({
    baseURL: API_URL,
});

api.interceptors.request.use((config) => {
    const token = useAuthStore.getState().token;
    if (token) {
        config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
});

export const getStandards = async () => {
    const response = await api.get('/standards');
    return response.data;
};

export const getSubjects = async (standard?: string) => {
    const url = standard ? `/subjects?standard=${standard}` : '/subjects';
    const response = await api.get(url);
    return response.data;
};

export const getQuestionsBySubtopic = async (subtopicId: string) => {
    const token = useAuthStore.getState().token;
    if (!token) return [];
    const response = await api.get(`/questions/${subtopicId}`);
    return response.data;
};



/*******************************************************************************
 * FILE: client/src/services/forumService.ts
 *******************************************************************************/

import axios from 'axios';
import { useAuthStore } from '../store/authStore';

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000/api';

const getAuthHeader = () => {
    const token = useAuthStore.getState().token;
    if (!token) return {};
    return { headers: { Authorization: `Bearer ${token}` } };
};

export const getPosts = async (filters: any = {}) => {
    const authHeader = getAuthHeader();
    if (!authHeader.headers) return [];

    const params = new URLSearchParams();
    if (filters.subjectId) params.append('subjectId', filters.subjectId);
    if (filters.standard) params.append('standard', filters.standard);
    if (filters.board) params.append('board', filters.board);
    if (filters.sortBy) params.append('sortBy', filters.sortBy);

    const response = await axios.get(`${API_URL}/forum/posts?${params.toString()}`, authHeader);
    return response.data;
};

export const createPost = async (data: any) => {
    const authHeader = getAuthHeader();
    if (!authHeader.headers) return null;

    const response = await axios.post(`${API_URL}/forum/posts`, data, {
        headers: {
            ...authHeader.headers,
            'Content-Type': 'multipart/form-data',
        },
    });
    return response.data;
};

export const getPost = async (id: string) => {
    const authHeader = getAuthHeader();
    if (!authHeader.headers) return null;

    const response = await axios.get(`${API_URL}/forum/posts/${id}`, authHeader);
    return response.data;
};

export const createReply = async (postId: string, content: string) => {
    const authHeader = getAuthHeader();
    if (!authHeader.headers) return null;

    const response = await axios.post(`${API_URL}/forum/posts/${postId}/reply`, { postId, content }, authHeader);
    return response.data;
};

export const likePost = async (id: string) => {
    const authHeader = getAuthHeader();
    if (!authHeader.headers) return null;

    const response = await axios.post(`${API_URL}/forum/posts/${id}/like`, {}, authHeader);
    return response.data;
};



/*******************************************************************************
 * FILE: client/src/services/leaderboardService.ts
 *******************************************************************************/

import axios from 'axios';
import { useAuthStore } from '../store/authStore';

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000/api';

const getAuthHeader = () => {
    const token = useAuthStore.getState().token;
    if (!token) return {};
    return { headers: { Authorization: `Bearer ${token}` } };
};

export const getGlobalLeaderboard = async (limit = 50) => {
    const authHeader = getAuthHeader();
    if (!authHeader.headers) return [];
    const response = await axios.get(`${API_URL}/leaderboard/global?limit=${limit}`, authHeader);
    return response.data;
};

export const getStandardLeaderboard = async (standard: string, limit = 50) => {
    const authHeader = getAuthHeader();
    if (!authHeader.headers) return [];
    const response = await axios.get(`${API_URL}/leaderboard/standard/${standard}?limit=${limit}`, authHeader);
    return response.data;
};

export const getSubjectLeaderboard = async (subjectId: string, limit = 50) => {
    const authHeader = getAuthHeader();
    if (!authHeader.headers) return [];
    const response = await axios.get(`${API_URL}/leaderboard/subject/${subjectId}?limit=${limit}`, authHeader);
    return response.data;
};

export const getUserRank = async (userId: string) => {
    const authHeader = getAuthHeader();
    if (!authHeader.headers) return null;
    const response = await axios.get(`${API_URL}/leaderboard/user/${userId}/rank`, authHeader);
    return response.data;
};



/*******************************************************************************
 * FILE: client/src/services/mentorService.ts
 *******************************************************************************/

import { useAuthStore } from '@/store/authStore';

const API_BASE = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000/api';

const authHeaders = (isFormData: boolean = false) => {
    const headers: any = {
        Authorization: `Bearer ${useAuthStore.getState().token}`
    };
    if (!isFormData) {
        headers['Content-Type'] = 'application/json';
    }
    return headers;
};

export interface Mentor {
    id: string;
    name: string;
    email: string;
    profilePicture?: string;
    youtubeChannel?: string;
    boards: string[];
    languages: string[];
    standards: string[];
    bio?: string;
    isActive: boolean;
    avgRating: number | null;
    totalRatings: number;
    ratings: { rating: number; comment?: string; userId: string; createdAt: string }[];
    createdAt: string;
}

export const getMentors = async (filters?: { board?: string; standard?: string; language?: string }): Promise<Mentor[]> => {
    const params = new URLSearchParams();
    if (filters?.board) params.append('board', filters.board);
    if (filters?.standard) params.append('standard', filters.standard);
    if (filters?.language) params.append('language', filters.language);
    const res = await fetch(`${API_BASE}/mentors?${params}`, { headers: authHeaders() });
    if (!res.ok) throw new Error('Failed to fetch mentors');
    return res.json();
};

export const getMentorById = async (id: string): Promise<Mentor> => {
    const res = await fetch(`${API_BASE}/mentors/${id}`, { headers: authHeaders() });
    if (!res.ok) throw new Error('Failed to fetch mentor');
    return res.json();
};

export const createMentor = async (data: FormData): Promise<Mentor> => {
    const res = await fetch(`${API_BASE}/mentors`, {
        method: 'POST',
        headers: authHeaders(true),
        body: data
    });
    if (!res.ok) { const e = await res.json(); throw new Error(e.message); }
    return res.json();
};

export const updateMentor = async (id: string, data: FormData | Partial<Mentor>): Promise<Mentor> => {
    const isFormData = data instanceof FormData;
    const res = await fetch(`${API_BASE}/mentors/${id}`, {
        method: 'PUT',
        headers: authHeaders(isFormData),
        body: isFormData ? data : JSON.stringify(data)
    });
    if (!res.ok) { const e = await res.json(); throw new Error(e.message); }
    return res.json();
};

export const deleteMentor = async (id: string): Promise<void> => {
    const res = await fetch(`${API_BASE}/mentors/${id}`, { method: 'DELETE', headers: authHeaders() });
    if (!res.ok) throw new Error('Failed to delete mentor');
};

export const requestMeeting = async (mentorId: string, message: string): Promise<{ message: string }> => {
    const res = await fetch(`${API_BASE}/mentors/${mentorId}/request`, {
        method: 'POST',
        headers: authHeaders(),
        body: JSON.stringify({ message })
    });
    if (!res.ok) { const e = await res.json(); throw new Error(e.message); }
    return res.json();
};

export const rateMentor = async (mentorId: string, rating: number, comment?: string): Promise<void> => {
    const res = await fetch(`${API_BASE}/mentors/${mentorId}/rate`, {
        method: 'POST',
        headers: authHeaders(),
        body: JSON.stringify({ rating, comment })
    });
    if (!res.ok) throw new Error('Failed to submit rating');
};



/*******************************************************************************
 * FILE: client/src/services/notificationService.ts
 *******************************************************************************/

import axios from 'axios';
import { useAuthStore } from '../store/authStore';

const API_URL = `${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000/api'}/notifications`;

const getAuthHeader = () => {
    const token = useAuthStore.getState().token;
    if (!token) return {};
    return { headers: { Authorization: `Bearer ${token}` } };
};

export const getNotifications = async () => {
    const authHeader = getAuthHeader();
    if (!authHeader.headers) return [];
    const response = await axios.get(API_URL, authHeader);
    return response.data;
};

export const syncNotifications = async () => {
    const authHeader = getAuthHeader();
    if (!authHeader.headers) return [];
    const response = await axios.post(`${API_URL}/sync`, {}, authHeader);
    return response.data;
};

export const markAsRead = async (id: string) => {
    const authHeader = getAuthHeader();
    if (!authHeader.headers) return null;
    const response = await axios.put(`${API_URL}/${id}/read`, {}, authHeader);
    return response.data;
};



/*******************************************************************************
 * FILE: client/src/services/profileService.ts
 *******************************************************************************/

import axios from 'axios';
import { useAuthStore } from '../store/authStore';

const API_URL = `${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000/api'}/profile`;

const api = axios.create({
    baseURL: API_URL,
});

api.interceptors.request.use((config) => {
    const token = useAuthStore.getState().token;
    if (token) {
        config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
});

export const getProfile = async () => {
    const response = await api.get('/');
    return response.data;
};

export const updateProfile = async (data: any) => {
    const response = await api.put('/', data);
    return response.data;
};

export const uploadPhotoBase64 = async (photoData: string) => {
    const token = useAuthStore.getState().token;
    const response = await axios.post(`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000/api'}/auth/upload-photo-base64`, {
        photoData
    }, {
        headers: { Authorization: `Bearer ${token}` }
    });
    return response.data;
};





/*******************************************************************************
 * FILE: client/src/services/quizService.ts
 *******************************************************************************/

import axios from 'axios';
import { useAuthStore } from '../store/authStore';

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://127.0.0.1:5000/api';

const getAuthHeader = () => {
    const token = useAuthStore.getState().token;
    if (!token) return {};
    return { headers: { Authorization: `Bearer ${token}` } };
};

export const startQuiz = async (levelId: string) => {
    const authHeader = getAuthHeader();
    if (!authHeader.headers) return null;
    const response = await axios.post(`${API_URL}/quiz/start`, { levelId }, authHeader);
    return response.data;
};

export const getQuizQuestions = async (levelId: string) => {
    const authHeader = getAuthHeader();
    if (!authHeader.headers) return [];
    const response = await axios.get(`${API_URL}/content/quiz/questions?levelId=${levelId}`, authHeader);
    return response.data;
};

export const submitAnswer = async (data: { sessionId: string, questionId: string, selectedOptionId: number, timeTaken: number }) => {
    const authHeader = getAuthHeader();
    if (!authHeader.headers) return null;
    const response = await axios.post(`${API_URL}/quiz/submit`, data, authHeader);
    return response.data;
};

export const completeQuiz = async (sessionId: string) => {
    const authHeader = getAuthHeader();
    if (!authHeader.headers) return null;
    const response = await axios.post(`${API_URL}/quiz/complete`, { sessionId }, authHeader);
    return response.data;
};

export const getQuizReports = async () => {
    const authHeader = getAuthHeader();
    if (!authHeader.headers) return [];
    const response = await axios.get(`${API_URL}/quiz/reports`, authHeader);
    return response.data;
};

export const getAdaptiveQuestion = async (query: { difficulty: string, chapterId: string, sessionId: string }) => {
    const authHeader = getAuthHeader();
    if (!authHeader.headers) return null;
    const response = await axios.get(`${API_URL}/content/adaptive-question`, {
        ...authHeader,
        params: query
    });
    return response.data;
};

export const getQuizSession = async (sessionId: string) => {
    const authHeader = getAuthHeader();
    if (!authHeader.headers) return null;
    const response = await axios.get(`${API_URL}/quiz/session/${sessionId}`, authHeader);
    return response.data;
};



/*******************************************************************************
 * FILE: client/src/store/authStore.ts
 *******************************************************************************/

import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface User {
    id: string;
    name: string;
    email: string;
    role: string;
    profilePhoto?: string;
    streak?: number;
    xp?: number;
    scholarStatus?: string;
    rankScore?: number;
    classStandard?: string;
    gender?: string;
    age?: number;
    schoolName?: string;
    board?: string;
    emailVerified?: boolean;
}

interface AuthState {
    user: User | null;
    token: string | null;
    isAuthenticated: boolean;
    login: (user: User, token: string) => void;
    logout: () => void;
}

export const useAuthStore = create<AuthState>()(
    persist(
        (set) => ({
            user: null,
            token: null,
            isAuthenticated: false,
            login: (user, token) => set({ user, token, isAuthenticated: true }),
            logout: () => set({ user: null, token: null, isAuthenticated: false }),
        }),
        {
            name: 'auth-storage',
        }
    )
);



/*******************************************************************************
 * FILE: server/check-db.ts
 *******************************************************************************/

import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
    const userCount = await prisma.user.count();
    console.log(`Total users in database: ${userCount}`);

    const users = await prisma.user.findMany({
        select: {
            email: true,
            name: true,
            role: true
        }
    });

    console.log('User list:');
    console.table(users);
}

main()
    .catch(e => console.error(e))
    .finally(async () => {
        await prisma.$disconnect();
    });



/*******************************************************************************
 * FILE: server/check_links.ts
 *******************************************************************************/

import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();

async function main() {
    console.log('Checking Chapter Links...');
    const chapters = await prisma.chapter.findMany({
        select: { name: true, subject: { select: { name: true } }, youtubeLink: true },
    });
    console.log(JSON.stringify(chapters, null, 2));
}

main()
    .catch(e => console.error(e))
    .finally(async () => await prisma.$disconnect());



/*******************************************************************************
 * FILE: server/config/db.ts
 *******************************************************************************/

import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

export default prisma;



/*******************************************************************************
 * FILE: server/controllers/adminController.ts
 *******************************************************************************/

import { Request, Response } from 'express';
import prisma from '../config/db.js';

export const getSystemStats = async (req: Request, res: Response) => {
    try {
        const [userCount, postCount, questionCount, attemptCount] = await Promise.all([
            prisma.user.count(),
            prisma.forumPost.count(),
            prisma.question.count(),
            prisma.attempt.count(),
        ]);

        res.json({
            users: userCount,
            posts: postCount,
            questions: questionCount,
            attempts: attemptCount,
        });
    } catch (error) {
        console.error('Error fetching admin stats:', error);
        res.status(500).json({ message: 'Error fetching admin stats', error });
    }
};

export const getAllUsers = async (req: Request, res: Response) => {
    try {
        const users = await prisma.user.findMany({
            select: {
                id: true,
                email: true,
                name: true,
                role: true,
                createdAt: true,
                lastLogin: true,
            },
            orderBy: {
                createdAt: 'desc',
            },
        });

        res.json(users);
    } catch (error) {
        console.error('Error fetching users:', error);
        res.status(500).json({ message: 'Error fetching users', error });
    }
};

export const updateUserRole = async (req: Request, res: Response) => {
    const { id } = req.params;
    const { role } = req.body;

    if (!['STUDENT', 'ADMIN'].includes(role)) {
        return res.status(400).json({ message: 'Invalid role' });
    }

    try {
        const updatedUser = await prisma.user.update({
            where: { id: id as string },
            data: { role },
            select: {
                id: true,
                email: true,
                name: true,
                role: true,
            },
        });

        res.json({ message: 'User role updated successfully', user: updatedUser });
    } catch (error) {
        console.error('Error updating user role:', error);
        res.status(500).json({ message: 'Error updating user role', error });
    }
};



/*******************************************************************************
 * FILE: server/controllers/aiController.ts
 *******************************************************************************/

import { Request, Response } from 'express';
import { generateMentorResponse, generateDailyPlan, generateRemediation } from '../services/aiMentorService.js';
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

export const chatWithMentor = async (req: Request, res: Response) => {
    try {
        const { message, userContext } = req.body;

        if (!message) {
            return res.status(400).json({ message: 'Message is required' });
        }

        const userId = (req as any).user?.userId;

        if (!userId) {
            return res.status(401).json({ message: 'Unauthorized' });
        }

        // Fetch User and Pro status
        const user = await prisma.user.findUnique({
            where: { id: userId },
            select: { classStandard: true, name: true, role: true }
        });

        if (!user) {
            return res.status(404).json({ message: 'User not found' });
        }

        // AI Logic continues below (Limits removed for everyone)

        // Fetch User Context for Chat
        let enrichedContext: any = {};
        const standard = user.classStandard || '10';

        // Fetch Subjects
        const subjects = await prisma.subject.findMany({
            where: { standard },
            include: { chapters: { select: { name: true } } }
        });

        const availableContent = subjects.map(s => `${s.name} (${s.chapters.length} chapters)`);

        // Fetch Weak Topics
        const weakAreas = await prisma.masteryTracking.findMany({
            where: { userId },
            orderBy: { masteryLevel: 'asc' },
            take: 2,
            include: { subtopic: { include: { chapter: { include: { subject: true } } } } }
        });

        const weakTopics = weakAreas.map(w => `${w.subtopic.chapter.subject.name}: ${w.subtopic.name}`);

        enrichedContext = {
            studentName: user.name,
            standard: standard,
            subjects: availableContent,
            weakTopics: weakTopics
        };

        const response = await generateMentorResponse(message, { ...userContext, ...enrichedContext });

        // Log the usage
        await prisma.analyticsLog.create({
            data: {
                userId,
                action: 'CHAT_WITH_MENTOR',
                metadata: JSON.stringify({ messageLength: message.length })
            }
        });

        res.json({
            success: true,
            response,
            timestamp: new Date().toISOString()
        });
    } catch (error: any) {
        console.error('Chat error:', error);
        res.status(500).json({
            success: false,
            message: error.message || 'Failed to get AI response'
        });
    }
};

export const getDailyPlan = async (req: Request, res: Response) => {
    try {
        const userId = (req as any).user?.userId;

        if (!userId) {
            return res.status(401).json({ success: false, message: 'Unauthorized' });
        }

        // Fetch User details
        const user = await prisma.user.findUnique({
            where: { id: userId },
            select: { classStandard: true, name: true }
        });

        if (!user) {
            return res.status(404).json({ success: false, message: 'User not found' });
        }

        const standard = user.classStandard || '10';

        // Fetch Subjects and Chapters for this standard
        const subjects = await prisma.subject.findMany({
            where: { standard },
            include: {
                chapters: {
                    select: { name: true }
                }
            }
        });

        const availableContent = subjects.map(s => ({
            subject: s.name,
            chapters: s.chapters.map(c => c.name)
        }));

        // Fetch Weak Topics (lowest mastery)
        const weakAreas = await prisma.masteryTracking.findMany({
            where: { userId },
            orderBy: { masteryLevel: 'asc' },
            take: 3,
            include: {
                subtopic: {
                    include: {
                        chapter: {
                            include: { subject: true }
                        }
                    }
                }
            }
        });

        const weakTopics = weakAreas.map(w => `${w.subtopic.chapter.subject.name}: ${w.subtopic.name}`);

        const userContext = {
            userId: userId,
            level: standard,
            weakTopics: weakTopics.length > 0 ? weakTopics : ['General Revision'],
            availableContent: availableContent
        };

        const plan = await generateDailyPlan(userContext);

        res.json({
            success: true,
            plan,
            timestamp: new Date().toISOString()
        });
    } catch (error: any) {
        console.error('Daily plan error:', error);
        res.status(500).json({
            success: false,
            message: error.message || 'Failed to generate daily plan'
        });
    }
};

export const getRemediation = async (req: Request, res: Response) => {
    try {
        const { questionId, type } = req.body;

        if (!questionId || !type) {
            return res.status(400).json({ message: 'questionId and type are required' });
        }

        const question = await prisma.question.findUnique({
            where: { id: questionId }
        });

        if (!question) {
            return res.status(404).json({ message: 'Question not found' });
        }

        // Parse options if string
        const parsedQuestion = {
            ...question,
            options: typeof question.options === 'string' ? JSON.parse(question.options) : question.options
        };

        const remediation = await generateRemediation(parsedQuestion, type as 'UPGRADE' | 'DOWNGRADE');

        res.json({ success: true, remediation });
    } catch (error: any) {
        console.error('Remediation error:', error);
        res.status(500).json({ success: false, message: 'Failed to generate remediation' });
    }
};



/*******************************************************************************
 * FILE: server/controllers/analyticsController.ts
 *******************************************************************************/

import { Request, Response } from 'express';
import prisma from '../config/db.js';
import { GoogleGenerativeAI } from '@google/generative-ai';

// Gemini keys (same as aiMentorService)
const geminiApiKeys = (process.env.GEMINI_API_KEY || '').split(',').map(k => k.trim()).filter(Boolean);
const genAIs = geminiApiKeys.map(k => new GoogleGenerativeAI(k));

// Ask Gemini to explain the correct answer for a flashcard question
async function aiExplainAnswer(question: string, correctAnswer: string): Promise<string> {
    for (const genAI of genAIs) {
        try {
            const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });
            const prompt = `You are a helpful tutor for Indian school students (Class 8-10).
Question: "${question}"
Correct Answer: "${correctAnswer}"

Give a clear, concise explanation (2-3 sentences max) of WHY this is the correct answer. Use simple language. No bullet points, just plain text.`;
            const result = await model.generateContent(prompt);
            const text = result.response.text().trim();
            if (text) return text;
        } catch (e: any) {
            console.warn('Gemini key failed for zen explanation:', e.message);
        }
    }
    return `The correct answer is: ${correctAnswer}`;
}

// Get time spent analytics (subject-wise or chapter-wise if subjectId is provided)
export const getTimeSpentAnalytics = async (req: Request, res: Response) => {
    const userId = (req as any).user.userId;
    const { subjectId: filterSubjectId } = req.query;

    try {
        const timeData = await prisma.quizSession.findMany({
            where: {
                userId,
                status: 'COMPLETED',
                level: filterSubjectId ? {
                    chapter: {
                        subjectId: filterSubjectId as string
                    }
                } : undefined
            },
            include: {
                level: {
                    include: {
                        chapter: {
                            include: {
                                subject: true
                            }
                        }
                    }
                }
            }
        });

        if (filterSubjectId) {
            // Group by chapter
            const chapterTimeMap: Record<string, { name: string; time: number }> = {};
            timeData.forEach(session => {
                const chapterName = session.level?.chapter?.name || 'Unknown';
                const chapterId = session.level?.chapter?.id || 'unknown';
                if (!chapterTimeMap[chapterId]) {
                    chapterTimeMap[chapterId] = { name: chapterName, time: 0 };
                }
                chapterTimeMap[chapterId].time += session.timeSpent || 0;
            });
            const result = Object.values(chapterTimeMap).map(item => ({
                label: item.name,
                value: Math.round(item.time / 60)
            }));
            return res.json(result);
        }

        // Default: Group by subject
        const subjectTimeMap: Record<string, { name: string; time: number }> = {};
        timeData.forEach(session => {
            const subjectName = session.level?.chapter?.subject?.name || 'Unknown';
            const subjectId = session.level?.chapter?.subject?.id || 'unknown';
            if (!subjectTimeMap[subjectId]) {
                subjectTimeMap[subjectId] = { name: subjectName, time: 0 };
            }
            subjectTimeMap[subjectId].time += session.timeSpent || 0;
        });

        const result = Object.values(subjectTimeMap).map(item => ({
            label: item.name,
            value: Math.round(item.time / 60)
        }));

        res.json(result);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error fetching time analytics', error });
    }
};

// Get accuracy trend (last 30 days)
export const getAccuracyTrend = async (req: Request, res: Response) => {
    const userId = (req as any).user.userId;

    try {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

        const sessions = await prisma.quizSession.findMany({
            where: {
                userId,
                status: 'COMPLETED',
                startTime: {
                    gte: thirtyDaysAgo
                }
            },
            orderBy: {
                startTime: 'asc'
            }
        });

        // Group by date
        const dateMap: Record<string, { total: number; correct: number; count: number }> = {};

        for (const session of sessions) {
            const date = session.startTime.toISOString().split('T')[0];

            if (!dateMap[date]) {
                dateMap[date] = { total: 0, correct: 0, count: 0 };
            }

            const attempts = await prisma.attempt.findMany({
                where: { quizSessionId: session.id }
            });

            const correctCount = attempts.filter(a => a.isCorrect).length;
            dateMap[date].total += attempts.length;
            dateMap[date].correct += correctCount;
            dateMap[date].count += 1;
        }

        const result = Object.entries(dateMap).map(([date, data]) => ({
            date,
            accuracy: data.total > 0 ? Math.round((data.correct / data.total) * 100) : 0
        }));

        res.json(result);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error fetching accuracy trend', error });
    }
};

// Get difficulty mastery (filterable by subject or chapter)
export const getDifficultyMastery = async (req: Request, res: Response) => {
    const userId = (req as any).user.userId;
    const { subjectId, chapterId } = req.query;

    try {
        const attempts = await prisma.attempt.findMany({
            where: {
                userId,
                question: {
                    level: (subjectId || chapterId) ? {
                        chapter: chapterId ? { id: chapterId as string } : { subjectId: subjectId as string }
                    } : undefined
                }
            },
            include: {
                question: true
            }
        });

        const difficultyStats: Record<string, { total: number; correct: number }> = {
            EASY: { total: 0, correct: 0 },
            MEDIUM: { total: 0, correct: 0 },
            HARD: { total: 0, correct: 0 }
        };

        attempts.forEach(attempt => {
            const difficulty = attempt.question?.difficulty || 'EASY';
            if (difficultyStats[difficulty]) {
                difficultyStats[difficulty].total += 1;
                if (attempt.isCorrect) {
                    difficultyStats[difficulty].correct += 1;
                }
            }
        });

        const result = Object.entries(difficultyStats).map(([difficulty, stats]) => ({
            difficulty,
            accuracy: stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0,
            count: stats.total
        }));

        res.json(result);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error fetching difficulty mastery', error });
    }
};

// Get rank progression (last 30 days)
export const getRankProgression = async (req: Request, res: Response) => {
    const userId = (req as any).user.userId;

    try {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

        const sessions = await prisma.quizSession.findMany({
            where: {
                userId,
                status: 'COMPLETED',
                startTime: {
                    gte: thirtyDaysAgo
                }
            },
            orderBy: {
                startTime: 'asc'
            }
        });

        // Get user's rank score progression
        const user = await prisma.user.findUnique({
            where: { id: userId },
            select: { rankScore: true }
        });

        // Calculate cumulative rank score over time
        let cumulativeScore = 0;
        const result = sessions.map(session => {
            const date = session.startTime.toISOString().split('T')[0];
            // Approximate score earned per session (simplified)
            const sessionScore = session.score * 0.5 + 10; // Simplified calculation
            cumulativeScore += sessionScore;

            return {
                date,
                rankScore: Math.round(cumulativeScore)
            };
        });

        // Add current rank score as final point
        if (result.length > 0 && user) {
            result.push({
                date: new Date().toISOString().split('T')[0],
                rankScore: user.rankScore
            });
        }

        res.json(result);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error fetching rank progression', error });
    }
};
// Get Zen Zone Revision Data (Weak Topics + Key Questions)
export const getZenRevisionData = async (req: Request, res: Response) => {
    const userId = (req as any).user.userId;

    try {
        // ‚îÄ‚îÄ 1. Compute Weak Chapters from real Attempt data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Fetch all attempts by this user with question ‚Üí level ‚Üí chapter ‚Üí subject
        const allAttempts = await prisma.attempt.findMany({
            where: { userId },
            include: {
                question: {
                    include: {
                        level: {
                            include: {
                                chapter: {
                                    include: { subject: true }
                                }
                            }
                        },
                        subtopic: {
                            include: {
                                chapter: {
                                    include: { subject: true }
                                }
                            }
                        }
                    }
                }
            }
        });

        // Group by chapter, compute mastery = correct / total * 100
        const chapterMap: Record<string, {
            id: string; name: string; subject: string; total: number; correct: number;
        }> = {};

        for (const attempt of allAttempts) {
            const chapter = attempt.question?.level?.chapter || attempt.question?.subtopic?.chapter;
            const subject = attempt.question?.level?.chapter?.subject || attempt.question?.subtopic?.chapter?.subject;
            if (!chapter) continue;

            if (!chapterMap[chapter.id]) {
                chapterMap[chapter.id] = {
                    id: chapter.id,
                    name: chapter.name,
                    subject: subject?.name || 'General',
                    total: 0,
                    correct: 0,
                };
            }
            chapterMap[chapter.id].total += 1;
            if (attempt.isCorrect) chapterMap[chapter.id].correct += 1;
        }

        // Sort by mastery ascending (weakest first), take top 3 with at least 1 attempt
        const sortedChapters = Object.values(chapterMap)
            .filter(c => c.total > 0)
            .map(c => ({
                id: c.id,
                name: c.name,
                chapter: c.name,
                subject: c.subject,
                mastery: Math.round((c.correct / c.total) * 100),
                total: c.total,
            }))
            .sort((a, b) => a.mastery - b.mastery)
            .slice(0, 3);

        const weakTopics = sortedChapters.length > 0 ? sortedChapters : [
            { id: '1', name: 'General Review', chapter: 'Basics', subject: 'Science', mastery: 45, total: 0 },
            { id: '2', name: 'Time Management', chapter: 'Exam Prep', subject: 'Strategy', mastery: 30, total: 0 }
        ];

        // ‚îÄ‚îÄ 2. Fetch flashcard questions from the student's weak chapters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const weakChapterIds = sortedChapters.map(c => c.id);

        const importantQuestions = await prisma.question.findMany({
            where: {
                difficulty: 'HARD',
                OR: [
                    weakChapterIds.length > 0 ? { level: { chapterId: { in: weakChapterIds } } } : {},
                    weakChapterIds.length > 0 ? { subtopic: { chapterId: { in: weakChapterIds } } } : {},
                ]
            },
            take: 5,
            include: {
                level: { include: { chapter: true } },
                subtopic: { include: { chapter: true } }
            }
        });

        // Build questions with AI explanations
        const formattedQuestions = await Promise.all(importantQuestions.map(async q => {
            const opts: any[] = typeof q.options === 'string' ? JSON.parse(q.options) : (q.options as any[]);
            // Find the correct answer text
            const correctOpt = opts.find((o: any) => o.id === q.correctOption || o.id === String(q.correctOption));
            const correctAnswerText = correctOpt?.text || opts[0]?.text || 'See explanation';

            // Use AI to explain ‚Äî fallback to stored rightFeedback
            let explanation = q.rightFeedback && q.rightFeedback.trim().length > 10
                ? q.rightFeedback
                : await aiExplainAnswer(q.content, correctAnswerText);

            return {
                id: q.id,
                content: q.content,
                chapter: q.level?.chapter?.name || (q as any).subtopic?.chapter?.name || 'General',
                options: opts,
                correctOption: q.correctOption,
                correctAnswerText,
                explanation
            };
        }));

        // If no questions from DB, use high-yield fallback questions with AI explanations
        const fallbackRaw = [
            {
                id: 'f1', content: "Which Newton's law explains why we lean forward when a bus stops suddenly?",
                options: [{ id: 1, text: "First Law" }, { id: 2, text: "Second Law" }, { id: 3, text: "Third Law" }, { id: 4, text: "Law of Gravity" }],
                correctOption: 1, chapter: 'Laws of Motion'
            },
            {
                id: 'f2', content: "What is the SI unit of electric current?",
                options: [{ id: 1, text: "Volt" }, { id: 2, text: "Watt" }, { id: 3, text: "Ampere" }, { id: 4, text: "Ohm" }],
                correctOption: 3, chapter: 'Electricity'
            },
            {
                id: 'f3', content: "Which gas is produced during photosynthesis?",
                options: [{ id: 1, text: "Carbon Dioxide" }, { id: 2, text: "Oxygen" }, { id: 3, text: "Nitrogen" }, { id: 4, text: "Hydrogen" }],
                correctOption: 2, chapter: 'Life Processes'
            },
            {
                id: 'f4', content: "The mirror formula is 1/f = 1/v + 1/u. What does 'f' represent?",
                options: [{ id: 1, text: "Focal length" }, { id: 2, text: "Frequency" }, { id: 3, text: "Force" }, { id: 4, text: "Field" }],
                correctOption: 1, chapter: 'Light'
            },
            {
                id: 'f5', content: "What type of reaction is rusting of iron?",
                options: [{ id: 1, text: "Decomposition" }, { id: 2, text: "Displacement" }, { id: 3, text: "Oxidation" }, { id: 4, text: "Neutralization" }],
                correctOption: 3, chapter: 'Chemical Reactions'
            }
        ];

        const fallbackWithAI = await Promise.all(fallbackRaw.map(async q => {
            const correctOpt = q.options.find(o => o.id === q.correctOption);
            const correctAnswerText = correctOpt?.text || '';
            const explanation = await aiExplainAnswer(q.content, correctAnswerText);
            return { ...q, correctAnswerText, explanation };
        }));

        res.json({
            weakTopics: weakTopics.length > 0 ? weakTopics : [
                { id: '1', name: 'General Review', chapter: 'Basics', subject: 'Science', mastery: 45 },
                { id: '2', name: 'Time Management', chapter: 'Exam Prep', subject: 'Strategy', mastery: 30 }
            ],
            importantQuestions: formattedQuestions.length > 0 ? formattedQuestions : fallbackWithAI
        });
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error fetching Zen revision data', error });
    }
};



/*******************************************************************************
 * FILE: server/controllers/authController.ts
 *******************************************************************************/

import { Request, Response } from 'express';
import bcrypt from 'bcrypt';
import jwt from 'jsonwebtoken';
import prisma from '../config/db.js';
import fs from 'fs';
import crypto from 'crypto';

const JWT_SECRET = process.env.JWT_SECRET || 'secret';
const FRONTEND_URL = process.env.FRONTEND_URL || 'http://localhost:3000';
import nodemailer from 'nodemailer';

// Configure Nodemailer (Using environment variables)
const transporter = nodemailer.createTransport({
    service: 'gmail', // Standard for Gmail
    auth: {
        user: process.env.EMAIL_USER,
        pass: process.env.EMAIL_PASS
    }
});

console.log('Initializing SMTP with user:', process.env.EMAIL_USER);

// Verify connection configuration
transporter.verify((error, success) => {
    const logPath = './smtp-debug.log';
    if (error) {
        fs.appendFileSync(logPath, `[${new Date().toISOString()}] SMTP Connection Error: ${JSON.stringify(error)}\n`);
        console.error('SMTP Connection Error:', error);
    } else {
        fs.appendFileSync(logPath, `[${new Date().toISOString()}] SMTP Server is ready\n`);
        console.log('SMTP Server is ready to take our messages');
    }
});

export const register = async (req: Request, res: Response) => {
    const { name, email, password, role, board } = req.body;

    console.log('Registration attempt:', { name, email, role });

    try {
        const existingUser = await prisma.user.findUnique({ where: { email } });
        if (existingUser) {
            console.log('User already exists:', email);
            return res.status(400).json({ message: 'User already exists' });
        }

        const hashedPassword = await bcrypt.hash(password, 10);
        const verificationToken = crypto.randomBytes(32).toString('hex');

        const user = await prisma.user.create({
            data: {
                name,
                email,
                password: hashedPassword,
                role: role || 'STUDENT',
                board: board || 'Maharashtra State Board',
                lastLogin: new Date(),
                streak: 1,
                emailVerified: false,
                verificationToken,
            },
        });

        console.log('User created successfully:', user.id);

        // Send verification email (non-blocking)
        sendVerificationEmail(email, name, verificationToken).catch(err =>
            console.error('Failed to send verification email:', err)
        );

        const token = jwt.sign({ userId: user.id, role: user.role }, JWT_SECRET, {
            expiresIn: '1h',
        });

        res.status(201).json({
            token,
            user: {
                id: user.id,
                name: user.name,
                email: user.email,
                role: user.role,
                streak: user.streak,
                xp: user.xp,
                scholarStatus: user.scholarStatus,
                profilePhoto: user.profilePhoto,
                classStandard: user.classStandard,
                emailVerified: user.emailVerified,
            }
        });
    } catch (error) {
        console.error('Registration error:', error);
        res.status(500).json({ message: 'Server error', error });
    }
};

// ‚îÄ‚îÄ Verification Email Helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sendVerificationEmail(email: string, name: string, token: string) {
    const verifyUrl = `${FRONTEND_URL}/verify-email?token=${token}`;
    await transporter.sendMail({
        from: `"Yatsya Platform" <${process.env.EMAIL_USER}>`,
        to: email,
        subject: '‚úÖ Verify Your Yatsya Account',
        html: `
            <div style="font-family:sans-serif;max-width:600px;margin:0 auto;background:#0B1120;color:#e2e8f0;border-radius:16px;padding:32px;">
                <h2 style="color:#22d3ee;margin-bottom:4px;">Welcome to Yatsya, ${name}! üéì</h2>
                <p style="color:#94a3b8;margin-top:0;">One more step ‚Äî please verify your email address.</p>
                <hr style="border:1px solid #1e293b;margin:24px 0;">
                <p>Click the button below to verify your account and unlock full access to Yatsya:</p>
                <a href="${verifyUrl}"
                    style="display:inline-block;margin:16px 0;padding:14px 32px;background:#22d3ee;color:#000;font-weight:900;border-radius:12px;text-decoration:none;font-size:16px;">
                    ‚úÖ Verify My Email
                </a>
                <p style="color:#64748b;font-size:12px;margin-top:24px;">Or copy this link: <a href="${verifyUrl}" style="color:#22d3ee;">${verifyUrl}</a></p>
                <p style="color:#64748b;font-size:11px;">This link expires in 24 hours. If you didn't register, ignore this email.</p>
            </div>
        `
    });
    console.log(`Verification email sent to ${email}`);
}

// ‚îÄ‚îÄ GET /api/auth/verify-email?token=... ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
export const verifyEmail = async (req: Request, res: Response) => {
    const { token } = req.query as { token: string };
    if (!token) return res.status(400).json({ message: 'Token is required' });

    try {
        const user = await prisma.user.findUnique({ where: { verificationToken: token } });
        if (!user) return res.status(400).json({ message: 'Invalid or expired verification link.' });
        if (user.emailVerified) return res.json({ message: 'Email already verified.' });

        await prisma.user.update({
            where: { id: user.id },
            data: { emailVerified: true, verificationToken: null }
        });

        console.log('Email verified for:', user.email);
        res.json({ message: 'Email verified successfully! You can now log in.', email: user.email });
    } catch (error) {
        res.status(500).json({ message: 'Server error during verification', error });
    }
};

// ‚îÄ‚îÄ POST /api/auth/resend-verification ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
export const resendVerification = async (req: Request, res: Response) => {
    const { email } = req.body;
    try {
        const user = await prisma.user.findUnique({ where: { email } });
        if (!user) return res.status(404).json({ message: 'User not found' });
        if (user.emailVerified) return res.json({ message: 'Email is already verified.' });

        const newToken = crypto.randomBytes(32).toString('hex');
        await prisma.user.update({ where: { id: user.id }, data: { verificationToken: newToken } });
        await sendVerificationEmail(email, user.name, newToken);

        res.json({ message: 'Verification email resent. Please check your inbox.' });
    } catch (error) {
        res.status(500).json({ message: 'Failed to resend verification email', error });
    }
};

export const login = async (req: Request, res: Response) => {
    const { email, password } = req.body;

    console.log('Login attempt for email:', email);

    try {
        const user = await prisma.user.findUnique({ where: { email } });
        if (!user) {
            console.log('User not found:', email);
            return res.status(400).json({ message: 'Invalid credentials' });
        }

        console.log('User found:', user.email);
        const isMatch = await bcrypt.compare(password, user.password);
        console.log('Password match:', isMatch);

        if (!isMatch) {
            console.log('Password mismatch for user:', email);
            return res.status(400).json({ message: 'Invalid credentials' });
        }

        // üö´ Block login if email not verified (except hardcoded admin)
        if (!user.emailVerified && user.email !== 'yatsya35@gmail.com') {
            return res.status(403).json({
                message: 'Please verify your email before logging in.',
                emailVerified: false,
                email: user.email,
            });
        }

        // --- Streak Calculation Logic ---
        const now = new Date();
        const lastLogin = user.lastLogin;
        let newStreak = user.streak || 0;

        if (!lastLogin) {
            newStreak = 1;
        } else {
            const lastDate = new Date(lastLogin);

            // Check if last login was yesterday
            const yesterday = new Date(now);
            yesterday.setDate(now.getDate() - 1);

            const isSameDay = (d1: Date, d2: Date) =>
                d1.getFullYear() === d2.getFullYear() &&
                d1.getMonth() === d2.getMonth() &&
                d1.getDate() === d2.getDate();

            if (isSameDay(lastDate, now)) {
                // Already logged in today, keep streak
            } else if (isSameDay(lastDate, yesterday)) {
                // Logged in yesterday, increment streak
                newStreak += 1;
            } else {
                // Logged in before yesterday, reset streak
                newStreak = 1;
            }
        }

        if (user.email === 'yatsya35@gmail.com' && user.role !== 'ADMIN') {
            await prisma.user.update({
                where: { id: user.id },
                data: { role: 'ADMIN' }
            });
            user.role = 'ADMIN';
        }

        const updatedUser = await prisma.user.update({
            where: { id: user.id },
            data: {
                lastLogin: now,
                streak: newStreak
            }
        });

        const token = jwt.sign({ userId: updatedUser.id, role: updatedUser.role }, JWT_SECRET, {
            expiresIn: '1h',
        });

        console.log('Login successful for user:', email, 'Streak:', newStreak);
        res.json({
            token,
            user: {
                id: updatedUser.id,
                name: updatedUser.name,
                email: updatedUser.email,
                role: updatedUser.role,
                streak: updatedUser.streak,
                xp: updatedUser.xp,
                scholarStatus: updatedUser.scholarStatus,
                profilePhoto: updatedUser.profilePhoto,
                classStandard: updatedUser.classStandard,
                gender: updatedUser.gender,
                age: updatedUser.age,
                schoolName: updatedUser.schoolName,
                board: updatedUser.board
            }
        });
    } catch (error) {
        console.error('Login error:', error);
        res.status(500).json({ message: 'Server error', error });
    }
};


export const changePassword = async (req: Request, res: Response) => {
    const { userId, currentPassword, newPassword } = req.body;

    try {
        const user = await prisma.user.findUnique({ where: { id: userId } });
        if (!user) {
            return res.status(404).json({ message: 'User not found' });
        }

        const isMatch = await bcrypt.compare(currentPassword, user.password);
        if (!isMatch) {
            return res.status(400).json({ message: 'Incorrect current password' });
        }

        const hashedPassword = await bcrypt.hash(newPassword, 10);

        await prisma.user.update({
            where: { id: userId },
            data: { password: hashedPassword }
        });

        res.json({ message: 'Password updated successfully' });
    } catch (error) {
        res.status(500).json({ message: 'Error changing password', error });
    }
};

export const forgotPassword = async (req: Request, res: Response) => {
    const { email } = req.body;

    try {
        const user = await prisma.user.findUnique({ where: { email } });
        if (!user) {
            return res.status(404).json({ message: 'User not found' });
        }

        // Generate temporary password
        const tempPassword = Math.random().toString(36).slice(-8);
        const hashedPassword = await bcrypt.hash(tempPassword, 10);

        // Update user password
        await prisma.user.update({
            where: { email },
            data: { password: hashedPassword }
        });

        // Send email
        const mailOptions = {
            from: process.env.EMAIL_USER || 'noreply@edutech.com',
            to: email,
            subject: 'Password Reset Request',
            text: `Your new temporary password is: ${tempPassword}\n\nPlease log in and change your password immediately.`
        };

        try {
            await transporter.sendMail(mailOptions);
            console.log(`Password reset email sent to ${email}`);

            // In production, we don't return the password in the response.
            // But we can include a help message.
            res.json({
                message: 'A temporary password has been sent to your email. Please check your inbox (and spam folder).'
            });
        } catch (emailError: any) {
            const logPath = './smtp-debug.log';
            fs.appendFileSync(logPath, `[${new Date().toISOString()}] Email Send Failed for ${email}: ${emailError.message}\n`);
            console.error('Email send failed:', emailError);

            // Log the temp password for dev fallback if sending fails
            console.log(`[DEV FALLBACK] Temp Password for ${email}: ${tempPassword}`);

            res.status(500).json({
                message: 'Failed to send reset email. Please try again later or contact support.',
                error: emailError.message,
                devPass: tempPassword // Always return temp password for now to allow user to continue
            });
        }

    } catch (error) {
        console.error('Forgot password error:', error);
        res.status(500).json({ message: 'Server error', error });
    }
};



/*******************************************************************************
 * FILE: server/controllers/contentController.ts
 *******************************************************************************/

import { Request, Response } from 'express';
import prisma from '../config/db.js';

export const getStandards = async (req: Request, res: Response) => {
    // Hardcoded logic for now as per requirements
    const standards = [
        { id: '8', name: 'Standard 8', locked: false },
        { id: '9', name: 'Standard 9', locked: true },
        { id: '10', name: 'Standard 10', locked: true }
    ];
    res.json(standards);
};

// Get subjects by standard
export const getSubjects = async (req: Request, res: Response) => {
    const { standard } = req.query;
    const userId = (req as any).user?.userId;

    try {
        const whereClause = standard ? { standard: String(standard) } : {};
        const subjects = await prisma.subject.findMany({
            where: whereClause,
            include: {
                chapters: {
                    include: {
                        subtopics: true,
                        levels: {
                            orderBy: { order: 'asc' }
                        }
                    },
                    orderBy: { order: 'asc' }
                },
                _count: {
                    select: { chapters: true }
                }
            }
        });

        // Add lock status if userId is available (authenticated)
        if (userId) {
            for (const subject of subjects) {
                for (const chapter of subject.chapters) {
                    const levels = chapter.levels;
                    let prevLevelPassed = true;

                    for (let i = 0; i < levels.length; i++) {
                        const level = levels[i] as any;
                        if (level.name === 'Diagnostic') {
                            level.isLocked = false;
                        } else {
                            level.isLocked = !prevLevelPassed;
                        }

                        // Check if current level is passed to unlock next
                        const bestAttempt = await prisma.quizSession.findFirst({
                            where: {
                                userId,
                                levelId: level.id,
                                status: 'COMPLETED'
                            },
                            orderBy: { score: 'desc' }
                        });

                        const requiredScore = level.name === 'Diagnostic' ? 80 : 60;
                        prevLevelPassed = bestAttempt ? bestAttempt.score >= requiredScore : false;
                    }
                }
            }
        }

        res.json(subjects);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Server error', error });
    }
};

// Get chapters for a subject with levels
export const getChapters = async (req: Request, res: Response) => {
    const { subjectId } = req.params;
    try {
        const chapters = await prisma.chapter.findMany({
            where: { subjectId: String(subjectId) },
            include: {
                levels: {
                    orderBy: { order: 'asc' }
                },
                subtopics: true // Keep for reference if needed
            }
        });
        res.json(chapters);
    } catch (error) {
        res.status(500).json({ message: 'Server error', error });
    }
};

// Get question by level (for new quiz engine) or subtopic
// If levelId is provided, logic to fetch questions based on distribution
export const getQuizQuestions = async (req: Request, res: Response) => {
    const { levelId, subtopicId } = req.query;

    try {
        let questions: any[] = [];

        if (levelId) {
            // New logic: Fetch questions directly from Level
            const level = await prisma.level.findUnique({
                where: { id: String(levelId) },
                include: { questions: true } // Questions are now directly linked to Level in seed
            });

            if (!level) return res.status(404).json({ message: 'Level not found' });

            const allQuestions = level.questions;

            // Filter by difficulty
            const easy = allQuestions.filter(q => q.difficulty === 'EASY');
            const medium = allQuestions.filter(q => q.difficulty === 'MEDIUM');
            const hard = allQuestions.filter(q => q.difficulty === 'HARD');

            // Pick random (simple shuffle)
            const pick = (arr: any[], count: number) => arr.sort(() => 0.5 - Math.random()).slice(0, count);

            questions = [
                ...pick(easy, 5),
                ...pick(medium, 3),
                ...pick(hard, 2)
            ];

            // If not enough questions, just fill with whatever we have to reach 10 if possible
            if (questions.length < 10) {
                const remaining = allQuestions.filter(q => !questions.some(sel => sel.id === q.id));
                const needed = 10 - questions.length;
                questions = [...questions, ...pick(remaining, needed)];
            }

            // Shuffle the final set of questions so difficulties are mixed
            questions.sort(() => 0.5 - Math.random());

        } else if (subtopicId) {
            questions = await prisma.question.findMany({
                where: { subtopicId: String(subtopicId) }
            });
        }

        const parsedQuestions = questions.map((q: any) => {
            let options = typeof q.options === 'string' ? JSON.parse(q.options) : q.options;
            // Shuffle options
            if (Array.isArray(options)) {
                options.sort(() => 0.5 - Math.random());
            }

            // Return sanitized question (NO correctOption, NO feedback)
            return {
                id: q.id,
                content: q.content,
                options: options,
                difficulty: q.difficulty,
                // explanation/feedback hidden
            };
        });

        res.json(parsedQuestions);

    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error fetching questions', error });
    }
};

// Legacy/Direct get questions by subtopic
export const getQuestionsBySubtopic = async (req: Request, res: Response) => {
    // Reusing getQuizQuestions logic or keeping simple
    return getQuizQuestions(req, res);
};

export const createQuestion = async (req: Request, res: Response) => {
    const { content, options, correctOption, explanation, difficulty, subtopicId } = req.body;
    try {
        const question = await prisma.question.create({
            data: {
                content,
                options: JSON.stringify(options),
                correctOption,
                explanation,
                difficulty,
                subtopicId,
            },
        });
        res.status(201).json({ ...question, options: JSON.parse(question.options) });
    } catch (error) {
        res.status(500).json({ message: 'Error creating question', error });
    }
};

export const getAdaptiveQuestion = async (req: Request, res: Response) => {
    const { difficulty, chapterId, sessionId } = req.query;

    try {
        let question;

        if (difficulty === 'CHALLENGE') {
            // Find the Challenge level for this chapter
            const challengeLevel = await prisma.level.findFirst({
                where: { chapterId: String(chapterId), name: 'Challenge' },
                include: { questions: true }
            });

            if (challengeLevel && challengeLevel.questions.length > 0) {
                // Filter out already attempted questions
                const attemptedIds = (await prisma.attempt.findMany({
                    where: { quizSessionId: String(sessionId) },
                    select: { questionId: true }
                })).map(a => a.questionId);

                const available = challengeLevel.questions.filter(q => !attemptedIds.includes(q.id));
                question = available[Math.floor(Math.random() * available.length)] || challengeLevel.questions[0];
            }
        } else {
            // Standard difficulty pull (e.g. EASY for downgrade)
            const available = await prisma.question.findMany({
                where: {
                    difficulty: String(difficulty),
                    level: { chapterId: String(chapterId) }
                }
            });

            if (available.length > 0) {
                question = available[Math.floor(Math.random() * available.length)];
            }
        }

        if (!question) return res.status(404).json({ message: 'No suitable adaptive question found' });

        // Sanitize
        res.json({
            id: question.id,
            content: question.content,
            options: typeof question.options === 'string' ? JSON.parse(question.options) : question.options,
            difficulty: question.difficulty
        });
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error fetching adaptive question', error });
    }
};

export const seedContent = async (req: Request, res: Response) => {
    res.json({ message: 'Use CLI seed script instead.' });
};



/*******************************************************************************
 * FILE: server/controllers/forumController.ts
 *******************************************************************************/

import { Request, Response } from 'express';
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

// Get all posts (or filtered)
export const getPosts = async (req: Request, res: Response) => {
    const { subjectId, standard, board, sortBy } = req.query;

    try {
        const where: any = {};
        where.parentId = null; // Only top-level posts

        if (subjectId) where.subjectId = String(subjectId);

        // Filter by Standard (User's classStandard OR Subject's standard)
        if (standard) {
            where.OR = [
                { user: { classStandard: String(standard) } },
                { subject: { standard: String(standard) } }
            ];
        }

        // Filter by Board (User's board)
        if (board) {
            where.user = { ...where.user, board: String(board) };
        }

        // Sorting Logic
        let orderBy: any = { createdAt: 'desc' }; // Default: Newest
        if (sortBy === 'oldest') orderBy = { createdAt: 'asc' };
        if (sortBy === 'popular') orderBy = { upvotes: 'desc' };

        const posts = await prisma.forumPost.findMany({
            where,
            include: {
                user: { select: { id: true, name: true, profilePhoto: true, classStandard: true, board: true } },
                subject: { select: { id: true, name: true, standard: true } },
                _count: { select: { replies: true } }
            },
            orderBy
        });

        res.json(posts);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error fetching posts' });
    }
};

// Create a new post
export const createPost = async (req: Request, res: Response) => {
    const { title, content, subjectId } = req.body;
    const userId = (req as any).user.userId;

    // Get file URL if file was uploaded
    const fileUrl = (req as any).file ? `/uploads/${(req as any).file.filename}` : null;

    try {
        const post = await prisma.forumPost.create({
            data: {
                title,
                content,
                subjectId,
                fileUrl,
                userId
            }
        });
        res.status(201).json(post);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error creating post' });
    }
};

// Get a single post with replies
export const getPost = async (req: Request, res: Response) => {
    const id = req.params.id as string;

    try {
        const post = await prisma.forumPost.findUnique({
            where: { id },
            include: {
                user: { select: { id: true, name: true, profilePhoto: true } },
                subject: { select: { id: true, name: true } },
                replies: {
                    include: {
                        user: { select: { id: true, name: true, profilePhoto: true } }
                    },
                    orderBy: { createdAt: 'asc' }
                }
            }
        });

        if (!post) return res.status(404).json({ message: 'Post not found' });
        res.json(post);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error fetching post' });
    }
};

// Create a reply
export const createReply = async (req: Request, res: Response) => {
    const { content, postId } = req.body; // postId is parentId
    const userId = (req as any).user.userId;

    try {
        // Verify parent exists
        const parent = await prisma.forumPost.findUnique({ where: { id: postId } });
        if (!parent) return res.status(404).json({ message: 'Parent post not found' });

        const reply = await prisma.forumPost.create({
            data: {
                title: `Re: ${parent.title}`,
                content,
                userId,
                parentId: postId,
                subjectId: parent.subjectId
            }
        });
        res.status(201).json(reply);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error creating reply' });
    }
};

// Like (Upvote) a post
export const likePost = async (req: Request, res: Response) => {
    const id = req.params.id as string;

    try {
        const post = await prisma.forumPost.update({
            where: { id },
            data: { upvotes: { increment: 1 } }
        });
        res.json(post);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error upvoting post' });
    }
};



/*******************************************************************************
 * FILE: server/controllers/leaderboardController.ts
 *******************************************************************************/

import { Request, Response } from 'express';
import prisma from '../config/db.js';

// Get global leaderboard
export const getGlobalLeaderboard = async (req: Request, res: Response) => {
    const { limit = 50 } = req.query;

    try {
        const users = await prisma.user.findMany({
            select: {
                id: true,
                name: true,
                email: true,
                xp: true,
                rankScore: true,
                scholarStatus: true,
                streak: true,
            },
            orderBy: {
                rankScore: 'desc'
            },
            take: Number(limit)
        });

        // Add rank position
        const leaderboard = users.map((user, index) => ({
            ...user,
            rank: index + 1
        }));

        res.json(leaderboard);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error fetching leaderboard', error });
    }
};

// Get standard-wise leaderboard
export const getStandardLeaderboard = async (req: Request, res: Response) => {
    const { standard } = req.params;
    const { limit = 50 } = req.query;

    try {
        // Get users who have completed quizzes in this standard
        const users = await prisma.user.findMany({
            where: {
                quizSessions: {
                    some: {
                        level: {
                            chapter: {
                                subject: {
                                    standard: String(standard)
                                }
                            }
                        },
                        status: 'COMPLETED'
                    }
                }
            },
            select: {
                id: true,
                name: true,
                email: true,
                xp: true,
                rankScore: true,
                scholarStatus: true,
                streak: true,
            },
            orderBy: {
                rankScore: 'desc'
            },
            take: Number(limit)
        });

        const leaderboard = users.map((user, index) => ({
            ...user,
            rank: index + 1
        }));

        res.json(leaderboard);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error fetching standard leaderboard', error });
    }
};

// Get subject-wise leaderboard
export const getSubjectLeaderboard = async (req: Request, res: Response) => {
    const { subjectId } = req.params;
    const { limit = 50 } = req.query;

    try {
        // Get users who have completed quizzes in this subject
        const users = await prisma.user.findMany({
            where: {
                quizSessions: {
                    some: {
                        level: {
                            chapter: {
                                subjectId: String(subjectId)
                            }
                        },
                        status: 'COMPLETED'
                    }
                }
            },
            select: {
                id: true,
                name: true,
                email: true,
                xp: true,
                rankScore: true,
                scholarStatus: true,
                streak: true,
            },
            orderBy: {
                rankScore: 'desc'
            },
            take: Number(limit)
        });

        const leaderboard = users.map((user, index) => ({
            ...user,
            rank: index + 1
        }));

        res.json(leaderboard);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error fetching subject leaderboard', error });
    }
};

// Get user's rank position
export const getUserRank = async (req: Request, res: Response) => {
    const userId = req.params.userId as string;

    try {
        // Get all users ordered by rank score
        const allUsers = await prisma.user.findMany({
            select: {
                id: true,
                rankScore: true,
            },
            orderBy: {
                rankScore: 'desc'
            }
        });

        // Find user's position
        const userIndex = allUsers.findIndex(u => u.id === userId);

        if (userIndex === -1) {
            return res.status(404).json({ message: 'User not found' });
        }

        const user = await prisma.user.findUnique({
            where: { id: userId },
            select: {
                id: true,
                name: true,
                email: true,
                xp: true,
                rankScore: true,
                scholarStatus: true,
                streak: true,
            }
        });

        res.json({
            ...user,
            rank: userIndex + 1,
            totalUsers: allUsers.length
        });
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error fetching user rank', error });
    }
};



/*******************************************************************************
 * FILE: server/controllers/mentorController.ts
 *******************************************************************************/

import { Request, Response } from 'express';
import prisma from '../config/db.js';
import nodemailer from 'nodemailer';

const transporter = nodemailer.createTransport({
    service: 'gmail',
    auth: {
        user: process.env.EMAIL_USER,
        pass: process.env.EMAIL_PASS
    }
});

// ‚îÄ‚îÄ Helper: parse JSON fields ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const parseMentor = (m: any) => ({
    ...m,
    boards: JSON.parse(m.boards || '[]'),
    languages: JSON.parse(m.languages || '[]'),
    standards: JSON.parse(m.standards || '[]'),
    avgRating: m.ratings?.length
        ? Math.round((m.ratings.reduce((s: number, r: any) => s + r.rating, 0) / m.ratings.length) * 10) / 10
        : null,
    totalRatings: m.ratings?.length ?? 0,
});

// ‚îÄ‚îÄ GET /api/mentors ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
export const getAllMentors = async (req: Request, res: Response) => {
    try {
        const { board, standard, language } = req.query as any;

        const mentors = await prisma.mentor.findMany({
            where: { isActive: true },
            include: { ratings: { select: { rating: true, comment: true, userId: true, createdAt: true } } },
            orderBy: { createdAt: 'desc' }
        });

        let parsed = mentors.map(parseMentor);

        // Filter client-side (JSON array stored as string)
        if (board) parsed = parsed.filter((m: any) => m.boards.includes(board));
        if (standard) parsed = parsed.filter((m: any) => m.standards.includes(standard));
        if (language) parsed = parsed.filter((m: any) => m.languages.includes(language));

        res.json(parsed);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error fetching mentors', error });
    }
};

// ‚îÄ‚îÄ GET /api/mentors/:id ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
export const getMentorById = async (req: Request, res: Response) => {
    try {
        const mentor = await prisma.mentor.findUnique({
            where: { id: req.params.id },
            include: { ratings: { orderBy: { createdAt: 'desc' } } }
        });
        if (!mentor) return res.status(404).json({ message: 'Mentor not found' });
        res.json(parseMentor(mentor));
    } catch (error) {
        res.status(500).json({ message: 'Error fetching mentor', error });
    }
};

// ‚îÄ‚îÄ POST /api/mentors  (Admin only) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
export const createMentor = async (req: Request, res: Response) => {
    try {
        const { name, email, youtubeChannel, boards, languages, standards, bio } = req.body;
        if (!name || !email || !boards || !languages || !standards)
            return res.status(400).json({ message: 'name, email, boards, languages, standards are required' });

        let profilePicture = null;
        if (req.file) {
            profilePicture = `/uploads/${req.file.filename}`;
        }

        return res.status(400).json({ message: 'name, email, boards, languages, standards are required' });

        const mentor = await prisma.mentor.create({
            data: {
                name,
                email,
                youtubeChannel,
                boards: JSON.stringify(Array.isArray(boards) ? boards : [boards]),
                languages: JSON.stringify(Array.isArray(languages) ? languages : [languages]),
                standards: JSON.stringify(Array.isArray(standards) ? standards : [standards]),
                bio,
                profilePicture,
            }
        });
        res.status(201).json({ ...mentor, boards, languages, standards });
    } catch (error: any) {
        if (error.code === 'P2002') return res.status(400).json({ message: 'A mentor with this email already exists.' });
        res.status(500).json({ message: 'Error creating mentor', error });
    }
};

// ‚îÄ‚îÄ PUT /api/mentors/:id  (Admin only) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
export const updateMentor = async (req: Request, res: Response) => {
    try {
        const { name, email, youtubeChannel, boards, languages, standards, bio, isActive } = req.body;

        const updateData: any = {
            name, email, youtubeChannel, bio,
            ...(boards && { boards: JSON.stringify(Array.isArray(boards) ? boards : [boards]) }),
            ...(languages && { languages: JSON.stringify(Array.isArray(languages) ? languages : [languages]) }),
            ...(standards && { standards: JSON.stringify(Array.isArray(standards) ? standards : [standards]) }),
        };

        if (isActive !== undefined) {
            updateData.isActive = isActive === 'true' || isActive === true;
        }

        if (req.file) {
            updateData.profilePicture = `/uploads/${req.file.filename}`;
        }

        const mentor = await prisma.mentor.update({
            where: { id: req.params.id },
            data: updateData
        });
        res.json(parseMentor({ ...mentor, ratings: [] }));
    } catch (error) {
        res.status(500).json({ message: 'Error updating mentor', error });
    }
};

// ‚îÄ‚îÄ DELETE /api/mentors/:id  (Admin only) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
export const deleteMentor = async (req: Request, res: Response) => {
    try {
        await prisma.mentor.delete({ where: { id: req.params.id } });
        res.json({ message: 'Mentor deleted successfully' });
    } catch (error) {
        res.status(500).json({ message: 'Error deleting mentor', error });
    }
};

// ‚îÄ‚îÄ POST /api/mentors/:id/request  (Student) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
export const requestMeeting = async (req: Request, res: Response) => {
    try {
        const userId = (req as any).user.userId;
        const { message } = req.body;

        if (!message?.trim()) return res.status(400).json({ message: 'Message is required' });

        const [mentor, student] = await Promise.all([
            prisma.mentor.findUnique({ where: { id: req.params.id } }),
            prisma.user.findUnique({ where: { id: userId }, select: { name: true, email: true } })
        ]);

        if (!mentor) return res.status(404).json({ message: 'Mentor not found' });
        if (!student) return res.status(404).json({ message: 'Student not found' });

        await transporter.sendMail({
            from: `"Yatsya Platform" <${process.env.EMAIL_USER}>`,
            to: mentor.email,
            replyTo: student.email,
            subject: `Meeting Request from ${student.name} ‚Äî Yatsya`,
            html: `
                <div style="font-family:sans-serif;max-width:600px;margin:0 auto;background:#0B1120;color:#e2e8f0;border-radius:16px;padding:32px;">
                    <h2 style="color:#22d3ee;margin-bottom:4px;">üìö New Meeting Request</h2>
                    <p style="color:#94a3b8;margin-top:0;">via Yatsya Adaptive Learning Platform</p>
                    <hr style="border:1px solid #1e293b;margin:24px 0;">
                    <p><strong>Student Name:</strong> ${student.name}</p>
                    <p><strong>Student Email:</strong> <a href="mailto:${student.email}" style="color:#22d3ee;">${student.email}</a></p>
                    <p><strong>Message:</strong></p>
                    <blockquote style="background:#1e293b;border-left:4px solid #22d3ee;padding:16px;border-radius:8px;margin:8px 0;">
                        ${message.replace(/\n/g, '<br>')}
                    </blockquote>
                    <hr style="border:1px solid #1e293b;margin:24px 0;">
                    <p style="color:#64748b;font-size:12px;">You can reply directly to this email to contact the student.</p>
                </div>
            `
        });

        res.json({ message: 'Meeting request sent successfully to the mentor.' });
    } catch (error: any) {
        console.error('Meeting request error:', error);
        res.status(500).json({ message: 'Failed to send meeting request', error: error.message });
    }
};

// ‚îÄ‚îÄ POST /api/mentors/:id/rate  (Student) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
export const rateMentor = async (req: Request, res: Response) => {
    try {
        const userId = (req as any).user.userId;
        const { rating, comment } = req.body;

        if (!rating || rating < 1 || rating > 5)
            return res.status(400).json({ message: 'Rating must be between 1 and 5' });

        const mentor = await prisma.mentor.findUnique({ where: { id: req.params.id } });
        if (!mentor) return res.status(404).json({ message: 'Mentor not found' });

        const result = await prisma.mentorRating.upsert({
            where: { mentorId_userId: { mentorId: req.params.id, userId } },
            update: { rating, comment },
            create: { mentorId: req.params.id, userId, rating, comment }
        });

        res.json({ message: 'Rating submitted', rating: result });
    } catch (error) {
        res.status(500).json({ message: 'Error submitting rating', error });
    }
};



/*******************************************************************************
 * FILE: server/controllers/notificationController.ts
 *******************************************************************************/

import { Request, Response } from 'express';
import prisma from '../config/db.js';

const NUDGES = [
    "The bird is watching you... take your lesson!",
    "Another day, another chance to not disappoint the bird.",
    "Your streak is crying. Do you want to see a bird cry?",
    "I'm not mad, just disappointed. Open the app.",
    "Studies show that taking a quiz every day makes you 100% more likely to not get poked by a bird.",
    "Is that a streak I see expiring? How... unfortunate.",
    "Remember: The bird never sleeps. Neither should your ambition."
];

export const getNotifications = async (req: Request, res: Response) => {
    const userId = (req as any).user.userId;

    try {
        const notifications = await prisma.notification.findMany({
            where: { userId },
            orderBy: { createdAt: 'desc' },
            take: 20
        });
        res.json(notifications);
    } catch (error) {
        res.status(500).json({ message: 'Error fetching notifications', error });
    }
};

export const markAsRead = async (req: Request, res: Response) => {
    const { id } = req.params;
    try {
        await prisma.notification.update({
            where: { id: id as string },
            data: { isRead: true }
        });
        res.json({ message: 'Marked as read' });
    } catch (error) {
        res.status(500).json({ message: 'Error updating notification', error });
    }
};

export const syncNotifications = async (req: Request, res: Response) => {
    const userId = (req as any).user.userId;

    try {
        const user = await prisma.user.findUnique({
            where: { id: userId },
            include: { notifications: true, quizSessions: { orderBy: { startTime: 'desc' }, take: 1 } }
        });

        if (!user) return res.status(404).json({ message: 'User not found' });

        const now = new Date();
        const lastActivity = user.quizSessions[0]?.startTime || user.createdAt;
        const hoursSinceLastActivity = (now.getTime() - lastActivity.getTime()) / (1000 * 60 * 60);

        // 1. Daily Reminder (If no session today)
        const startOfToday = new Date();
        startOfToday.setHours(0, 0, 0, 0);
        const hasSessionToday = user.quizSessions[0]?.startTime >= startOfToday;

        if (!hasSessionToday) {
            const lastReminder = user.notifications.find(n => n.type === 'REMINDER' && n.createdAt >= startOfToday);
            if (!lastReminder) {
                await prisma.notification.create({
                    data: {
                        userId,
                        title: "Daily Goal",
                        message: "Don't break your streak! Time for a quick science quiz.",
                        type: "REMINDER"
                    }
                });
            }
        }

        // 2. Streak Alert (In danger)
        if (user.streak > 0 && hoursSinceLastActivity > 20 && hoursSinceLastActivity < 24) {
            const recentStreakAlert = user.notifications.find(n => n.type === 'STREAK' && n.createdAt >= startOfToday);
            if (!recentStreakAlert) {
                await prisma.notification.create({
                    data: {
                        userId,
                        title: "Streak in Danger!",
                        message: `Your ${user.streak}-day streak is about to expire. Save it now!`,
                        type: "STREAK"
                    }
                });
            }
        }

        // 3. Persistent Nudges (Aggressive/Funny)
        if (hoursSinceLastActivity > 48) {
            const lastNudge = user.notifications.find(n => n.type === 'NUDGE' && n.createdAt >= startOfToday);
            if (!lastNudge) {
                const randomNudge = NUDGES[Math.floor(Math.random() * NUDGES.length)];
                await prisma.notification.create({
                    data: {
                        userId,
                        title: "Where are you?",
                        message: randomNudge,
                        type: "NUDGE"
                    }
                });
            }
        }

        // Return the fresh list
        const notifications = await prisma.notification.findMany({
            where: { userId },
            orderBy: { createdAt: 'desc' },
            take: 20
        });
        res.json(notifications);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error syncing notifications', error });
    }
};



/*******************************************************************************
 * FILE: server/controllers/profileController.ts
 *******************************************************************************/

import { Request, Response } from 'express';
import prisma from '../config/db.js';

// Get User Profile
export const getProfile = async (req: Request, res: Response) => {
    const userId = (req as any).user.userId;

    try {
        const user = await prisma.user.findUnique({
            where: { id: userId },
            select: {
                id: true,
                name: true,
                email: true,
                role: true,
                gender: true,
                age: true,
                classStandard: true,
                schoolName: true,
                board: true,
                profilePhoto: true,
                streak: true,
                xp: true,
                scholarStatus: true,
                rankScore: true,
                badges: { include: { badge: true } }
            }
        });
        res.json(user);
    } catch (error) {
        res.status(500).json({ message: 'Error fetching profile' });
    }
};



// Update Profile
export const updateProfile = async (req: Request, res: Response) => {
    const userId = (req as any).user.userId;
    const { name, gender, age, schoolName, board, classStandard, profilePhoto } = req.body;

    console.log('Update Profile Request for User:', userId);
    console.log('Data:', { name, gender, age, schoolName, board, classStandard, photoPrefix: profilePhoto?.substring(0, 30) });

    try {
        const user = await prisma.user.update({
            where: { id: userId },
            data: {
                name,
                gender,
                age: age ? (isNaN(parseInt(age)) ? undefined : parseInt(age)) : null,
                schoolName,
                board,
                classStandard,
                profilePhoto
            }
        });

        console.log('Update successful for User:', userId);

        res.json({
            message: 'Profile updated successfully',
            user: {
                id: user.id,
                name: user.name,
                email: user.email,
                role: user.role,
                gender: user.gender,
                age: user.age,
                classStandard: user.classStandard,
                schoolName: user.schoolName,
                board: user.board,
                profilePhoto: user.profilePhoto
            }
        });
    } catch (error) {
        console.error('Update Profile Error:', error);
        res.status(500).json({ message: 'Error updating profile' });
    }
};



/*******************************************************************************
 * FILE: server/controllers/quizController.ts
 *******************************************************************************/

import { Request, Response } from 'express';
import prisma from '../config/db.js';
import { generateQuizFeedback } from '../services/aiMentorService.js';

// Start a quiz session
export const startQuizSession = async (req: Request, res: Response) => {
    const { levelId } = req.body;
    const userId = (req as any).user.userId; // Middleware augments req

    try {
        // --- LEVEL LOCK CHECK ---
        const level = await prisma.level.findUnique({
            where: { id: levelId },
            include: { chapter: true }
        });

        if (!level) return res.status(404).json({ message: 'Level not found' });

        // If it's not Diagnostic, check if prerequisite is met
        if (level.name !== 'Diagnostic') {
            const levels = await prisma.level.findMany({
                where: { chapterId: level.chapterId },
                orderBy: { order: 'asc' }
            });

            const currentLevelIndex = levels.findIndex(l => l.id === levelId);
            if (currentLevelIndex > 0) {
                const prevLevel = levels[currentLevelIndex - 1];
                const bestAttempt = await prisma.quizSession.findFirst({
                    where: {
                        userId,
                        levelId: prevLevel.id,
                        status: 'COMPLETED'
                    },
                    orderBy: { score: 'desc' }
                });

                const requiredScore = prevLevel.name === 'Diagnostic' ? 80 : 60;
                if (!bestAttempt || bestAttempt.score < requiredScore) {
                    return res.status(403).json({
                        message: `Level locked. You need ${requiredScore}% in ${prevLevel.name} to unlock this level.`
                    });
                }
            }
        }

        const session = await prisma.quizSession.create({
            data: {
                userId,
                levelId,
                status: 'IN_PROGRESS',
                startTime: new Date(),
                score: 0,
            }
        });
        res.json(session);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error starting quiz', error });
    }
};

// Submit an answer (record attempt)
export const submitAnswer = async (req: Request, res: Response) => {
    const { sessionId, questionId, selectedOptionId, timeTaken } = req.body;
    const userId = (req as any).user.userId;

    try {
        const question = await prisma.question.findUnique({
            where: { id: questionId },
            include: { level: { include: { chapter: true } } }
        });
        if (!question) return res.status(404).json({ message: 'Question not found' });

        const isCorrect = question.correctOption === selectedOptionId;

        await prisma.attempt.create({
            data: {
                userId,
                quizSessionId: sessionId,
                questionId,
                isCorrect,
                timeTaken,
            }
        });

        // --- ADAPTIVE LOGIC DETECTION ---
        let adaptiveAction: 'UPGRADE' | 'DOWNGRADE' | 'NONE' = 'NONE';

        // Fetch recent attempts in this session
        const recentAttempts = await prisma.attempt.findMany({
            where: { quizSessionId: sessionId },
            orderBy: { createdAt: 'desc' },
            take: 3,
            include: { question: true }
        });

        if (isCorrect) {
            // Check for UPGRADE: 3 consecutive correct HARD questions with speed < 25s
            if (recentAttempts.length >= 3) {
                const fastHardCorrect = recentAttempts.every(a =>
                    a.isCorrect &&
                    a.question.difficulty === 'HARD' &&
                    a.timeTaken < 25
                );
                if (fastHardCorrect) adaptiveAction = 'UPGRADE';
            }
        } else {
            // Check for DOWNGRADE: 2 consecutive missed MEDIUM questions
            if (recentAttempts.length >= 2) {
                const missedMedium = recentAttempts.slice(0, 2).every(a =>
                    !a.isCorrect &&
                    a.question.difficulty === 'MEDIUM'
                );
                if (missedMedium) adaptiveAction = 'DOWNGRADE';
            }
        }

        // Return feedback immediately
        const feedback = isCorrect ? question.rightFeedback : question.wrongFeedback;
        res.json({
            isCorrect,
            correctOption: question.correctOption,
            feedback: feedback || (isCorrect ? 'Correct!' : 'Incorrect.'),
            adaptiveAction,
            chapterId: question.level?.chapterId,
            subtopicId: question.subtopicId
        });
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error submitting answer', error });
    }
};

// Complete quiz session
export const completeQuizSession = async (req: Request, res: Response) => {
    const { sessionId } = req.body;
    const userId = (req as any).user.userId;

    try {
        const session = await prisma.quizSession.findUnique({
            where: { id: sessionId },
            include: {
                attempts: { include: { question: { include: { subtopic: true } } } },
                level: { include: { chapter: { include: { subject: true } } } }
            }
        });

        if (!session) return res.status(404).json({ message: 'Session not found' });

        // Calculate score
        const totalQuestions = session.attempts.length;
        const correctAnswers = session.attempts.reduce((acc: number, curr: any) => acc + (curr.isCorrect ? 1 : 0), 0);
        const scorePercentage = totalQuestions > 0 ? (correctAnswers / totalQuestions) * 100 : 0;
        const timeTaken = session.attempts.reduce((acc: number, curr: any) => acc + curr.timeTaken, 0); // Total seconds

        // --- Backend Anti-Cheat Detection ---
        let isFlagged = session.isFlagged || false;
        let flagReason = '';

        // 1. Fast Completion Detection (< 30 seconds for entire quiz)
        if (timeTaken < 30 && totalQuestions >= 10) {
            isFlagged = true;
            flagReason = 'Fast completion detected';
        }

        // 2. Pattern Detection (all answers < 2 seconds each)
        const avgTimePerQuestion = totalQuestions > 0 ? timeTaken / totalQuestions : 0;
        if (avgTimePerQuestion < 2) {
            isFlagged = true;
            flagReason = flagReason ? `${flagReason}; Suspicious answer pattern` : 'Suspicious answer pattern';
        }

        // 3. Tab Switch Tracking (already tracked in frontend)
        if (session.tabSwitches >= 3) {
            isFlagged = true;
            flagReason = flagReason ? `${flagReason}; Excessive tab switching` : 'Excessive tab switching';
        }

        // 4. Perfect Score Pattern (100% on first attempt after multiple failures)
        if (scorePercentage === 100) {
            const previousAttempts = await prisma.quizSession.findMany({
                where: {
                    userId,
                    levelId: session.levelId,
                    status: 'COMPLETED',
                    id: { not: sessionId }
                },
                orderBy: { startTime: 'desc' },
                take: 3
            });

            const recentFailures = previousAttempts.filter(a => a.score < 60).length;
            if (recentFailures >= 2) {
                isFlagged = true;
                flagReason = flagReason ? `${flagReason}; Suspicious score improvement` : 'Suspicious score improvement';
            }
        }

        // --- AI Feedback Generation (ASYNCHRONOUS) ---
        const wrongAnswers = session.attempts.filter(a => !a.isCorrect);

        // Trigger background AI task
        generateQuizFeedback(
            scorePercentage,
            session.level.chapter.subject.name,
            session.level.chapter.name,
            session.level.name,
            wrongAnswers
        ).then(async (aiResponse) => {
            // Update session with AI feedback once ready
            await prisma.quizSession.update({
                where: { id: sessionId },
                data: {
                    aiFeedback: aiResponse.feedback,
                    recommendations: aiResponse.recommendations
                }
            });
            console.log(`AI Feedback generated for session ${sessionId}`);
        }).catch(err => {
            console.error(`AI Feedback generation failed for session ${sessionId}:`, err);
        });

        // Update session immediately with core stats
        const updatedSession = await prisma.quizSession.update({
            where: { id: sessionId },
            data: {
                status: 'COMPLETED',
                endTime: new Date(),
                score: scorePercentage,
                timeSpent: timeTaken,
                isFlagged,
            }
        });

        // --- Adaptive Logic ---
        let message = 'Quiz completed.';
        let nextLevelUnlock = '';

        if (session.level.name === 'Diagnostic') {
            if (scorePercentage >= 80) {
                message = 'Excellent! You have unlocked Beginner Level.';
                nextLevelUnlock = 'Beginner';
            } else {
                message = 'You need at least 80% to unlock the Beginner Level. Please try again.';
                nextLevelUnlock = '';
            }
        }
        // Logic for other levels (Sequential)
        else if (session.level.name === 'Beginner' && scorePercentage >= 60) nextLevelUnlock = 'Intermediate';
        else if (session.level.name === 'Intermediate' && scorePercentage >= 60) nextLevelUnlock = 'Advance';
        else if (session.level.name === 'Advance' && scorePercentage >= 60) nextLevelUnlock = 'Challenge';


        // --- Gamification Logic ---

        // 1. XP Calculation
        // Formula: Correct * 10
        const baseXp = correctAnswers * 10;

        // 2. Rank Score Calculation
        // Formula: Score * 0.5 + Levels * 10 + Streak * 2 + Speed Bonus
        const user = await prisma.user.findUnique({ where: { id: userId }, include: { quizSessions: true } });
        const levelsCompleted = user?.quizSessions.filter((s: any) => s.status === 'COMPLETED').length || 0;
        const currentStreak = user?.streak || 0;

        // Speed Bonus: If average time per question < 30s, give bonus
        const avgTime = totalQuestions > 0 ? timeTaken / totalQuestions : 0;
        const speedBonus = avgTime < 30 ? 50 : (avgTime < 60 ? 20 : 0);

        const rankScoreIds = (scorePercentage * 0.5) + (levelsCompleted * 10) + (currentStreak * 2) + speedBonus;

        // 3. Update User
        // Scholar Status Logic:
        // Learner: 0-500, Smart: 500-1500, Gold: 1500-3000, Elite: 3000+
        const newXp = (user?.xp || 0) + baseXp;
        let newStatus = 'Learner';
        if (newXp > 3000) newStatus = 'Elite Scholar';
        else if (newXp > 1500) newStatus = 'Gold Scholar';
        else if (newXp > 500) newStatus = 'Smart Scholar';

        await prisma.user.update({
            where: { id: userId },
            data: {
                xp: newXp,
                rankScore: { increment: rankScoreIds }, // Accumulate
                scholarStatus: newStatus,
            }
        });

        // Log XP
        await prisma.xpLog.create({
            data: {
                userId,
                amount: baseXp,
                reason: `Quiz Completion: ${session.level?.name || 'Standard'}`
            }
        });

        res.json({
            message,
            score: scorePercentage,
            xpEarned: baseXp,
            rankScoreEarned: rankScoreIds,
            newStatus,
            nextLevelUnlock,
            // aiFeedback and recommendations are NOT returned yet as they are being generated
            aiFeedbackFetched: false,
            youtubeLink: session.level.chapter.youtubeLink
        });

    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error completing quiz', error });
    }
};

// Get specific quiz session details
export const getQuizSessionDetails = async (req: Request, res: Response) => {
    const { sessionId } = req.params;

    try {
        const session = await prisma.quizSession.findUnique({
            where: { id: sessionId as string },
            include: {
                level: {
                    include: {
                        chapter: {
                            include: {
                                subject: true
                            }
                        }
                    }
                }
            }
        });

        if (!session) return res.status(404).json({ message: 'Session not found' });

        res.json(session);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error fetching session details' });
    }
};

// Get previous quiz reports
export const getQuizReports = async (req: Request, res: Response) => {
    const userId = (req as any).user.userId;

    try {
        const reports = await prisma.quizSession.findMany({
            where: {
                userId,
                status: 'COMPLETED'
            },
            include: {
                level: {
                    include: {
                        chapter: {
                            include: {
                                subject: true
                            }
                        }
                    }
                }
            },
            orderBy: { endTime: 'desc' },
            take: 10
        });

        res.json(reports);
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: 'Error fetching reports' });
    }
};



/*******************************************************************************
 * FILE: server/controllers/uploadController.ts
 *******************************************************************************/

import { Request, Response } from 'express';
import multer from 'multer';
import path from 'path';
import fs from 'fs';

// Configure multer for memory storage (we'll save base64)
const storage = multer.memoryStorage();
const upload = multer({
    storage,
    limits: { fileSize: 5 * 1024 * 1024 }, // 5MB limit
    fileFilter: (req, file, cb) => {
        const allowedTypes = /jpeg|jpg|png|gif|webp/;
        const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());
        const mimetype = allowedTypes.test(file.mimetype);

        if (mimetype && extname) {
            return cb(null, true);
        } else {
            cb(new Error('Only image files are allowed!'));
        }
    }
}).single('photo');

export const uploadPhoto = (req: Request, res: Response) => {
    upload(req, res, (err) => {
        if (err) {
            return res.status(400).json({ message: err.message });
        }

        if (!req.file) {
            return res.status(400).json({ message: 'No file uploaded' });
        }

        try {
            // Convert buffer to base64
            const base64Image = `data:${req.file.mimetype};base64,${req.file.buffer.toString('base64')}`;

            res.json({
                message: 'Photo uploaded successfully',
                photoUrl: base64Image
            });
        } catch (error) {
            res.status(500).json({ message: 'Error processing photo', error });
        }
    });
};

// Alternative: Handle base64 upload directly from cropped image
export const uploadPhotoBase64 = (req: Request, res: Response) => {
    try {
        const { photoData } = req.body;

        if (!photoData || !photoData.startsWith('data:image')) {
            return res.status(400).json({ message: 'Invalid photo data' });
        }

        // In a production app, you would:
        // 1. Save to cloud storage (AWS S3, Cloudinary, etc.)
        // 2. Return the public URL
        // For now, we'll just return the base64 data

        res.json({
            message: 'Photo uploaded successfully',
            photoUrl: photoData
        });
    } catch (error) {
        res.status(500).json({ message: 'Error uploading photo', error });
    }
};



/*******************************************************************************
 * FILE: server/create-yatsya-db.ts
 *******************************************************************************/

import { Client } from 'pg';
import dotenv from 'dotenv';
dotenv.config();

async function setupDatabase() {
    const connectionString = process.env.DATABASE_URL;
    // Extract base connection string (pointing to 'postgres' instead of 'yatsya_db')
    const baseConn = connectionString.includes('yatsya_db')
        ? connectionString.replace(/\/yatsya_db\?/, '/postgres?')
        : connectionString;

    const client = new Client({
        connectionString: baseConn,
    });

    try {
        await client.connect();
        console.log('Connected to default postgres database');

        // Check if yatsya_db exists
        const res = await client.query("SELECT 1 FROM pg_database WHERE datname='yatsya_db'");
        if (res.rowCount === 0) {
            console.log('Database yatsya_db does not exist. Creating...');
            await client.query('CREATE DATABASE yatsya_db');
            console.log('Database yatsya_db created successfully');
        } else {
            console.log('Database yatsya_db already exists');
        }
        await client.end();
    } catch (err) {
        console.error('Error setting up database:', err.message);
    }
}

setupDatabase();



/*******************************************************************************
 * FILE: server/debug_xp.ts
 *******************************************************************************/

import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
    console.log('--- Starting XP Debug Script ---');

    // 1. Get a test user (or create one if empty)
    let user = await prisma.user.findFirst();
    if (!user) {
        console.log('No user found, creating a test user...');
        user = await prisma.user.create({
            data: {
                name: 'Test User',
                email: 'test@xp.com',
                password: 'hashedpassword',
                xp: 0
            }
        });
    }

    console.log(`User found: ${user.email}`);
    console.log(`Initial XP: ${user.xp}`);

    // 2. Find a level to play
    const level = await prisma.level.findFirst({ include: { chapter: true } });
    if (!level) {
        console.error('No levels found in DB. Cannot simulate quiz.');
        return;
    }
    console.log(`Simulating quiz for Level: ${level.name} (Chapter: ${level.chapter.name})`);

    // 3. Create a Quiz Session
    const session = await prisma.quizSession.create({
        data: {
            userId: user.id,
            levelId: level.id,
            status: 'IN_PROGRESS',
            score: 0,
            startTime: new Date()
        }
    });
    console.log(`Session created: ${session.id}`);

    // 4. Create dummy attempts (1 Correct Answer = 10 XP)
    const question = await prisma.question.findFirst({ where: { levelId: level.id } }) ||
        await prisma.question.findFirst(); // Fallback

    if (!question) {
        console.error('No questions found.');
        return;
    }

    await prisma.attempt.create({
        data: {
            userId: user.id,
            quizSessionId: session.id,
            questionId: question.id,
            isCorrect: true, // This should give 10 XP
            timeTaken: 5
        }
    });
    console.log('Created 1 correct attempt (should be 10 XP).');

    // 5. Simulate Complete Quiz Logic (Manual implementation of controller logic for verification)
    // In the real app, this is done by quizController.completeQuizSession.
    // We will call the EXACT logic used there (simplified for script).

    // --- CONTROLLER LOGIC SIMULATION START ---
    const totalQuestions = 1;
    const correctAnswers = 1;
    const scorePercentage = 100;

    const baseXp = correctAnswers * 10;
    const currentXp = user.xp || 0;
    const newXp = currentXp + baseXp;

    console.log(`Calculated Base XP: ${baseXp}`);
    console.log(`Expected New XP: ${newXp}`);

    // Perform Update
    const updatedUser = await prisma.user.update({
        where: { id: user.id },
        data: {
            xp: newXp
        }
    });

    await prisma.xpLog.create({
        data: {
            userId: user.id,
            amount: baseXp,
            reason: 'Debug Script Test'
        }
    });

    // --- CONTROLLER LOGIC SIMULATION END ---

    console.log(`Updated User XP in DB: ${updatedUser.xp}`);

    if (updatedUser.xp === newXp) {
        console.log('SUCCESS: XP was saved correctly.');
    } else {
        console.error('FAILURE: XP mismatch.');
    }
}

main()
    .catch(e => console.error(e))
    .finally(async () => await prisma.$disconnect());



/*******************************************************************************
 * FILE: server/deduplicate_chapters.ts
 *******************************************************************************/


import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function deduplicateChapters() {
    console.log('Checking for duplicate chapters...');

    const chapters = await prisma.chapter.findMany({
        include: {
            subject: true
        }
    });


    // Group chapters by normalized unique key
    const chapterGroups: Record<string, typeof chapters> = {};

    for (const chapter of chapters) {
        const normalizedName = chapter.name.toLowerCase().replace('&', 'and').replace(/\s+/g, ' ').trim();
        const uniqueKey = `${normalizedName}-${chapter.subjectId}`;

        if (!chapterGroups[uniqueKey]) {
            chapterGroups[uniqueKey] = [];
        }
        chapterGroups[uniqueKey].push(chapter);
    }

    // Process groups
    for (const [key, group] of Object.entries(chapterGroups)) {
        if (group.length > 1) {
            console.log(`Found duplicate group: ${key} (${group.length} chapters)`);

            // Keep the first one as primary
            const primary = group[0];
            const duplicates = group.slice(1);

            console.log(`  Keeping primary: ${primary.name} (${primary.id})`);


            for (const duplicate of duplicates) {
                console.log(`  Processing duplicate: ${duplicate.name} (${duplicate.id})`);

                // 1. Merge Levels
                const duplicateLevels = await prisma.level.findMany({ where: { chapterId: duplicate.id } });
                for (const level of duplicateLevels) {
                    const existingLevel = await prisma.level.findFirst({
                        where: { chapterId: primary.id, name: level.name }
                    });

                    if (existingLevel) {
                        console.log(`    Merging Level "${level.name}"...`);
                        await prisma.question.updateMany({ where: { levelId: level.id }, data: { levelId: existingLevel.id } });
                        await prisma.quizSession.updateMany({ where: { levelId: level.id }, data: { levelId: existingLevel.id } });
                        await prisma.level.delete({ where: { id: level.id } });
                    } else {
                        console.log(`    Moving Level "${level.name}"...`);
                        await prisma.level.update({ where: { id: level.id }, data: { chapterId: primary.id } });
                    }
                }

                // 2. Merge Subtopics
                const duplicateSubtopics = await prisma.subtopic.findMany({ where: { chapterId: duplicate.id } });
                for (const subtopic of duplicateSubtopics) {
                    const existingSubtopic = await prisma.subtopic.findFirst({
                        where: { chapterId: primary.id, name: subtopic.name }
                    });

                    if (existingSubtopic) {
                        console.log(`    Merging Subtopic "${subtopic.name}"...`);
                        await prisma.question.updateMany({ where: { subtopicId: subtopic.id }, data: { subtopicId: existingSubtopic.id } });
                        await prisma.masteryTracking.updateMany({ where: { subtopicId: subtopic.id }, data: { subtopicId: existingSubtopic.id } });
                        await prisma.subtopic.delete({ where: { id: subtopic.id } });
                    } else {
                        console.log(`    Moving Subtopic "${subtopic.name}"...`);
                        await prisma.subtopic.update({ where: { id: subtopic.id }, data: { chapterId: primary.id } });
                    }
                }

                // 3. Delete Duplicate Chapter
                try {
                    await prisma.chapter.delete({ where: { id: duplicate.id } });
                    console.log(`    Deleted duplicate chapter.`);
                } catch (error) {
                    console.error(`    Failed to delete duplicate chapter:`, error);
                }
            }
        }
    }

    console.log('Deduplication complete.');
}

deduplicateChapters()
    .catch((e) => {
        console.error(e);
        process.exit(1);
    })
    .finally(async () => {
        await prisma.$disconnect();
    });



/*******************************************************************************
 * FILE: server/env-test.ts
 *******************************************************************************/

import dotenv from 'dotenv';
import path from 'path';

const result = dotenv.config();
console.log('Dotenv result:', result);
console.log('CWD:', process.cwd());
console.log('PORT:', process.env.PORT);
console.log('DATABASE_URL:', process.env.DATABASE_URL);
console.log('GEMINI_API_KEY:', process.env.GEMINI_API_KEY ? 'Present' : 'Missing');



/*******************************************************************************
 * FILE: server/explain_project.ts
 *******************************************************************************/

/**
 * Hackathon Technical Explanation Script
 * Outputs a structured technical summary of the project.
 */

const projectDetails = {
    name: "AI-Powered Adaptive Learning Platform",
    architecture: "Express.js / TypeScript / Prisma / PostgreSQL",
    coreFeatures: [
        "4-Tier Adaptive Difficulty Engine (Diagnostic to Challenge)",
        "Real-time UPGRADE/DOWNGRADE logic based on performance patterns",
        "AI Behavioral Anti-Cheat (Tab switch detection, speed metrics)",
        "Gamified Progression (XP Logs, Scholar Status rankings)"
    ],
    aiStack: {
        providers: ["Google Gemini 1.5 Flash", "OpenAI GPT-4o-mini"],
        strategy: "Rate-limit resilient rotation & fallback service layer"
    },
    uniqueStats: [
        "Dynamic content generation for 'Challenge' levels",
        "Personalized AI Mentor feedback per quiz session",
        "Backend anti-cheat detection for suspicious score jumps"
    ]
};

function displayExplanation() {
    console.log("====================================================");
    console.log(`üöÄ PROJECT: ${projectDetails.name}`);
    console.log("====================================================");

    console.log("\nüèóÔ∏è  ARCHITECTURE:");
    console.log(projectDetails.architecture);

    console.log("\nüéØ CORE FEATURES:");
    projectDetails.coreFeatures.forEach(f => console.log(` - ${f}`));

    console.log("\nü§ñ AI STACK:");
    console.log(` Providers: ${projectDetails.aiStack.providers.join(", ")}`);
    console.log(` Strategy:  ${projectDetails.aiStack.strategy}`);

    console.log("\n‚ú® UNIQUE VALUE PROPS:");
    projectDetails.uniqueStats.forEach(s => console.log(` + ${s}`));

    console.log("\n====================================================");
    console.log("             HACKATHON READY VERSION v1.0");
    console.log("====================================================");
}

displayExplanation();



/*******************************************************************************
 * FILE: server/inspect_content.ts
 *******************************************************************************/


import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function inspectContent() {
    console.log('Inspecting content...');

    const subjects = await prisma.subject.findMany({
        include: {
            chapters: true
        }
    });

    for (const subject of subjects) {
        console.log(`Subject: ${subject.name} (Standard: ${subject.standard}, ID: ${subject.id})`);
        console.log(`  Chapter Count: ${subject.chapters.length}`);
        subject.chapters.forEach(c => {
            console.log(`    - "${c.name}" (ID: ${c.id})`);
        });
    }
}

inspectContent()
    .catch((e) => {
        console.error(e);
        process.exit(1);
    })
    .finally(async () => {
        await prisma.$disconnect();
    });



/*******************************************************************************
 * FILE: server/middlewares/authMiddleware.ts
 *******************************************************************************/

import { Request, Response, NextFunction } from 'express';
import jwt from 'jsonwebtoken';

const JWT_SECRET = process.env.JWT_SECRET || 'secret';

interface AuthRequest extends Request {
    user?: any;
    userId?: string; // Added userId to AuthRequest
}

export const authenticate = async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
        const authHeader = req.headers.authorization;
        // console.log('Auth Header:', authHeader); // Optional: verbose
        const token = authHeader?.split(' ')[1];

        if (!token) {
            console.log('Middleware: No token provided');
            return res.status(401).json({ message: 'No token provided' });
        }

        const decoded = jwt.verify(token, JWT_SECRET) as { userId?: string, id?: string, role: string };
        const userId = decoded.userId || decoded.id;

        if (!userId) {
            console.log('Middleware: No userId in decoded token', decoded);
            res.status(401).json({ message: 'Token invalid: Missing user ID' });
            return;
        }

        req.user = { userId: userId, role: decoded.role };
        req.userId = userId; // Keep for backward compatibility
        next();
    } catch (error) {
        console.error('Middleware Auth Error:', error);
        res.status(401).json({ message: 'Invalid token' });
    }
};

export const authorize = (...roles: string[]) => {
    return (req: AuthRequest, res: Response, next: NextFunction) => {
        if (!req.user || !roles.includes(req.user.role)) {
            return res.status(403).json({ message: 'User role is not authorized' });
        }
        next();
    };
};



/*******************************************************************************
 * FILE: server/middlewares/upload.ts
 *******************************************************************************/

import multer from 'multer';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';
import { dirname } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Ensure uploads directory exists
const uploadDir = path.resolve(__dirname, '../uploads');
if (!fs.existsSync(uploadDir)) {
    fs.mkdirSync(uploadDir, { recursive: true });
}

// Configure storage
const storage = multer.diskStorage({
    destination: (req, file, cb) => {
        const uploadPath = path.resolve(__dirname, '../uploads');
        // Ensure directory exists at runtime too (e.g. after server restart)
        if (!fs.existsSync(uploadPath)) {
            fs.mkdirSync(uploadPath, { recursive: true });
        }
        cb(null, uploadPath);
    },
    filename: (req, file, cb) => {
        const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
        cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));
    }
});

// File filter
const fileFilter = (req: any, file: any, cb: any) => {
    const allowedExtensions = /jpeg|jpg|png|gif|pdf/;
    const allowedMimeTypes = /image\/(jpeg|jpg|png|gif)|application\/pdf/;
    const extname = allowedExtensions.test(path.extname(file.originalname).toLowerCase());
    const mimetype = allowedMimeTypes.test(file.mimetype);

    if (mimetype && extname) {
        return cb(null, true);
    } else {
        cb(new Error('Only images (JPEG, PNG, GIF) and PDF files are allowed!'));
    }
};

// Create multer instance
export const upload = multer({
    storage: storage,
    limits: {
        fileSize: 5 * 1024 * 1024 // 5MB limit
    },
    fileFilter: fileFilter
});



/*******************************************************************************
 * FILE: server/prisma/mathChapters.ts
 *******************************************************************************/

export interface QuestionData {
    q: string; op: string[]; ans: number; diff: string; r: string; w: string;
}
export interface LevelData { name: string; questions: QuestionData[]; }
export interface ChapterData { name: string; order: number; levels: LevelData[]; youtubeLink?: string; }

function makeLevels(topics: Record<string, QuestionData[]>): LevelData[] {
    return ['Diagnostic', 'Beginner', 'Intermediate', 'Advance', 'Challenge'].map(n => ({ name: n, questions: topics[n] }));
}

// ========== CHAPTER 1: Rational and Irrational Numbers ==========
const ch1: Record<string, QuestionData[]> = {
    Diagnostic: [
        { q: 'Which of the following is a natural number?', op: ['‚àí2', '0', '5', '1/2'], ans: 3, diff: 'EASY', r: 'Correct! Good basic speed.', w: 'Natural numbers are 1,2,3‚Ä¶ Revise basics.' },
        { q: 'Which is an integer?', op: ['3/4', '‚àí5', '2.5', '‚àö2'], ans: 2, diff: 'EASY', r: 'Excellent accuracy.', w: 'Integers include negatives. Revise.' },
        { q: 'Rational number form is:', op: ['m/n where n‚â†0', 'Only whole', 'Only decimal', 'Only fraction'], ans: 1, diff: 'EASY', r: 'Perfect concept clarity.', w: 'Rational = m/n form. Revise.' },
        { q: 'Which is rational?', op: ['‚àö2', 'œÄ', '3/5', '‚àö3'], ans: 3, diff: 'EASY', r: 'Good identification.', w: 'Fractions are rational.' },
        { q: 'How many rational numbers between 1 and 2?', op: ['1', '2', '10', 'Infinite'], ans: 4, diff: 'EASY', r: 'Excellent! Strong accuracy.', w: 'Infinite rational numbers exist.' },
        { q: '7/3 on number line equals:', op: ['1‚Öì', '2‚Öì', '3‚Öì', '4‚Öì'], ans: 2, diff: 'MEDIUM', r: 'Great fraction understanding.', w: 'Divide properly.' },
        { q: 'Which is smaller?', op: ['‚àí2', '1', '0', '3'], ans: 1, diff: 'MEDIUM', r: 'Good sign understanding.', w: 'Negative numbers are smallest.' },
        { q: '‚àí2/3 lies:', op: ['Right of 0', 'Left of 0', 'At 0', 'At 1'], ans: 2, diff: 'MEDIUM', r: 'Accurate understanding.', w: 'Negatives lie left of zero.' },
        { q: 'Compare 5/4 and 2/3', op: ['5/4 > 2/3', '5/4 < 2/3', 'Equal', 'None'], ans: 1, diff: 'HARD', r: 'Excellent calculation.', w: 'Use LCM method.' },
        { q: 'Decimal of 7/4 is:', op: ['1.25', '1.75', '2.75', '0.75'], ans: 2, diff: 'HARD', r: 'Fast conversion.', w: 'Divide carefully.' },
    ],
    Beginner: [
        { q: 'Whole numbers include:', op: ['‚àí1', '0', '1/2', 'œÄ'], ans: 2, diff: 'EASY', r: 'Good recall.', w: 'Whole numbers start from 0.' },
        { q: 'Which is NOT rational?', op: ['4', '‚àí3', '‚àö5', '1/2'], ans: 3, diff: 'EASY', r: 'Strong concept.', w: '‚àö5 is irrational.' },
        { q: '0 is:', op: ['Natural only', 'Whole number', 'Irrational', 'Fraction'], ans: 2, diff: 'EASY', r: 'Accurate.', w: '0 is a whole number.' },
        { q: '‚àí5/2 is:', op: ['Rational', 'Irrational', 'Natural', 'Whole'], ans: 1, diff: 'EASY', r: 'Excellent clarity.', w: 'Fractions are rational.' },
        { q: '3/5 in decimal:', op: ['0.6', '0.5', '0.3', '1.5'], ans: 1, diff: 'EASY', r: 'Fast and accurate.', w: 'Divide properly.' },
        { q: 'Larger number:', op: ['‚àí3', '‚àí7', '‚àí10', '‚àí1'], ans: 4, diff: 'MEDIUM', r: 'Good number sense.', w: 'Closer to zero is greater.' },
        { q: '3/5 and 6/10 are:', op: ['Equal', 'Greater', 'Smaller', 'None'], ans: 1, diff: 'MEDIUM', r: 'Accurate.', w: 'Simplify to compare.' },
        { q: 'Decimal of ‚àí5/3:', op: ['‚àí1.66‚Ä¶', '‚àí2.5', '‚àí0.5', '1.66'], ans: 1, diff: 'MEDIUM', r: 'Good speed.', w: 'Divide carefully.' },
        { q: 'Which is greatest?', op: ['‚àí1/2', '0', '1/3', '‚àí1'], ans: 3, diff: 'HARD', r: 'Strong accuracy.', w: 'Compare on number line.' },
        { q: 'Terminating decimal example:', op: ['1/3', '1/6', '1/4', '2/7'], ans: 3, diff: 'HARD', r: 'Excellent understanding.', w: 'Terminating = finite digits.' },
    ],
    Intermediate: [
        { q: 'Which is a rational number?', op: ['‚àö3', '‚àö5', '3/7', 'œÄ'], ans: 3, diff: 'EASY', r: 'Great accuracy.', w: 'Rational = m/n form.' },
        { q: 'Which is a whole number?', op: ['‚àí3', '1/2', '0', '‚àí1'], ans: 3, diff: 'EASY', r: 'Excellent speed.', w: 'Whole numbers start from 0.' },
        { q: 'Which is an integer?', op: ['2/3', '‚àí5', '1.2', '‚àö2'], ans: 2, diff: 'EASY', r: 'Good identification.', w: 'Integers include negatives.' },
        { q: 'Which number is positive?', op: ['‚àí4/5', '‚àí2', '3/2', '‚àí7'], ans: 3, diff: 'EASY', r: 'Accurate understanding.', w: 'Positive > 0.' },
        { q: 'Which is smaller?', op: ['5', '‚àí3', '2', '1'], ans: 2, diff: 'EASY', r: 'Excellent comparison.', w: 'Negatives are always smaller.' },
        { q: 'Compare 5/4 and 2/3', op: ['5/4 > 2/3', '5/4 < 2/3', 'Equal', 'Cannot compare'], ans: 1, diff: 'MEDIUM', r: 'Good calculation.', w: 'Use cross multiplication.' },
        { q: 'Which is greater?', op: ['‚àí7/3', '‚àí5/2', 'Both equal', 'Cannot compare'], ans: 2, diff: 'MEDIUM', r: 'Excellent comparing negatives.', w: '‚àí5/2 closer to zero = greater.' },
        { q: '3/5 and 6/10 are:', op: ['Equal', 'Greater', 'Smaller', 'Not related'], ans: 1, diff: 'MEDIUM', r: 'Good simplification.', w: 'Convert to same denominator.' },
        { q: 'Which is non-terminating recurring?', op: ['1/2', '3/4', '5/6', '1/5'], ans: 3, diff: 'HARD', r: 'Excellent concept clarity.', w: '5/6 = 0.8333‚Ä¶ recurring.' },
        { q: 'How many rational numbers between 1 and 2?', op: ['1', '2', 'Infinite', 'None'], ans: 3, diff: 'HARD', r: 'Strong understanding.', w: 'Infinite rational numbers exist.' },
    ],
    Advance: [
        { q: 'Which is an irrational number?', op: ['3/4', '‚àö2', '‚àí5', '0'], ans: 2, diff: 'EASY', r: 'Excellent identification.', w: '‚àö2 is irrational.' },
        { q: 'œÄ is:', op: ['Rational', 'Irrational', 'Integer', 'Whole'], ans: 2, diff: 'EASY', r: 'Quick and accurate.', w: 'œÄ is irrational.' },
        { q: 'Which is a terminating decimal?', op: ['1/3', '2/7', '3/8', '5/9'], ans: 3, diff: 'EASY', r: 'Good identification.', w: '3/8 = 0.375 terminates.' },
        { q: '‚àí‚àö5 is:', op: ['Rational', 'Irrational', 'Integer', 'Whole'], ans: 2, diff: 'EASY', r: 'Excellent accuracy.', w: '‚àö of non-perfect square = irrational.' },
        { q: 'Which is rational?', op: ['‚àö3', 'œÄ', '0.75', '‚àö7'], ans: 3, diff: 'EASY', r: 'Good accuracy.', w: '0.75 is rational.' },
        { q: 'Compare ‚àí17/20 and ‚àí13/20', op: ['‚àí17/20 > ‚àí13/20', '‚àí17/20 < ‚àí13/20', 'Equal', 'Cannot compare'], ans: 2, diff: 'MEDIUM', r: 'Strong comparing negatives.', w: 'More negative = smaller.' },
        { q: '12/15 and 3/5 are:', op: ['Equal', 'Greater', 'Smaller', 'None'], ans: 1, diff: 'MEDIUM', r: 'Excellent simplification.', w: 'Simplify fractions.' },
        { q: 'Which is non-terminating recurring?', op: ['1/2', '1/4', '2/3', '3/8'], ans: 3, diff: 'MEDIUM', r: 'Good clarity.', w: '2/3 = 0.666‚Ä¶ recurring.' },
        { q: 'Which is irrational?', op: ['3 + ‚àö2', '4/5', '7', '0.25'], ans: 1, diff: 'HARD', r: 'Excellent higher-level thinking.', w: 'Sum with ‚àö2 is irrational.' },
        { q: 'Which statement is true?', op: ['All rational are integers', 'All integers are rational', 'All rational are whole', 'None'], ans: 2, diff: 'HARD', r: 'Very accurate.', w: 'Integers ‚Üí rational (as fraction).' },
    ],
    Challenge: [
        { q: 'Real numbers include:', op: ['Only rational', 'Only irrational', 'Both', 'Only integers'], ans: 3, diff: 'EASY', r: 'Excellent accuracy.', w: 'Real = rational + irrational.' },
        { q: 'Which lies left of zero?', op: ['3', '‚àí2', '1/2', '‚àö4'], ans: 2, diff: 'EASY', r: 'Good understanding.', w: 'Negatives lie left.' },
        { q: '3.14 is:', op: ['Irrational', 'Rational', 'Integer', 'Natural'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Finite decimal = rational.' },
        { q: 'Infinite irrational numbers exist?', op: ['Yes', 'No', 'Only 10', 'Only 1'], ans: 1, diff: 'EASY', r: 'Strong clarity.', w: 'Yes, infinitely many.' },
        { q: '‚àí2 on number line is:', op: ['Right of 0', 'Left of 0', 'At 0', 'At 2'], ans: 2, diff: 'EASY', r: 'Fast and accurate.', w: 'Negatives always left.' },
        { q: 'Which is greater?', op: ['‚àí7/11', '‚àí3/4', 'Both equal', 'Cannot say'], ans: 1, diff: 'MEDIUM', r: 'Excellent comparing negatives.', w: 'Less negative = greater.' },
        { q: 'Decimal of 9/14 is:', op: ['0.5', '0.64‚Ä¶', '0.75', '1.5'], ans: 2, diff: 'MEDIUM', r: 'Good calculation.', w: 'Divide properly.' },
        { q: 'Which is terminating?', op: ['1/6', '1/7', '1/8', '2/9'], ans: 3, diff: 'MEDIUM', r: 'Strong recognition.', w: '1/8 terminates.' },
        { q: 'Rational between 1 and 2:', op: ['Only 1', 'Only 2', 'Infinite', 'None'], ans: 3, diff: 'HARD', r: 'Excellent advanced clarity.', w: 'Infinite rationals exist.' },
        { q: '‚àö2 is irrational because:', op: ['Cannot be m/n', 'It is integer', 'It is whole', 'It is negative'], ans: 1, diff: 'HARD', r: 'Very high accuracy.', w: 'Irrational ‚â† fraction.' },
    ],
};

// ========== CHAPTER 2: Parallel Lines and Transversal ==========
const ch2: Record<string, QuestionData[]> = {
    Diagnostic: [
        { q: 'Lines that never meet are called:', op: ['Intersecting', 'Parallel', 'Perpendicular', 'Curved'], ans: 2, diff: 'EASY', r: 'Correct! Good basic concept.', w: 'Parallel lines never intersect.' },
        { q: 'A line cutting two parallel lines is called:', op: ['Median', 'Transversal', 'Bisector', 'Diameter'], ans: 2, diff: 'EASY', r: 'Excellent recall.', w: 'Transversal cuts across parallel lines.' },
        { q: 'How many angles are formed when a transversal cuts two parallel lines?', op: ['4', '6', '8', '10'], ans: 3, diff: 'EASY', r: 'Good accuracy.', w: '8 angles are formed (4 at each point).' },
        { q: 'Alternate interior angles are:', op: ['Equal', 'Supplementary', 'Complementary', 'Unequal'], ans: 1, diff: 'EASY', r: 'Strong geometry concept.', w: 'Alternate interior angles are equal.' },
        { q: 'Co-interior angles are:', op: ['Equal', 'Supplementary', 'Complementary', 'None'], ans: 2, diff: 'EASY', r: 'Accurate understanding.', w: 'Co-interior angles sum to 180¬∞.' },
        { q: 'If one angle of parallel lines cut by transversal is 70¬∞, its corresponding angle is:', op: ['70¬∞', '110¬∞', '90¬∞', '180¬∞'], ans: 1, diff: 'MEDIUM', r: 'Great angle knowledge.', w: 'Corresponding angles are equal.' },
        { q: 'If co-interior angle is 120¬∞, other co-interior angle is:', op: ['120¬∞', '60¬∞', '90¬∞', '180¬∞'], ans: 2, diff: 'MEDIUM', r: 'Good supplementary concept.', w: 'Co-interior angles sum to 180¬∞.' },
        { q: 'Vertically opposite angles are:', op: ['Supplementary', 'Complementary', 'Equal', 'None'], ans: 3, diff: 'MEDIUM', r: 'Excellent understanding.', w: 'Vertically opposite angles are equal.' },
        { q: 'If alternate angles are unequal, lines are:', op: ['Parallel', 'Not parallel', 'Perpendicular', 'Equal'], ans: 2, diff: 'HARD', r: 'Strong logical reasoning.', w: 'Unequal alternate angles means not parallel.' },
        { q: 'Sum of angles on same side of transversal for parallel lines:', op: ['90¬∞', '180¬∞', '360¬∞', '270¬∞'], ans: 2, diff: 'HARD', r: 'Excellent advanced concept.', w: 'Co-interior angles = 180¬∞.' },
    ],
    Beginner: [
        { q: 'Symbol for parallel lines:', op: ['‚ä•', '||', '=', '‚â†'], ans: 2, diff: 'EASY', r: 'Good recall.', w: '|| is the symbol for parallel.' },
        { q: 'Perpendicular lines form angle of:', op: ['45¬∞', '90¬∞', '180¬∞', '60¬∞'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Perpendicular = 90¬∞.' },
        { q: 'Corresponding angles are on:', op: ['Same side', 'Opposite side', 'Inside only', 'None'], ans: 1, diff: 'EASY', r: 'Good concept.', w: 'Same side of transversal.' },
        { q: 'Interior angles lie:', op: ['Outside lines', 'Between lines', 'On lines', 'Nowhere'], ans: 2, diff: 'EASY', r: 'Correct understanding.', w: 'Interior = between the lines.' },
        { q: 'Exterior angles lie:', op: ['Between lines', 'Outside lines', 'On lines', 'Nowhere'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Exterior = outside the lines.' },
        { q: 'If ‚à†1 = 65¬∞, its supplementary angle is:', op: ['65¬∞', '115¬∞', '90¬∞', '25¬∞'], ans: 2, diff: 'MEDIUM', r: 'Good calculation.', w: '180¬∞ ‚àí 65¬∞ = 115¬∞.' },
        { q: 'Alternate exterior angles are:', op: ['Equal', 'Supplementary', 'Complementary', 'None'], ans: 1, diff: 'MEDIUM', r: 'Strong concept.', w: 'Alternate exterior angles are equal.' },
        { q: 'Linear pair angles sum to:', op: ['90¬∞', '180¬∞', '360¬∞', '270¬∞'], ans: 2, diff: 'MEDIUM', r: 'Excellent understanding.', w: 'Linear pair = 180¬∞.' },
        { q: 'If corresponding angle is 130¬∞, alternate interior angle is:', op: ['130¬∞', '50¬∞', '90¬∞', '180¬∞'], ans: 2, diff: 'HARD', r: 'Excellent analytical skills.', w: 'Alternate interior = 180¬∞ ‚àí 130¬∞ = 50¬∞.' },
        { q: 'Two parallel lines have how many transversals possible?', op: ['1', '2', 'Infinite', '0'], ans: 3, diff: 'HARD', r: 'Great reasoning.', w: 'Infinite transversals can cut parallel lines.' },
    ],
    Intermediate: [
        { q: 'Angles on the same side of transversal, one interior one exterior:', op: ['Alternate', 'Corresponding', 'Co-interior', 'None'], ans: 2, diff: 'EASY', r: 'Good identification.', w: 'These are corresponding angles.' },
        { q: 'If two lines are parallel, alternate angles are:', op: ['Unequal', 'Equal', 'Supplementary', 'None'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Alternate angles equal for parallel lines.' },
        { q: 'Transversal makes how many pairs of corresponding angles?', op: ['2', '4', '6', '8'], ans: 2, diff: 'EASY', r: 'Good counting.', w: '4 pairs of corresponding angles.' },
        { q: 'If ‚à†3 = 55¬∞, vertically opposite angle is:', op: ['55¬∞', '125¬∞', '90¬∞', '35¬∞'], ans: 1, diff: 'EASY', r: 'Excellent recall.', w: 'Vertically opposite = equal.' },
        { q: 'Angles forming a linear pair are:', op: ['Equal', 'Supplementary', 'Complementary', 'Vertical'], ans: 2, diff: 'EASY', r: 'Correct.', w: 'Linear pair = supplementary.' },
        { q: 'If co-interior angles are 75¬∞ and x, find x:', op: ['75¬∞', '105¬∞', '115¬∞', '85¬∞'], ans: 2, diff: 'MEDIUM', r: 'Good calculation.', w: '180¬∞ ‚àí 75¬∞ = 105¬∞.' },
        { q: 'If alternate angle is 110¬∞, co-interior angle is:', op: ['110¬∞', '70¬∞', '90¬∞', '180¬∞'], ans: 2, diff: 'MEDIUM', r: 'Strong understanding.', w: 'Co-interior = 180¬∞ ‚àí 110¬∞ = 70¬∞.' },
        { q: 'Number of pairs of alternate interior angles:', op: ['1', '2', '4', '8'], ans: 2, diff: 'MEDIUM', r: 'Accurate counting.', w: '2 pairs of alternate interior angles.' },
        { q: 'Lines in the same plane that do not intersect:', op: ['Skew', 'Parallel', 'Perpendicular', 'Concurrent'], ans: 2, diff: 'HARD', r: 'Excellent definition recall.', w: 'Parallel lines are coplanar non-intersecting.' },
        { q: 'If ‚à†1 = 3x and ‚à†2 = 2x are co-interior, x =:', op: ['36¬∞', '30¬∞', '45¬∞', '60¬∞'], ans: 1, diff: 'HARD', r: 'Great algebra + geometry.', w: '3x + 2x = 180¬∞ ‚Üí x = 36¬∞.' },
    ],
    Advance: [
        { q: 'If a transversal is perpendicular to one parallel line, it is:', op: ['Parallel to other', 'Perpendicular to other', 'Oblique', 'None'], ans: 2, diff: 'EASY', r: 'Excellent logical thinking.', w: 'Perpendicular to both parallel lines.' },
        { q: 'Corresponding angles are also called:', op: ['F-angles', 'Z-angles', 'X-angles', 'O-angles'], ans: 1, diff: 'EASY', r: 'Good recall.', w: 'Corresponding = F-angles.' },
        { q: 'Alternate angles are also called:', op: ['F-angles', 'Z-angles', 'X-angles', 'O-angles'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Alternate = Z-angles.' },
        { q: 'If both alternate angles are 90¬∞, transversal is:', op: ['Parallel', 'Perpendicular', 'Oblique', 'None'], ans: 2, diff: 'EASY', r: 'Good understanding.', w: 'Both 90¬∞ means perpendicular.' },
        { q: 'Sum of all angles at a point:', op: ['180¬∞', '270¬∞', '360¬∞', '90¬∞'], ans: 3, diff: 'EASY', r: 'Correct concept.', w: 'Angles at a point = 360¬∞.' },
        { q: 'If ‚à†A = 2x+10 and corresponding ‚à†B = 3x‚àí20, find x:', op: ['30', '25', '20', '35'], ans: 1, diff: 'MEDIUM', r: 'Excellent algebra.', w: '2x+10 = 3x‚àí20 ‚Üí x = 30.' },
        { q: 'Interior angles on same side are also called:', op: ['Alternate', 'Co-interior', 'Corresponding', 'Vertical'], ans: 2, diff: 'MEDIUM', r: 'Good terminology.', w: 'Same-side interior = co-interior.' },
        { q: 'If one angle is 4x and supplementary angle is 5x, find x:', op: ['20¬∞', '15¬∞', '25¬∞', '10¬∞'], ans: 1, diff: 'MEDIUM', r: 'Strong calculation.', w: '4x + 5x = 180¬∞ ‚Üí x = 20¬∞.' },
        { q: 'Three parallel lines cut by a transversal form how many angles?', op: ['8', '10', '12', '6'], ans: 3, diff: 'HARD', r: 'Excellent advanced reasoning.', w: '3 intersection points √ó 4 angles = 12.' },
        { q: 'If ‚à†1:‚à†2 = 2:7 and they are co-interior, ‚à†1 =:', op: ['40¬∞', '20¬∞', '60¬∞', '80¬∞'], ans: 1, diff: 'HARD', r: 'Great ratio + geometry.', w: '2x+7x=180 ‚Üí x=20, ‚à†1=40¬∞.' },
    ],
    Challenge: [
        { q: 'Euclid\'s parallel postulate states:', op: ['Lines always meet', 'One parallel through point', 'No parallels exist', 'Lines are curved'], ans: 2, diff: 'EASY', r: 'Excellent history knowledge.', w: 'One unique parallel through external point.' },
        { q: 'Railway tracks are an example of:', op: ['Perpendicular lines', 'Parallel lines', 'Intersecting lines', 'Curved lines'], ans: 2, diff: 'EASY', r: 'Good real-world connect.', w: 'Tracks are parallel.' },
        { q: 'If two lines are cut by transversal making equal corresponding angles they are:', op: ['Perpendicular', 'Parallel', 'Skew', 'Concurrent'], ans: 2, diff: 'EASY', r: 'Accurate converse theorem.', w: 'Equal corresponding angles ‚Üí parallel.' },
        { q: 'Supplementary angles sum to:', op: ['90¬∞', '180¬∞', '360¬∞', '45¬∞'], ans: 2, diff: 'EASY', r: 'Good recall.', w: 'Supplementary = 180¬∞.' },
        { q: 'Complementary angles sum to:', op: ['90¬∞', '180¬∞', '360¬∞', '45¬∞'], ans: 1, diff: 'EASY', r: 'Accurate.', w: 'Complementary = 90¬∞.' },
        { q: 'If ‚à†x and ‚à†y are alternate and ‚à†x = 5a+15, ‚à†y = 3a+45, find a:', op: ['15', '10', '20', '25'], ans: 1, diff: 'MEDIUM', r: 'Excellent algebraic skills.', w: '5a+15=3a+45 ‚Üí a=15.' },
        { q: 'Angle bisector of 120¬∞ makes angle of:', op: ['30¬∞', '60¬∞', '90¬∞', '45¬∞'], ans: 2, diff: 'MEDIUM', r: 'Good bisector concept.', w: '120¬∞/2 = 60¬∞.' },
        { q: 'If exterior angle is 140¬∞, interior angle on same side is:', op: ['140¬∞', '40¬∞', '50¬∞', '90¬∞'], ans: 2, diff: 'MEDIUM', r: 'Strong calculation.', w: '180¬∞ ‚àí 140¬∞ = 40¬∞.' },
        { q: 'Two angles are 3x+5 and 7x‚àí25, co-interior. x =:', op: ['20', '15', '25', '10'], ans: 1, diff: 'HARD', r: 'Excellent problem-solving.', w: '3x+5+7x‚àí25=180 ‚Üí x=20.' },
        { q: 'In a triangle with one side extended, exterior angle equals:', op: ['Adjacent interior', 'Sum of remote interiors', 'Half of sum', 'None'], ans: 2, diff: 'HARD', r: 'Great theorem knowledge.', w: 'Exterior angle = sum of remote interior angles.' },
    ],
};

// ========== CHAPTER 3: Indices and Cube Root ==========
const ch3: Record<string, QuestionData[]> = {
    Diagnostic: [
        { q: '2¬≥ equals:', op: ['6', '8', '9', '4'], ans: 2, diff: 'EASY', r: 'Good basic power.', w: '2¬≥ = 2√ó2√ó2 = 8.' },
        { q: '5‚Å∞ equals:', op: ['0', '5', '1', '50'], ans: 3, diff: 'EASY', r: 'Excellent rule recall.', w: 'Any number‚Å∞ = 1.' },
        { q: '10¬≤ equals:', op: ['20', '100', '1000', '10'], ans: 2, diff: 'EASY', r: 'Accurate.', w: '10¬≤ = 100.' },
        { q: 'Cube root of 27 is:', op: ['3', '9', '27', '6'], ans: 1, diff: 'EASY', r: 'Good cube root knowledge.', w: '3¬≥ = 27, so ‚àõ27 = 3.' },
        { q: 'Which is a perfect cube?', op: ['8', '10', '12', '15'], ans: 1, diff: 'EASY', r: 'Correct identification.', w: '8 = 2¬≥ is a perfect cube.' },
        { q: 'a·µê √ó a‚Åø equals:', op: ['a·µê‚Å∫‚Åø', 'a·µê‚Åø', 'a·µê‚Åª‚Åø', '2a·µê'], ans: 1, diff: 'MEDIUM', r: 'Strong index law.', w: 'Same base: add exponents.' },
        { q: 'a·µê √∑ a‚Åø equals:', op: ['a·µê‚Å∫‚Åø', 'a·µê‚Åø', 'a·µê‚Åª‚Åø', 'a·µê/‚Åø'], ans: 3, diff: 'MEDIUM', r: 'Good rule application.', w: 'Same base division: subtract exponents.' },
        { q: '(2¬≥)¬≤ equals:', op: ['2‚Åµ', '2‚Å∂', '2‚Åπ', '2¬π'], ans: 2, diff: 'MEDIUM', r: 'Excellent power of power.', w: '(a·µê)‚Åø = a·µê‚Åø = 2‚Å∂.' },
        { q: '‚àõ125 equals:', op: ['5', '25', '15', '10'], ans: 1, diff: 'HARD', r: 'Strong cube root.', w: '5¬≥ = 125.' },
        { q: '2‚Åª¬≥ equals:', op: ['‚àí8', '1/8', '8', '‚àí1/8'], ans: 2, diff: 'HARD', r: 'Excellent negative index.', w: '2‚Åª¬≥ = 1/2¬≥ = 1/8.' },
    ],
    Beginner: [
        { q: '3¬≤ equals:', op: ['6', '9', '27', '3'], ans: 2, diff: 'EASY', r: 'Good basic power.', w: '3¬≤ = 9.' },
        { q: '4¬≥ equals:', op: ['12', '16', '64', '48'], ans: 3, diff: 'EASY', r: 'Accurate.', w: '4¬≥ = 64.' },
        { q: 'a¬π equals:', op: ['0', '1', 'a', 'a¬≤'], ans: 3, diff: 'EASY', r: 'Good rule.', w: 'Any number¬π = itself.' },
        { q: 'Cube root of 64 is:', op: ['2', '4', '8', '16'], ans: 2, diff: 'EASY', r: 'Correct.', w: '4¬≥ = 64.' },
        { q: '‚àõ1 equals:', op: ['0', '1', '‚àí1', 'Undefined'], ans: 2, diff: 'EASY', r: 'Accurate.', w: '1¬≥ = 1.' },
        { q: '2‚Å¥ √ó 2¬≥ equals:', op: ['2‚Å∑', '2¬π¬≤', '4‚Å∑', '2¬π'], ans: 1, diff: 'MEDIUM', r: 'Good law of indices.', w: '2‚Å¥‚Å∫¬≥ = 2‚Å∑.' },
        { q: '5¬≥ √∑ 5¬≤ equals:', op: ['5‚Åµ', '5¬π', '5‚Å∂', '1'], ans: 2, diff: 'MEDIUM', r: 'Strong division rule.', w: '5¬≥‚Åª¬≤ = 5¬π = 5.' },
        { q: '(3¬≤)¬≥ equals:', op: ['3‚Åµ', '3‚Å∂', '3‚Å∏', '9¬≥'], ans: 2, diff: 'MEDIUM', r: 'Excellent power rule.', w: '(3¬≤)¬≥ = 3‚Å∂.' },
        { q: '‚àõ216 equals:', op: ['6', '36', '12', '18'], ans: 1, diff: 'HARD', r: 'Excellent cube root.', w: '6¬≥ = 216.' },
        { q: '(‚àí2)¬≥ equals:', op: ['8', '‚àí8', '6', '‚àí6'], ans: 2, diff: 'HARD', r: 'Good sign handling.', w: '(‚àí2)¬≥ = ‚àí8 (odd power stays negative).' },
    ],
    Intermediate: [
        { q: '1‚Å∞‚Å∞ equals:', op: ['0', '100', '1', 'Undefined'], ans: 3, diff: 'EASY', r: 'Good rule.', w: '1 raised to any power = 1.' },
        { q: '‚àõ8 equals:', op: ['2', '4', '8', '16'], ans: 1, diff: 'EASY', r: 'Accurate.', w: '2¬≥ = 8.' },
        { q: 'Which is a perfect cube?', op: ['9', '16', '27', '25'], ans: 3, diff: 'EASY', r: 'Good identification.', w: '27 = 3¬≥.' },
        { q: '(ab)¬≤ equals:', op: ['a¬≤b¬≤', 'ab¬≤', 'a¬≤b', '2ab'], ans: 1, diff: 'EASY', r: 'Correct rule.', w: '(ab)‚Åø = a‚Åøb‚Åø.' },
        { q: '10¬≥ equals:', op: ['30', '100', '1000', '10000'], ans: 3, diff: 'EASY', r: 'Good recall.', w: '10¬≥ = 1000.' },
        { q: 'Simplify: 3‚Åµ √ó 3‚Åª¬≤ =', op: ['3¬≥', '3‚Å∑', '3¬π‚Å∞', '3‚Åª¬≥'], ans: 1, diff: 'MEDIUM', r: 'Good negative index.', w: '3‚Åµ‚Å∫‚ÅΩ‚Åª¬≤‚Åæ = 3¬≥.' },
        { q: '(a/b)¬≥ equals:', op: ['a¬≥/b¬≥', '3a/3b', 'a/b¬≥', 'a¬≥/b'], ans: 1, diff: 'MEDIUM', r: 'Strong fraction power.', w: '(a/b)‚Åø = a‚Åø/b‚Åø.' },
        { q: '‚àõ1000 equals:', op: ['10', '100', '31', '33'], ans: 1, diff: 'MEDIUM', r: 'Accurate.', w: '10¬≥ = 1000.' },
        { q: 'If 2À£ = 32, x =:', op: ['4', '5', '6', '3'], ans: 2, diff: 'HARD', r: 'Excellent equation solving.', w: '2‚Åµ = 32.' },
        { q: '‚àõ(‚àí64) equals:', op: ['4', '‚àí4', '8', '‚àí8'], ans: 2, diff: 'HARD', r: 'Good negative cube root.', w: '(‚àí4)¬≥ = ‚àí64.' },
    ],
    Advance: [
        { q: 'a‚Åª¬π equals:', op: ['‚àía', '1/a', 'a', '0'], ans: 2, diff: 'EASY', r: 'Good reciprocal concept.', w: 'a‚Åª¬π = 1/a.' },
        { q: '(2/3)¬≤ equals:', op: ['4/9', '2/9', '4/6', '2/3'], ans: 1, diff: 'EASY', r: 'Accurate.', w: '(2/3)¬≤ = 4/9.' },
        { q: '7‚Å∞ + 3‚Å∞ equals:', op: ['0', '1', '2', '10'], ans: 3, diff: 'EASY', r: 'Excellent rule application.', w: '7‚Å∞=1, 3‚Å∞=1, sum=2.' },
        { q: '‚àõ343 equals:', op: ['7', '49', '17', '21'], ans: 1, diff: 'EASY', r: 'Good cube root.', w: '7¬≥ = 343.' },
        { q: '(‚àí3)¬≤ equals:', op: ['9', '‚àí9', '6', '‚àí6'], ans: 1, diff: 'EASY', r: 'Correct sign rule.', w: 'Even power ‚Üí positive.' },
        { q: 'Simplify: (2¬≥ √ó 3¬≤) √∑ (2¬≤ √ó 3) =', op: ['6', '12', '18', '3'], ans: 1, diff: 'MEDIUM', r: 'Excellent simplification.', w: '2¬π √ó 3¬π = 6.' },
        { q: 'If 3À£ = 81, x =:', op: ['2', '3', '4', '5'], ans: 3, diff: 'MEDIUM', r: 'Good equation solving.', w: '3‚Å¥ = 81.' },
        { q: '(5‚Åª¬≤)‚Åª¬π equals:', op: ['5¬≤', '5‚Åª¬≤', '25', '1/25'], ans: 1, diff: 'MEDIUM', r: 'Strong negative index.', w: '(5‚Åª¬≤)‚Åª¬π = 5¬≤ = 25.' },
        { q: '‚àõ(27 √ó 8) equals:', op: ['6', '15', '12', '21'], ans: 1, diff: 'HARD', r: 'Excellent property: ‚àõ(ab)=‚àõa√ó‚àõb.', w: '‚àõ27 √ó ‚àõ8 = 3√ó2 = 6.' },
        { q: 'Express 0.001 as power of 10:', op: ['10‚Åª¬≤', '10‚Åª¬≥', '10¬≥', '10‚Åª¬π'], ans: 2, diff: 'HARD', r: 'Strong scientific notation.', w: '0.001 = 10‚Åª¬≥.' },
    ],
    Challenge: [
        { q: 'Standard form of 5000 is:', op: ['5√ó10¬≤', '5√ó10¬≥', '50√ó10¬≤', '0.5√ó10‚Å¥'], ans: 2, diff: 'EASY', r: 'Good standard form.', w: '5000 = 5√ó10¬≥.' },
        { q: '2‚Åµ equals:', op: ['10', '16', '32', '64'], ans: 3, diff: 'EASY', r: 'Accurate.', w: '2‚Åµ = 32.' },
        { q: '‚àõ512 equals:', op: ['8', '64', '12', '16'], ans: 1, diff: 'EASY', r: 'Correct cube root.', w: '8¬≥ = 512.' },
        { q: '(‚àí1)‚Åµ‚Å∞ equals:', op: ['‚àí1', '1', '50', '0'], ans: 2, diff: 'EASY', r: 'Good sign rule.', w: 'Even power of ‚àí1 = 1.' },
        { q: '(10¬≤)¬≥ equals:', op: ['10‚Åµ', '10‚Å∂', '10‚Å∏', '10‚Åπ'], ans: 2, diff: 'EASY', r: 'Strong power of power.', w: '(10¬≤)¬≥ = 10‚Å∂.' },
        { q: 'Simplify: 2‚Åµ √ó 2‚Åª¬≥ √ó 2¬≤ =', op: ['2‚Å¥', '2¬π‚Å∞', '2‚Å∞', '2¬≤'], ans: 1, diff: 'MEDIUM', r: 'Excellent index manipulation.', w: '5+(‚àí3)+2 = 4, so 2‚Å¥.' },
        { q: 'If x¬≥ = ‚àí125, x =:', op: ['5', '‚àí5', '25', '‚àí25'], ans: 2, diff: 'MEDIUM', r: 'Good equation solving.', w: '(‚àí5)¬≥ = ‚àí125.' },
        { q: '‚àõ(0.008) equals:', op: ['0.2', '0.02', '0.8', '2'], ans: 1, diff: 'MEDIUM', r: 'Excellent decimal cube root.', w: '0.2¬≥ = 0.008.' },
        { q: 'Simplify: (8/27)^(1/3) =', op: ['2/3', '8/3', '2/9', '4/9'], ans: 1, diff: 'HARD', r: 'Outstanding fractional power.', w: '‚àõ8/‚àõ27 = 2/3.' },
        { q: 'If 2À£‚Å∫¬π = 64, x =:', op: ['4', '5', '6', '3'], ans: 2, diff: 'HARD', r: 'Excellent equation mastery.', w: '2‚Å∂=64, so x+1=6, x=5.' },
    ],
};


// ========== CHAPTER 4: Altitudes and Medians of a Triangle ==========
const ch4: Record<string, QuestionData[]> = {
    Diagnostic: [
        { q: 'An altitude of a triangle is:', op: ['Perpendicular to base', 'Parallel to base', 'Equal to base', 'Half of base'], ans: 1, diff: 'EASY', r: 'Correct!', w: 'Altitude is perpendicular from vertex to base.' },
        { q: 'A median connects vertex to:', op: ['Midpoint of opposite side', 'Any point', 'Adjacent vertex', 'Centre'], ans: 1, diff: 'EASY', r: 'Excellent recall.', w: 'Median goes to midpoint of opposite side.' },
        { q: 'How many altitudes does a triangle have?', op: ['1', '2', '3', '4'], ans: 3, diff: 'EASY', r: 'Good accuracy.', w: 'Every triangle has 3 altitudes.' },
        { q: 'How many medians does a triangle have?', op: ['1', '2', '3', '6'], ans: 3, diff: 'EASY', r: 'Accurate.', w: '3 medians, one from each vertex.' },
        { q: 'The point where all 3 medians meet is called:', op: ['Orthocentre', 'Centroid', 'Incentre', 'Circumcentre'], ans: 2, diff: 'EASY', r: 'Strong concept.', w: 'Medians meet at centroid.' },
        { q: 'The point where all 3 altitudes meet is called:', op: ['Centroid', 'Orthocentre', 'Incentre', 'Circumcentre'], ans: 2, diff: 'MEDIUM', r: 'Good identification.', w: 'Altitudes meet at orthocentre.' },
        { q: 'Centroid divides median in ratio:', op: ['1:1', '1:2', '2:1', '3:1'], ans: 3, diff: 'MEDIUM', r: 'Excellent property.', w: 'Centroid divides median 2:1 from vertex.' },
        { q: 'In a right triangle, altitude from right angle falls on:', op: ['Outside', 'Hypotenuse', 'Shortest side', 'Longest side only'], ans: 2, diff: 'MEDIUM', r: 'Good understanding.', w: 'Altitude falls on hypotenuse.' },
        { q: 'Orthocentre of a right triangle lies:', op: ['Inside', 'Outside', 'At right-angle vertex', 'At centroid'], ans: 3, diff: 'HARD', r: 'Excellent advanced knowledge.', w: 'Orthocentre is at the right angle vertex.' },
        { q: 'In an equilateral triangle, altitude and median are:', op: ['Different', 'Same', 'Perpendicular', 'Parallel'], ans: 2, diff: 'HARD', r: 'Strong reasoning.', w: 'In equilateral triangle, altitude = median.' },
    ],
    Beginner: [
        { q: 'Altitude makes what angle with the base?', op: ['45¬∞', '60¬∞', '90¬∞', '180¬∞'], ans: 3, diff: 'EASY', r: 'Good recall.', w: 'Altitude is perpendicular = 90¬∞.' },
        { q: 'Median divides opposite side into:', op: ['Unequal parts', '2 equal parts', '3 parts', '4 parts'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Median bisects opposite side.' },
        { q: 'In an obtuse triangle, orthocentre lies:', op: ['Inside', 'Outside', 'On a vertex', 'At centre'], ans: 2, diff: 'EASY', r: 'Good concept.', w: 'Orthocentre is outside for obtuse triangles.' },
        { q: 'Centroid always lies:', op: ['Outside', 'Inside', 'On a side', 'At vertex'], ans: 2, diff: 'EASY', r: 'Correct.', w: 'Centroid always lies inside.' },
        { q: 'The altitude is also called:', op: ['Height', 'Base', 'Diagonal', 'Median'], ans: 1, diff: 'EASY', r: 'Good terminology.', w: 'Altitude = height.' },
        { q: 'If median is 9 cm, centroid to vertex is:', op: ['3 cm', '6 cm', '4.5 cm', '9 cm'], ans: 2, diff: 'MEDIUM', r: 'Good ratio application.', w: '2/3 of 9 = 6 cm.' },
        { q: 'If median is 12 cm, centroid to midpoint is:', op: ['4 cm', '6 cm', '8 cm', '3 cm'], ans: 1, diff: 'MEDIUM', r: 'Excellent calculation.', w: '1/3 of 12 = 4 cm.' },
        { q: 'In isosceles triangle, median to base is also:', op: ['Altitude', 'Diagonal', 'Parallel', 'Transversal'], ans: 1, diff: 'MEDIUM', r: 'Strong understanding.', w: 'Median to base = altitude in isosceles.' },
        { q: 'How many concurrent points do medians form?', op: ['0', '1', '2', '3'], ans: 2, diff: 'HARD', r: 'Excellent concurrence concept.', w: 'All 3 medians meet at 1 point.' },
        { q: 'Centroid divides triangle into how many equal-area triangles?', op: ['2', '3', '6', '4'], ans: 3, diff: 'HARD', r: 'Outstanding property.', w: 'Centroid creates 6 equal-area triangles.' },
    ],
    Intermediate: [
        { q: 'Altitude can lie outside in:', op: ['Acute', 'Right', 'Obtuse', 'Equilateral'], ans: 3, diff: 'EASY', r: 'Good understanding.', w: 'In obtuse triangles, altitude can be outside.' },
        { q: 'The centroid is also called:', op: ['Centre of gravity', 'Circumcentre', 'Incentre', 'Excentre'], ans: 1, diff: 'EASY', r: 'Correct terminology.', w: 'Centroid = centre of gravity.' },
        { q: 'A triangle has how many orthocentres?', op: ['0', '1', '2', '3'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Only 1 orthocentre per triangle.' },
        { q: 'In acute triangle, orthocentre lies:', op: ['Inside', 'Outside', 'On hypotenuse', 'At vertex'], ans: 1, diff: 'EASY', r: 'Good recall.', w: 'Inside for acute triangles.' },
        { q: 'Median and altitude same in:', op: ['Scalene', 'Isosceles only', 'Equilateral', 'Right'], ans: 3, diff: 'EASY', r: 'Correct.', w: 'In equilateral, they coincide.' },
        { q: 'If median from A is 15 cm, AG =:', op: ['5 cm', '10 cm', '7.5 cm', '15 cm'], ans: 2, diff: 'MEDIUM', r: 'Good ratio.', w: 'AG = 2/3 √ó 15 = 10 cm.' },
        { q: 'In equilateral triangle side 6, median =:', op: ['3', '3‚àö3', '6', '2‚àö3'], ans: 2, diff: 'MEDIUM', r: 'Strong formula.', w: 'Median = (‚àö3/2)√ó6 = 3‚àö3.' },
        { q: 'Sum of angles at orthocentre:', op: ['180¬∞', '360¬∞', '90¬∞', '270¬∞'], ans: 2, diff: 'MEDIUM', r: 'Excellent reasoning.', w: 'Angles around a point = 360¬∞.' },
        { q: 'Altitude from A to BC is denoted:', op: ['ma', 'ha', 'la', 'da'], ans: 2, diff: 'HARD', r: 'Good notation.', w: 'ha denotes altitude from A.' },
        { q: 'Area of triangle = ¬Ω √ó base √ó:', op: ['Side', 'Median', 'Altitude', 'Diagonal'], ans: 3, diff: 'HARD', r: 'Excellent formula.', w: 'Area = ¬Ω √ó base √ó altitude.' },
    ],
    Advance: [
        { q: 'In right triangle, how many altitudes lie on sides?', op: ['0', '1', '2', '3'], ans: 3, diff: 'EASY', r: 'Great visualization.', w: 'Two legs serve as altitudes.' },
        { q: 'Circumcentre of right triangle lies on:', op: ['Inside', 'Outside', 'Hypotenuse midpoint', 'Vertex'], ans: 3, diff: 'EASY', r: 'Excellent.', w: 'Circumcentre = midpoint of hypotenuse.' },
        { q: 'Foot of altitude is:', op: ['The vertex', 'Point where altitude meets base', 'Centroid', 'Midpoint'], ans: 2, diff: 'EASY', r: 'Good definition.', w: 'Foot = where altitude meets base.' },
        { q: 'Centroid coordinates use:', op: ['Sum/3', 'Sum/2', 'Product', 'Difference'], ans: 1, diff: 'EASY', r: 'Good formula.', w: 'Centroid = ((x‚ÇÅ+x‚ÇÇ+x‚ÇÉ)/3, (y‚ÇÅ+y‚ÇÇ+y‚ÇÉ)/3).' },
        { q: 'In scalene triangle, all medians are:', op: ['Equal', 'Unequal', 'Zero', 'Parallel'], ans: 2, diff: 'EASY', r: 'Correct.', w: 'Unequal sides ‚Üí unequal medians.' },
        { q: 'If G is centroid and GD = 4, median AD =:', op: ['8', '12', '6', '16'], ans: 2, diff: 'MEDIUM', r: 'Good ratio.', w: 'GD = 1/3 of AD ‚Üí AD = 12.' },
        { q: 'Orthocentre, centroid, circumcentre lie on:', op: ['Euler line', 'Median', 'Altitude', 'Base'], ans: 1, diff: 'MEDIUM', r: 'Excellent advanced knowledge.', w: 'They lie on Euler line.' },
        { q: 'In equilateral ‚ñ≥, centroid and orthocentre:', op: ['Different', 'Same point', 'Opposite', 'Parallel'], ans: 2, diff: 'MEDIUM', r: 'Strong understanding.', w: 'All centres coincide in equilateral ‚ñ≥.' },
        { q: 'If ‚ñ≥ has vertices (0,0),(6,0),(3,6), centroid is:', op: ['(3,2)', '(3,3)', '(2,3)', '(4,2)'], ans: 1, diff: 'HARD', r: 'Excellent coordinate geometry.', w: '((0+6+3)/3,(0+0+6)/3)=(3,2).' },
        { q: 'Three medians divide triangle into:', op: ['3 triangles', '6 triangles', '4 triangles', '2 triangles'], ans: 2, diff: 'HARD', r: 'Strong knowledge.', w: '3 medians create 6 smaller triangles.' },
    ],
    Challenge: [
        { q: 'Which always passes through vertex?', op: ['Perpendicular bisector', 'Median and Altitude', 'Only median', 'All'], ans: 2, diff: 'EASY', r: 'Great distinction.', w: 'Median and altitude start from vertex.' },
        { q: 'Centroid divides median in ratio from vertex:', op: ['1:1', '2:1', '3:1', '1:2'], ans: 2, diff: 'EASY', r: 'Accurate.', w: '2:1 from vertex.' },
        { q: 'Longest median is opposite to:', op: ['Longest side', 'Shortest side', 'Equal side', 'Right angle'], ans: 2, diff: 'EASY', r: 'Excellent property.', w: 'Longest median opposite shortest side.' },
        { q: 'In acute triangle, altitudes inside:', op: ['1', '2', '3', '0'], ans: 3, diff: 'EASY', r: 'Good visualization.', w: 'All 3 altitudes inside for acute.' },
        { q: 'In obtuse triangle, altitudes outside:', op: ['0', '1', '2', '3'], ans: 3, diff: 'EASY', r: 'Strong concept.', w: '2 altitudes fall outside in obtuse.' },
        { q: 'Midpoint of B(0,0),C(8,0) is:', op: ['(4,0)', '(0,4)', '(8,0)', '(2,0)'], ans: 1, diff: 'MEDIUM', r: 'Good midpoint.', w: '((0+8)/2,0)=(4,0).' },
        { q: 'If altitude=10, base=12, area=:', op: ['60', '120', '30', '24'], ans: 1, diff: 'MEDIUM', r: 'Excellent area calculation.', w: '¬Ω√ó12√ó10=60.' },
        { q: 'Medians divide triangle into:', op: ['3 triangles', '6 triangles', '4 triangles', '2 triangles'], ans: 2, diff: 'MEDIUM', r: 'Strong knowledge.', w: '6 smaller triangles.' },
        { q: 'If centroid G, PG=8, then median PM=:', op: ['12', '16', '24', '10'], ans: 1, diff: 'HARD', r: 'Excellent ratio mastery.', w: 'PG=2/3 PM ‚Üí PM=12.' },
        { q: 'Orthocentre of equilateral ‚ñ≥ with vertices (0,0),(6,0),(3,3‚àö3):', op: ['(3,‚àö3)', '(3,3)', '(0,0)', '(3,2‚àö3)'], ans: 1, diff: 'HARD', r: 'Outstanding coordinate geometry.', w: 'In equilateral, orthocentre=centroid=(3,‚àö3).' },
    ],
};

// ========== CHAPTER 5: Expansion Formulae ==========
const ch5: Record<string, QuestionData[]> = {
    Diagnostic: [
        { q: '(a+b)¬≤ equals:', op: ['a¬≤+b¬≤', 'a¬≤+2ab+b¬≤', 'a¬≤‚àí2ab+b¬≤', '2a+2b'], ans: 2, diff: 'EASY', r: 'Correct formula!', w: '(a+b)¬≤ = a¬≤+2ab+b¬≤.' },
        { q: '(a‚àíb)¬≤ equals:', op: ['a¬≤‚àíb¬≤', 'a¬≤+2ab+b¬≤', 'a¬≤‚àí2ab+b¬≤', 'a‚àíb'], ans: 3, diff: 'EASY', r: 'Good recall.', w: '(a‚àíb)¬≤ = a¬≤‚àí2ab+b¬≤.' },
        { q: '(a+b)(a‚àíb) equals:', op: ['a¬≤+b¬≤', 'a¬≤‚àíb¬≤', '2ab', 'a¬≤+2ab+b¬≤'], ans: 2, diff: 'EASY', r: 'Excellent identity.', w: 'Difference of squares: a¬≤‚àíb¬≤.' },
        { q: '(x+3)¬≤ equals:', op: ['x¬≤+9', 'x¬≤+3x+9', 'x¬≤+6x+9', 'x¬≤+6x+3'], ans: 3, diff: 'EASY', r: 'Good application.', w: '(x+3)¬≤ = x¬≤+6x+9.' },
        { q: '(2+3)¬≤ equals:', op: ['10', '13', '25', '11'], ans: 3, diff: 'EASY', r: 'Accurate.', w: '5¬≤ = 25.' },
        { q: '(x‚àí5)¬≤ equals:', op: ['x¬≤‚àí25', 'x¬≤‚àí10x+25', 'x¬≤+10x+25', 'x¬≤‚àí5x+25'], ans: 2, diff: 'MEDIUM', r: 'Good expansion.', w: '(x‚àí5)¬≤ = x¬≤‚àí10x+25.' },
        { q: '(2x+3)¬≤ equals:', op: ['4x¬≤+9', '4x¬≤+6x+9', '4x¬≤+12x+9', '2x¬≤+12x+9'], ans: 3, diff: 'MEDIUM', r: 'Excellent coefficient handling.', w: '(2x)¬≤+2(2x)(3)+3¬≤ = 4x¬≤+12x+9.' },
        { q: '(a+b)¬≤‚àí(a‚àíb)¬≤ equals:', op: ['2ab', '4ab', '2a¬≤', '2b¬≤'], ans: 2, diff: 'MEDIUM', r: 'Strong identity.', w: 'Expand both and subtract: 4ab.' },
        { q: '101¬≤ using expansion:', op: ['10000', '10201', '10101', '10200'], ans: 2, diff: 'HARD', r: 'Excellent shortcut.', w: '(100+1)¬≤ = 10000+200+1 = 10201.' },
        { q: '99¬≤ using expansion:', op: ['9801', '9800', '9901', '9810'], ans: 1, diff: 'HARD', r: 'Great mental math!', w: '(100‚àí1)¬≤ = 10000‚àí200+1 = 9801.' },
    ],
    Beginner: [
        { q: 'In (a+b)¬≤, the middle term is:', op: ['a¬≤', 'b¬≤', '2ab', 'ab'], ans: 3, diff: 'EASY', r: 'Good identification.', w: 'Middle term = 2ab.' },
        { q: '(p+q)¬≤ when p=2, q=1:', op: ['5', '9', '6', '4'], ans: 2, diff: 'EASY', r: 'Accurate.', w: '(2+1)¬≤ = 9.' },
        { q: '(a+0)¬≤ equals:', op: ['a', '0', 'a¬≤', '2a'], ans: 3, diff: 'EASY', r: 'Good understanding.', w: '(a+0)¬≤ = a¬≤.' },
        { q: 'a¬≤‚àíb¬≤ is called:', op: ['Sum of squares', 'Difference of squares', 'Perfect square', 'Cube'], ans: 2, diff: 'EASY', r: 'Correct terminology.', w: 'a¬≤‚àíb¬≤ = difference of squares.' },
        { q: '(x+1)(x‚àí1) equals:', op: ['x¬≤‚àí1', 'x¬≤+1', 'x¬≤‚àíx', '2x'], ans: 1, diff: 'EASY', r: 'Excellent identity.', w: 'x¬≤‚àí1.' },
        { q: '(3a+2b)¬≤ equals:', op: ['9a¬≤+4b¬≤', '9a¬≤+6ab+4b¬≤', '9a¬≤+12ab+4b¬≤', '3a¬≤+12ab+2b¬≤'], ans: 3, diff: 'MEDIUM', r: 'Good expansion.', w: '9a¬≤+12ab+4b¬≤.' },
        { q: '(x‚àí4)(x+4) equals:', op: ['x¬≤‚àí16', 'x¬≤+16', 'x¬≤‚àí8x', 'x¬≤‚àí4'], ans: 1, diff: 'MEDIUM', r: 'Strong identity.', w: 'x¬≤‚àí16.' },
        { q: '(a+b)¬≤+(a‚àíb)¬≤ equals:', op: ['2a¬≤', '2b¬≤', '2a¬≤+2b¬≤', '4ab'], ans: 3, diff: 'MEDIUM', r: 'Excellent combination.', w: 'Expand and add: 2a¬≤+2b¬≤.' },
        { q: '52 √ó 48 using identity:', op: ['2496', '2500', '2400', '2504'], ans: 1, diff: 'HARD', r: 'Excellent application.', w: '(50+2)(50‚àí2)=2500‚àí4=2496.' },
        { q: 'If (x+1/x)=5, x¬≤+1/x¬≤=:', op: ['23', '25', '27', '21'], ans: 1, diff: 'HARD', r: 'Outstanding algebra.', w: '(x+1/x)¬≤=x¬≤+2+1/x¬≤ ‚Üí 25‚àí2=23.' },
    ],
    Intermediate: [
        { q: '(a+b+c)¬≤ has how many terms?', op: ['3', '6', '9', '4'], ans: 2, diff: 'EASY', r: 'Good knowledge.', w: 'a¬≤+b¬≤+c¬≤+2ab+2bc+2ca = 6 terms.' },
        { q: '(x+2)¬≤ ‚àí x¬≤ equals:', op: ['4', '4x+4', '2x+4', '4x'], ans: 2, diff: 'EASY', r: 'Good expansion.', w: 'x¬≤+4x+4‚àíx¬≤ = 4x+4.' },
        { q: '(5)¬≤ ‚àí (3)¬≤ equals:', op: ['16', '4', '8', '34'], ans: 1, diff: 'EASY', r: 'Correct.', w: '25‚àí9 = 16.' },
        { q: '(a+b)¬≤ is always:', op: ['Negative', 'Zero', 'Positive or zero', 'Negative or zero'], ans: 3, diff: 'EASY', r: 'Good understanding.', w: 'Squares are always ‚â• 0.' },
        { q: '(1+1)¬≤ equals:', op: ['2', '3', '4', '1'], ans: 3, diff: 'EASY', r: 'Accurate.', w: '2¬≤ = 4.' },
        { q: 'Expand (2x‚àí3y)¬≤:', op: ['4x¬≤‚àí9y¬≤', '4x¬≤‚àí6xy+9y¬≤', '4x¬≤‚àí12xy+9y¬≤', '2x¬≤‚àí12xy+9y¬≤'], ans: 3, diff: 'MEDIUM', r: 'Excellent expansion.', w: '4x¬≤‚àí12xy+9y¬≤.' },
        { q: '(x+y)(x‚àíy) when x=7,y=3:', op: ['40', '10', '21', '49'], ans: 1, diff: 'MEDIUM', r: 'Good mental math.', w: '49‚àí9 = 40.' },
        { q: '(a+b)¬≥ expands to:', op: ['a¬≥+3a¬≤b+3ab¬≤+b¬≥', 'a¬≥+b¬≥', 'a¬≥‚àíb¬≥', '3ab'], ans: 1, diff: 'MEDIUM', r: 'Strong cube expansion.', w: '(a+b)¬≥ = a¬≥+3a¬≤b+3ab¬≤+b¬≥.' },
        { q: '(x+3)(x+5) using identity:', op: ['x¬≤+8x+15', 'x¬≤+8x+8', 'x¬≤+15x+8', 'x¬≤+5x+3'], ans: 1, diff: 'HARD', r: 'Excellent identity.', w: 'x¬≤+(3+5)x+15 = x¬≤+8x+15.' },
        { q: 'If a+b=10, ab=21, a¬≤+b¬≤=:', op: ['58', '79', '100', '42'], ans: 1, diff: 'HARD', r: 'Outstanding manipulation.', w: '(a+b)¬≤=a¬≤+2ab+b¬≤ ‚Üí 100‚àí42=58.' },
    ],
    Advance: [
        { q: 'Factored form of a¬≤‚àíb¬≤:', op: ['(a‚àíb)¬≤', '(a+b)¬≤', '(a+b)(a‚àíb)', '(a‚àíb)(a+b+1)'], ans: 3, diff: 'EASY', r: 'Good factoring.', w: 'a¬≤‚àíb¬≤ = (a+b)(a‚àíb).' },
        { q: '(‚àía+b)¬≤ equals:', op: ['a¬≤+2ab+b¬≤', 'a¬≤‚àí2ab+b¬≤', '‚àía¬≤+b¬≤', 'b¬≤‚àía¬≤'], ans: 2, diff: 'EASY', r: 'Good sign handling.', w: '(b‚àía)¬≤ = a¬≤‚àí2ab+b¬≤.' },
        { q: '(x+y+z)¬≤ includes term:', op: ['2xyz', '2xy', '3xy', 'x¬≤y¬≤'], ans: 2, diff: 'EASY', r: 'Correct.', w: 'Includes 2xy, 2yz, 2xz terms.' },
        { q: '(10+2)¬≤ = 10¬≤+2(10)(2)+2¬≤ =:', op: ['120', '144', '124', '140'], ans: 2, diff: 'EASY', r: 'Accurate.', w: '100+40+4 = 144.' },
        { q: '(a‚àíb)¬≤ is always:', op: ['Negative', 'Positive or zero', 'Zero', 'Undefined'], ans: 2, diff: 'EASY', r: 'Good understanding.', w: 'Any square ‚â• 0.' },
        { q: 'Expand (3x+4)(3x‚àí4):', op: ['9x¬≤‚àí16', '9x¬≤+16', '9x¬≤‚àí8x', '9x¬≤+24x‚àí16'], ans: 1, diff: 'MEDIUM', r: 'Excellent.', w: '(3x)¬≤‚àí4¬≤ = 9x¬≤‚àí16.' },
        { q: 'If a‚àíb=3, ab=10, a¬≤+b¬≤=:', op: ['29', '19', '9', '39'], ans: 1, diff: 'MEDIUM', r: 'Strong manipulation.', w: '(a‚àíb)¬≤=a¬≤‚àí2ab+b¬≤ ‚Üí 9+20=29.' },
        { q: '(x+1/x)¬≤ equals:', op: ['x¬≤+1/x¬≤', 'x¬≤+2+1/x¬≤', 'x¬≤+1+1/x¬≤', 'x¬≤‚àí2+1/x¬≤'], ans: 2, diff: 'MEDIUM', r: 'Excellent expansion.', w: 'x¬≤+2+1/x¬≤.' },
        { q: '(a+b)¬≥ ‚àí (a‚àíb)¬≥ equals:', op: ['2b¬≥', '2b(3a¬≤+b¬≤)', '6a¬≤b', '2a¬≥'], ans: 2, diff: 'HARD', r: 'Outstanding cube identity.', w: 'Expand and subtract: 2b(3a¬≤+b¬≤).' },
        { q: 'If x¬≤+1/x¬≤=27, (x‚àí1/x)¬≤=:', op: ['25', '23', '29', '27'], ans: 1, diff: 'HARD', r: 'Excellent reasoning.', w: 'x¬≤‚àí2+1/x¬≤=27‚àí2=25.' },
    ],
    Challenge: [
        { q: '(a+b)¬≤‚àí2ab equals:', op: ['a¬≤+b¬≤', 'a¬≤‚àíb¬≤', '2a¬≤', '(a‚àíb)¬≤'], ans: 1, diff: 'EASY', r: 'Good identity.', w: 'a¬≤+2ab+b¬≤‚àí2ab = a¬≤+b¬≤.' },
        { q: '103¬≤ using (100+3)¬≤:', op: ['10609', '10600', '10309', '10603'], ans: 1, diff: 'EASY', r: 'Excellent shortcut.', w: '10000+600+9 = 10609.' },
        { q: '97 √ó 103 using identity:', op: ['9991', '10000', '10006', '9909'], ans: 1, diff: 'EASY', r: 'Great mental math.', w: '(100‚àí3)(100+3)=10000‚àí9=9991.' },
        { q: '(2a)¬≤ equals:', op: ['2a¬≤', '4a¬≤', '4a', '2a'], ans: 2, diff: 'EASY', r: 'Good squaring.', w: '(2a)¬≤ = 4a¬≤.' },
        { q: 'If a=b in (a+b)¬≤, result:', op: ['2a¬≤', '4a¬≤', 'a¬≤', 'a‚Å¥'], ans: 2, diff: 'EASY', r: 'Good substitution.', w: '(2a)¬≤=4a¬≤.' },
        { q: 'Simplify (x+3)¬≤‚àí(x‚àí3)¬≤:', op: ['12x', '6x', '9', '18'], ans: 1, diff: 'MEDIUM', r: 'Excellent identity.', w: '4ab ‚Üí 4(x)(3)=12x.' },
        { q: 'If a¬≤+b¬≤=50, ab=7, (a+b)¬≤=:', op: ['64', '57', '43', '36'], ans: 1, diff: 'MEDIUM', r: 'Strong formula.', w: 'a¬≤+2ab+b¬≤=50+14=64.' },
        { q: '995¬≤ equals:', op: ['990025', '990000', '990050', '989025'], ans: 1, diff: 'MEDIUM', r: 'Excellent mental math.', w: '(1000‚àí5)¬≤=1000000‚àí10000+25=990025.' },
        { q: 'If (a+b+c)¬≤=100, a¬≤+b¬≤+c¬≤=40, ab+bc+ca=:', op: ['30', '60', '20', '50'], ans: 1, diff: 'HARD', r: 'Outstanding mastery.', w: '100=40+2(ab+bc+ca) ‚Üí 30.' },
        { q: '(x¬≤+1/x¬≤)‚àí(x‚àí1/x)¬≤ equals:', op: ['0', '2', '‚àí2', '1'], ans: 2, diff: 'HARD', r: 'Excellent skills.', w: 'x¬≤+1/x¬≤‚àí(x¬≤‚àí2+1/x¬≤) = 2.' },
    ],
};

export const mathChaptersData: ChapterData[] = [
    { name: 'Rational and Irrational Numbers', order: 1, levels: makeLevels(ch1), youtubeLink: 'https://youtube.com/playlist?list=PLjm_mvBNlvBYgDuCkYL3YntehJ3ldWBA5&si=DXxyroqha1RJFZfT' },
    { name: 'Parallel Lines and Transversal', order: 2, levels: makeLevels(ch2), youtubeLink: 'https://youtube.com/playlist?list=PLjm_mvBNlvBYgDuCkYL3YntehJ3ldWBA5&si=DXxyroqha1RJFZfT' },
    { name: 'Indices and Cube Root', order: 3, levels: makeLevels(ch3), youtubeLink: 'https://youtube.com/playlist?list=PLjm_mvBNlvBYgDuCkYL3YntehJ3ldWBA5&si=DXxyroqha1RJFZfT' },
    { name: 'Altitudes and Medians of a Triangle', order: 4, levels: makeLevels(ch4), youtubeLink: 'https://youtube.com/playlist?list=PLjm_mvBNlvBYgDuCkYL3YntehJ3ldWBA5&si=DXxyroqha1RJFZfT' },
    { name: 'Expansion Formulae', order: 5, levels: makeLevels(ch5), youtubeLink: 'https://youtube.com/playlist?list=PLjm_mvBNlvBYgDuCkYL3YntehJ3ldWBA5&si=DXxyroqha1RJFZfT' },
];




/*******************************************************************************
 * FILE: server/prisma/scienceChapters.ts
 *******************************************************************************/

import { QuestionData, LevelData, ChapterData } from './mathChapters.js';

function makeLevels(topics: Record<string, QuestionData[]>): LevelData[] {
    return ['Diagnostic', 'Beginner', 'Intermediate', 'Advance', 'Challenge'].map(n => ({ name: n, questions: topics[n] }));
}

// ========== CHAPTER 1: Living World and Classification of Microbes ==========
const ch1: Record<string, QuestionData[]> = {
    Diagnostic: [
        { q: 'Biological classification means:', op: ['Naming only', 'Grouping organisms', 'Eating food', 'Movement'], ans: 2, diff: 'EASY', r: 'Excellent speed and accuracy.', w: 'Classification means grouping.' },
        { q: 'Total kingdoms in five-kingdom system:', op: ['2', '3', '5', '7'], ans: 3, diff: 'EASY', r: 'Good recall.', w: 'Five kingdom system.' },
        { q: 'Monera organisms are:', op: ['Multicellular', 'Prokaryotic', 'Only plants', 'Only animals'], ans: 2, diff: 'EASY', r: 'Accurate response.', w: 'Monera are prokaryotic.' },
        { q: 'Amoeba belongs to:', op: ['Monera', 'Protista', 'Fungi', 'Animalia'], ans: 2, diff: 'EASY', r: 'Fast identification.', w: 'Amoeba is Protista.' },
        { q: 'Fungi obtain food by:', op: ['Photosynthesis', 'Absorption', 'Hunting', 'Chewing'], ans: 2, diff: 'EASY', r: 'Good accuracy.', w: 'Fungi absorb nutrients.' },
        { q: 'Bacteria reproduce by:', op: ['Budding', 'Binary fission', 'Seeds', 'Spores only'], ans: 2, diff: 'MEDIUM', r: 'Strong accuracy.', w: 'Bacteria divide by binary fission.' },
        { q: 'Protista are mostly:', op: ['Multicellular', 'Unicellular', 'Only plants', 'Only fungi'], ans: 2, diff: 'MEDIUM', r: 'Accurate.', w: 'Protista are unicellular.' },
        { q: 'Viruses are visible using:', op: ['Simple microscope', 'Compound microscope', 'Electron microscope', 'Naked eye'], ans: 3, diff: 'MEDIUM', r: 'Excellent accuracy.', w: 'Viruses need electron microscope.' },
        { q: 'Producers in ecosystem:', op: ['Animals', 'Plants', 'Fungi', 'Viruses'], ans: 2, diff: 'HARD', r: 'High accuracy.', w: 'Plants are producers.' },
        { q: 'Smallest microbes are:', op: ['Bacteria', 'Fungi', 'Virus', 'Algae'], ans: 3, diff: 'HARD', r: 'Excellent.', w: 'Viruses are smallest.' },
    ],
    Beginner: [
        { q: 'Study of microbes is called:', op: ['Botany', 'Zoology', 'Microbiology', 'Physics'], ans: 3, diff: 'EASY', r: 'Good accuracy.', w: 'Microbiology studies microbes.' },
        { q: 'Which is unicellular?', op: ['Mushroom', 'Amoeba', 'Human', 'Tree'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Amoeba is unicellular.' },
        { q: 'Algae are mostly:', op: ['Aquatic', 'Desert', 'Air', 'Soil only'], ans: 1, diff: 'EASY', r: 'Good accuracy.', w: 'Algae mostly live in water.' },
        { q: 'Cell wall in fungi made of:', op: ['Cellulose', 'Chitin', 'Protein', 'Fat'], ans: 2, diff: 'EASY', r: 'Excellent recall.', w: 'Fungi wall contains chitin.' },
        { q: 'Euglena is:', op: ['Bacteria', 'Protist', 'Virus', 'Animal'], ans: 2, diff: 'EASY', r: 'Strong accuracy.', w: 'Euglena belongs to Protista.' },
        { q: 'Saprotrophs feed on:', op: ['Fresh plants', 'Dead matter', 'Water', 'Air'], ans: 2, diff: 'MEDIUM', r: 'Accurate.', w: 'Saprotrophs feed on dead matter.' },
        { q: 'Which is prokaryotic?', op: ['Amoeba', 'Bacteria', 'Fungi', 'Algae'], ans: 2, diff: 'MEDIUM', r: 'Excellent.', w: 'Bacteria are prokaryotes.' },
        { q: 'Photosynthesis occurs in:', op: ['Fungi', 'Animals', 'Algae', 'Virus'], ans: 3, diff: 'MEDIUM', r: 'Good concept clarity.', w: 'Algae perform photosynthesis.' },
        { q: 'Virus contains:', op: ['Only protein', 'DNA/RNA + protein', 'Only nucleus', 'Cytoplasm'], ans: 2, diff: 'HARD', r: 'Strong accuracy.', w: 'Virus has genetic material + protein coat.' },
        { q: 'Decomposers are:', op: ['Plants', 'Fungi', 'Animals', 'Birds'], ans: 2, diff: 'HARD', r: 'Excellent.', w: 'Fungi act as decomposers.' },
    ],
    Intermediate: [
        { q: 'Five kingdom system based on:', op: ['Colour', 'Size', 'Cell and nutrition', 'Weight'], ans: 3, diff: 'EASY', r: 'Good accuracy.', w: 'Revise classification criteria.' },
        { q: 'Multicellular kingdom:', op: ['Monera', 'Protista', 'Animalia', 'Virus'], ans: 3, diff: 'EASY', r: 'Accurate.', w: 'Animals are multicellular.' },
        { q: 'Bacteria size measured in:', op: ['Meter', 'Kilometer', 'Micrometer', 'Liter'], ans: 3, diff: 'EASY', r: 'Good scientific accuracy.', w: 'Bacteria measured in micrometer.' },
        { q: 'Protozoa found in:', op: ['Space', 'Soil/water', 'Fire', 'Metal'], ans: 2, diff: 'EASY', r: 'Correct.', w: 'Protozoa live in soil & water.' },
        { q: 'Mushroom belongs to:', op: ['Fungi', 'Monera', 'Protista', 'Virus'], ans: 1, diff: 'EASY', r: 'Strong accuracy.', w: 'Mushroom is fungus.' },
        { q: 'Autotroph example:', op: ['Amoeba', 'Algae', 'Fungi', 'Virus'], ans: 2, diff: 'MEDIUM', r: 'Good clarity.', w: 'Algae are autotrophs.' },
        { q: 'Pathogenic protozoa causes:', op: ['Cold', 'Malaria', 'Fever only', 'Headache'], ans: 2, diff: 'MEDIUM', r: 'Excellent accuracy.', w: 'Plasmodium causes malaria.' },
        { q: 'Virus multiplies in:', op: ['Water', 'Air', 'Host cell', 'Soil'], ans: 3, diff: 'MEDIUM', r: 'High accuracy.', w: 'Virus needs host cell.' },
        { q: 'Which has no nucleus?', op: ['Fungi', 'Protista', 'Bacteria', 'Algae'], ans: 3, diff: 'HARD', r: 'Excellent.', w: 'Bacteria lack nucleus.' },
        { q: 'Consumers are:', op: ['Plants', 'Animals', 'Fungi', 'Algae'], ans: 2, diff: 'HARD', r: 'Strong understanding.', w: 'Animals are consumers.' },
    ],
    Advance: [
        { q: 'Producers make food by:', op: ['Digestion', 'Photosynthesis', 'Absorption', 'Hunting'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Producers photosynthesize.' },
        { q: 'Chlorella is:', op: ['Bacteria', 'Algae', 'Virus', 'Animal'], ans: 2, diff: 'EASY', r: 'Good accuracy.', w: 'Chlorella is algae.' },
        { q: 'Fungi are:', op: ['Autotroph', 'Heterotroph', 'Producers', 'None'], ans: 2, diff: 'EASY', r: 'Correct.', w: 'Fungi are heterotrophs.' },
        { q: 'Monera includes:', op: ['Virus', 'Bacteria', 'Plants', 'Animals'], ans: 2, diff: 'EASY', r: 'Excellent speed.', w: 'Monera = bacteria.' },
        { q: 'Binary fission seen in:', op: ['Plants', 'Animals', 'Bacteria', 'Birds'], ans: 3, diff: 'EASY', r: 'Accurate recall.', w: 'Bacteria divide by fission.' },
        { q: 'Virus size measured in:', op: ['Meter', 'mm', 'nm', 'cm'], ans: 3, diff: 'MEDIUM', r: 'Good accuracy.', w: 'Virus measured in nanometer.' },
        { q: 'Multicellular fungi example:', op: ['Yeast', 'Mushroom', 'Bacteria', 'Virus'], ans: 2, diff: 'MEDIUM', r: 'Accurate.', w: 'Mushroom is multicellular fungus.' },
        { q: 'Euglena shows:', op: ['Only plant trait', 'Only animal trait', 'Both', 'None'], ans: 3, diff: 'MEDIUM', r: 'High concept accuracy.', w: 'Euglena shows both traits.' },
        { q: 'Edge of living and non-living:', op: ['Fungi', 'Virus', 'Algae', 'Bacteria'], ans: 2, diff: 'HARD', r: 'Excellent knowledge.', w: 'Virus shows both properties.' },
        { q: 'Decomposer role done by:', op: ['Plants', 'Fungi', 'Birds', 'Fish'], ans: 2, diff: 'HARD', r: 'Strong concept.', w: 'Fungi decompose matter.' },
    ],
    Challenge: [
        { q: 'Classification helps in:', op: ['Confusion', 'Study organisms', 'Destroy life', 'Ignore species'], ans: 2, diff: 'EASY', r: 'Fast and accurate.', w: 'Classification helps study.' },
        { q: 'Autotroph means:', op: ['Eats others', 'Makes own food', 'No food', 'Only water'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Autotroph makes own food.' },
        { q: 'Protozoa are:', op: ['Multicellular', 'Unicellular', 'Plants', 'Virus'], ans: 2, diff: 'EASY', r: 'Good accuracy.', w: 'Protozoa unicellular.' },
        { q: 'Virus contains:', op: ['Only cell', 'Only nucleus', 'DNA or RNA', 'Roots'], ans: 3, diff: 'EASY', r: 'Excellent.', w: 'Virus has DNA/RNA.' },
        { q: 'Algae contain:', op: ['Chloroplast', 'Bone', 'Muscle', 'Hair'], ans: 1, diff: 'EASY', r: 'Correct.', w: 'Chloroplast present in algae.' },
        { q: 'Pathogenic bacteria example:', op: ['Mushroom', 'Lactobacillus', 'Salmonella', 'Algae'], ans: 3, diff: 'MEDIUM', r: 'Strong accuracy.', w: 'Salmonella causes disease.' },
        { q: 'Fungi reproduce by:', op: ['Budding/spores', 'Seeds', 'Eggs', 'Roots'], ans: 1, diff: 'MEDIUM', r: 'Excellent clarity.', w: 'Fungi reproduce by spores/budding.' },
        { q: 'Which is eukaryotic?', op: ['Bacteria', 'Virus', 'Amoeba', 'None'], ans: 3, diff: 'MEDIUM', r: 'Accurate.', w: 'Amoeba is eukaryotic.' },
        { q: 'Most numerous organisms:', op: ['Animals', 'Microorganisms', 'Plants', 'Birds'], ans: 2, diff: 'HARD', r: 'Advanced accuracy.', w: 'Microbes most numerous.' },
        { q: 'Study of classification called:', op: ['Taxonomy', 'Anatomy', 'Chemistry', 'Physics'], ans: 1, diff: 'HARD', r: 'Excellent mastery.', w: 'Taxonomy = classification study.' },
    ],
};

// ========== CHAPTER 2: Health and Diseases ==========
const ch2: Record<string, QuestionData[]> = {
    Diagnostic: [
        { q: 'Health means:', op: ['Absence of disease only', 'Physical, mental & social well-being', 'Only physical fitness', 'Only mental fitness'], ans: 2, diff: 'EASY', r: 'Correct WHO definition.', w: 'Health = complete well-being.' },
        { q: 'Disease caused by bacteria:', op: ['Malaria', 'Tuberculosis', 'AIDS', 'Dengue'], ans: 2, diff: 'EASY', r: 'Good identification.', w: 'TB is bacterial.' },
        { q: 'Malaria is spread by:', op: ['Housefly', 'Mosquito', 'Dog', 'Cat'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Anopheles mosquito spreads malaria.' },
        { q: 'Vaccine was discovered by:', op: ['Newton', 'Edward Jenner', 'Einstein', 'Darwin'], ans: 2, diff: 'EASY', r: 'Good history.', w: 'Edward Jenner discovered vaccination.' },
        { q: 'AIDS is caused by:', op: ['Bacteria', 'Virus', 'Fungi', 'Protozoa'], ans: 2, diff: 'EASY', r: 'Correct.', w: 'HIV virus causes AIDS.' },
        { q: 'Communicable diseases spread through:', op: ['Genetics', 'Contact/vectors', 'Exercise', 'Sleep'], ans: 2, diff: 'MEDIUM', r: 'Good understanding.', w: 'Communicable = spread by contact/vectors.' },
        { q: 'Dengue is caused by:', op: ['Bacteria', 'Protozoa', 'Virus', 'Fungi'], ans: 3, diff: 'MEDIUM', r: 'Accurate.', w: 'Dengue virus spread by Aedes mosquito.' },
        { q: 'First line of defence in body:', op: ['WBC', 'Skin', 'Bones', 'Brain'], ans: 2, diff: 'MEDIUM', r: 'Good immunity concept.', w: 'Skin is first barrier.' },
        { q: 'Antibiotic kills:', op: ['Virus', 'Bacteria', 'Both', 'None'], ans: 2, diff: 'HARD', r: 'Excellent distinction.', w: 'Antibiotics work against bacteria only.' },
        { q: 'Non-communicable disease example:', op: ['Cholera', 'Diabetes', 'Malaria', 'TB'], ans: 2, diff: 'HARD', r: 'Strong classification.', w: 'Diabetes is non-communicable.' },
    ],
    Beginner: [
        { q: 'Deficiency of iron causes:', op: ['Scurvy', 'Anaemia', 'Goitre', 'Rickets'], ans: 2, diff: 'EASY', r: 'Good recall.', w: 'Iron deficiency ‚Üí anaemia.' },
        { q: 'Vitamin C prevents:', op: ['Rickets', 'Scurvy', 'Night blindness', 'Goitre'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Vitamin C prevents scurvy.' },
        { q: 'Cholera spreads through:', op: ['Air', 'Contaminated water', 'Touch', 'Light'], ans: 2, diff: 'EASY', r: 'Good knowledge.', w: 'Cholera is waterborne.' },
        { q: 'Which vitamin prevents night blindness?', op: ['A', 'B', 'C', 'D'], ans: 1, diff: 'EASY', r: 'Correct.', w: 'Vitamin A for night vision.' },
        { q: 'Rickets caused by deficiency of:', op: ['Vitamin A', 'Vitamin B', 'Vitamin C', 'Vitamin D'], ans: 4, diff: 'EASY', r: 'Good recall.', w: 'Vitamin D deficiency ‚Üí rickets.' },
        { q: 'White blood cells help in:', op: ['Digestion', 'Immunity', 'Breathing', 'Movement'], ans: 2, diff: 'MEDIUM', r: 'Good understanding.', w: 'WBCs fight infections.' },
        { q: 'Typhoid is caused by:', op: ['Virus', 'Fungi', 'Bacteria', 'Protozoa'], ans: 3, diff: 'MEDIUM', r: 'Accurate.', w: 'Salmonella typhi bacteria.' },
        { q: 'Vaccination provides:', op: ['Natural immunity', 'Artificial immunity', 'No immunity', 'Weakness'], ans: 2, diff: 'MEDIUM', r: 'Good concept.', w: 'Vaccines provide artificial immunity.' },
        { q: 'Goitre caused by deficiency of:', op: ['Iron', 'Iodine', 'Calcium', 'Zinc'], ans: 2, diff: 'HARD', r: 'Excellent recall.', w: 'Iodine deficiency ‚Üí goitre.' },
        { q: 'Vector for dengue:', op: ['Anopheles', 'Aedes', 'Housefly', 'Cockroach'], ans: 2, diff: 'HARD', r: 'Strong knowledge.', w: 'Aedes mosquito spreads dengue.' },
    ],
    Intermediate: [
        { q: 'Pathogen means:', op: ['Medicine', 'Disease-causing organism', 'Food', 'Vitamin'], ans: 2, diff: 'EASY', r: 'Good vocabulary.', w: 'Pathogen = disease-causing agent.' },
        { q: 'Which is a viral disease?', op: ['TB', 'Cholera', 'Common cold', 'Typhoid'], ans: 3, diff: 'EASY', r: 'Accurate.', w: 'Common cold is viral.' },
        { q: 'Balanced diet contains:', op: ['Only carbs', 'Only protein', 'All nutrients', 'Only vitamins'], ans: 3, diff: 'EASY', r: 'Good nutrition concept.', w: 'Balanced diet has all nutrients.' },
        { q: 'Immunity means:', op: ['Disease', 'Resistance to disease', 'Food', 'Exercise'], ans: 2, diff: 'EASY', r: 'Correct.', w: 'Immunity = resistance to disease.' },
        { q: 'Personal hygiene prevents:', op: ['Growth', 'Disease', 'Movement', 'Sleep'], ans: 2, diff: 'EASY', r: 'Good understanding.', w: 'Hygiene prevents disease.' },
        { q: 'Antibodies are produced by:', op: ['RBC', 'WBC', 'Platelets', 'Plasma'], ans: 2, diff: 'MEDIUM', r: 'Excellent.', w: 'White blood cells produce antibodies.' },
        { q: 'Pasteurization kills germs in:', op: ['Soil', 'Water', 'Milk', 'Air'], ans: 3, diff: 'MEDIUM', r: 'Good knowledge.', w: 'Pasteurization treats milk.' },
        { q: 'ORS is used for:', op: ['Headache', 'Dehydration', 'Fracture', 'Fever'], ans: 2, diff: 'MEDIUM', r: 'Accurate.', w: 'ORS treats dehydration.' },
        { q: 'Ringworm is caused by:', op: ['Worm', 'Fungi', 'Bacteria', 'Virus'], ans: 2, diff: 'HARD', r: 'Excellent ‚Äî tricky name!', w: 'Ringworm is actually a fungal infection.' },
        { q: 'Penicillin is obtained from:', op: ['Bacteria', 'Fungi', 'Virus', 'Algae'], ans: 2, diff: 'HARD', r: 'Strong history knowledge.', w: 'Penicillin comes from Penicillium fungus.' },
    ],
    Advance: [
        { q: 'BCG vaccine protects against:', op: ['Polio', 'Tuberculosis', 'Malaria', 'Dengue'], ans: 2, diff: 'EASY', r: 'Good recall.', w: 'BCG for tuberculosis.' },
        { q: 'Kwashiorkor caused by deficiency of:', op: ['Carbohydrates', 'Protein', 'Fats', 'Vitamins'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Protein deficiency ‚Üí kwashiorkor.' },
        { q: 'Contaminated food causes:', op: ['Healthy growth', 'Food poisoning', 'Strength', 'Nothing'], ans: 2, diff: 'EASY', r: 'Correct.', w: 'Contaminated food causes food poisoning.' },
        { q: 'Hereditary diseases are:', op: ['Communicable', 'Non-communicable', 'Viral', 'Bacterial'], ans: 2, diff: 'EASY', r: 'Good classification.', w: 'Hereditary = non-communicable.' },
        { q: 'Antibiotics should be used:', op: ['Daily', 'As prescribed', 'Anytime', 'Never'], ans: 2, diff: 'EASY', r: 'Excellent awareness.', w: 'Only as prescribed by doctor.' },
        { q: 'HIV attacks which cells?', op: ['RBC', 'WBC (T-cells)', 'Platelets', 'Nerve cells'], ans: 2, diff: 'MEDIUM', r: 'Strong knowledge.', w: 'HIV attacks T-helper cells (WBC).' },
        { q: 'Marasmus caused by deficiency of:', op: ['Protein & calories', 'Only vitamins', 'Only iron', 'Only water'], ans: 1, diff: 'MEDIUM', r: 'Good understanding.', w: 'Protein-calorie malnutrition ‚Üí marasmus.' },
        { q: 'Rabies spread by:', op: ['Water', 'Dog bite', 'Touch', 'Air'], ans: 2, diff: 'MEDIUM', r: 'Accurate.', w: 'Rabies spreads through animal bites.' },
        { q: 'Antibiotic resistance occurs when:', op: ['Body gets stronger', 'Bacteria become resistant', 'Virus dies', 'Nothing'], ans: 2, diff: 'HARD', r: 'Excellent concept.', w: 'Overuse leads to resistant bacteria.' },
        { q: 'Polio vaccine developed by:', op: ['Jenner', 'Jonas Salk', 'Pasteur', 'Fleming'], ans: 2, diff: 'HARD', r: 'Great history recall.', w: 'Jonas Salk developed polio vaccine.' },
    ],
    Challenge: [
        { q: 'WHO stands for:', op: ['World Health Organization', 'World Human Organization', 'World Hospital Organization', 'World Help Organization'], ans: 1, diff: 'EASY', r: 'Good recall.', w: 'World Health Organization.' },
        { q: 'Infectious disease means:', op: ['Hereditary', 'Communicable', 'Nutritional', 'Mental'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Infectious = communicable.' },
        { q: 'Clean water prevents:', op: ['All diseases', 'Waterborne diseases', 'Genetic diseases', 'Mental illness'], ans: 2, diff: 'EASY', r: 'Good.', w: 'Clean water prevents waterborne diseases.' },
        { q: 'Protein-rich food:', op: ['Rice', 'Pulses/dal', 'Sugar', 'Oil'], ans: 2, diff: 'EASY', r: 'Good nutrition.', w: 'Pulses/dal are protein-rich.' },
        { q: 'Mosquito nets prevent:', op: ['Cold', 'Mosquito-borne diseases', 'Headache', 'Fracture'], ans: 2, diff: 'EASY', r: 'Practical knowledge.', w: 'Nets prevent mosquito-borne diseases.' },
        { q: 'Epidemic means:', op: ['One person ill', 'Disease spreading widely', 'No disease', 'Cure found'], ans: 2, diff: 'MEDIUM', r: 'Excellent vocabulary.', w: 'Epidemic = widespread disease.' },
        { q: 'Active immunity develops after:', op: ['Sleeping', 'Infection or vaccination', 'Eating', 'Drinking water'], ans: 2, diff: 'MEDIUM', r: 'Strong concept.', w: 'Infection/vaccine ‚Üí active immunity.' },
        { q: 'Carrier of disease:', op: ['Medicine', 'Vector', 'Food only', 'None'], ans: 2, diff: 'MEDIUM', r: 'Good.', w: 'Vectors carry disease organisms.' },
        { q: 'Autoimmune disease means:', op: ['Body attacks itself', 'External infection', 'Nutritional', 'Genetic only'], ans: 1, diff: 'HARD', r: 'Excellent advanced concept.', w: 'Immune system attacks own body.' },
        { q: 'Pandemic means:', op: ['Local disease', 'Worldwide disease spread', 'Seasonal allergy', 'One case'], ans: 2, diff: 'HARD', r: 'Strong vocabulary.', w: 'Pandemic = global disease spread.' },
    ],
};

// ========== CHAPTER 3: Force and Pressure ==========
const ch3: Record<string, QuestionData[]> = {
    Diagnostic: [
        { q: 'Force is a:', op: ['Push or pull', 'Colour', 'Sound', 'Smell'], ans: 1, diff: 'EASY', r: 'Good basic concept.', w: 'Force = push or pull.' },
        { q: 'SI unit of force is:', op: ['Meter', 'Newton', 'Kilogram', 'Second'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Force measured in Newtons.' },
        { q: 'Pressure = Force √∑:', op: ['Mass', 'Area', 'Volume', 'Time'], ans: 2, diff: 'EASY', r: 'Correct formula.', w: 'Pressure = Force/Area.' },
        { q: 'Gravitational force pulls objects:', op: ['Upward', 'Downward', 'Sideways', 'Nowhere'], ans: 2, diff: 'EASY', r: 'Good understanding.', w: 'Gravity pulls downward.' },
        { q: 'Friction opposes:', op: ['Gravity', 'Motion', 'Light', 'Sound'], ans: 2, diff: 'EASY', r: 'Excellent.', w: 'Friction opposes motion.' },
        { q: 'Unit of pressure is:', op: ['Newton', 'Pascal', 'Meter', 'Kilogram'], ans: 2, diff: 'MEDIUM', r: 'Good recall.', w: 'Pressure measured in Pascal (Pa).' },
        { q: 'Atmospheric pressure acts in:', op: ['One direction', 'All directions', 'Only downward', 'Only upward'], ans: 2, diff: 'MEDIUM', r: 'Strong concept.', w: 'Atmospheric pressure acts in all directions.' },
        { q: 'Liquid pressure increases with:', op: ['Colour', 'Depth', 'Width', 'Temperature only'], ans: 2, diff: 'MEDIUM', r: 'Good understanding.', w: 'Deeper = more pressure.' },
        { q: 'Sharp knife cuts better because:', op: ['More area', 'Less area = more pressure', 'More force', 'Less force'], ans: 2, diff: 'HARD', r: 'Excellent pressure application.', w: 'Less area ‚Üí more pressure.' },
        { q: 'Force can change an object\'s:', op: ['Colour', 'Shape, speed, direction', 'Smell', 'Taste'], ans: 2, diff: 'HARD', r: 'Strong understanding.', w: 'Force changes shape, speed, or direction.' },
    ],
    Beginner: [
        { q: 'Muscular force is exerted by:', op: ['Machines', 'Muscles', 'Magnets', 'Gravity'], ans: 2, diff: 'EASY', r: 'Good recall.', w: 'Muscles exert muscular force.' },
        { q: 'Contact force requires:', op: ['No contact', 'Physical contact', 'Light', 'Sound'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Contact force needs physical touch.' },
        { q: 'Magnetic force is:', op: ['Contact force', 'Non-contact force', 'No force', 'Friction'], ans: 2, diff: 'EASY', r: 'Good classification.', w: 'Magnetic force is non-contact.' },
        { q: 'Weight of object on moon is:', op: ['Same as earth', 'Less than earth', 'More than earth', 'Zero'], ans: 2, diff: 'EASY', r: 'Correct.', w: 'Moon has less gravity ‚Üí less weight.' },
        { q: 'Electrostatic force is:', op: ['Contact', 'Non-contact', 'Friction', 'Muscular'], ans: 2, diff: 'EASY', r: 'Good classification.', w: 'Electrostatic force is non-contact.' },
        { q: 'Wider tyre on truck because:', op: ['Looks better', 'Distributes pressure', 'Increases pressure', 'No reason'], ans: 2, diff: 'MEDIUM', r: 'Good application.', w: 'More area = less pressure on road.' },
        { q: 'Camel walks easily on sand due to:', op: ['Light weight', 'Wide feet', 'Thin legs', 'Long neck'], ans: 2, diff: 'MEDIUM', r: 'Excellent real-world concept.', w: 'Wide feet = less pressure on sand.' },
        { q: 'Spring balance measures:', op: ['Mass', 'Force', 'Length', 'Volume'], ans: 2, diff: 'MEDIUM', r: 'Accurate.', w: 'Spring balance measures force.' },
        { q: 'Net force on stationary object:', op: ['Maximum', 'Minimum', 'Zero', 'Infinite'], ans: 3, diff: 'HARD', r: 'Strong Newton\'s law.', w: 'Balanced forces ‚Üí net force = zero.' },
        { q: 'Pascal\'s law applies to:', op: ['Solids', 'Liquids', 'Gases only', 'Both liquids and gases'], ans: 4, diff: 'HARD', r: 'Excellent advanced concept.', w: 'Pascal\'s law applies to fluids (liquids & gases).' },
    ],
    Intermediate: [
        { q: 'Gravity is discovered by:', op: ['Einstein', 'Newton', 'Galileo', 'Edison'], ans: 2, diff: 'EASY', r: 'Good history.', w: 'Newton discovered gravity.' },
        { q: '1 Pascal equals:', op: ['1 N/m', '1 N/m¬≤', '1 kg/m', '1 m/s¬≤'], ans: 2, diff: 'EASY', r: 'Accurate unit.', w: '1 Pa = 1 N/m¬≤.' },
        { q: 'Friction is useful for:', op: ['Walking', 'Sliding', 'Both', 'Neither'], ans: 1, diff: 'EASY', r: 'Good understanding.', w: 'Friction helps us walk.' },
        { q: 'Pressure increases when area:', op: ['Increases', 'Decreases', 'Stays same', 'Doubles'], ans: 2, diff: 'EASY', r: 'Correct relationship.', w: 'Less area = more pressure.' },
        { q: 'Force is a vector because it has:', op: ['Only magnitude', 'Magnitude and direction', 'Only direction', 'Neither'], ans: 2, diff: 'EASY', r: 'Good physics concept.', w: 'Vectors have magnitude + direction.' },
        { q: 'If force = 100N, area = 5m¬≤, pressure =:', op: ['20 Pa', '500 Pa', '50 Pa', '105 Pa'], ans: 1, diff: 'MEDIUM', r: 'Good calculation.', w: '100/5 = 20 Pa.' },
        { q: 'Hydraulic machines work on:', op: ['Newton\'s law', 'Pascal\'s law', 'Ohm\'s law', 'Boyle\'s law'], ans: 2, diff: 'MEDIUM', r: 'Excellent.', w: 'Hydraulic machines use Pascal\'s law.' },
        { q: 'Buoyant force acts:', op: ['Downward', 'Upward', 'Sideways', 'No direction'], ans: 2, diff: 'MEDIUM', r: 'Strong concept.', w: 'Buoyancy acts upward.' },
        { q: 'If force doubles and area stays same, pressure:', op: ['Halves', 'Doubles', 'Stays same', 'Triples'], ans: 2, diff: 'HARD', r: 'Excellent proportional reasoning.', w: 'P = F/A, F doubles ‚Üí P doubles.' },
        { q: 'Atmospheric pressure at sea level:', op: ['Zero', '1 atm', '2 atm', '0.5 atm'], ans: 2, diff: 'HARD', r: 'Good scientific knowledge.', w: '1 atmosphere at sea level.' },
    ],
    Advance: [
        { q: 'Streamlined shapes reduce:', op: ['Weight', 'Friction/drag', 'Gravity', 'Pressure'], ans: 2, diff: 'EASY', r: 'Good application.', w: 'Streamline shapes reduce drag.' },
        { q: 'Rolling friction is ___ sliding friction:', op: ['Greater than', 'Less than', 'Equal to', 'Unrelated to'], ans: 2, diff: 'EASY', r: 'Accurate comparison.', w: 'Rolling friction < sliding friction.' },
        { q: 'Lubricants:', op: ['Increase friction', 'Reduce friction', 'Have no effect', 'Increase weight'], ans: 2, diff: 'EASY', r: 'Good practical knowledge.', w: 'Lubricants reduce friction.' },
        { q: 'Dam walls are thicker at bottom because:', op: ['Looks better', 'More water pressure at bottom', 'Less water', 'No reason'], ans: 2, diff: 'EASY', r: 'Excellent real-world connection.', w: 'Water pressure increases with depth.' },
        { q: 'Acceleration due to gravity (g):', op: ['9.8 m/s¬≤', '10 m', '98 m/s', '1 m/s¬≤'], ans: 1, diff: 'EASY', r: 'Good recall.', w: 'g ‚âà 9.8 m/s¬≤.' },
        { q: 'If area halves, pressure:', op: ['Halves', 'Doubles', 'Stays same', 'Triples'], ans: 2, diff: 'MEDIUM', r: 'Good inverse relationship.', w: 'Half area ‚Üí double pressure.' },
        { q: 'Heavy schoolbag straps are wide to:', op: ['Look better', 'Reduce pressure on shoulders', 'Increase pressure', 'No reason'], ans: 2, diff: 'MEDIUM', r: 'Excellent practical application.', w: 'Wide straps = less pressure.' },
        { q: 'Torricelli invented:', op: ['Telescope', 'Barometer', 'Thermometer', 'Compass'], ans: 2, diff: 'MEDIUM', r: 'Good history.', w: 'Torricelli invented the barometer.' },
        { q: 'Force of 200N on 0.01m¬≤ gives pressure:', op: ['2000 Pa', '20000 Pa', '200 Pa', '20 Pa'], ans: 2, diff: 'HARD', r: 'Excellent calculation.', w: '200/0.01 = 20000 Pa.' },
        { q: 'Archimedes principle relates to:', op: ['Friction', 'Buoyancy', 'Magnetism', 'Electricity'], ans: 2, diff: 'HARD', r: 'Strong knowledge.', w: 'Archimedes principle = buoyancy.' },
    ],
    Challenge: [
        { q: 'Nail has pointed tip to:', op: ['Look sharp', 'Increase pressure', 'Decrease pressure', 'Save material'], ans: 2, diff: 'EASY', r: 'Good application.', w: 'Small area ‚Üí more pressure.' },
        { q: 'Tractor has wide tyres to:', op: ['Go faster', 'Reduce pressure on soil', 'Look bigger', 'Carry more'], ans: 2, diff: 'EASY', r: 'Correct reasoning.', w: 'Wide tyres distribute pressure.' },
        { q: 'Suction cups work due to:', op: ['Gravity', 'Atmospheric pressure', 'Friction', 'Magnetism'], ans: 2, diff: 'EASY', r: 'Excellent.', w: 'Suction cups use atmospheric pressure.' },
        { q: 'In space, atmospheric pressure is:', op: ['Very high', 'Normal', 'Zero/negligible', 'Double'], ans: 3, diff: 'EASY', r: 'Good understanding.', w: 'No atmosphere in space ‚Üí no pressure.' },
        { q: 'Weight = mass √ó:', op: ['Speed', 'g (gravity)', 'Area', 'Volume'], ans: 2, diff: 'EASY', r: 'Correct formula.', w: 'W = m √ó g.' },
        { q: 'If same force on area 10m¬≤ vs 5m¬≤, which has more pressure?', op: ['10m¬≤', '5m¬≤', 'Same', 'Cannot tell'], ans: 2, diff: 'MEDIUM', r: 'Good reasoning.', w: 'Smaller area = more pressure.' },
        { q: 'Blood pressure is measured by:', op: ['Thermometer', 'Sphygmomanometer', 'Barometer', 'Scale'], ans: 2, diff: 'MEDIUM', r: 'Excellent vocabulary.', w: 'Sphygmomanometer measures blood pressure.' },
        { q: 'Friction produces:', op: ['Cold', 'Heat', 'Light only', 'Nothing'], ans: 2, diff: 'MEDIUM', r: 'Good concept.', w: 'Friction generates heat.' },
        { q: 'If F=50N, A=0.005m¬≤, P=:', op: ['10000 Pa', '250 Pa', '100 Pa', '1000 Pa'], ans: 1, diff: 'HARD', r: 'Excellent calculation.', w: '50/0.005 = 10000 Pa.' },
        { q: 'Manometer measures:', op: ['Temperature', 'Gas pressure', 'Speed', 'Weight'], ans: 2, diff: 'HARD', r: 'Strong instrument knowledge.', w: 'Manometer measures gas pressure.' },
    ],
};

// ========== CHAPTER 4: Current Electricity and Magnetism ==========
const ch4: Record<string, QuestionData[]> = {
    Diagnostic: [
        { q: 'Electric current is flow of:', op: ['Protons', 'Electrons', 'Neutrons', 'Atoms'], ans: 2, diff: 'EASY', r: 'Correct!', w: 'Current = flow of electrons.' },
        { q: 'SI unit of current is:', op: ['Volt', 'Ampere', 'Ohm', 'Watt'], ans: 2, diff: 'EASY', r: 'Good recall.', w: 'Current measured in Ampere.' },
        { q: 'Battery provides:', op: ['AC', 'DC', 'Both', 'None'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Battery provides direct current.' },
        { q: 'Unit of resistance is:', op: ['Volt', 'Ampere', 'Ohm', 'Watt'], ans: 3, diff: 'EASY', r: 'Good knowledge.', w: 'Resistance in Ohm (Œ©).' },
        { q: 'Magnet attracts:', op: ['Wood', 'Plastic', 'Iron', 'Glass'], ans: 3, diff: 'EASY', r: 'Excellent.', w: 'Magnets attract iron.' },
        { q: 'Ohm\'s law: V =', op: ['I √ó R', 'I / R', 'I + R', 'I ‚àí R'], ans: 1, diff: 'MEDIUM', r: 'Good formula recall.', w: 'V = I √ó R.' },
        { q: 'Good conductor of electricity:', op: ['Rubber', 'Wood', 'Copper', 'Plastic'], ans: 3, diff: 'MEDIUM', r: 'Accurate identification.', w: 'Copper is a good conductor.' },
        { q: 'Electromagnet works on:', op: ['Gravity', 'Current through coil', 'Light', 'Sound'], ans: 2, diff: 'MEDIUM', r: 'Strong concept.', w: 'Current in coil creates magnetic field.' },
        { q: 'LED stands for:', op: ['Light Emitting Diode', 'Low Energy Device', 'Light Electric Device', 'Large Electron Diode'], ans: 1, diff: 'HARD', r: 'Excellent.', w: 'Light Emitting Diode.' },
        { q: 'Fuse wire protects circuit from:', op: ['Low voltage', 'Overloading', 'Underloading', 'Magnetism'], ans: 2, diff: 'HARD', r: 'Strong safety knowledge.', w: 'Fuse melts during overload.' },
    ],
    Beginner: [
        { q: 'Switch is used to:', op: ['Increase current', 'Break/make circuit', 'Store charge', 'Create voltage'], ans: 2, diff: 'EASY', r: 'Good understanding.', w: 'Switch makes or breaks circuit.' },
        { q: 'Insulator example:', op: ['Copper', 'Iron', 'Rubber', 'Aluminium'], ans: 3, diff: 'EASY', r: 'Accurate.', w: 'Rubber is an insulator.' },
        { q: 'Electric cell has:', op: ['1 terminal', '2 terminals', '3 terminals', 'No terminal'], ans: 2, diff: 'EASY', r: 'Good recall.', w: 'Cell has positive and negative terminals.' },
        { q: 'Unit of voltage is:', op: ['Ampere', 'Volt', 'Ohm', 'Watt'], ans: 2, diff: 'EASY', r: 'Correct.', w: 'Voltage in Volts.' },
        { q: 'Like poles of magnets:', op: ['Attract', 'Repel', 'No effect', 'Combine'], ans: 2, diff: 'EASY', r: 'Good magnet concept.', w: 'Like poles repel.' },
        { q: 'Series circuit has:', op: ['Multiple paths', 'Single path', 'No path', 'Branching paths'], ans: 2, diff: 'MEDIUM', r: 'Good understanding.', w: 'Series = single path.' },
        { q: 'Parallel circuit has:', op: ['Single path', 'Multiple paths', 'No connection', 'Broken wire'], ans: 2, diff: 'MEDIUM', r: 'Accurate.', w: 'Parallel = multiple paths.' },
        { q: 'Magnetic field lines go from:', op: ['South to North outside', 'North to South outside', 'Random', 'No direction'], ans: 2, diff: 'MEDIUM', r: 'Good field line concept.', w: 'N to S outside the magnet.' },
        { q: 'If R increases, current:', op: ['Increases', 'Decreases', 'Stays same', 'Doubles'], ans: 2, diff: 'HARD', r: 'Excellent Ohm\'s law.', w: 'More resistance ‚Üí less current.' },
        { q: 'Electric motor converts:', op: ['Light to sound', 'Electrical to mechanical', 'Heat to light', 'Mechanical to electrical'], ans: 2, diff: 'HARD', r: 'Strong understanding.', w: 'Motor: electrical ‚Üí mechanical energy.' },
    ],
    Intermediate: [
        { q: 'Ammeter measures:', op: ['Voltage', 'Current', 'Resistance', 'Power'], ans: 2, diff: 'EASY', r: 'Good instrument knowledge.', w: 'Ammeter measures current.' },
        { q: 'Voltmeter measures:', op: ['Current', 'Voltage', 'Resistance', 'Speed'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Voltmeter measures voltage.' },
        { q: 'Earth is a:', op: ['Small magnet', 'Giant magnet', 'Non-magnet', 'Electric field'], ans: 2, diff: 'EASY', r: 'Good concept.', w: 'Earth behaves as a giant magnet.' },
        { q: 'Compass needle points:', op: ['East-West', 'North-South', 'Up-Down', 'Random'], ans: 2, diff: 'EASY', r: 'Correct.', w: 'Compass aligns N-S.' },
        { q: 'Bulb glows when circuit is:', op: ['Open', 'Closed', 'Broken', 'Off'], ans: 2, diff: 'EASY', r: 'Good understanding.', w: 'Closed circuit allows current.' },
        { q: 'If V=12V and R=4Œ©, I=:', op: ['3A', '48A', '8A', '16A'], ans: 1, diff: 'MEDIUM', r: 'Good calculation.', w: 'I = V/R = 12/4 = 3A.' },
        { q: 'Electromagnet is temporary because:', op: ['It breaks', 'Magnetism stops when current stops', 'It melts', 'It is weak'], ans: 2, diff: 'MEDIUM', r: 'Excellent concept.', w: 'No current ‚Üí no magnetism.' },
        { q: 'Ammeter is connected in:', op: ['Parallel', 'Series', 'Either', 'Neither'], ans: 2, diff: 'MEDIUM', r: 'Strong circuit knowledge.', w: 'Ammeter connected in series.' },
        { q: 'If V=220V, I=5A, R=:', op: ['44Œ©', '1100Œ©', '225Œ©', '215Œ©'], ans: 1, diff: 'HARD', r: 'Excellent calculation.', w: 'R = V/I = 220/5 = 44Œ©.' },
        { q: 'Generator converts:', op: ['Electrical to mechanical', 'Mechanical to electrical', 'Heat to light', 'Sound to light'], ans: 2, diff: 'HARD', r: 'Strong energy conversion.', w: 'Generator: mechanical ‚Üí electrical.' },
    ],
    Advance: [
        { q: 'Heating element made of:', op: ['Copper', 'Nichrome', 'Aluminium', 'Gold'], ans: 2, diff: 'EASY', r: 'Good knowledge.', w: 'Nichrome has high resistance ‚Üí heating.' },
        { q: 'Electric power unit is:', op: ['Ampere', 'Volt', 'Watt', 'Ohm'], ans: 3, diff: 'EASY', r: 'Accurate.', w: 'Power measured in Watts.' },
        { q: 'P = V √ó:', op: ['R', 'I', 'Œ©', 'W'], ans: 2, diff: 'EASY', r: 'Good formula.', w: 'P = V √ó I.' },
        { q: 'Electromagnets used in:', op: ['Cranes', 'Cooking', 'Washing', 'Walking'], ans: 1, diff: 'EASY', r: 'Good application.', w: 'Cranes use electromagnets.' },
        { q: 'Magnetic compass invented in:', op: ['India', 'China', 'USA', 'Russia'], ans: 2, diff: 'EASY', r: 'Good history.', w: 'Chinese invented compass.' },
        { q: 'If V=10V, I=2A, P=:', op: ['5W', '20W', '12W', '8W'], ans: 2, diff: 'MEDIUM', r: 'Excellent calculation.', w: 'P = 10 √ó 2 = 20W.' },
        { q: 'Voltmeter is connected in:', op: ['Series', 'Parallel', 'Either', 'Neither'], ans: 2, diff: 'MEDIUM', r: 'Strong knowledge.', w: 'Voltmeter connected in parallel.' },
        { q: 'MCB replaced:', op: ['Switch', 'Fuse', 'Battery', 'Wire'], ans: 2, diff: 'MEDIUM', r: 'Good practical knowledge.', w: 'MCB (Miniature Circuit Breaker) replaces fuse.' },
        { q: 'Resistance in series: R_total =', op: ['R1+R2', 'R1√óR2', 'R1/R2', 'R1‚àíR2'], ans: 1, diff: 'HARD', r: 'Excellent series formula.', w: 'Series: R_total = R1 + R2.' },
        { q: 'Electric energy: E =', op: ['P √ó t', 'P / t', 'P + t', 'P ‚àí t'], ans: 1, diff: 'HARD', r: 'Outstanding formula knowledge.', w: 'Energy = Power √ó time.' },
    ],
    Challenge: [
        { q: 'Electric bell uses:', op: ['Permanent magnet', 'Electromagnet', 'No magnet', 'Light'], ans: 2, diff: 'EASY', r: 'Good application.', w: 'Electric bell uses electromagnet.' },
        { q: 'Short circuit occurs when:', op: ['Wires touch directly', 'Switch is off', 'Battery is removed', 'Circuit is open'], ans: 1, diff: 'EASY', r: 'Accurate.', w: 'Short circuit = direct wire contact.' },
        { q: '1 kWh equals:', op: ['1000 Wh', '100 Wh', '10 Wh', '1 Wh'], ans: 1, diff: 'EASY', r: 'Good unit conversion.', w: '1 kWh = 1000 Watt-hours.' },
        { q: 'Earthing protects from:', op: ['Theft', 'Electric shock', 'Rain', 'Cold'], ans: 2, diff: 'EASY', r: 'Good safety knowledge.', w: 'Earthing prevents electric shock.' },
        { q: 'Magnetic field strongest at:', op: ['Centre', 'Poles', 'Middle of sides', 'Far away'], ans: 2, diff: 'EASY', r: 'Correct.', w: 'Strongest at poles.' },
        { q: 'If 3 resistors of 6Œ© each in series, total R:', op: ['2Œ©', '6Œ©', '18Œ©', '12Œ©'], ans: 3, diff: 'MEDIUM', r: 'Excellent series calculation.', w: '6+6+6 = 18Œ©.' },
        { q: 'Domestic supply in India is:', op: ['110V AC', '220V AC', '12V DC', '440V DC'], ans: 2, diff: 'MEDIUM', r: 'Good practical knowledge.', w: 'India uses 220V AC.' },
        { q: 'Solenoid behaves like:', op: ['Bulb', 'Bar magnet', 'Resistor', 'Battery'], ans: 2, diff: 'MEDIUM', r: 'Strong electromagnet concept.', w: 'Current-carrying solenoid = bar magnet.' },
        { q: 'If P=100W, t=5hours, energy=:', op: ['500Wh', '20Wh', '105Wh', '95Wh'], ans: 1, diff: 'HARD', r: 'Excellent energy calculation.', w: 'E = 100√ó5 = 500 Wh.' },
        { q: 'Fleming\'s left hand rule gives direction of:', op: ['Current', 'Force on conductor', 'Voltage', 'Resistance'], ans: 2, diff: 'HARD', r: 'Outstanding physics knowledge.', w: 'Left hand rule ‚Üí force direction on conductor.' },
    ],
};

// ========== CHAPTER 5: Inside the Atom ==========
const ch5: Record<string, QuestionData[]> = {
    Diagnostic: [
        { q: 'Atom is the smallest unit of:', op: ['Compound', 'Element', 'Mixture', 'Solution'], ans: 2, diff: 'EASY', r: 'Good basic concept.', w: 'Atom is smallest unit of element.' },
        { q: 'Electron has charge:', op: ['Positive', 'Negative', 'Neutral', 'No charge'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Electron has negative charge.' },
        { q: 'Proton has charge:', op: ['Positive', 'Negative', 'Neutral', 'No charge'], ans: 1, diff: 'EASY', r: 'Correct.', w: 'Proton has positive charge.' },
        { q: 'Neutron has charge:', op: ['Positive', 'Negative', 'Neutral', 'Double positive'], ans: 3, diff: 'EASY', r: 'Good recall.', w: 'Neutron is electrically neutral.' },
        { q: 'Nucleus contains:', op: ['Electrons only', 'Protons and neutrons', 'Only neutrons', 'Only protons'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Nucleus has protons + neutrons.' },
        { q: 'Electrons revolve around:', op: ['Proton', 'Neutron', 'Nucleus', 'Other electrons'], ans: 3, diff: 'MEDIUM', r: 'Strong concept.', w: 'Electrons orbit the nucleus.' },
        { q: 'Atomic number equals number of:', op: ['Neutrons', 'Protons', 'Electrons in outer shell', 'Mass'], ans: 2, diff: 'MEDIUM', r: 'Excellent.', w: 'Atomic number = number of protons.' },
        { q: 'Mass number = protons +:', op: ['Electrons', 'Neutrons', 'Photons', 'Atoms'], ans: 2, diff: 'MEDIUM', r: 'Good formula.', w: 'Mass number = protons + neutrons.' },
        { q: 'Who discovered electron?', op: ['Rutherford', 'Thomson', 'Bohr', 'Dalton'], ans: 2, diff: 'HARD', r: 'Excellent history.', w: 'J.J. Thomson discovered electron.' },
        { q: 'Who discovered nucleus?', op: ['Thomson', 'Rutherford', 'Bohr', 'Chadwick'], ans: 2, diff: 'HARD', r: 'Strong history recall.', w: 'Rutherford discovered the nucleus.' },
    ],
    Beginner: [
        { q: 'Atom was first proposed by:', op: ['Newton', 'Dalton', 'Thomson', 'Bohr'], ans: 2, diff: 'EASY', r: 'Good history.', w: 'Dalton proposed atomic theory.' },
        { q: 'Electron\'s mass is:', op: ['Very large', 'Very small', 'Equal to proton', 'Zero'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Electron mass is negligible.' },
        { q: 'Proton is found in:', op: ['Orbit', 'Nucleus', 'Outside atom', 'Electron cloud'], ans: 2, diff: 'EASY', r: 'Correct.', w: 'Proton is in the nucleus.' },
        { q: 'Most of atom is:', op: ['Solid', 'Empty space', 'Liquid', 'Gas'], ans: 2, diff: 'EASY', r: 'Good concept.', w: 'Atom is mostly empty space.' },
        { q: 'Hydrogen has how many protons?', op: ['0', '1', '2', '3'], ans: 2, diff: 'EASY', r: 'Excellent.', w: 'Hydrogen has 1 proton.' },
        { q: 'Maximum electrons in first shell:', op: ['2', '8', '18', '32'], ans: 1, diff: 'MEDIUM', r: 'Good shell knowledge.', w: 'First shell holds max 2 electrons.' },
        { q: 'Maximum electrons in second shell:', op: ['2', '8', '18', '32'], ans: 2, diff: 'MEDIUM', r: 'Accurate.', w: 'Second shell holds max 8 electrons.' },
        { q: 'Thomson model is called:', op: ['Nuclear model', 'Plum pudding model', 'Planetary model', 'Solar model'], ans: 2, diff: 'MEDIUM', r: 'Good model knowledge.', w: 'Thomson proposed plum pudding model.' },
        { q: 'Isotopes have same:', op: ['Mass number', 'Atomic number', 'Neutrons', 'Weight'], ans: 2, diff: 'HARD', r: 'Excellent.', w: 'Isotopes have same atomic number.' },
        { q: 'Chadwick discovered:', op: ['Electron', 'Proton', 'Neutron', 'Nucleus'], ans: 3, diff: 'HARD', r: 'Strong history.', w: 'Chadwick discovered neutron.' },
    ],
    Intermediate: [
        { q: 'Valence electrons are in:', op: ['Inner shell', 'Outermost shell', 'Nucleus', 'Between shells'], ans: 2, diff: 'EASY', r: 'Good concept.', w: 'Valence electrons are in outermost shell.' },
        { q: 'Carbon atomic number 6 means:', op: ['6 neutrons', '6 protons', '6 shells', '6 molecules'], ans: 2, diff: 'EASY', r: 'Accurate.', w: '6 protons in carbon.' },
        { q: 'Neutral atom has equal:', op: ['Protons and neutrons', 'Protons and electrons', 'Neutrons and electrons', 'Mass and charge'], ans: 2, diff: 'EASY', r: 'Correct.', w: 'Neutral atom: protons = electrons.' },
        { q: 'Helium has mass number 4 and atomic number 2. Neutrons:', op: ['2', '4', '6', '0'], ans: 1, diff: 'EASY', r: 'Good calculation.', w: 'Neutrons = 4‚àí2 = 2.' },
        { q: 'Electron shells are also called:', op: ['Layers', 'Orbits/energy levels', 'Rings', 'Circles'], ans: 2, diff: 'EASY', r: 'Good terminology.', w: 'Shells = orbits or energy levels.' },
        { q: 'Sodium (Z=11) electronic configuration:', op: ['2,8,1', '2,8,2', '2,9', '11'], ans: 1, diff: 'MEDIUM', r: 'Excellent configuration.', w: 'Na: 2,8,1.' },
        { q: 'Chlorine (Z=17) valence electrons:', op: ['2', '7', '8', '17'], ans: 2, diff: 'MEDIUM', r: 'Good.', w: 'Cl: 2,8,7 ‚Üí 7 valence electrons.' },
        { q: 'Bohr\'s model proposed:', op: ['Random electron motion', 'Fixed orbits for electrons', 'No electrons', 'Liquid nucleus'], ans: 2, diff: 'MEDIUM', r: 'Strong model knowledge.', w: 'Bohr said electrons in fixed orbits.' },
        { q: 'Oxygen (Z=8) has electrons in shells:', op: ['2,6', '8', '2,8', '6,2'], ans: 1, diff: 'HARD', r: 'Excellent configuration.', w: 'O: 2,6.' },
        { q: 'Noble gases have ___ valence shell:', op: ['Empty', 'Incomplete', 'Complete/full', 'No shell'], ans: 3, diff: 'HARD', r: 'Outstanding.', w: 'Noble gases have complete valence shells.' },
    ],
    Advance: [
        { q: 'Alpha particles are:', op: ['Electrons', 'Helium nuclei', 'Neutrons', 'Photons'], ans: 2, diff: 'EASY', r: 'Good knowledge.', w: 'Alpha particles = helium nuclei.' },
        { q: 'Rutherford\'s experiment used:', op: ['Electrons', 'Alpha particles', 'Neutrons', 'Light'], ans: 2, diff: 'EASY', r: 'Accurate.', w: 'Gold foil experiment used alpha particles.' },
        { q: 'Most alpha particles passed through gold foil because:', op: ['Gold is weak', 'Atom is mostly empty', 'Gold is magnetic', 'Alpha is small'], ans: 2, diff: 'EASY', r: 'Excellent reasoning.', w: 'Atom is mostly empty space.' },
        { q: 'Ion is formed when atom:', op: ['Gains/loses protons', 'Gains/loses electrons', 'Breaks apart', 'Combines with neutrons'], ans: 2, diff: 'EASY', r: 'Good concept.', w: 'Ion = atom gaining/losing electrons.' },
        { q: 'Cation has:', op: ['Negative charge', 'Positive charge', 'No charge', 'Extra neutrons'], ans: 2, diff: 'EASY', r: 'Correct.', w: 'Cation = positive ion.' },
        { q: 'Anion has:', op: ['Positive charge', 'Negative charge', 'No charge', 'Extra protons'], ans: 2, diff: 'MEDIUM', r: 'Good.', w: 'Anion = negative ion.' },
        { q: 'Calcium (Z=20) configuration:', op: ['2,8,10', '2,8,8,2', '2,8,8', '20'], ans: 2, diff: 'MEDIUM', r: 'Excellent.', w: 'Ca: 2,8,8,2.' },
        { q: 'Isotopes of carbon: C-12 and C-14 differ in:', op: ['Protons', 'Electrons', 'Neutrons', 'Atomic number'], ans: 3, diff: 'MEDIUM', r: 'Strong isotope concept.', w: 'Isotopes differ in neutrons.' },
        { q: 'Maximum electrons in third shell:', op: ['2', '8', '18', '32'], ans: 3, diff: 'HARD', r: 'Excellent shell formula.', w: 'Third shell: 2n¬≤ = 2(3¬≤) = 18.' },
        { q: 'Electron configuration of Argon (Z=18):', op: ['2,8,8', '2,8,10', '2,8,6,2', '18'], ans: 1, diff: 'HARD', r: 'Outstanding.', w: 'Ar: 2,8,8.' },
    ],
    Challenge: [
        { q: 'Formula for max electrons in shell n:', op: ['n¬≤', '2n¬≤', '2n', 'n¬≥'], ans: 2, diff: 'EASY', r: 'Excellent formula recall.', w: 'Max electrons = 2n¬≤.' },
        { q: 'Deuterium has 1 proton and:', op: ['0 neutrons', '1 neutron', '2 neutrons', '3 neutrons'], ans: 2, diff: 'EASY', r: 'Good isotope knowledge.', w: 'Deuterium: 1p + 1n.' },
        { q: 'Electron was discovered using:', op: ['Gold foil', 'Cathode ray tube', 'Microscope', 'Telescope'], ans: 2, diff: 'EASY', r: 'Good history.', w: 'Cathode ray experiment discovered electron.' },
        { q: 'Atom is electrically neutral because:', op: ['No charges', 'Equal protons and electrons', 'Only neutrons', 'Magic'], ans: 2, diff: 'EASY', r: 'Correct.', w: 'Equal p+ and e‚àí ‚Üí neutral.' },
        { q: 'Nucleus size compared to atom:', op: ['Same', 'Very small', 'Very large', 'Half'], ans: 2, diff: 'EASY', r: 'Excellent.', w: 'Nucleus is very tiny compared to atom.' },
        { q: 'Potassium (Z=19) configuration:', op: ['2,8,9', '2,8,8,1', '2,8,1', '19'], ans: 2, diff: 'MEDIUM', r: 'Excellent configuration.', w: 'K: 2,8,8,1.' },
        { q: 'Fe (Z=26) has protons:', op: ['26', '56', '30', '52'], ans: 1, diff: 'MEDIUM', r: 'Good.', w: 'Z = number of protons = 26.' },
        { q: 'Isobars have same:', op: ['Atomic number', 'Mass number', 'Neutrons', 'Electrons'], ans: 2, diff: 'MEDIUM', r: 'Strong concept.', w: 'Isobars have same mass number.' },
        { q: 'Tritium has 1 proton and:', op: ['0 neutrons', '1 neutron', '2 neutrons', '3 neutrons'], ans: 3, diff: 'HARD', r: 'Excellent isotope knowledge.', w: 'Tritium: 1p + 2n.' },
        { q: 'Gold foil experiment proved atom has:', op: ['No empty space', 'Dense positive nucleus', 'Only electrons', 'No nucleus'], ans: 2, diff: 'HARD', r: 'Outstanding understanding.', w: 'Proved dense positive nucleus exists.' },
    ],
};

export const scienceChaptersData: ChapterData[] = [
    { name: 'Living World and Classification of Microbes', order: 1, levels: makeLevels(ch1), youtubeLink: 'https://youtube.com/playlist?list=PLjm_mvBNlvBaXfRPwWssb8P0DTcUpxPfI&si=n0CNrgDDvQN-OF2R' },
    { name: 'Health and Diseases', order: 2, levels: makeLevels(ch2), youtubeLink: 'https://youtube.com/playlist?list=PLjm_mvBNlvBaXfRPwWssb8P0DTcUpxPfI&si=n0CNrgDDvQN-OF2R' },
    { name: 'Force and Pressure', order: 3, levels: makeLevels(ch3), youtubeLink: 'https://youtube.com/playlist?list=PLjm_mvBNlvBaXfRPwWssb8P0DTcUpxPfI&si=n0CNrgDDvQN-OF2R' },
    { name: 'Current Electricity and Magnetism', order: 4, levels: makeLevels(ch4), youtubeLink: 'https://youtube.com/playlist?list=PLjm_mvBNlvBaXfRPwWssb8P0DTcUpxPfI&si=n0CNrgDDvQN-OF2R' },
    { name: 'Inside the Atom', order: 5, levels: makeLevels(ch5), youtubeLink: 'https://youtube.com/playlist?list=PLjm_mvBNlvBaXfRPwWssb8P0DTcUpxPfI&si=n0CNrgDDvQN-OF2R' },
];




/*******************************************************************************
 * FILE: server/prisma/seed.ts
 *******************************************************************************/

import { PrismaClient } from '@prisma/client';
import { mathChaptersData } from './mathChapters.js';
import { scienceChaptersData } from './scienceChapters.js';

const prisma = new PrismaClient();

async function main() {
    console.log('Seeding database with DETAILED usage...');

    // HELPER to create Levels and Questions
    async function createLevels(chapterId: string, levelsData: any[]) {
        for (const [index, lvl] of levelsData.entries()) {
            const level = await prisma.level.upsert({
                where: { chapterId_name: { chapterId: chapterId, name: lvl.name } },
                update: {},
                create: { name: lvl.name, order: index + 1, chapterId: chapterId }
            });

            console.log(`  - Level: ${lvl.name}`);

            // Check if level already has questions to avoid redundant operations on every build
            const existingCount = await prisma.question.count({ where: { levelId: level.id } });
            if (existingCount > 0) {
                console.log(`    (Skipping ${existingCount} existing questions)`);
                continue;
            }

            for (const q of lvl.questions) {
                await prisma.question.create({
                    data: {
                        content: q.q,
                        options: JSON.stringify(q.op.map((text: string, i: number) => ({ id: i + 1, text }))),
                        correctOption: q.ans,
                        difficulty: q.diff,
                        explanation: q.r,
                        rightFeedback: q.r,
                        wrongFeedback: q.w,
                        levelId: level.id
                    }
                });
            }
        }
    }

    // --- MATHEMATICS (Standard 8) ---
    const mathSubject = await prisma.subject.upsert({
        where: { name_standard: { name: 'Mathematics', standard: '8' } },
        update: {},
        create: { name: 'Mathematics', standard: '8' }
    });

    console.log('Processing Mathematics...');

    for (const ch of mathChaptersData) {
        console.log(`Chapter: ${ch.name}`);
        const chapter = await prisma.chapter.upsert({
            where: { subjectId_name: { subjectId: mathSubject.id, name: ch.name } },
            update: { youtubeLink: ch.youtubeLink },
            create: { name: ch.name, subjectId: mathSubject.id, order: ch.order, youtubeLink: ch.youtubeLink }
        });
        await createLevels(chapter.id, ch.levels);
    }

    // --- SCIENCE (Standard 8) ---
    const scienceSubject = await prisma.subject.upsert({
        where: { name_standard: { name: 'Science', standard: '8' } },
        update: {},
        create: { name: 'Science', standard: '8' }
    });

    console.log('Processing Science...');

    for (const ch of scienceChaptersData) {
        console.log(`Chapter: ${ch.name}`);
        const chapter = await prisma.chapter.upsert({
            where: { subjectId_name: { subjectId: scienceSubject.id, name: ch.name } },
            update: { youtubeLink: ch.youtubeLink },
            create: { name: ch.name, subjectId: scienceSubject.id, order: ch.order, youtubeLink: ch.youtubeLink }
        });
        await createLevels(chapter.id, ch.levels);
    }

    // --- STANDARD 9 & 10 (Placeholders) ---
    const standards = ['9', '10'];
    const subjects = ['Mathematics', 'Science'];

    for (const std of standards) {
        console.log(`Processing Standard ${std}...`);
        for (const subjName of subjects) {
            const subject = await prisma.subject.upsert({
                where: { name_standard: { name: subjName, standard: std } },
                update: {},
                create: { name: subjName, standard: std }
            });

            // Create one placeholder chapter
            const chapter = await prisma.chapter.upsert({
                where: { subjectId_name: { subjectId: subject.id, name: `${subjName} - ${std}th Grade Intro` } },
                update: {},
                create: { name: `${subjName} - ${std}th Grade Intro`, subjectId: subject.id, order: 1 }
            });

            // Create placeholder levels
            const levelsData = [
                {
                    name: 'Diagnostic',
                    questions: [
                        { q: `Placeholder question 1 for ${subjName} ${std}`, op: ['Option A', 'Option B', 'Option C', 'Option D'], ans: 1, diff: 'EASY', r: 'Correct!', w: 'Incorrect.' },
                        { q: `Placeholder question 2 for ${subjName} ${std}`, op: ['Option A', 'Option B', 'Option C', 'Option D'], ans: 2, diff: 'EASY', r: 'Correct!', w: 'Incorrect.' },
                        { q: `Placeholder question 3 for ${subjName} ${std}`, op: ['Option A', 'Option B', 'Option C', 'Option D'], ans: 3, diff: 'EASY', r: 'Correct!', w: 'Incorrect.' },
                        { q: `Placeholder question 4 for ${subjName} ${std}`, op: ['Option A', 'Option B', 'Option C', 'Option D'], ans: 4, diff: 'EASY', r: 'Correct!', w: 'Incorrect.' },
                        { q: `Placeholder question 5 for ${subjName} ${std}`, op: ['Option A', 'Option B', 'Option C', 'Option D'], ans: 1, diff: 'EASY', r: 'Correct!', w: 'Incorrect.' },
                    ]
                }
            ];
            await createLevels(chapter.id, levelsData);
        }
    }

    console.log('Seeding completed successfully.');
}

main()
    .then(async () => {
        await prisma.$disconnect();
    })
    .catch(async (e) => {
        console.error(e);
        await prisma.$disconnect();
        process.exit(1);
    });



/*******************************************************************************
 * FILE: server/repro-register.ts
 *******************************************************************************/

async function testRegister() {
    try {
        console.log('Attempting to register test user via fetch...');
        const response = await fetch('http://localhost:5000/api/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: 'Test User',
                email: 'test' + Date.now() + '@example.com',
                password: 'password123',
                board: 'CBSE'
            })
        });

        const data = await response.json();
        if (response.ok) {
            console.log('‚úÖ SUCCESS:', data);
        } else {
            console.error('‚ùå FAILED:', response.status, data);
        }
    } catch (error: any) {
        console.error('‚ùå ERROR:', error.message);
    }
}

testRegister();



/*******************************************************************************
 * FILE: server/routes/adminRoutes.ts
 *******************************************************************************/

import express from 'express';
import { getSystemStats, getAllUsers, updateUserRole } from '../controllers/adminController.js';
import { authenticate, authorize } from '../middlewares/authMiddleware.js';

const router = express.Router();

// All admin routes require authentication and ADMIN role
router.use(authenticate);
router.use(authorize('ADMIN'));

router.get('/stats', getSystemStats);
router.get('/users', getAllUsers);
router.patch('/users/:id/role', updateUserRole);

export default router;



/*******************************************************************************
 * FILE: server/routes/aiRoutes.ts
 *******************************************************************************/

import express from 'express';
import { chatWithMentor, getDailyPlan, getRemediation } from '../controllers/aiController.js';
import { authenticate } from '../middlewares/authMiddleware.js';

const router = express.Router();

router.post('/chat', authenticate, chatWithMentor);
router.post('/remediation', authenticate, getRemediation);
router.get('/daily-plan', authenticate, getDailyPlan);

export default router;



/*******************************************************************************
 * FILE: server/routes/analyticsRoutes.ts
 *******************************************************************************/

import express from 'express';
import {
    getTimeSpentAnalytics,
    getAccuracyTrend,
    getDifficultyMastery,
    getRankProgression,
    getZenRevisionData
} from '../controllers/analyticsController.js';
import { authenticate } from '../middlewares/authMiddleware.js';

const router = express.Router();

router.get('/time-spent', authenticate, getTimeSpentAnalytics);
router.get('/accuracy-trend', authenticate, getAccuracyTrend);
router.get('/difficulty-mastery', authenticate, getDifficultyMastery);
router.get('/rank-progression', authenticate, getRankProgression);
router.get('/zen-revision', authenticate, getZenRevisionData);

export default router;



/*******************************************************************************
 * FILE: server/routes/authRoutes.ts
 *******************************************************************************/

import express from 'express';
import { register, login, changePassword, forgotPassword, verifyEmail, resendVerification } from '../controllers/authController.js';
import { uploadPhoto, uploadPhotoBase64 } from '../controllers/uploadController.js';
import { authenticate } from '../middlewares/authMiddleware.js';

const router = express.Router();

router.post('/register', register);
router.post('/login', login);
router.put('/change-password', authenticate, changePassword);
router.post('/forgot-password', forgotPassword);
router.post('/upload-photo', uploadPhoto);
router.post('/upload-photo-base64', uploadPhotoBase64);
router.get('/verify-email', verifyEmail);                // ‚Üê new
router.post('/resend-verification', resendVerification); // ‚Üê new

export default router;



/*******************************************************************************
 * FILE: server/routes/contentRoutes.ts
 *******************************************************************************/

import express from 'express';
import { getStandards, getSubjects, getChapters, getQuizQuestions, seedContent, getAdaptiveQuestion } from '../controllers/contentController.js';
import { authenticate } from '../middlewares/authMiddleware.js';

const router = express.Router();

router.get('/standards', authenticate, getStandards);
router.get('/subjects', authenticate, getSubjects);
router.get('/subjects/:subjectId/chapters', authenticate, getChapters);
router.get('/quiz/questions', authenticate, getQuizQuestions);
router.get('/adaptive-question', authenticate, getAdaptiveQuestion);
router.post('/seed', seedContent);

export default router;



/*******************************************************************************
 * FILE: server/routes/forumRoutes.ts
 *******************************************************************************/

import express, { Request, Response, NextFunction } from 'express';
import { getPosts, createPost, getPost, createReply, likePost } from '../controllers/forumController.js';
import { authenticate } from '../middlewares/authMiddleware.js';
import { upload } from '../middlewares/upload.js';
import multer from 'multer';

const router = express.Router();

// Wrap multer upload with error handling so bad file types return a clear 400 error
const uploadWithErrorHandling = (req: Request, res: Response, next: NextFunction) => {
    upload.single('file')(req, res, (err) => {
        if (err instanceof multer.MulterError) {
            // Multer-specific errors (e.g. file too large)
            return res.status(400).json({ message: `Upload error: ${err.message}` });
        } else if (err) {
            // Custom fileFilter error (wrong file type)
            return res.status(400).json({ message: err.message });
        }
        next();
    });
};

router.get('/posts', authenticate, getPosts);
router.post('/posts', authenticate, uploadWithErrorHandling, createPost);
router.get('/posts/:id', authenticate, getPost);
router.post('/posts/:id/reply', authenticate, createReply);
router.post('/posts/:id/like', authenticate, likePost);

export default router;



/*******************************************************************************
 * FILE: server/routes/leaderboardRoutes.ts
 *******************************************************************************/

import express from 'express';
import {
    getGlobalLeaderboard,
    getStandardLeaderboard,
    getSubjectLeaderboard,
    getUserRank
} from '../controllers/leaderboardController.js';
import { authenticate } from '../middlewares/authMiddleware.js';

const router = express.Router();

// All leaderboard routes require authentication
router.get('/global', authenticate, getGlobalLeaderboard);
router.get('/standard/:standard', authenticate, getStandardLeaderboard);
router.get('/subject/:subjectId', authenticate, getSubjectLeaderboard);
router.get('/user/:userId/rank', authenticate, getUserRank);

export default router;



/*******************************************************************************
 * FILE: server/routes/mentorRoutes.ts
 *******************************************************************************/

import express from 'express';
import { authenticate } from '../middlewares/authMiddleware.js';
import { upload } from '../middlewares/upload.js';
import {
    getAllMentors,
    getMentorById,
    createMentor,
    updateMentor,
    deleteMentor,
    requestMeeting,
    rateMentor
} from '../controllers/mentorController.js';

const router = express.Router();

// Middleware: Admin check
const adminOnly = (req: any, res: any, next: any) => {
    if (req.user?.role !== 'ADMIN') return res.status(403).json({ message: 'Admin access required' });
    next();
};

router.get('/', authenticate, getAllMentors);
router.get('/:id', authenticate, getMentorById);
router.post('/', authenticate, adminOnly, upload.single('profilePicture'), createMentor);
router.put('/:id', authenticate, adminOnly, upload.single('profilePicture'), updateMentor);
router.delete('/:id', authenticate, adminOnly, deleteMentor);
router.post('/:id/request', authenticate, requestMeeting);
router.post('/:id/rate', authenticate, rateMentor);

export default router;



/*******************************************************************************
 * FILE: server/routes/notificationRoutes.ts
 *******************************************************************************/

import express from 'express';
import { getNotifications, markAsRead, syncNotifications } from '../controllers/notificationController.js';
import { authenticate } from '../middlewares/authMiddleware.js';

const router = express.Router();

router.get('/', authenticate, getNotifications);
router.post('/sync', authenticate, syncNotifications);
router.put('/:id/read', authenticate, markAsRead);

export default router;



/*******************************************************************************
 * FILE: server/routes/profileRoutes.ts
 *******************************************************************************/

import express from 'express';
import { getProfile, updateProfile } from '../controllers/profileController.js';
import { authenticate } from '../middlewares/authMiddleware.js';

const router = express.Router();

router.get('/', authenticate, getProfile);
router.put('/', authenticate, updateProfile);

export default router;



/*******************************************************************************
 * FILE: server/routes/quizRoutes.ts
 *******************************************************************************/

import express from 'express';
import { startQuizSession, submitAnswer, completeQuizSession, getQuizReports, getQuizSessionDetails } from '../controllers/quizController.js';
import { authenticate } from '../middlewares/authMiddleware.js';

const router = express.Router();

// Get previous quiz reports (GET /api/quiz/reports)
router.get('/reports', authenticate, getQuizReports);

// Get specific session status (GET /api/quiz/session/:sessionId)
router.get('/session/:sessionId', authenticate, getQuizSessionDetails);

// Start a quiz (POST /api/quiz/start { levelId })
router.post('/start', authenticate, startQuizSession);

// Submit an answer (POST /api/quiz/submit { sessionId, questionId, selectedOptionId, timeTaken })
router.post('/submit', authenticate, submitAnswer);

// Complete a quiz (POST /api/quiz/complete { sessionId })
router.post('/complete', authenticate, completeQuizSession);

export default router;



/*******************************************************************************
 * FILE: server/server.ts
 *******************************************************************************/

import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import path from 'path';
import { fileURLToPath } from 'url';
import fs from 'fs';
import prisma from './config/db.js';

dotenv.config();

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Ensure uploads directory exists
const uploadsDir = path.resolve(__dirname, './uploads');
if (!fs.existsSync(uploadsDir)) {
    fs.mkdirSync(uploadsDir, { recursive: true });
}

const app = express();
const PORT = process.env.PORT || 5000;

const allowedOrigins = [
    'http://localhost:3000',
    'http://localhost:3001',
    'http://127.0.0.1:3000',
    'http://127.0.0.1:3001',
    process.env.FRONTEND_URL
].filter(Boolean) as string[];

app.use(cors({
    origin: (origin, callback) => {
        if (!origin || allowedOrigins.includes(origin)) {
            callback(null, true);
        } else {
            callback(new Error('Not allowed by CORS'));
        }
    },
    credentials: true
}));
import authRoutes from './routes/authRoutes.js';
import contentRoutes from './routes/contentRoutes.js';
import aiRoutes from './routes/aiRoutes.js';
import quizRoutes from './routes/quizRoutes.js';
import forumRoutes from './routes/forumRoutes.js';
import profileRoutes from './routes/profileRoutes.js';
import leaderboardRoutes from './routes/leaderboardRoutes.js';
import analyticsRoutes from './routes/analyticsRoutes.js';
import notificationRoutes from './routes/notificationRoutes.js';
import adminRoutes from './routes/adminRoutes.js';
import mentorRoutes from './routes/mentorRoutes.js';

app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ limit: '10mb', extended: true }));
app.use('/uploads', express.static(uploadsDir)); // Serve uploaded files
app.use('/api/auth', authRoutes);
app.use('/api/content', contentRoutes);
app.use('/api/ai', aiRoutes);
app.use('/api/quiz', quizRoutes);
app.use('/api/forum', forumRoutes);
app.use('/api/profile', profileRoutes);
app.use('/api/leaderboard', leaderboardRoutes);
app.use('/api/analytics', analyticsRoutes);
app.use('/api/notifications', notificationRoutes);
app.use('/api/admin', adminRoutes);
app.use('/api/mentors', mentorRoutes);

app.get('/', (req, res) => {
    res.send('API is running...');
});

app.listen(PORT, () => {
    console.log(`Server running on port ${PORT}`);
});



/*******************************************************************************
 * FILE: server/services/aiMentorService.ts
 *******************************************************************************/

import { GoogleGenerativeAI } from '@google/generative-ai';
import OpenAI from 'openai';
import { Ollama } from 'ollama';
import dotenv from 'dotenv';

dotenv.config();

// Ollama Setup
const ollamaHost = process.env.OLLAMA_HOST || 'http://localhost:11434';
const ollamaModel = process.env.OLLAMA_MODEL || 'qwen2.5:0.5b';
const ollama = new Ollama({ host: ollamaHost });

// Ollama Speed Options ‚Äî read from .env for easy tuning without code changes
const OLLAMA_FAST_OPTIONS = {
    num_predict: parseInt(process.env.OLLAMA_NUM_PREDICT || '120'),  // Max tokens (lower = faster)
    num_ctx: parseInt(process.env.OLLAMA_NUM_CTX || '512'),          // Context window (smaller = faster)
    temperature: 0.3,   // More deterministic, less randomness
    top_k: 20,          // Restrict vocab sampling
    top_p: 0.8,
    num_thread: 8,      // Use more CPU threads for faster local inference
};

// For end-of-quiz deep report ‚Äî allow more tokens but still optimized
const OLLAMA_REPORT_OPTIONS = {
    num_predict: parseInt(process.env.OLLAMA_NUM_PREDICT || '120') * 3, // 3x for full report
    num_ctx: parseInt(process.env.OLLAMA_NUM_CTX || '512') * 2,         // 2x context for report
    temperature: 0.3,
    top_k: 20,
    top_p: 0.8,
};

// Gemini Setup
const geminiApiKeys = (process.env.GEMINI_API_KEY || '').split(',').map(key => key.trim()).filter(key => key !== '');
const genAIs = geminiApiKeys.map(key => new GoogleGenerativeAI(key));

// OpenAI Setup
const openaiApiKeys = (process.env.OPENAI_API_KEY || '').split(',').map(key => key.trim()).filter(key => key !== '');
const openais = openaiApiKeys.map(key => new OpenAI({ apiKey: key }));

// Fallback logic for when AI is unavailable
const DEFAULT_FALLBACK_RESPONSE = "I'm currently resting to sharpen my knowledge! I'll be back in a moment to help you with your questions. In the meantime, why not try one of the practice quizzes?";

/**
 * Universal call helper that tries Ollama first, then Gemini, then OpenAI
 */
const callAIProviders = async (
    ollamaOp: () => Promise<any>,
    geminiOp: (genAI: GoogleGenerativeAI) => Promise<any>,
    openaiOp: (openai: OpenAI) => Promise<any>
) => {
    let lastError: any = null;

    // 1. Try Ollama (Local) first
    try {
        console.log(`Trying Ollama (${ollamaModel})...`);
        return await ollamaOp();
    } catch (error: any) {
        lastError = error;
        console.error(`Ollama Error:`, error.message);
        // If Ollama fails, fall back to other providers
    }

    // 2. Try OpenAI keys if available
    for (let i = 0; i < openais.length; i++) {
        try {
            console.log(`Trying OpenAI Key ${i + 1}...`);
            return await openaiOp(openais[i]);
        } catch (error: any) {
            lastError = error;
            console.error(`OpenAI Error (Key ${i + 1}):`, error.message);
            // If it's a quota issue (429), try next key
            if (error.status === 429 || error.status === 500 || error.status === 503) continue;
        }
    }

    // 3. Fallback to Gemini keys
    for (let i = 0; i < genAIs.length; i++) {
        try {
            console.log(`Fallback: Trying Gemini Key ${i + 1}...`);
            return await geminiOp(genAIs[i]);
        } catch (error: any) {
            lastError = error;
            console.error(`Gemini Error (Key ${i + 1}):`, error.status || error.message);
            // If it's a quota issue (429), try next key
            if (error.status === 429 || error.status === 503 || error.status === 500) continue;
        }
    }

    throw lastError || new Error("No AI providers available.");
};

export const generateMentorResponse = async (message: string, userContext: any) => {
    const level = userContext?.standard || userContext?.level || 8;
    const studentName = userContext?.studentName ? `, ${userContext.studentName}` : '';
    const weakTopics = Array.isArray(userContext?.weakTopics) ? userContext.weakTopics.join(', ') : 'None';
    const subjects = Array.isArray(userContext?.subjects) ? userContext.subjects.join(', ') : 'General Science & Math';

    const systemPrompt = `You are 'Yatsya', a concise AI mentor for Std ${level} students. Reply in 2-3 sentences max. Be warm and direct.`;
    const userPrompt = `Student${studentName} asks: "${message}"
Weak areas: ${weakTopics}. Answer helpfully and briefly.`;

    try {
        return await callAIProviders(
            async () => {
                const response = await ollama.chat({
                    model: ollamaModel,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: userPrompt }
                    ],
                    options: OLLAMA_FAST_OPTIONS,
                });
                return response.message.content;
            },
            async (genAI) => {
                const model = genAI.getGenerativeModel({ model: "gemini-flash-lite-latest" });
                const chat = model.startChat({
                    history: [
                        { role: "user", parts: [{ text: systemPrompt }] },
                        { role: "model", parts: [{ text: "Hello! I'm Yatsya, your personal AI mentor. How can I assist you today?" }] },
                    ],
                });
                const result = await chat.sendMessage(userPrompt);
                return (await result.response).text();
            },
            async (openaiClient) => {
                const response = await openaiClient.chat.completions.create({
                    model: "gpt-4o-mini",
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: userPrompt }
                    ],
                });
                return response.choices[0].message.content;
            }
        );
    } catch (error) {
        return DEFAULT_FALLBACK_RESPONSE;
    }
};

export const generateDailyPlan = async (userContext: any) => {
    const availableContentStr = userContext?.availableContent
        ? JSON.stringify(userContext.availableContent)
        : 'Standard 8-10 Math and Science curriculum';

    const prompt = `Generate a 4-task daily study plan for Std ${userContext?.level || 8}.
Weak topics: ${Array.isArray(userContext?.weakTopics) ? userContext.weakTopics.join(', ') : 'None'}.
Content: ${availableContentStr}
Respond ONLY with this JSON (no extra text):
{"tasks":[{"subject":"Math","topic":"Algebra","duration":"30 mins","type":"Practice"}]}`;

    try {
        return await callAIProviders(
            async () => {
                const response = await ollama.chat({
                    model: ollamaModel,
                    messages: [{ role: 'user', content: prompt }],
                    format: 'json',
                    options: OLLAMA_REPORT_OPTIONS,
                });
                return JSON.parse(response.message.content || '{}');
            },
            async (genAI) => {
                const model = genAI.getGenerativeModel({ model: "gemini-flash-lite-latest" });
                const result = await model.generateContent(prompt);
                const text = (await result.response).text();
                const jsonStart = text.indexOf('{');
                const jsonEnd = text.lastIndexOf('}');
                return JSON.parse(text.substring(jsonStart, jsonEnd + 1));
            },
            async (openaiClient) => {
                const response = await openaiClient.chat.completions.create({
                    model: "gpt-4o-mini",
                    messages: [{ role: "user", content: prompt }],
                    response_format: { type: "json_object" }
                });
                return JSON.parse(response.choices[0].message.content || '{}');
            }
        );
    } catch (error) {
        return {
            tasks: [
                { subject: "Math", topic: "General Revision", duration: "30 mins", type: "Practice" },
                { subject: "Science", topic: "Chapter Review", duration: "45 mins", type: "Reading" }
            ],
            isFallback: true
        };
    }
};

export const generateQuizFeedback = async (score: number, subjectName: string, chapterName: string, levelName: string, wrongAnswers: any[]) => {
    const wrongTopics = wrongAnswers.map((q: any) => q.question.subtopic?.name || q.question.difficulty).filter((v, i, a) => a.indexOf(v) === i);

    const prompt = `Quiz result: ${subjectName} > ${chapterName} (${levelName}), Score: ${score}%.
Wrong topics: ${wrongTopics.join(', ') || 'None'}.
Respond ONLY with this JSON:
{"feedback":"2-sentence encouragement.","recommendations":"- Topic: https://www.youtube.com/results?search_query=Topic"}`;

    try {
        return await callAIProviders(
            async () => {
                const response = await ollama.chat({
                    model: ollamaModel,
                    messages: [{ role: 'user', content: prompt }],
                    format: 'json',
                    options: OLLAMA_FAST_OPTIONS,
                });
                return JSON.parse(response.message.content || '{}');
            },
            async (genAI) => {
                const model = genAI.getGenerativeModel({ model: "gemini-flash-lite-latest" });
                const result = await model.generateContent(prompt);
                const text = (await result.response).text();
                const jsonStart = text.indexOf('{');
                const jsonEnd = text.lastIndexOf('}');
                return JSON.parse(text.substring(jsonStart, jsonEnd + 1));
            },
            async (openaiClient) => {
                const response = await openaiClient.chat.completions.create({
                    model: "gpt-4o-mini",
                    messages: [{ role: "user", content: prompt }],
                    response_format: { type: "json_object" }
                });
                return JSON.parse(response.choices[0].message.content || '{}');
            }
        );
    } catch (error) {
        return {
            feedback: score >= 80 ? "Great job! You have a solid understanding." : "Keep practicing! You're making progress.",
            recommendations: "Visit our subtopic section for more practice."
        };
    }
};

export const generateRemediation = async (question: any, type: 'UPGRADE' | 'DOWNGRADE') => {
    const prompt = type === 'UPGRADE'
        ? `Q: "${question.content}" Answer: "${question.options[question.correctOption]}". Student got it fast. Give a 2-sentence deep-dive: explain WHY it's correct + one real-world application. Be concise.`
        : `Q: "${question.content}" Answer: "${question.options[question.correctOption]}". Student struggled. Give a 2-sentence micro-lesson: simple analogy + how to remember it. Be encouraging.`;

    try {
        return await callAIProviders(
            async () => {
                const response = await ollama.chat({
                    model: ollamaModel,
                    messages: [{ role: 'user', content: prompt }],
                    options: OLLAMA_FAST_OPTIONS,
                });
                return response.message.content;
            },
            async (genAI) => {
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash-lite" });
                const result = await model.generateContent(prompt);
                return (await result.response).text();
            },
            async (openaiClient) => {
                const response = await openaiClient.chat.completions.create({
                    model: "gpt-4o-mini",
                    messages: [{ role: "user", content: prompt }]
                });
                return response.choices[0].message.content;
            }
        );
    } catch (error) {
        return type === 'UPGRADE'
            ? "Fascinating choice! This concept is fundamental to modern engineering. Keep up the high speed!"
            : "Think of this like a puzzle where every piece fits together. Take it step-by-step and you'll master it!";
    }
};



/*******************************************************************************
 * FILE: server/test-ai.ts
 *******************************************************************************/

import { GoogleGenerativeAI } from '@google/generative-ai';
import dotenv from 'dotenv';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Load .env from the server directory
dotenv.config({ path: path.join(__dirname, '.env') });

const apiKey = process.env.GEMINI_API_KEY;

if (!apiKey) {
    console.error("Error: GEMINI_API_KEY not found in .env file.");
    process.exit(1);
}

import OpenAI from 'openai';
// ...
async function testConnection() {
    // Test OpenAI
    const openaiKeyRaw = process.env.OPENAI_API_KEY || '';
    const openaiKeys = openaiKeyRaw.split(',').map(k => k.trim()).filter(k => k !== '');

    console.log(`\n--- Testing ${openaiKeys.length} OpenAI Keys (Default) ---`);
    if (openaiKeys.length > 0) {
        for (let i = 0; i < openaiKeys.length; i++) {
            const key = openaiKeys[i];
            console.log(`\nTesting OpenAI Key ${i + 1}:`);
            try {
                const openaiClient = new OpenAI({ apiKey: key });
                const response = await openaiClient.chat.completions.create({
                    model: "gpt-4o-mini",
                    messages: [{ role: "user", content: "Hi" }],
                });
                console.log(`‚úÖ OpenAI SUCCESS:`, response.choices[0].message.content?.substring(0, 30) + "...");
            } catch (e: any) {
                console.log(`‚ùå OpenAI FAILED:`, e.message);
                if (i === openaiKeys.length - 1) {
                    console.log(`(All OpenAI keys failed, system will fall back to Gemini)`);
                }
            }
        }
    } else {
        console.log("‚ö†Ô∏è OpenAI Key not found in .env");
    }

    // Test Gemini Keys
    const geminiKeys = (apiKey || '').split(',').map(k => k.trim()).filter(k => k !== '');
    console.log(`\n--- Testing Gemini Keys (Fallback) ---`);
    for (let i = 0; i < geminiKeys.length; i++) {
        const key = geminiKeys[i];
        console.log(`\nTesting Gemini Key ${i + 1}:`);
        try {
            const genAI = new GoogleGenerativeAI(key);
            const model = genAI.getGenerativeModel({ model: "gemini-flash-lite-latest" });
            const result = await model.generateContent("Hi");
            console.log(`‚úÖ Gemini SUCCESS:`, (await result.response).text().substring(0, 30) + "...");
        } catch (e: any) {
            console.log(`‚ùå Gemini FAILED:`, e.message);
        }
    }
}

testConnection();



/*******************************************************************************
 * FILE: server/test-gemini.ts
 *******************************************************************************/

import { GoogleGenerativeAI } from '@google/generative-ai';
import dotenv from 'dotenv';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

dotenv.config({ path: path.join(__dirname, '.env') });

async function testGemini() {
    const apiKeyRaw = process.env.GEMINI_API_KEY || '';
    const keys = apiKeyRaw.split(',').map(k => k.trim()).filter(k => k !== '');

    if (keys.length === 0) {
        console.error("‚ùå Error: No GEMINI_API_KEY found in .env");
        return;
    }

    console.log(`--- Testing ${keys.length} Gemini API Key(s) ---`);

    for (let i = 0; i < keys.length; i++) {
        const key = keys[i];
        console.log(`\nTesting Key ${i + 1}: ${key.substring(0, 8)}...`);
        try {
            const genAI = new GoogleGenerativeAI(key);
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
            const result = await model.generateContent("Say 'Gemini is working!'");
            const response = await result.response;
            console.log(`‚úÖ SUCCESS: ${response.text()}`);
        } catch (error: any) {
            console.error(`‚ùå FAILED: ${error.message}`);
        }
    }
}

testGemini();



/*******************************************************************************
 * FILE: server/test-ollama-direct.ts
 *******************************************************************************/

import { Ollama } from 'ollama';
import dotenv from 'dotenv';
dotenv.config();

async function test() {
    const ollama = new Ollama({ host: process.env.OLLAMA_HOST || 'http://127.0.0.1:11434' });
    const model = process.env.OLLAMA_MODEL || 'llama3';
    console.log(`Testing direct Ollama connection to ${ollama.config.host} with model ${model}...`);
    try {
        const response = await ollama.chat({
            model: model,
            messages: [{ role: 'user', content: 'Say hello' }],
        });
        console.log('Ollama Response:', response.message.content);
    } catch (error) {
        console.error('Ollama Connection Failed:', error.message);
    }
}

test();



/*******************************************************************************
 * FILE: server/test-ollama-integration.ts
 *******************************************************************************/

import { generateMentorResponse } from './services/aiMentorService.js';

async function testOllama() {
    console.log('--- Testing Ollama Integration ---');
    try {
        const response = await generateMentorResponse('What is gravity?', { level: 9, subjects: ['Science'] });
        console.log('Mentor Response:', response);
        if (response.includes('resting') || response.includes('fallback')) {
            console.log('FAILED: Received fallback response.');
        } else {
            console.log('SUCCESS: Received valid response from AI.');
        }
    } catch (error) {
        console.error('ERROR during test:', error.message);
    }
}

testOllama();



/*******************************************************************************
 * FILE: server/verify-db.ts
 *******************************************************************************/

import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();

async function main() {
    console.log('--- Database Verification (yatsya_db) ---');
    console.log('Subjects:', await prisma.subject.count());
    console.log('Chapters:', await prisma.chapter.count());
    console.log('Questions:', await prisma.question.count());
    console.log('---------------------------');
}

main()
    .catch(e => console.error(e))
    .finally(async () => {
        await prisma.$disconnect();
    });
